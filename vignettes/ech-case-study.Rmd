---
title: "Analisis del mercado laboral uruguayo con la ECH"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Analisis del mercado laboral uruguayo con la ECH}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: references.bib
link-citations: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE,
  eval = FALSE
)
```

```{r setup}
library(metasurvey)
library(survey)
library(data.table)
```

## La Encuesta Continua de Hogares

La Encuesta Continua de Hogares (ECH) es la principal fuente de
informacion socioeconomica de Uruguay. Desde 1968, el Instituto Nacional
de Estadistica (INE) la lleva adelante de forma ininterrumpida, lo que
la convierte en una de las series de encuestas de hogares mas largas de
America Latina [@ine2023].

La ECH tiene dos grandes propositos. Por un lado, produce las cifras
oficiales de empleo, desempleo, pobreza e ingresos que se publican
mensual y trimestralmente. Por otro, sus microdatos son la base de buena
parte de la investigacion academica en ciencias sociales y economia en
Uruguay. Tesis de grado, articulos de revistas, informes de consultoria
y documentos de politica publica dependen de estos datos.

Para quienes trabajan con encuestas de hogares en la region, el paquete
[`ech`](https://calcita.github.io/ech/) de Gabriela Mathieu y Richard
Detomasi ofrece un conjunto valioso de funciones para calcular
indicadores socioeconomicos con la ECH. De la misma forma, el paquete
[`eph`](https://docs.ropensci.org/eph/) de Diego Kozlowski, Pablo
Tiscornia y Guido Weksler hace lo propio con la Encuesta Permanente de
Hogares de Argentina y esta publicado en rOpenSci. **metasurvey** se
inspira en estos proyectos y complementa su enfoque: en lugar de
funciones especificas para cada indicador, ofrece una capa de
metaprogramacion que permite construir, documentar y compartir pipelines
de procesamiento completos.

### Estructura de la encuesta

La ECH utiliza un diseno de panel rotativo. Cada trimestre ingresa una
nueva muestra de hogares (la *implantacion*), que es luego entrevistada
mensualmente durante seis meses (el *seguimiento*). Esto permite
producir:

- **Estimaciones anuales** usando la muestra de implantacion con pesos
  anuales
- **Estimaciones mensuales** usando los seguimientos con pesos mensuales
- **Estimaciones trimestrales-a-mensuales** que combinan la correlacion
  entre trimestres solapados

Las variables clave para el analisis laboral son [@inedata]:

| Variable | Descripcion | Valores relevantes |
|----------|-------------|-------------------|
| `POBPCOAC` | Condicion de actividad | 2=Ocupado, 3-5=Desocupado, 6-8=Inactivo |
| `e27` | Edad en anos | Continua |
| `e26` | Sexo | 1=Hombre, 2=Mujer |
| `e51` | Nivel educativo | 1-14, escala codificada |
| `ht11` | Ingreso total del hogar | En pesos uruguayos corrientes |
| `pesoano` | Factor de expansion anual | Peso muestral |
| `dpto` | Departamento | 1-19 |

## Cargando datos de la ECH

En una situacion real, los microdatos se cargan directamente desde los
archivos del INE. El paquete `metasurvey` puede manejar la estructura
completa del panel, incluyendo los pesos replicados bootstrap que el INE
provee para la estimacion robusta de varianzas:

```{r load-real-data}
# Carga de la ECH 2023 completa con pesos replicados
path_dir <- "ruta/a/datos/ech_2023"

ech_2023 <- load_panel_survey(
  path_implantation = file.path(path_dir, "ECH_implantacion_2023.csv"),
  path_follow_up = file.path(path_dir, "seguimiento"),
  svy_type = "ech",
  svy_weight_implantation = add_weight(
    annual = add_replicate(
      "W_ANO",
      replicate_path = file.path(path_dir, "anual", "pesos_replicados_bootstrap_anual_2023.csv"),
      replicate_id = c("ID" = "ID"),
      replicate_pattern = "wr[0-9]+",
      replicate_type = "bootstrap"
    )
  ),
  svy_weight_follow_up = add_weight(
    monthly = add_replicate(
      "W",
      replicate_path = file.path(
        path_dir,
        c("pesos_replicados_bootstrap_mensuales_ene_jun_2023",
          "pesos_replicados_bootstrap_mensuales_jul_dic_2023")
      ),
      replicate_id = c("ID" = "ID"),
      replicate_pattern = "wr[0-9]+",
      replicate_type = "bootstrap"
    )
  )
)
```

Para los ejemplos de esta guia, usamos datos simulados que reproducen la
estructura de la ECH. Las distribuciones estan calibradas para generar
resultados en el rango de las cifras oficiales, aunque los valores
puntuales no coincidiran exactamente:

```{r simulate-data}
set.seed(2023)
n <- 2000

# Simulamos microdatos con distribuciones calibradas
dt <- data.table(
  numero   = 1:n,
  e27      = pmax(0, round(rnorm(n, 38, 18))),
  e26      = sample(c(1, 2), n, replace = TRUE, prob = c(0.48, 0.52)),
  ht11     = round(pmax(0, rnorm(n, 45000, 25000))),
  cant_per = sample(1:6, n, replace = TRUE, prob = c(0.20, 0.25, 0.25, 0.15, 0.10, 0.05)),
  POBPCOAC = sample(c(2, 3, 4, 5, 6, 7, 8), n, replace = TRUE,
                    prob = c(0.55, 0.04, 0.02, 0.02, 0.15, 0.12, 0.10)),
  e51      = sample(1:14, n, replace = TRUE,
                    prob = c(0.02, 0.05, 0.08, 0.10, 0.12, 0.08,
                             0.10, 0.12, 0.10, 0.08, 0.05, 0.04, 0.03, 0.03)),
  dpto     = sample(1:19, n, replace = TRUE,
                    prob = c(0.40, rep(0.60/18, 18))),
  pesoano  = round(runif(n, 0.5, 3.0), 4)
)

svy <- Survey$new(
  data    = dt,
  edition = "2023",
  type    = "ech",
  psu     = NULL,
  engine  = "data.table",
  weight  = add_weight(annual = "pesoano")
)
```

## Construccion de indicadores laborales

### Definiciones basicas segun la OIT

Las definiciones de la Organizacion Internacional del Trabajo (OIT)
[@ilo2013] establecen tres poblaciones fundamentales:

- **Poblacion en Edad de Trabajar (PET)**: personas de 14 anos o mas
  (en Uruguay, el corte es 14 anos; en Argentina, por ejemplo, la EPH
  usa 10 anos)
- **Poblacion Economicamente Activa (PEA)**: personas que trabajan o
  buscan trabajo activamente
- **Ocupados (PO)**: personas que trabajaron al menos una hora en el
  periodo de referencia
- **Desocupados (PD)**: personas que no trabajaron pero buscaron empleo

Con `metasurvey`, estas definiciones se codifican como pasos del
pipeline:

```{r labor-indicators}
# Poblacion en Edad de Trabajar
svy <- step_recode(svy, pet,
  e27 >= 14 ~ 1,
  .default = 0,
  comment = "PET: Poblacion en Edad de Trabajar (14+ anios)"
)

# Poblacion Economicamente Activa
svy <- step_recode(svy, pea,
  POBPCOAC %in% 2:5 ~ 1,
  .default = 0,
  comment = "PEA: Poblacion Economicamente Activa (ocupados + desocupados)"
)

# Ocupados
svy <- step_recode(svy, po,
  POBPCOAC == 2 ~ 1,
  .default = 0,
  comment = "PO: Ocupados (POBPCOAC == 2)"
)

# Desocupados
svy <- step_recode(svy, pd,
  POBPCOAC %in% 3:5 ~ 1,
  .default = 0,
  comment = "PD: Desocupados (POBPCOAC %in% 3:5)"
)

# Tasas
svy <- step_compute(svy,
  tasa_empleo    = po / pet,
  tasa_desempleo = pd / pea,
  tasa_actividad = pea / pet,
  comment = "Tasas laborales basicas: empleo, desempleo, actividad"
)
```

### Variables demograficas para desagregaciones

Los indicadores laborales agregados ocultan diferencias importantes. La
brecha de genero en el mercado laboral uruguayo es persistente: la tasa
de desempleo de las mujeres es sistematicamente mayor que la de los
hombres, y la tasa de actividad es menor. Para hacer visibles estas
diferencias, necesitamos variables de cruce:

```{r demographic-vars}
# Sexo
svy <- step_recode(svy, sexo,
  e26 == 1 ~ "Hombre",
  e26 == 2 ~ "Mujer",
  .default = "Otro",
  comment = "Sexo"
)

# Grupos de edad para analisis laboral
svy <- step_recode(svy, tramo_edad,
  e27 < 25  ~ "Jovenes (14-24)",
  e27 < 45  ~ "Adultos (25-44)",
  e27 < 65  ~ "Mayores (45-64)",
  .default  = "Adultos mayores (65+)",
  .to_factor = TRUE,
  ordered = TRUE,
  comment = "Tramos de edad para analisis laboral"
)

# Nivel educativo agregado
svy <- step_recode(svy, nivel_educativo,
  e51 %in% 1:6   ~ "Hasta primaria",
  e51 %in% 7:9   ~ "Secundaria",
  e51 %in% 10:14 ~ "Terciaria",
  .default = "Sin dato",
  comment = "Nivel educativo agregado (3 categorias)"
)

# Region
svy <- step_recode(svy, region,
  dpto == 1 ~ "Montevideo",
  .default  = "Interior",
  comment = "Region: Montevideo vs Interior"
)

# Ingreso per capita del hogar
svy <- step_compute(svy,
  ingreso_pc = ht11 / cant_per,
  comment = "Ingreso per capita del hogar"
)
```

## Estimacion con diseno muestral

Una vez construidas las variables, el siguiente paso es estimar los
indicadores con errores estandar que tengan en cuenta el diseno muestral.
Esto es fundamental: un `mean()` simple sobre los microdatos produce
estimaciones puntuales incorrectas (no usa los pesos de expansion) y
errores estandar que subestiman la incertidumbre real.

La funcion `workflow()` encapsula las llamadas a `survey::svymean()`,
`survey::svytotal()` y `survey::svyby()`, y devuelve los resultados en
un `data.table` ordenado con estimacion, error estandar y coeficiente de
variacion.

```{r estimation}
# Indicadores anuales agregados
resultados <- workflow(
  list(svy),
  survey::svymean(~tasa_empleo, na.rm = TRUE),
  survey::svymean(~tasa_desempleo, na.rm = TRUE),
  survey::svymean(~tasa_actividad, na.rm = TRUE),
  survey::svytotal(~po, na.rm = TRUE),
  survey::svytotal(~pd, na.rm = TRUE),
  estimation_type = "annual"
)

resultados
```

### Desagregacion por sexo

```{r gender-breakdown}
# Tasas por sexo
por_sexo <- workflow(
  list(svy),
  survey::svyby(~tasa_desempleo, ~sexo, survey::svymean, na.rm = TRUE),
  survey::svyby(~tasa_empleo, ~sexo, survey::svymean, na.rm = TRUE),
  survey::svyby(~tasa_actividad, ~sexo, survey::svymean, na.rm = TRUE),
  estimation_type = "annual"
)

por_sexo
```

En las cifras oficiales del INE para 2023, la tasa de desempleo de las
mujeres fue de 9.7% frente a 6.1% para los hombres---una brecha de 3.6
puntos porcentuales que se ha mantenido relativamente estable en la
ultima decada.

### Desagregacion por tramo de edad

```{r age-breakdown}
por_edad <- workflow(
  list(svy),
  survey::svyby(~tasa_desempleo, ~tramo_edad, survey::svymean, na.rm = TRUE),
  survey::svyby(~tasa_empleo, ~tramo_edad, survey::svymean, na.rm = TRUE),
  estimation_type = "annual"
)

por_edad
```

El desempleo juvenil es tipicamente dos a tres veces mayor que el
desempleo adulto. En 2023, la tasa de desempleo de los jovenes de 14 a
24 anos fue de 26.5%, frente a un promedio nacional de 8.3%. Este es uno
de los desafios estructurales del mercado laboral uruguayo que motiva
politicas publicas como el programa "Yo Estudio y Trabajo" y las
exoneraciones a la contratacion de jovenes.

### Desagregacion regional

```{r region-breakdown}
por_region <- workflow(
  list(svy),
  survey::svyby(~tasa_desempleo, ~region, survey::svymean, na.rm = TRUE),
  survey::svyby(~ingreso_pc, ~region, survey::svymean, na.rm = TRUE),
  estimation_type = "annual"
)

por_region
```

Montevideo concentra el 40% de la poblacion y presenta historicamente
tasas de desempleo ligeramente superiores al Interior, pero tambien
ingresos per capita mas altos. Esta aparente paradoja se explica por la
mayor tasa de actividad femenina en Montevideo y por las diferencias en
la estructura productiva.

## Evaluacion de calidad

Toda estimacion basada en una muestra tiene incertidumbre. El coeficiente
de variacion (CV) cuantifica la precision relativa de cada estimacion.
El INE de Uruguay [@ine2023] clasifica la calidad de las estimaciones
asi:

| CV | Calidad | Recomendacion |
|----|---------|---------------|
| < 5% | Excelente | Publicar sin restricciones |
| 5%--10% | Muy buena | Publicar con confianza |
| 10%--15% | Buena | Publicar para la mayoria de usos |
| 15%--25% | Aceptable | Publicar con nota de precaucion |
| 25%--35% | Pobre | Solo para tendencias generales |
| >= 35% | No confiable | No publicar |

La funcion `evaluate_cv()` clasifica automaticamente la calidad:

```{r quality}
# Evaluar calidad de las estimaciones
resultados[, calidad := sapply(cv * 100, evaluate_cv)]
resultados[, .(stat, value, se, cv_pct = round(cv * 100, 2), calidad)]
```

Un error comun al trabajar con la ECH es calcular estimaciones para
subpoblaciones demasiado pequenas. Por ejemplo, la tasa de desempleo
de mujeres jovenes con educacion terciaria en el departamento de Flores
probablemente tenga un CV superior al 35% y no deberia publicarse como
cifra confiable. Antes de desagregar, siempre hay que verificar que el
tamano muestral del dominio sea suficiente.

## Convirtiendo el analisis en una receta

Hasta ahora hemos construido un pipeline completo de procesamiento. Si
queremos que otro investigador pueda aplicar exactamente las mismas
definiciones a la ECH de 2024 (o a cualquier otra edicion), podemos
convertir los pasos en una receta:

```{r recipe}
# Crear receta a partir de los pasos aplicados
receta_laboral <- steps_to_recipe(
  name        = "Indicadores Laborales ECH - Estandar OIT",
  user        = "investigador@ejemplo.com",
  svy         = svy,
  description = paste(
    "Pipeline estandar de indicadores laborales para la ECH,",
    "siguiendo las definiciones de la OIT (2013).",
    "Incluye PET, PEA, PO, PD, tasas laborales basicas,",
    "y variables demograficas para desagregacion",
    "(sexo, tramo de edad, nivel educativo, region)."
  ),
  steps = get_steps(svy),
  topic = "labor_market"
)

# Documentacion automatica
doc <- receta_laboral$doc()
cat("Variables de entrada requeridas:\n")
cat(paste(" -", doc$input_variables), sep = "\n")
cat("\nVariables que crea:\n")
cat(paste(" -", doc$output_variables), sep = "\n")
```

### Publicar para la comunidad

Si queremos que esta receta este disponible para todos los usuarios de
metasurvey:

```{r publish}
# Iniciar sesion
api_login("investigador@ejemplo.com", "mi_password")

# Publicar
api_publish_recipe(receta_laboral)

# Ahora cualquier usuario puede encontrarla:
# api_list_recipes(search = "laboral", svy_type = "ech")
```

Para mas detalles sobre el ecosistema de recetas, la certificacion y el
mecanismo de descubrimiento, ver la guia
[The Recipe Ecosystem](api-ecosystem.html).

### Aplicar a otra edicion

```{r reapply}
# Cargar datos de otra edicion
ech_2024 <- Survey$new(
  data = nueva_data_2024,
  edition = "2024",
  type = "ech",
  psu = NULL,
  engine = "data.table",
  weight = add_weight(annual = "pesoano")
)

# Validar que la receta es compatible
val <- receta_laboral$validate(ech_2024)
if (val$validation_passed) {
  ech_2024$add_recipe(receta_laboral)
  ech_2024 <- bake_recipes(ech_2024)
  cat("Receta aplicada exitosamente a la ECH 2024.\n")
}
```

## Analisis mensual con el panel rotativo

La ECH permite producir estimaciones mensuales usando los datos de
seguimiento. Esto es particularmente util para monitorear el mercado
laboral en coyunturas de crisis (como fue el caso en 2020 con la
pandemia):

```{r monthly}
# Extraer encuestas mensuales del panel
mensuales <- extract_surveys(ech_procesada, monthly = 1:12)

# Tasa de desempleo mensual
serie_mensual <- workflow(
  survey = mensuales,
  survey::svymean(~tasa_desempleo, na.rm = TRUE),
  estimation_type = "monthly"
)

serie_mensual
```

Las estimaciones mensuales tienen mayor variabilidad que las anuales
porque se basan en muestras mas pequenas. Es habitual que el CV
mensual sea el doble del CV anual para el mismo indicador. Por eso los
comunicados oficiales del INE enfatizan las tendencias mas que los
valores puntuales mensuales.

## Buenas practicas

1. **Usar siempre los pesos de expansion.** Un analisis sin pesos produce
   estimaciones sesgadas. `workflow()` se encarga de esto automaticamente
   a traves del diseno muestral del objeto `Survey`.

2. **Evaluar el CV antes de publicar.** Desagregar demasiado reduce el
   tamano muestral efectivo. Si el CV supera el 25%, la estimacion no
   deberia publicarse como cifra confiable.

3. **Documentar las definiciones.** Dos investigadores pueden obtener
   tasas de desempleo diferentes si uno incluye a los trabajadores
   desalentados y otro no. Las recetas de metasurvey hacen explicitas
   estas decisiones.

4. **Validar contra cifras oficiales.** Siempre comparar las estimaciones
   con los boletines del INE. Si hay diferencias importantes, revisar las
   definiciones y el tratamiento de los pesos.

5. **Compartir el pipeline.** Publicar la receta permite que otros
   investigadores reproduzcan el analisis y detecten posibles errores.

## Referencias
