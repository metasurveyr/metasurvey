<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1100 820" font-family="'Segoe UI', Arial, sans-serif">
  <defs>
    <linearGradient id="apiGrad" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#ede9fe"/>
      <stop offset="100%" stop-color="#f5f3ff"/>
    </linearGradient>
    <linearGradient id="workerGrad" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#fef3c7"/>
      <stop offset="100%" stop-color="#fffbeb"/>
    </linearGradient>
    <linearGradient id="shinyGrad" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#ecfdf5"/>
      <stop offset="100%" stop-color="#f0fdf4"/>
    </linearGradient>
    <linearGradient id="chainGrad" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#faf5ff"/>
      <stop offset="100%" stop-color="#f3e8ff"/>
    </linearGradient>
    <filter id="shadow" x="-2%" y="-2%" width="104%" height="104%">
      <feDropShadow dx="1" dy="1" stdDeviation="2" flood-opacity="0.12"/>
    </filter>
    <marker id="arrowOrange" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#d97706"/>
    </marker>
    <marker id="arrowBlue" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#2563eb"/>
    </marker>
    <marker id="arrowGray" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#94a3b8"/>
    </marker>
    <marker id="arrowRed" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#dc2626"/>
    </marker>
    <marker id="arrowGold" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#ca8a04"/>
    </marker>
    <marker id="arrowPurple" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#4f46e5"/>
    </marker>
    <marker id="arrowGreen" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#059669"/>
    </marker>
    <marker id="arrowIndigo" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#6366f1"/>
    </marker>
  </defs>

  <!-- ========== CLOUD PROVIDER BACKGROUND ========== -->
  <rect x="10" y="10" width="1080" height="800" rx="12" fill="#f0f4ff" stroke="#4f46e5" stroke-width="2" stroke-dasharray="8 4"/>
  <text x="30" y="35" font-size="13" fill="#4f46e5" font-weight="bold">Cloud Provider</text>
  <text x="155" y="35" font-size="11" fill="#64748b">(AWS / Azure / GCP / On-Premise)</text>

  <!-- ========== K8S CLUSTER ========== -->
  <rect x="25" y="55" width="620" height="400" rx="8" fill="#ffffff" stroke="#1e3a5f" stroke-width="2" filter="url(#shadow)"/>
  <text x="45" y="78" font-size="13" fill="#1e3a5f" font-weight="bold">Kubernetes Cluster</text>
  <text x="195" y="78" font-size="10" fill="#64748b">(EKS / AKS / GKE / Minikube)</text>
  <text x="45" y="95" font-size="10" fill="#6366f1" font-weight="bold">namespace: metasurvey</text>

  <!-- ========== API POD ========== -->
  <rect x="40" y="110" width="195" height="195" rx="8" fill="url(#apiGrad)" stroke="#7c3aed" stroke-width="2" filter="url(#shadow)"/>
  <text x="137" y="132" font-size="12" fill="#5b21b6" font-weight="bold" text-anchor="middle">metasurvey API</text>
  <text x="137" y="147" font-size="10" fill="#7c3aed" text-anchor="middle">Deployment (replicas: 2)</text>
  <!-- API container box -->
  <rect x="52" y="155" width="170" height="35" rx="6" fill="#f5f3ff" stroke="#a78bfa" stroke-width="1"/>
  <text x="137" y="174" font-size="11" fill="#1e293b" font-weight="bold" text-anchor="middle">plumber :8787</text>
  <text x="137" y="186" font-size="9" fill="#64748b" text-anchor="middle">rocker/r-ver:4.4.0</text>
  <!-- API endpoints -->
  <text x="52" y="207" font-size="9" fill="#374151">GET /indicators</text>
  <text x="52" y="219" font-size="9" fill="#374151">GET /indicators/:id</text>
  <text x="52" y="231" font-size="9" fill="#374151">GET /indicators/:id/recipe</text>
  <text x="52" y="243" font-size="9" fill="#374151">GET /indicators/:id/workflow</text>
  <text x="52" y="255" font-size="9" fill="#374151">POST /indicators</text>
  <text x="52" y="267" font-size="9" fill="#d97706" font-weight="bold">POST /indicators/compute</text>
  <text x="179" y="267" font-size="8" fill="#d97706">&#8594; Worker</text>
  <text x="52" y="279" font-size="9" fill="#374151">GET /recipes · GET /workflows</text>
  <!-- PUBLIC badge -->
  <rect x="176" y="113" width="52" height="16" rx="8" fill="#16a34a"/>
  <text x="202" y="125" font-size="8" fill="#ffffff" font-weight="bold" text-anchor="middle">PUBLIC</text>

  <!-- ========== WORKER POD ========== -->
  <rect x="265" y="110" width="195" height="195" rx="8" fill="url(#workerGrad)" stroke="#d97706" stroke-width="2" filter="url(#shadow)"/>
  <text x="362" y="132" font-size="12" fill="#92400e" font-weight="bold" text-anchor="middle">Compute Worker</text>
  <text x="362" y="147" font-size="10" fill="#d97706" text-anchor="middle">Deployment (replicas: 1)</text>
  <!-- Worker container box -->
  <rect x="277" y="155" width="170" height="35" rx="6" fill="#fffbeb" stroke="#fbbf24" stroke-width="1"/>
  <text x="362" y="174" font-size="10" fill="#1e293b" font-weight="bold" text-anchor="middle">plumber + metasurvey</text>
  <text x="362" y="186" font-size="9" fill="#64748b" text-anchor="middle">:8788 (internal only)</text>
  <!-- Worker detail -->
  <text x="277" y="207" font-size="9" fill="#374151" font-weight="bold">POST /compute:</text>
  <text x="277" y="219" font-size="9" fill="#374151">1. Load microdata from volume</text>
  <text x="277" y="231" font-size="9" fill="#374151">2. Fetch recipe from MongoDB</text>
  <text x="277" y="243" font-size="9" fill="#374151">3. Apply recipes (bake_steps)</text>
  <text x="277" y="255" font-size="9" fill="#374151">4. Run workflow (svymean/svytotal)</text>
  <text x="277" y="267" font-size="9" fill="#374151">5. Return results to API</text>
  <!-- INTERNAL badge -->
  <rect x="395" y="113" width="58" height="16" rx="8" fill="#d97706"/>
  <text x="424" y="125" font-size="8" fill="#ffffff" font-weight="bold" text-anchor="middle">INTERNAL</text>

  <!-- ========== ARROW: API → Worker (POST /compute) ========== -->
  <line x1="235" y1="180" x2="265" y2="180" stroke="#d97706" stroke-width="2" marker-end="url(#arrowOrange)"/>
  <text x="237" y="173" font-size="8" fill="#d97706" font-weight="bold">POST /compute</text>

  <!-- ========== SHINY POD ========== -->
  <rect x="490" y="110" width="145" height="90" rx="8" fill="url(#shinyGrad)" stroke="#059669" stroke-width="2" filter="url(#shadow)"/>
  <text x="562" y="132" font-size="12" fill="#065f46" font-weight="bold" text-anchor="middle">Shiny Explorer</text>
  <text x="562" y="147" font-size="10" fill="#059669" text-anchor="middle">Deployment (1)</text>
  <rect x="500" y="155" width="125" height="35" rx="6" fill="#f0fdf4" stroke="#6ee7b7" stroke-width="1"/>
  <text x="562" y="174" font-size="11" fill="#1e293b" font-weight="bold" text-anchor="middle">shiny :3838</text>
  <text x="562" y="186" font-size="9" fill="#64748b" text-anchor="middle">Recipe browser UI</text>

  <!-- Arrow: Shiny → API (internal, dashed) -->
  <line x1="490" y1="155" x2="235" y2="155" stroke="#94a3b8" stroke-width="1" stroke-dasharray="4 3" marker-end="url(#arrowGray)"/>
  <text x="350" y="150" font-size="8" fill="#94a3b8" text-anchor="middle">internal</text>

  <!-- ========== INGRESS ========== -->
  <rect x="40" y="330" width="420" height="55" rx="8" fill="#dbeafe" stroke="#2563eb" stroke-width="2" filter="url(#shadow)"/>
  <text x="250" y="352" font-size="12" fill="#1e40af" font-weight="bold" text-anchor="middle">Ingress Controller</text>
  <text x="250" y="366" font-size="10" fill="#3b82f6" text-anchor="middle">(NGINX / ALB)</text>
  <text x="250" y="379" font-size="9" fill="#1e3a5f" text-anchor="middle">api.metasurvey.org &#8594; :8787  |  explorer.metasurvey.org &#8594; :3838</text>
  <!-- TLS badge -->
  <rect x="45" y="333" width="30" height="16" rx="8" fill="#16a34a"/>
  <text x="60" y="344" font-size="8" fill="#ffffff" font-weight="bold" text-anchor="middle">TLS</text>

  <!-- Arrows: Ingress → API and Ingress → Shiny -->
  <line x1="150" y1="330" x2="137" y2="305" stroke="#2563eb" stroke-width="2" marker-end="url(#arrowBlue)"/>
  <line x1="370" y1="330" x2="540" y2="200" stroke="#059669" stroke-width="2" marker-end="url(#arrowGreen)"/>

  <!-- HPA + ConfigMap + Secrets -->
  <rect x="490" y="335" width="90" height="20" rx="10" fill="#eef2ff" stroke="#a5b4fc" stroke-width="1"/>
  <text x="535" y="349" font-size="9" fill="#6366f1" font-weight="bold" text-anchor="middle">HPA auto-scale</text>
  <rect x="490" y="360" width="55" height="17" rx="8" fill="#f1f5f9" stroke="#94a3b8" stroke-width="1"/>
  <text x="517" y="372" font-size="8" fill="#64748b" text-anchor="middle">ConfigMap</text>
  <rect x="550" y="360" width="48" height="17" rx="8" fill="#f1f5f9" stroke="#94a3b8" stroke-width="1"/>
  <text x="574" y="372" font-size="8" fill="#64748b" text-anchor="middle">Secrets</text>

  <!-- ========== MANAGED SERVICES ========== -->

  <!-- MongoDB -->
  <rect x="680" y="55" width="195" height="145" rx="8" fill="#fef2f2" stroke="#dc2626" stroke-width="2" filter="url(#shadow)"/>
  <text x="777" y="78" font-size="13" fill="#991b1b" font-weight="bold" text-anchor="middle">MongoDB</text>
  <text x="777" y="93" font-size="9" fill="#dc2626" text-anchor="middle">DocumentDB / CosmosDB / Atlas / mongo:7</text>
  <text x="693" y="115" font-size="10" fill="#374151" font-weight="bold">Collections:</text>
  <text x="693" y="129" font-size="9" fill="#374151">&#8226; indicators &#8592; results + traceability</text>
  <text x="693" y="142" font-size="9" fill="#374151">&#8226; recipes &#8592; transformation steps</text>
  <text x="693" y="155" font-size="9" fill="#374151">&#8226; workflows &#8592; estimation calls</text>
  <text x="693" y="168" font-size="9" fill="#374151">&#8226; users</text>
  <text x="693" y="181" font-size="9" fill="#374151">&#8226; anda_variables</text>

  <!-- Arrow: K8s → MongoDB -->
  <line x1="645" y1="140" x2="680" y2="140" stroke="#dc2626" stroke-width="2" marker-end="url(#arrowRed)"/>

  <!-- Object Storage (Microdata) -->
  <rect x="680" y="220" width="195" height="100" rx="8" fill="#fefce8" stroke="#ca8a04" stroke-width="2" filter="url(#shadow)"/>
  <text x="777" y="243" font-size="13" fill="#854d0e" font-weight="bold" text-anchor="middle">Object Storage</text>
  <text x="777" y="258" font-size="9" fill="#ca8a04" text-anchor="middle">S3 / Blob Storage / GCS</text>
  <text x="693" y="278" font-size="9" fill="#374151">&#8226; Microdata files (.sav, .dta, .csv)</text>
  <text x="693" y="291" font-size="9" fill="#374151">&#8226; Mounted read-only on Worker</text>
  <text x="693" y="304" font-size="9" fill="#374151">&#8226; Encrypted, versioned</text>
  <!-- PRIVATE badge -->
  <rect x="822" y="223" width="48" height="16" rx="8" fill="#dc2626"/>
  <text x="846" y="234" font-size="8" fill="#ffffff" font-weight="bold" text-anchor="middle">PRIVATE</text>

  <!-- Arrow: Worker → Storage -->
  <line x1="460" y1="270" x2="680" y2="270" stroke="#ca8a04" stroke-width="2" marker-end="url(#arrowGold)"/>
  <text x="560" y="264" font-size="8" fill="#ca8a04" font-weight="bold">microdata volume (ro)</text>

  <!-- Redis (optional) -->
  <rect x="680" y="340" width="195" height="55" rx="8" fill="#f0fdf4" stroke="#16a34a" stroke-width="2" filter="url(#shadow)"/>
  <text x="777" y="363" font-size="12" fill="#166534" font-weight="bold" text-anchor="middle">Redis <tspan font-size="9" fill="#16a34a" font-weight="normal">(optional)</tspan></text>
  <text x="777" y="380" font-size="9" fill="#64748b" text-anchor="middle">ElastiCache / Memorystore / Azure Cache</text>

  <!-- Arrow: K8s → Redis (dashed) -->
  <line x1="645" y1="370" x2="680" y2="370" stroke="#16a34a" stroke-width="1" stroke-dasharray="4 3"/>

  <!-- ========== PUBLIC CONSUMERS ========== -->
  <rect x="25" y="470" width="460" height="115" rx="8" fill="#f8fafc" stroke="#94a3b8" stroke-width="2" stroke-dasharray="5 3"/>
  <text x="45" y="493" font-size="12" fill="#334155" font-weight="bold">Public Internet</text>

  <!-- Researchers -->
  <rect x="40" y="505" width="120" height="50" rx="8" fill="#ffffff" stroke="#6366f1" stroke-width="2" filter="url(#shadow)"/>
  <text x="100" y="527" font-size="11" fill="#1e293b" font-weight="bold" text-anchor="middle">Researchers</text>
  <text x="100" y="542" font-size="9" fill="#64748b" text-anchor="middle">R / Python / curl</text>

  <!-- Frontend -->
  <rect x="185" y="505" width="140" height="50" rx="8" fill="#ffffff" stroke="#6366f1" stroke-width="2" filter="url(#shadow)"/>
  <text x="255" y="527" font-size="11" fill="#1e293b" font-weight="bold" text-anchor="middle">Organization Site</text>
  <text x="255" y="542" font-size="9" fill="#64748b" text-anchor="middle">Angular / React / Vue</text>

  <!-- Journalists -->
  <rect x="350" y="505" width="120" height="50" rx="8" fill="#ffffff" stroke="#6366f1" stroke-width="2" filter="url(#shadow)"/>
  <text x="410" y="527" font-size="11" fill="#1e293b" font-weight="bold" text-anchor="middle">Journalists</text>
  <text x="410" y="542" font-size="9" fill="#64748b" text-anchor="middle">Data verification</text>

  <!-- Arrows: Consumers → Ingress -->
  <line x1="100" y1="505" x2="100" y2="385" stroke="#6366f1" stroke-width="2" marker-end="url(#arrowIndigo)"/>
  <line x1="255" y1="505" x2="255" y2="385" stroke="#6366f1" stroke-width="2" marker-end="url(#arrowIndigo)"/>
  <line x1="410" y1="505" x2="410" y2="385" stroke="#6366f1" stroke-width="2" marker-end="url(#arrowIndigo)"/>

  <!-- ========== TRANSPARENCY CHAIN ========== -->
  <rect x="680" y="440" width="400" height="365" rx="8" fill="url(#chainGrad)" stroke="#7c3aed" stroke-width="2" filter="url(#shadow)"/>
  <text x="880" y="465" font-size="14" fill="#5b21b6" font-weight="bold" text-anchor="middle">Transparency Chain</text>
  <!-- PUBLIC badge -->
  <rect x="1005" y="448" width="65" height="18" rx="9" fill="#16a34a"/>
  <text x="1037" y="461" font-size="8" fill="#ffffff" font-weight="bold" text-anchor="middle">PUBLIC</text>

  <!-- Indicator box -->
  <rect x="700" y="480" width="160" height="115" rx="8" fill="#ede9fe" stroke="#7c3aed" stroke-width="2"/>
  <text x="715" y="500" font-size="12" fill="#5b21b6" font-weight="bold">Indicator</text>
  <text x="715" y="516" font-size="9" fill="#7c3aed">GET /indicators/:id</text>
  <text x="715" y="536" font-size="10" fill="#374151">value: <tspan font-weight="bold">0.082</tspan></text>
  <text x="715" y="550" font-size="10" fill="#374151">se: 0.003</text>
  <text x="715" y="564" font-size="10" fill="#374151">cv: 0.037</text>
  <text x="715" y="578" font-size="10" fill="#374151">CI: [0.076, 0.088]</text>
  <!-- "the number" label -->
  <text x="870" y="530" font-size="10" fill="#7c3aed" font-weight="bold">the number</text>

  <!-- Workflow box -->
  <rect x="700" y="625" width="170" height="115" rx="8" fill="#dbeafe" stroke="#2563eb" stroke-width="2"/>
  <text x="715" y="645" font-size="12" fill="#1e40af" font-weight="bold">Workflow</text>
  <text x="715" y="661" font-size="9" fill="#2563eb">GET /indicators/:id/workflow</text>
  <text x="715" y="681" font-size="10" fill="#374151">svymean(~pd, design)</text>
  <text x="715" y="695" font-size="10" fill="#374151">estimation: annual</text>
  <text x="715" y="709" font-size="10" fill="#374151">design: svydesign</text>
  <text x="715" y="723" font-size="10" fill="#374151">recipe_ids: [ech_emp_001]</text>

  <!-- Recipe box -->
  <rect x="900" y="625" width="165" height="115" rx="8" fill="#ecfdf5" stroke="#059669" stroke-width="2"/>
  <text x="915" y="645" font-size="12" fill="#065f46" font-weight="bold">Recipe</text>
  <text x="915" y="661" font-size="9" fill="#059669">GET /indicators/:id/recipe</text>
  <text x="915" y="681" font-size="10" fill="#374151">step_compute(pd = ...)</text>
  <text x="915" y="695" font-size="10" fill="#374151">step_recode(pea, ...)</text>
  <text x="915" y="709" font-size="10" fill="#374151">depends_on: [e27, f66]</text>
  <text x="915" y="723" font-size="10" fill="#374151">output: [po, pd, pea]</text>

  <!-- Arrow: Indicator → Workflow -->
  <line x1="780" y1="595" x2="780" y2="625" stroke="#4f46e5" stroke-width="2" marker-end="url(#arrowPurple)"/>
  <text x="790" y="615" font-size="9" fill="#4f46e5" font-weight="bold">how was it estimated?</text>

  <!-- Arrow: Workflow → Recipe -->
  <line x1="870" y1="682" x2="900" y2="682" stroke="#059669" stroke-width="2" marker-end="url(#arrowGreen)"/>
  <text x="870" y="670" font-size="9" fill="#059669" font-weight="bold" transform="rotate(-90, 888, 670)">how were variables built?</text>

  <!-- ========== DEPLOYMENT OPTIONS ========== -->
  <rect x="910" y="55" width="170" height="145" rx="8" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/>
  <text x="995" y="78" font-size="11" fill="#334155" font-weight="bold" text-anchor="middle">Deployment Options</text>
  <text x="925" y="100" font-size="10" fill="#374151" font-weight="bold">Local:</text>
  <text x="935" y="115" font-size="10" fill="#374151">docker compose</text>
  <text x="935" y="130" font-size="10" fill="#374151">minikube</text>
  <text x="925" y="150" font-size="10" fill="#374151" font-weight="bold">Cloud:</text>
  <text x="935" y="165" font-size="10" fill="#374151">AWS EKS + DocumentDB</text>
  <text x="935" y="180" font-size="10" fill="#374151">Azure AKS + CosmosDB</text>
  <text x="935" y="195" font-size="10" fill="#374151">GCP GKE + Atlas</text>

  <!-- ========== BRANDING ========== -->
  <text x="550" y="800" font-size="11" fill="#6366f1" font-weight="bold" text-anchor="middle">metasurvey</text>
  <text x="690" y="800" font-size="10" fill="#94a3b8" text-anchor="middle">|  Self-Hosting Infrastructure  |  github.com/metasurveyr/metasurvey</text>
</svg>
