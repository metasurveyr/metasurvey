---
title: "Interactive Recipe Explorer"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Interactive Recipe Explorer}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

## Overview

metasurvey includes a Shiny web application for browsing, searching, and
managing recipes and workflows interactively. The app connects to the
metasurvey API to display community-contributed recipes, or works in
offline mode with built-in example data.

## Launching the App

```{r launch}
library(metasurvey)

# Open in your default browser
explore_recipes()

# Or specify host and port
explore_recipes(port = 3838, host = "127.0.0.1")
```

The `explore_recipes()` function starts the Shiny app and opens it in
your browser. No additional configuration is needed---the app connects
to the production API automatically.

## Navigating the Interface

The app has three main tabs in the top navigation bar:

### Recipes Tab

The **Recipes** tab is the main entry point. It shows a searchable grid
of published recipes, each displayed as a card with:

- **Name and edition** metadata
- **Description** (truncated to two lines)
- **Category tags** with colored badges (Labor Market, Income,
  Education, Health, Demographics, Housing)
- **Certification level** indicated by the card header color:
  - Indigo = Official
  - Emerald = Reviewed
  - Slate = Community
- **Download count** and a "View" button

#### Searching and Filtering

The top of the Recipes tab provides four filters:

| Filter | Options | Purpose |
|--------|---------|---------|
| Search | Free text | Matches recipe name and description |
| Survey type | ECH, EAII, EPH, EAI | Filter by survey |
| Category | Labor Market, Income, Education, Health, Demographics, Housing | Filter by topic |
| Certification | Official, Reviewed, Community | Filter by trust level |

Filters are applied client-side for instant results. Use the refresh
button to reload data from the API.

#### Statistics Row

Below the filters, three stat boxes summarize the current data:

- **Total recipes** in the registry
- **Official recipes** with institutional certification
- **Total downloads** across all recipes

#### Recipe Detail Modal

Click "View" on any recipe card to open a detail modal showing:

1. **Metadata**: name, description, edition, survey type
2. **Author info**: creator name, institution, trust level
3. **Input variables**: what the recipe expects in the survey data
   (shown as chips)
4. **Output variables**: what the recipe creates (shown as chips)
5. **Pipeline visualization**: interactive step graph (if the
   `visNetwork` package is installed)
6. **Dependent recipes**: other recipes this one depends on (clickable
   for navigation)
7. **Referencing workflows**: workflows that use this recipe (clickable
   to jump to the Workflows tab)
8. **ANDA metadata**: variable labels from the INE data catalog, when
   available (unofficial integration -- verify against official codebook)

### Workflows Tab

The **Workflows** tab shows published estimation workflows. Each workflow
card displays the estimation type (Annual, Quarterly, Monthly) and the
recipes it references.

Workflows use the same search and filter interface as recipes. The detail
modal shows:

- All estimation calls (`svymean`, `svytotal`, `svyratio`, `svyby`)
  displayed as a visual timeline
- Cross-references to the recipes used for data preparation
- Click on a referenced recipe to navigate directly to its detail

### Cross-Navigation

Recipes and workflows are linked bidirectionally:

- From a **recipe detail**, click on a referencing workflow to jump to
  the Workflows tab and open that workflow's detail
- From a **workflow detail**, click on a referenced recipe to jump back
  to the Recipes tab and open that recipe's detail

This lets you trace the full analysis pipeline: from data
transformation (recipe) to estimation (workflow).

### Profile Tab

The Profile tab changes depending on your authentication state:

**Before login**: shows a login/register form with two sub-tabs:

- **Login**: email and password
- **Register**: name, email, password, account type (Individual,
  Institutional Member, or Institution)

**After login**: shows your profile with:

- Name, account type, trust level, email, and institution
- **My Recipes** button to view your published recipes
- **API Token** section to generate a long-lived token for scripting
- **Logout** button

#### Generating an API Token

From the Profile tab, click "Generate API Token" to create a 90-day
token for use in R scripts:

```{r token}
# Use the token generated from the app
Sys.setenv(METASURVEY_TOKEN = "your-token-here")

# Now API calls work without interactive login
recipes <- api_list_recipes(survey_type = "ech")
```

This is useful for automated scripts and CI/CD pipelines.

#### Admin Panel

If your account has admin privileges, an additional panel appears for
reviewing institutional account requests. Admins can approve or reject
pending registrations.

## Offline Mode

If the API is unreachable, the app automatically switches to offline
mode using built-in example data. This includes 13 sample recipes and 6
sample workflows covering common ECH use cases:

- Labor market indicators
- Income distribution and poverty
- Education and health coverage
- Demographics and housing
- Innovation indicators (EAII)

Offline mode is useful for demonstrations and for exploring the interface
without network access.

## Docker Deployment

For production or team-internal deployment, the app includes a
Dockerfile:

```bash
# Build the image
docker build -t metasurvey-shiny inst/shiny/

# Run on port 3838
docker run -p 3838:3838 \
  -e METASURVEY_API_URL="https://metasurvey-api-production.up.railway.app" \
  metasurvey-shiny
```

The `METASURVEY_API_URL` environment variable configures which API the
app connects to. This can point to a self-hosted instance.

## Next Steps

- **[API and Database Reference](api-database.html)** -- Technical
  details on API endpoints and MongoDB schema
- **[Creating and Sharing Recipes](recipes.html)** -- Build recipes
  programmatically and publish them
- **[Estimation Workflows](workflows-and-estimation.html)** -- Compute
  survey-weighted estimates with `workflow()`
