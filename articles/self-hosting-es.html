<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Guia de Self-Hosting (ES) • metasurvey</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Guia de Self-Hosting (ES)">
<!-- javascript assets for rmarkdown --><meta name="pkgdown-site-root" content="../">
<script src="../ace-1.2.3/ace.js" type="text/javascript" charset="utf-8"></script><script src="../holder-2.9.0/holder.min.js" type="text/javascript" charset="utf-8"></script><script src="../snippets/snippets.js" type="text/javascript" charset="utf-8"></script><style type="text/css">
.snippet {
  border: solid 1px #cccccc;
  margin-bottom: 12px;
  width: 100%;
}
</style>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">metasurvey</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.21</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/metasurveyr/metasurvey/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Guia de Self-Hosting (ES)</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/metasurveyr/metasurvey/blob/develop/vignettes/self-hosting-es.Rmd" class="external-link"><code>vignettes/self-hosting-es.Rmd</code></a></small>
      <div class="d-none name"><code>self-hosting-es.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="descripcion-general">Descripcion general<a class="anchor" aria-label="anchor" href="#descripcion-general"></a>
</h2>
<p>Muchas organizaciones publican indicadores estadisticos derivados de
encuestas (tasas de desempleo, pobreza, innovacion) sin mostrar como
fueron calculados. El numero final es publico, pero la metodologia – que
variables se usaron, que transformaciones se aplicaron, que diseno
muestral se uso – queda oculta.</p>
<p>metasurvey resuelve esto <strong>separando los datos privados de la
metodologia publica</strong>. Se despliega la API de metasurvey en tu
propia infraestructura donde:</p>
<ul>
<li>
<strong>Los microdatos son privados</strong>: los archivos de la
encuesta nunca salen de tu red.</li>
<li>
<strong>Los indicadores son publicos</strong>: los resultados
(estimaciones puntuales, errores estandar, intervalos de confianza) se
sirven via la API.</li>
<li>
<strong>La metodologia es transparente</strong>: cualquiera puede
consultar la receta (pasos de transformacion) y el workflow (llamadas de
estimacion y diseno muestral) que produjo cada indicador.</li>
</ul>
<p>La cadena de trazabilidad es:</p>
<pre class="text"><code>Indicador                 Workflow                      Receta
(el numero)        --&gt;    (como se estimo)          --&gt; (como se construyeron las variables)
value: 0.082              svymean(~pd, design)          step_compute(svy, pd = ...)
se: 0.003                 estimation_type: annual       step_recode(svy, pea, ...)
cv: 0.037                 recipe_ids: [ech_emp_001]     depends_on: [e27, f66, ...]</code></pre>
</div>
<div class="section level2">
<h2 id="arquitectura">Arquitectura<a class="anchor" aria-label="anchor" href="#arquitectura"></a>
</h2>
<p>El sistema tiene <strong>dos servicios R</strong>: una API publica
que sirve indicadores y su trazabilidad, y un <strong>Worker</strong>
privado que tiene metasurvey instalado y acceso a los microdatos. El
worker es el unico componente que toca los datos crudos de la
encuesta.</p>
<div class="figure">
<img src="metasurvey-infrastructure.png" class="r-plt" alt="Infraestructura de self-hosting de metasurvey" width="100%"><p class="caption">
Infraestructura de self-hosting de metasurvey
</p>
</div>
<p><strong>Separacion clave</strong>: El Worker carga los microdatos,
busca las recetas en MongoDB, las aplica (<code>bake_steps</code>),
ejecuta la estimacion (<code>workflow</code>), y publica el resultado en
la API. La API publica nunca toca los microdatos – solo sirve
indicadores pre-computados y su trazabilidad.</p>
<p>El frontend tambien puede solicitar <strong>estimaciones bajo
demanda</strong> con filtros (ej., “tasa de desempleo para mujeres en
Montevideo”) via <code>POST /indicators/compute</code>, que la API
delega al Worker.</p>
</div>
<div class="section level2">
<h2 id="inicio-rapido-con-docker-compose">Inicio rapido con Docker Compose<a class="anchor" aria-label="anchor" href="#inicio-rapido-con-docker-compose"></a>
</h2>
<p>El repositorio incluye un <code>docker-compose.yml</code> que levanta
MongoDB, la API plumber y el explorador Shiny de recetas. No se necesita
base de datos externa.</p>
<div class="section level3">
<h3 id="clonar-y-configurar">1. Clonar y configurar<a class="anchor" aria-label="anchor" href="#clonar-y-configurar"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/metasurveyr/metasurvey.git</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="bu">cd</span> metasurvey</span></code></pre></div>
<p>Crear un archivo <code>.env</code> (o usar los valores por defecto
para desarrollo):</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># .env</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="va">MONGO_USER</span><span class="op">=</span>metasurvey</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="va">MONGO_PASSWORD</span><span class="op">=</span>cambiar-en-produccion</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="va">METASURVEY_JWT_SECRET</span><span class="op">=</span>cambiar-en-produccion</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="va">METASURVEY_ADMIN_EMAIL</span><span class="op">=</span>admin@example.com</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="levantar-el-stack">2. Levantar el stack<a class="anchor" aria-label="anchor" href="#levantar-el-stack"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="ex">docker</span> compose up <span class="at">--build</span></span></code></pre></div>
<p>Esto inicia cuatro servicios:</p>
<table class="table">
<thead><tr class="header">
<th>Servicio</th>
<th>URL</th>
<th>Descripcion</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>mongo</code></td>
<td><code>localhost:27017</code></td>
<td>MongoDB 7 con volumen persistente</td>
</tr>
<tr class="even">
<td><code>worker</code></td>
<td><code>localhost:8788</code></td>
<td>Worker de computo (solo interno)</td>
</tr>
<tr class="odd">
<td><code>api</code></td>
<td><code>http://localhost:8787</code></td>
<td>API REST plumber</td>
</tr>
<tr class="even">
<td><code>shiny</code></td>
<td><code>http://localhost:3838</code></td>
<td>Explorador de recetas</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="inicializar-la-base-de-datos">3. Inicializar la base de datos<a class="anchor" aria-label="anchor" href="#inicializar-la-base-de-datos"></a>
</h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># Crear colecciones e indices</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="ex">docker</span> compose exec mongo mongosh <span class="dt">\</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>  <span class="at">-u</span> metasurvey <span class="at">-p</span> cambiar-en-produccion <span class="dt">\</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>  <span class="at">--authenticationDatabase</span> admin <span class="dt">\</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>  metasurvey /dev/stdin <span class="op">&lt;</span> inst/scripts/setup_mongodb.js</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="co"># Cargar recetas, workflows e indicadores de ejemplo</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="ex">docker</span> compose exec api Rscript <span class="at">-e</span> <span class="st">'</span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a><span class="st">  Sys.setenv(</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a><span class="st">    METASURVEY_MONGO_URI = "mongodb://metasurvey:cambiar-en-produccion@mongo:27017/?authSource=admin"</span></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a><span class="st">  )</span></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a><span class="st">  source("/app/seed_ech_recipes.R")</span></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a><span class="st">'</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="verificar">4. Verificar<a class="anchor" aria-label="anchor" href="#verificar"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="ex">curl</span> http://localhost:8787/health</span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>  <span class="dt">"status"</span><span class="fu">:</span> <span class="st">"ok"</span><span class="fu">,</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>  <span class="dt">"service"</span><span class="fu">:</span> <span class="st">"metasurvey-api"</span><span class="fu">,</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>  <span class="dt">"mongodb"</span><span class="fu">:</span> <span class="st">"connected"</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="calcular-y-publicar-indicadores">Calcular y publicar indicadores<a class="anchor" aria-label="anchor" href="#calcular-y-publicar-indicadores"></a>
</h2>
<p>El flujo tipico: cargar datos de la encuesta, aplicar una receta,
ejecutar un workflow y publicar el resultado como indicador con
trazabilidad completa.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://metasurveyr.github.io/metasurvey/">metasurvey</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 1. Cargar datos de la encuesta (privado -- se queda en tu servidor)</span></span>
<span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/Survey.html">Survey</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">my_survey_data</span>,</span>
<span>  edition <span class="op">=</span> <span class="st">"2024"</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"ech"</span>,</span>
<span>  engine <span class="op">=</span> <span class="st">"data.table"</span>,</span>
<span>  weight <span class="op">=</span> <span class="fu"><a href="../reference/add_weight.html">add_weight</a></span><span class="op">(</span>annual <span class="op">=</span> <span class="st">"W_ANO"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Aplicar una receta (define variables como estado de desempleo)</span></span>
<span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/step_compute.html">step_compute</a></span><span class="op">(</span><span class="va">svy</span>,</span>
<span>  pd <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/fcase.html" class="external-link">fcase</a></span><span class="op">(</span></span>
<span>    <span class="va">pobpcoac</span> <span class="op">==</span> <span class="fl">2</span>, <span class="fl">1L</span>,</span>
<span>    <span class="va">pobpcoac</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fl">0L</span></span>
<span>  <span class="op">)</span>,</span>
<span>  comment <span class="op">=</span> <span class="st">"Desocupado: POBPCOAC == 2"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bake_steps.html">bake_steps</a></span><span class="op">(</span><span class="va">svy</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Ejecutar la estimacion (workflow)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/workflow.html">workflow</a></span><span class="op">(</span></span>
<span>  svy <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">svy</span><span class="op">)</span>,</span>
<span>  <span class="fu">survey</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svymean</a></span><span class="op">(</span><span class="op">~</span><span class="va">pd</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  estimation_type <span class="op">=</span> <span class="st">"annual"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># result es un data.table:</span></span>
<span><span class="co">#       stat      value     se     cv</span></span>
<span><span class="co"># svymean: pd    0.082  0.003  0.037</span></span></code></pre></div>
<p>Publicar el indicador en la API:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Conectar a la API local</span></span>
<span><span class="fu"><a href="../reference/configure_api.html">configure_api</a></span><span class="op">(</span><span class="st">"http://localhost:8787"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/api_login.html">api_login</a></span><span class="op">(</span><span class="st">"admin@example.com"</span>, <span class="st">"tu-password"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Construir el payload del indicador</span></span>
<span><span class="va">indicator</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="st">"Tasa de desempleo 2024"</span>,</span>
<span>  description <span class="op">=</span> <span class="st">"Tasa de desempleo anual, poblacion de 14 y mas"</span>,</span>
<span>  recipe_id <span class="op">=</span> <span class="st">"ech_employment_001"</span>,</span>
<span>  workflow_id <span class="op">=</span> <span class="st">"ech_wf_labor"</span>,</span>
<span>  survey_type <span class="op">=</span> <span class="st">"ech"</span>,</span>
<span>  edition <span class="op">=</span> <span class="st">"2024"</span>,</span>
<span>  estimation_type <span class="op">=</span> <span class="st">"annual"</span>,</span>
<span>  stat <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">stat</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>  value <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">value</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>  se <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">se</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>  cv <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">cv</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>  confint_lower <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">confint_lower</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>  confint_upper <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">confint_upper</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>  metadata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> <span class="st">"~pd"</span>,</span>
<span>    estimation_function <span class="op">=</span> <span class="st">"svymean"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Publicar (requiere autenticacion)</span></span>
<span><span class="va">resp</span> <span class="op">&lt;-</span> <span class="fu">httr2</span><span class="fu">::</span><span class="fu"><a href="https://httr2.r-lib.org/reference/request.html" class="external-link">request</a></span><span class="op">(</span><span class="st">"http://localhost:8787/indicators"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">httr2</span><span class="fu">::</span><span class="fu"><a href="https://httr2.r-lib.org/reference/req_headers.html" class="external-link">req_headers</a></span><span class="op">(</span></span>
<span>    Authorization <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Bearer"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"METASURVEY_TOKEN"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">httr2</span><span class="fu">::</span><span class="fu"><a href="https://httr2.r-lib.org/reference/req_body.html" class="external-link">req_body_json</a></span><span class="op">(</span><span class="va">indicator</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">httr2</span><span class="fu">::</span><span class="fu"><a href="https://httr2.r-lib.org/reference/req_perform.html" class="external-link">req_perform</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">httr2</span><span class="fu">::</span><span class="fu"><a href="https://httr2.r-lib.org/reference/resp_body_raw.html" class="external-link">resp_body_json</a></span><span class="op">(</span><span class="va">resp</span><span class="op">)</span></span>
<span><span class="co"># {ok: true, id: "ind_1708099200_42"}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="consumir-indicadores-transparencia">Consumir indicadores (transparencia)<a class="anchor" aria-label="anchor" href="#consumir-indicadores-transparencia"></a>
</h2>
<p>Una vez publicados, los indicadores y su metodologia completa son
accesibles <strong>sin autenticacion</strong>. Esta es la capa de
transparencia.</p>
<div class="section level3">
<h3 id="obtener-el-valor-del-indicador">Obtener el valor del indicador<a class="anchor" aria-label="anchor" href="#obtener-el-valor-del-indicador"></a>
</h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="ex">curl</span> http://localhost:8787/indicators/ind_ech_unemployment_2024</span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>  <span class="dt">"ok"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>  <span class="dt">"indicator"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>    <span class="dt">"id"</span><span class="fu">:</span> <span class="st">"ind_ech_unemployment_2024"</span><span class="fu">,</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>    <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Tasa de desempleo 2024"</span><span class="fu">,</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>    <span class="dt">"value"</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.082</span><span class="fu">,</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>    <span class="dt">"se"</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.003</span><span class="fu">,</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>    <span class="dt">"cv"</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.037</span><span class="fu">,</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>    <span class="dt">"confint_lower"</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.076</span><span class="fu">,</span></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>    <span class="dt">"confint_upper"</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.088</span><span class="fu">,</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>    <span class="dt">"survey_type"</span><span class="fu">:</span> <span class="st">"ech"</span><span class="fu">,</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>    <span class="dt">"edition"</span><span class="fu">:</span> <span class="st">"2024"</span><span class="fu">,</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>    <span class="dt">"recipe_id"</span><span class="fu">:</span> <span class="st">"ech_employment_001"</span><span class="fu">,</span></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>    <span class="dt">"workflow_id"</span><span class="fu">:</span> <span class="st">"ech_wf_labor"</span></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="obtener-el-workflow-como-se-estimo">Obtener el workflow (como se estimo)<a class="anchor" aria-label="anchor" href="#obtener-el-workflow-como-se-estimo"></a>
</h3>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="ex">curl</span> http://localhost:8787/indicators/ind_ech_unemployment_2024/workflow</span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>  <span class="dt">"ok"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>  <span class="dt">"indicator_id"</span><span class="fu">:</span> <span class="st">"ind_ech_unemployment_2024"</span><span class="fu">,</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>  <span class="dt">"workflow"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>    <span class="dt">"id"</span><span class="fu">:</span> <span class="st">"ech_wf_labor"</span><span class="fu">,</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>    <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Mercado Laboral ECH"</span><span class="fu">,</span></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>    <span class="dt">"estimation_type"</span><span class="fu">:</span> <span class="st">"annual"</span><span class="fu">,</span></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>    <span class="dt">"recipe_ids"</span><span class="fu">:</span> <span class="ot">[</span><span class="st">"ech_pobpcoac_000"</span><span class="ot">,</span> <span class="st">"ech_employment_001"</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>    <span class="dt">"calls"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>      <span class="st">"svymean(~pea, design, na.rm=TRUE)"</span><span class="ot">,</span></span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>      <span class="st">"svymean(~po, design, na.rm=TRUE)"</span><span class="ot">,</span></span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>      <span class="st">"svymean(~pd, design, na.rm=TRUE)"</span></span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>    <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a>    <span class="dt">"call_metadata"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a>      <span class="fu">{</span></span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a>        <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"svymean"</span><span class="fu">,</span></span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a>        <span class="dt">"formula"</span><span class="fu">:</span> <span class="st">"~pea"</span><span class="fu">,</span></span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a>        <span class="dt">"description"</span><span class="fu">:</span> <span class="st">"Tasa de actividad"</span></span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a>      <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a>      <span class="fu">{</span></span>
<span id="cb13-21"><a href="#cb13-21" tabindex="-1"></a>        <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"svymean"</span><span class="fu">,</span></span>
<span id="cb13-22"><a href="#cb13-22" tabindex="-1"></a>        <span class="dt">"formula"</span><span class="fu">:</span> <span class="st">"~pd"</span><span class="fu">,</span></span>
<span id="cb13-23"><a href="#cb13-23" tabindex="-1"></a>        <span class="dt">"description"</span><span class="fu">:</span> <span class="st">"Tasa de desempleo"</span></span>
<span id="cb13-24"><a href="#cb13-24" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb13-25"><a href="#cb13-25" tabindex="-1"></a>    <span class="ot">]</span></span>
<span id="cb13-26"><a href="#cb13-26" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb13-27"><a href="#cb13-27" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>El workflow indica <strong>que funcion estadistica se uso</strong>
(<code>svymean</code>), <strong>que formula</strong> (<code>~pd</code>),
y <strong>que recetas</strong> se aplicaron a los datos antes de la
estimacion.</p>
</div>
<div class="section level3">
<h3 id="obtener-la-receta-como-se-construyeron-las-variables">Obtener la receta (como se construyeron las variables)<a class="anchor" aria-label="anchor" href="#obtener-la-receta-como-se-construyeron-las-variables"></a>
</h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="ex">curl</span> http://localhost:8787/indicators/ind_ech_unemployment_2024/recipe</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>  <span class="dt">"ok"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>  <span class="dt">"indicator_id"</span><span class="fu">:</span> <span class="st">"ind_ech_unemployment_2024"</span><span class="fu">,</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>  <span class="dt">"recipe"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>    <span class="dt">"id"</span><span class="fu">:</span> <span class="st">"ech_employment_001"</span><span class="fu">,</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>    <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Employment Status"</span><span class="fu">,</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>    <span class="dt">"steps"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>      <span class="st">"step_compute(svy, po = fcase(pobpcoac == 1, 1L, TRUE, 0L), comment = 'Employed')"</span><span class="ot">,</span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>      <span class="st">"step_compute(svy, pd = fcase(pobpcoac == 2, 1L, TRUE, 0L), comment = 'Unemployed')"</span><span class="ot">,</span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>      <span class="st">"step_compute(svy, pea = fcase(pobpcoac %in% 1:2, 1L, TRUE, 0L), comment = 'EAP')"</span></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>    <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>    <span class="dt">"depends_on"</span><span class="fu">:</span> <span class="ot">[</span><span class="st">"pobpcoac"</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>    <span class="dt">"doc"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>      <span class="dt">"input_variables"</span><span class="fu">:</span> <span class="ot">[</span><span class="st">"pobpcoac"</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a>      <span class="dt">"output_variables"</span><span class="fu">:</span> <span class="ot">[</span><span class="st">"po"</span><span class="ot">,</span> <span class="st">"pd"</span><span class="ot">,</span> <span class="st">"pea"</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a>      <span class="dt">"pipeline"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a>        <span class="fu">{</span><span class="dt">"step"</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"compute"</span><span class="fu">,</span> <span class="dt">"outputs"</span><span class="fu">:</span> <span class="ot">[</span><span class="st">"po"</span><span class="ot">]</span><span class="fu">}</span><span class="ot">,</span></span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a>        <span class="fu">{</span><span class="dt">"step"</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"compute"</span><span class="fu">,</span> <span class="dt">"outputs"</span><span class="fu">:</span> <span class="ot">[</span><span class="st">"pd"</span><span class="ot">]</span><span class="fu">}</span><span class="ot">,</span></span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a>        <span class="fu">{</span><span class="dt">"step"</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"compute"</span><span class="fu">,</span> <span class="dt">"outputs"</span><span class="fu">:</span> <span class="ot">[</span><span class="st">"pea"</span><span class="ot">]</span><span class="fu">}</span></span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a>      <span class="ot">]</span></span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>La receta muestra <strong>exactamente como se construyo cada
variable</strong> a partir de las variables originales de la encuesta.
Combinada con el workflow, cualquiera puede verificar la cadena completa
de calculo sin acceder a los microdatos.</p>
</div>
</div>
<div class="section level2">
<h2 id="referencia-de-la-api-de-indicadores">Referencia de la API de indicadores<a class="anchor" aria-label="anchor" href="#referencia-de-la-api-de-indicadores"></a>
</h2>
<table class="table">
<colgroup>
<col width="21%">
<col width="27%">
<col width="16%">
<col width="35%">
</colgroup>
<thead><tr class="header">
<th>Metodo</th>
<th>Endpoint</th>
<th>Auth</th>
<th>Descripcion</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>GET</code></td>
<td><code>/indicators</code></td>
<td>No</td>
<td>Listar y buscar indicadores publicados</td>
</tr>
<tr class="even">
<td><code>GET</code></td>
<td><code>/indicators/:id</code></td>
<td>No</td>
<td>Obtener un indicador con metadatos</td>
</tr>
<tr class="odd">
<td><code>GET</code></td>
<td><code>/indicators/:id/recipe</code></td>
<td>No</td>
<td>Obtener la receta que construyo las variables</td>
</tr>
<tr class="even">
<td><code>GET</code></td>
<td><code>/indicators/:id/workflow</code></td>
<td>No</td>
<td>Obtener el workflow (estimacion + diseno)</td>
</tr>
<tr class="odd">
<td><code>POST</code></td>
<td><code>/indicators</code></td>
<td>Si</td>
<td>Publicar un indicador computado</td>
</tr>
<tr class="even">
<td><code>POST</code></td>
<td><code>/indicators/compute</code></td>
<td>Si</td>
<td>Estimar bajo demanda via el Worker (con filtros)</td>
</tr>
</tbody>
</table>
<div class="section level3">
<h3 id="parametros-de-consulta-para-get-indicators">Parametros de consulta para <code>GET /indicators</code><a class="anchor" aria-label="anchor" href="#parametros-de-consulta-para-get-indicators"></a>
</h3>
<table class="table">
<thead><tr class="header">
<th>Parametro</th>
<th>Tipo</th>
<th>Descripcion</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>search</code></td>
<td>string</td>
<td>Busqueda regex sobre el nombre del indicador</td>
</tr>
<tr class="even">
<td><code>survey_type</code></td>
<td>string</td>
<td>Filtrar por tipo de encuesta</td>
</tr>
<tr class="odd">
<td><code>recipe_id</code></td>
<td>string</td>
<td>Filtrar por ID de receta</td>
</tr>
<tr class="even">
<td><code>workflow_id</code></td>
<td>string</td>
<td>Filtrar por ID de workflow</td>
</tr>
<tr class="odd">
<td><code>edition</code></td>
<td>string</td>
<td>Filtrar por edicion de la encuesta</td>
</tr>
<tr class="even">
<td><code>limit</code></td>
<td>integer</td>
<td>Resultados maximos (por defecto 50)</td>
</tr>
<tr class="odd">
<td><code>offset</code></td>
<td>integer</td>
<td>Omitir N resultados (por defecto 0)</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="campos-del-documento-indicador">Campos del documento indicador<a class="anchor" aria-label="anchor" href="#campos-del-documento-indicador"></a>
</h3>
<table class="table">
<colgroup>
<col width="18%">
<col width="16%">
<col width="29%">
<col width="35%">
</colgroup>
<thead><tr class="header">
<th>Campo</th>
<th>Tipo</th>
<th>Requerido</th>
<th>Descripcion</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>id</code></td>
<td>string</td>
<td>Auto</td>
<td>Identificador unico</td>
</tr>
<tr class="even">
<td><code>name</code></td>
<td>string</td>
<td>Si</td>
<td>Nombre del indicador</td>
</tr>
<tr class="odd">
<td><code>workflow_id</code></td>
<td>string</td>
<td>Si</td>
<td>Workflow que lo produjo</td>
</tr>
<tr class="even">
<td><code>value</code></td>
<td>number</td>
<td>Si</td>
<td>Estimacion puntual</td>
</tr>
<tr class="odd">
<td><code>recipe_id</code></td>
<td>string</td>
<td>No</td>
<td>Receta que construyo las variables</td>
</tr>
<tr class="even">
<td><code>description</code></td>
<td>string</td>
<td>No</td>
<td>Descripcion legible</td>
</tr>
<tr class="odd">
<td><code>survey_type</code></td>
<td>string</td>
<td>No</td>
<td>Tipo de encuesta</td>
</tr>
<tr class="even">
<td><code>edition</code></td>
<td>string</td>
<td>No</td>
<td>Edicion de la encuesta</td>
</tr>
<tr class="odd">
<td><code>estimation_type</code></td>
<td>string</td>
<td>No</td>
<td>
<code>annual</code>, <code>quarterly</code>,
<code>monthly</code>
</td>
</tr>
<tr class="even">
<td><code>stat</code></td>
<td>string</td>
<td>No</td>
<td>Etiqueta del estadistico (ej., <code>svymean: pd</code>)</td>
</tr>
<tr class="odd">
<td><code>se</code></td>
<td>number</td>
<td>No</td>
<td>Error estandar</td>
</tr>
<tr class="even">
<td><code>cv</code></td>
<td>number</td>
<td>No</td>
<td>Coeficiente de variacion</td>
</tr>
<tr class="odd">
<td><code>confint_lower</code></td>
<td>number</td>
<td>No</td>
<td>Limite inferior del intervalo de confianza</td>
</tr>
<tr class="even">
<td><code>confint_upper</code></td>
<td>number</td>
<td>No</td>
<td>Limite superior del intervalo de confianza</td>
</tr>
<tr class="odd">
<td><code>metadata</code></td>
<td>object</td>
<td>No</td>
<td>Contexto adicional (formula, notas)</td>
</tr>
<tr class="even">
<td><code>published_at</code></td>
<td>string</td>
<td>Auto</td>
<td>Marca de tiempo ISO</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="despliegue-con-minikube">Despliegue con Minikube<a class="anchor" aria-label="anchor" href="#despliegue-con-minikube"></a>
</h2>
<p>Para despliegue local basado en Kubernetes, se puede usar <a href="https://minikube.sigs.k8s.io/" class="external-link">Minikube</a>.</p>
<div class="section level3">
<h3 id="iniciar-minikube">Iniciar Minikube<a class="anchor" aria-label="anchor" href="#iniciar-minikube"></a>
</h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="ex">minikube</span> start</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="deployment-de-mongodb">Deployment de MongoDB<a class="anchor" aria-label="anchor" href="#deployment-de-mongodb"></a>
</h3>
<div class="sourceCode" id="cb17"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="co"># k8s/mongo.yaml</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-mongo</span></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> metasurvey</span></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-mongo</span></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-mongo</span></span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> mongo</span></span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a><span class="at">          </span><span class="fu">image</span><span class="kw">:</span><span class="at"> mongo:7</span></span>
<span id="cb17-20"><a href="#cb17-20" tabindex="-1"></a><span class="at">          </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb17-21"><a href="#cb17-21" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">27017</span></span>
<span id="cb17-22"><a href="#cb17-22" tabindex="-1"></a><span class="at">          </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb17-23"><a href="#cb17-23" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> MONGO_INITDB_ROOT_USERNAME</span></span>
<span id="cb17-24"><a href="#cb17-24" tabindex="-1"></a><span class="at">              </span><span class="fu">value</span><span class="kw">:</span><span class="at"> metasurvey</span></span>
<span id="cb17-25"><a href="#cb17-25" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> MONGO_INITDB_ROOT_PASSWORD</span></span>
<span id="cb17-26"><a href="#cb17-26" tabindex="-1"></a><span class="at">              </span><span class="fu">valueFrom</span><span class="kw">:</span></span>
<span id="cb17-27"><a href="#cb17-27" tabindex="-1"></a><span class="at">                </span><span class="fu">secretKeyRef</span><span class="kw">:</span></span>
<span id="cb17-28"><a href="#cb17-28" tabindex="-1"></a><span class="at">                  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-secrets</span></span>
<span id="cb17-29"><a href="#cb17-29" tabindex="-1"></a><span class="at">                  </span><span class="fu">key</span><span class="kw">:</span><span class="at"> mongo-password</span></span>
<span id="cb17-30"><a href="#cb17-30" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb17-31"><a href="#cb17-31" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb17-32"><a href="#cb17-32" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb17-33"><a href="#cb17-33" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb17-34"><a href="#cb17-34" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> mongo-service</span></span>
<span id="cb17-35"><a href="#cb17-35" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> metasurvey</span></span>
<span id="cb17-36"><a href="#cb17-36" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb17-37"><a href="#cb17-37" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb17-38"><a href="#cb17-38" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-mongo</span></span>
<span id="cb17-39"><a href="#cb17-39" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb17-40"><a href="#cb17-40" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">27017</span></span>
<span id="cb17-41"><a href="#cb17-41" tabindex="-1"></a><span class="at">      </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">27017</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="deployment-del-worker">Deployment del Worker<a class="anchor" aria-label="anchor" href="#deployment-del-worker"></a>
</h3>
<div class="sourceCode" id="cb18"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="co"># k8s/worker.yaml</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-worker</span></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> metasurvey</span></span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-worker</span></span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb18-15"><a href="#cb18-15" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-worker</span></span>
<span id="cb18-16"><a href="#cb18-16" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb18-17"><a href="#cb18-17" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb18-18"><a href="#cb18-18" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> worker</span></span>
<span id="cb18-19"><a href="#cb18-19" tabindex="-1"></a><span class="at">          </span><span class="fu">image</span><span class="kw">:</span><span class="at"> ghcr.io/metasurveyr/metasurvey-worker:latest</span></span>
<span id="cb18-20"><a href="#cb18-20" tabindex="-1"></a><span class="at">          </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb18-21"><a href="#cb18-21" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">8788</span></span>
<span id="cb18-22"><a href="#cb18-22" tabindex="-1"></a><span class="at">          </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb18-23"><a href="#cb18-23" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> METASURVEY_MONGO_URI</span></span>
<span id="cb18-24"><a href="#cb18-24" tabindex="-1"></a><span class="at">              </span><span class="fu">value</span><span class="kw">:</span><span class="at"> </span><span class="st">"mongodb://metasurvey:$(MONGO_PASSWORD)@mongo-service:27017/?authSource=admin"</span></span>
<span id="cb18-25"><a href="#cb18-25" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> MONGO_PASSWORD</span></span>
<span id="cb18-26"><a href="#cb18-26" tabindex="-1"></a><span class="at">              </span><span class="fu">valueFrom</span><span class="kw">:</span></span>
<span id="cb18-27"><a href="#cb18-27" tabindex="-1"></a><span class="at">                </span><span class="fu">secretKeyRef</span><span class="kw">:</span></span>
<span id="cb18-28"><a href="#cb18-28" tabindex="-1"></a><span class="at">                  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-secrets</span></span>
<span id="cb18-29"><a href="#cb18-29" tabindex="-1"></a><span class="at">                  </span><span class="fu">key</span><span class="kw">:</span><span class="at"> mongo-password</span></span>
<span id="cb18-30"><a href="#cb18-30" tabindex="-1"></a><span class="at">          </span><span class="fu">volumeMounts</span><span class="kw">:</span></span>
<span id="cb18-31"><a href="#cb18-31" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> survey-data</span></span>
<span id="cb18-32"><a href="#cb18-32" tabindex="-1"></a><span class="at">              </span><span class="fu">mountPath</span><span class="kw">:</span><span class="at"> /data/surveys</span></span>
<span id="cb18-33"><a href="#cb18-33" tabindex="-1"></a><span class="at">              </span><span class="fu">readOnly</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb18-34"><a href="#cb18-34" tabindex="-1"></a><span class="at">          </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb18-35"><a href="#cb18-35" tabindex="-1"></a><span class="at">            </span><span class="fu">requests</span><span class="kw">:</span></span>
<span id="cb18-36"><a href="#cb18-36" tabindex="-1"></a><span class="at">              </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">"1Gi"</span></span>
<span id="cb18-37"><a href="#cb18-37" tabindex="-1"></a><span class="at">              </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">"500m"</span></span>
<span id="cb18-38"><a href="#cb18-38" tabindex="-1"></a><span class="at">            </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb18-39"><a href="#cb18-39" tabindex="-1"></a><span class="at">              </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">"4Gi"</span></span>
<span id="cb18-40"><a href="#cb18-40" tabindex="-1"></a><span class="at">              </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">"2000m"</span></span>
<span id="cb18-41"><a href="#cb18-41" tabindex="-1"></a><span class="at">      </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb18-42"><a href="#cb18-42" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> survey-data</span></span>
<span id="cb18-43"><a href="#cb18-43" tabindex="-1"></a><span class="at">          </span><span class="fu">persistentVolumeClaim</span><span class="kw">:</span></span>
<span id="cb18-44"><a href="#cb18-44" tabindex="-1"></a><span class="at">            </span><span class="fu">claimName</span><span class="kw">:</span><span class="at"> survey-microdata-pvc</span></span>
<span id="cb18-45"><a href="#cb18-45" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb18-46"><a href="#cb18-46" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb18-47"><a href="#cb18-47" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb18-48"><a href="#cb18-48" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb18-49"><a href="#cb18-49" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> worker-service</span></span>
<span id="cb18-50"><a href="#cb18-50" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> metasurvey</span></span>
<span id="cb18-51"><a href="#cb18-51" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb18-52"><a href="#cb18-52" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb18-53"><a href="#cb18-53" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-worker</span></span>
<span id="cb18-54"><a href="#cb18-54" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb18-55"><a href="#cb18-55" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8788</span></span>
<span id="cb18-56"><a href="#cb18-56" tabindex="-1"></a><span class="at">      </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">8788</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="deployment-de-la-api">Deployment de la API<a class="anchor" aria-label="anchor" href="#deployment-de-la-api"></a>
</h3>
<div class="sourceCode" id="cb19"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="co"># k8s/api.yaml</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> metasurvey</span></span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb19-15"><a href="#cb19-15" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb19-16"><a href="#cb19-16" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb19-17"><a href="#cb19-17" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb19-18"><a href="#cb19-18" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> api</span></span>
<span id="cb19-19"><a href="#cb19-19" tabindex="-1"></a><span class="at">          </span><span class="fu">image</span><span class="kw">:</span><span class="at"> ghcr.io/metasurveyr/metasurvey-api:latest</span></span>
<span id="cb19-20"><a href="#cb19-20" tabindex="-1"></a><span class="at">          </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb19-21"><a href="#cb19-21" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span>
<span id="cb19-22"><a href="#cb19-22" tabindex="-1"></a><span class="at">          </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb19-23"><a href="#cb19-23" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> METASURVEY_MONGO_URI</span></span>
<span id="cb19-24"><a href="#cb19-24" tabindex="-1"></a><span class="at">              </span><span class="fu">value</span><span class="kw">:</span><span class="at"> </span><span class="st">"mongodb://metasurvey:$(MONGO_PASSWORD)@mongo-service:27017/?authSource=admin"</span></span>
<span id="cb19-25"><a href="#cb19-25" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> MONGO_PASSWORD</span></span>
<span id="cb19-26"><a href="#cb19-26" tabindex="-1"></a><span class="at">              </span><span class="fu">valueFrom</span><span class="kw">:</span></span>
<span id="cb19-27"><a href="#cb19-27" tabindex="-1"></a><span class="at">                </span><span class="fu">secretKeyRef</span><span class="kw">:</span></span>
<span id="cb19-28"><a href="#cb19-28" tabindex="-1"></a><span class="at">                  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-secrets</span></span>
<span id="cb19-29"><a href="#cb19-29" tabindex="-1"></a><span class="at">                  </span><span class="fu">key</span><span class="kw">:</span><span class="at"> mongo-password</span></span>
<span id="cb19-30"><a href="#cb19-30" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> METASURVEY_JWT_SECRET</span></span>
<span id="cb19-31"><a href="#cb19-31" tabindex="-1"></a><span class="at">              </span><span class="fu">valueFrom</span><span class="kw">:</span></span>
<span id="cb19-32"><a href="#cb19-32" tabindex="-1"></a><span class="at">                </span><span class="fu">secretKeyRef</span><span class="kw">:</span></span>
<span id="cb19-33"><a href="#cb19-33" tabindex="-1"></a><span class="at">                  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-secrets</span></span>
<span id="cb19-34"><a href="#cb19-34" tabindex="-1"></a><span class="at">                  </span><span class="fu">key</span><span class="kw">:</span><span class="at"> jwt-secret</span></span>
<span id="cb19-35"><a href="#cb19-35" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> METASURVEY_WORKER_URL</span></span>
<span id="cb19-36"><a href="#cb19-36" tabindex="-1"></a><span class="at">              </span><span class="fu">value</span><span class="kw">:</span><span class="at"> </span><span class="st">"http://worker-service:8788"</span></span>
<span id="cb19-37"><a href="#cb19-37" tabindex="-1"></a><span class="at">          </span><span class="fu">livenessProbe</span><span class="kw">:</span></span>
<span id="cb19-38"><a href="#cb19-38" tabindex="-1"></a><span class="at">            </span><span class="fu">httpGet</span><span class="kw">:</span></span>
<span id="cb19-39"><a href="#cb19-39" tabindex="-1"></a><span class="at">              </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /health</span></span>
<span id="cb19-40"><a href="#cb19-40" tabindex="-1"></a><span class="at">              </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span>
<span id="cb19-41"><a href="#cb19-41" tabindex="-1"></a><span class="at">            </span><span class="fu">initialDelaySeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">30</span></span>
<span id="cb19-42"><a href="#cb19-42" tabindex="-1"></a><span class="at">          </span><span class="fu">readinessProbe</span><span class="kw">:</span></span>
<span id="cb19-43"><a href="#cb19-43" tabindex="-1"></a><span class="at">            </span><span class="fu">httpGet</span><span class="kw">:</span></span>
<span id="cb19-44"><a href="#cb19-44" tabindex="-1"></a><span class="at">              </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /health</span></span>
<span id="cb19-45"><a href="#cb19-45" tabindex="-1"></a><span class="at">              </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span>
<span id="cb19-46"><a href="#cb19-46" tabindex="-1"></a><span class="at">            </span><span class="fu">initialDelaySeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">10</span></span>
<span id="cb19-47"><a href="#cb19-47" tabindex="-1"></a><span class="at">          </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb19-48"><a href="#cb19-48" tabindex="-1"></a><span class="at">            </span><span class="fu">requests</span><span class="kw">:</span></span>
<span id="cb19-49"><a href="#cb19-49" tabindex="-1"></a><span class="at">              </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">"512Mi"</span></span>
<span id="cb19-50"><a href="#cb19-50" tabindex="-1"></a><span class="at">              </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">"250m"</span></span>
<span id="cb19-51"><a href="#cb19-51" tabindex="-1"></a><span class="at">            </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb19-52"><a href="#cb19-52" tabindex="-1"></a><span class="at">              </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">"1Gi"</span></span>
<span id="cb19-53"><a href="#cb19-53" tabindex="-1"></a><span class="at">              </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">"500m"</span></span>
<span id="cb19-54"><a href="#cb19-54" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb19-55"><a href="#cb19-55" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb19-56"><a href="#cb19-56" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb19-57"><a href="#cb19-57" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb19-58"><a href="#cb19-58" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb19-59"><a href="#cb19-59" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> metasurvey</span></span>
<span id="cb19-60"><a href="#cb19-60" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb19-61"><a href="#cb19-61" tabindex="-1"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> NodePort</span></span>
<span id="cb19-62"><a href="#cb19-62" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb19-63"><a href="#cb19-63" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb19-64"><a href="#cb19-64" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb19-65"><a href="#cb19-65" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span>
<span id="cb19-66"><a href="#cb19-66" tabindex="-1"></a><span class="at">      </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="aplicar-y-probar">Aplicar y probar<a class="anchor" aria-label="anchor" href="#aplicar-y-probar"></a>
</h3>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="ex">kubectl</span> create namespace metasurvey</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a><span class="ex">kubectl</span> create secret generic metasurvey-secrets <span class="dt">\</span></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>  <span class="at">--namespace</span> metasurvey <span class="dt">\</span></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>  <span class="at">--from-literal</span><span class="op">=</span>mongo-password=cambiar <span class="dt">\</span></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>  <span class="at">--from-literal</span><span class="op">=</span>jwt-secret=cambiar</span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> k8s/mongo.yaml <span class="at">-f</span> k8s/worker.yaml <span class="at">-f</span> k8s/api.yaml</span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a><span class="co"># Acceder a la API</span></span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a><span class="ex">minikube</span> service metasurvey-api <span class="at">-n</span> metasurvey</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="despliegue-en-aws-eks">Despliegue en AWS (EKS)<a class="anchor" aria-label="anchor" href="#despliegue-en-aws-eks"></a>
</h2>
<p>Para produccion en AWS se usa <a href="https://aws.amazon.com/eks/" class="external-link">EKS</a> con DocumentDB (MongoDB
compatible) como base de datos gestionada.</p>
<div class="section level3">
<h3 id="crear-el-cluster-eks">1. Crear el cluster EKS<a class="anchor" aria-label="anchor" href="#crear-el-cluster-eks"></a>
</h3>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="co"># Requiere: aws-cli, eksctl</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a><span class="ex">eksctl</span> create cluster <span class="dt">\</span></span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>  <span class="at">--name</span> metasurvey-prod <span class="dt">\</span></span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a>  <span class="at">--region</span> sa-east-1 <span class="dt">\</span></span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a>  <span class="at">--node-type</span> t3.medium <span class="dt">\</span></span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a>  <span class="at">--nodes</span> 2 <span class="dt">\</span></span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a>  <span class="at">--nodes-min</span> 1 <span class="dt">\</span></span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a>  <span class="at">--nodes-max</span> 5</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="crear-documentdb-mongodb-compatible">2. Crear DocumentDB (MongoDB compatible)<a class="anchor" aria-label="anchor" href="#crear-documentdb-mongodb-compatible"></a>
</h3>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="ex">aws</span> docdb create-db-cluster <span class="dt">\</span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>  <span class="at">--db-cluster-identifier</span> metasurvey-db <span class="dt">\</span></span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>  <span class="at">--engine</span> docdb <span class="dt">\</span></span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>  <span class="at">--master-username</span> metasurvey_admin <span class="dt">\</span></span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a>  <span class="at">--master-user-password</span> <span class="st">"</span><span class="va">$DB_PASSWORD</span><span class="st">"</span> <span class="dt">\</span></span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a>  <span class="at">--vpc-security-group-ids</span> <span class="st">"</span><span class="va">$SG_ID</span><span class="st">"</span> <span class="dt">\</span></span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a>  <span class="at">--db-subnet-group-name</span> <span class="st">"</span><span class="va">$SUBNET_GROUP</span><span class="st">"</span></span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a><span class="ex">aws</span> docdb create-db-instance <span class="dt">\</span></span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a>  <span class="at">--db-instance-identifier</span> metasurvey-db-1 <span class="dt">\</span></span>
<span id="cb22-11"><a href="#cb22-11" tabindex="-1"></a>  <span class="at">--db-cluster-identifier</span> metasurvey-db <span class="dt">\</span></span>
<span id="cb22-12"><a href="#cb22-12" tabindex="-1"></a>  <span class="at">--db-instance-class</span> db.r6g.large <span class="dt">\</span></span>
<span id="cb22-13"><a href="#cb22-13" tabindex="-1"></a>  <span class="at">--engine</span> docdb</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="configurar-secrets-en-kubernetes">3. Configurar secrets en Kubernetes<a class="anchor" aria-label="anchor" href="#configurar-secrets-en-kubernetes"></a>
</h3>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="ex">aws</span> eks update-kubeconfig <span class="at">--name</span> metasurvey-prod <span class="at">--region</span> sa-east-1</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a><span class="ex">kubectl</span> create namespace metasurvey</span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a><span class="ex">kubectl</span> create secret generic metasurvey-secrets <span class="dt">\</span></span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a>  <span class="at">--namespace</span> metasurvey <span class="dt">\</span></span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a>  <span class="at">--from-literal</span><span class="op">=</span>mongo-uri=<span class="st">"mongodb://metasurvey_admin:</span><span class="va">$DB_PASSWORD</span><span class="st">@metasurvey-db.cluster-xxx.sa-east-1.docdb.amazonaws.com:27017/?tls=true&amp;tlsCAFile=/rds-combined-ca-bundle.pem&amp;retryWrites=false"</span> <span class="dt">\</span></span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a>  <span class="at">--from-literal</span><span class="op">=</span>jwt-secret=<span class="st">"</span><span class="va">$(</span><span class="ex">openssl</span> rand <span class="at">-hex</span> 32<span class="va">)</span><span class="st">"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="deployment-con-alb-ingress">4. Deployment con ALB Ingress<a class="anchor" aria-label="anchor" href="#deployment-con-alb-ingress"></a>
</h3>
<div class="sourceCode" id="cb24"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="co"># k8s/aws-api.yaml</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> metasurvey</span></span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb24-11"><a href="#cb24-11" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb24-12"><a href="#cb24-12" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb24-13"><a href="#cb24-13" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb24-14"><a href="#cb24-14" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb24-15"><a href="#cb24-15" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb24-16"><a href="#cb24-16" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb24-17"><a href="#cb24-17" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb24-18"><a href="#cb24-18" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> api</span></span>
<span id="cb24-19"><a href="#cb24-19" tabindex="-1"></a><span class="at">          </span><span class="fu">image</span><span class="kw">:</span><span class="at"> ghcr.io/metasurveyr/metasurvey-api:latest</span></span>
<span id="cb24-20"><a href="#cb24-20" tabindex="-1"></a><span class="at">          </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb24-21"><a href="#cb24-21" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span>
<span id="cb24-22"><a href="#cb24-22" tabindex="-1"></a><span class="at">          </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb24-23"><a href="#cb24-23" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> METASURVEY_MONGO_URI</span></span>
<span id="cb24-24"><a href="#cb24-24" tabindex="-1"></a><span class="at">              </span><span class="fu">valueFrom</span><span class="kw">:</span></span>
<span id="cb24-25"><a href="#cb24-25" tabindex="-1"></a><span class="at">                </span><span class="fu">secretKeyRef</span><span class="kw">:</span></span>
<span id="cb24-26"><a href="#cb24-26" tabindex="-1"></a><span class="at">                  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-secrets</span></span>
<span id="cb24-27"><a href="#cb24-27" tabindex="-1"></a><span class="at">                  </span><span class="fu">key</span><span class="kw">:</span><span class="at"> mongo-uri</span></span>
<span id="cb24-28"><a href="#cb24-28" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> METASURVEY_JWT_SECRET</span></span>
<span id="cb24-29"><a href="#cb24-29" tabindex="-1"></a><span class="at">              </span><span class="fu">valueFrom</span><span class="kw">:</span></span>
<span id="cb24-30"><a href="#cb24-30" tabindex="-1"></a><span class="at">                </span><span class="fu">secretKeyRef</span><span class="kw">:</span></span>
<span id="cb24-31"><a href="#cb24-31" tabindex="-1"></a><span class="at">                  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-secrets</span></span>
<span id="cb24-32"><a href="#cb24-32" tabindex="-1"></a><span class="at">                  </span><span class="fu">key</span><span class="kw">:</span><span class="at"> jwt-secret</span></span>
<span id="cb24-33"><a href="#cb24-33" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> METASURVEY_WORKER_URL</span></span>
<span id="cb24-34"><a href="#cb24-34" tabindex="-1"></a><span class="at">              </span><span class="fu">value</span><span class="kw">:</span><span class="at"> </span><span class="st">"http://worker-service:8788"</span></span>
<span id="cb24-35"><a href="#cb24-35" tabindex="-1"></a><span class="at">          </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb24-36"><a href="#cb24-36" tabindex="-1"></a><span class="at">            </span><span class="fu">requests</span><span class="kw">:</span></span>
<span id="cb24-37"><a href="#cb24-37" tabindex="-1"></a><span class="at">              </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">"512Mi"</span></span>
<span id="cb24-38"><a href="#cb24-38" tabindex="-1"></a><span class="at">              </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">"250m"</span></span>
<span id="cb24-39"><a href="#cb24-39" tabindex="-1"></a><span class="at">            </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb24-40"><a href="#cb24-40" tabindex="-1"></a><span class="at">              </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">"1Gi"</span></span>
<span id="cb24-41"><a href="#cb24-41" tabindex="-1"></a><span class="at">              </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">"500m"</span></span>
<span id="cb24-42"><a href="#cb24-42" tabindex="-1"></a><span class="at">          </span><span class="fu">livenessProbe</span><span class="kw">:</span></span>
<span id="cb24-43"><a href="#cb24-43" tabindex="-1"></a><span class="at">            </span><span class="fu">httpGet</span><span class="kw">:</span></span>
<span id="cb24-44"><a href="#cb24-44" tabindex="-1"></a><span class="at">              </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /health</span></span>
<span id="cb24-45"><a href="#cb24-45" tabindex="-1"></a><span class="at">              </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span>
<span id="cb24-46"><a href="#cb24-46" tabindex="-1"></a><span class="at">            </span><span class="fu">initialDelaySeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">30</span></span>
<span id="cb24-47"><a href="#cb24-47" tabindex="-1"></a><span class="at">          </span><span class="fu">readinessProbe</span><span class="kw">:</span></span>
<span id="cb24-48"><a href="#cb24-48" tabindex="-1"></a><span class="at">            </span><span class="fu">httpGet</span><span class="kw">:</span></span>
<span id="cb24-49"><a href="#cb24-49" tabindex="-1"></a><span class="at">              </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /health</span></span>
<span id="cb24-50"><a href="#cb24-50" tabindex="-1"></a><span class="at">              </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span>
<span id="cb24-51"><a href="#cb24-51" tabindex="-1"></a><span class="at">            </span><span class="fu">initialDelaySeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">10</span></span>
<span id="cb24-52"><a href="#cb24-52" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb24-53"><a href="#cb24-53" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb24-54"><a href="#cb24-54" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb24-55"><a href="#cb24-55" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb24-56"><a href="#cb24-56" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb24-57"><a href="#cb24-57" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> metasurvey</span></span>
<span id="cb24-58"><a href="#cb24-58" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb24-59"><a href="#cb24-59" tabindex="-1"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> ClusterIP</span></span>
<span id="cb24-60"><a href="#cb24-60" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb24-61"><a href="#cb24-61" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb24-62"><a href="#cb24-62" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb24-63"><a href="#cb24-63" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span>
<span id="cb24-64"><a href="#cb24-64" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb24-65"><a href="#cb24-65" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> networking.k8s.io/v1</span></span>
<span id="cb24-66"><a href="#cb24-66" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Ingress</span></span>
<span id="cb24-67"><a href="#cb24-67" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb24-68"><a href="#cb24-68" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-ingress</span></span>
<span id="cb24-69"><a href="#cb24-69" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> metasurvey</span></span>
<span id="cb24-70"><a href="#cb24-70" tabindex="-1"></a><span class="at">  </span><span class="fu">annotations</span><span class="kw">:</span></span>
<span id="cb24-71"><a href="#cb24-71" tabindex="-1"></a><span class="at">    </span><span class="fu">kubernetes.io/ingress.class</span><span class="kw">:</span><span class="at"> alb</span></span>
<span id="cb24-72"><a href="#cb24-72" tabindex="-1"></a><span class="at">    </span><span class="fu">alb.ingress.kubernetes.io/scheme</span><span class="kw">:</span><span class="at"> internet-facing</span></span>
<span id="cb24-73"><a href="#cb24-73" tabindex="-1"></a><span class="at">    </span><span class="fu">alb.ingress.kubernetes.io/target-type</span><span class="kw">:</span><span class="at"> ip</span></span>
<span id="cb24-74"><a href="#cb24-74" tabindex="-1"></a><span class="at">    </span><span class="fu">alb.ingress.kubernetes.io/certificate-arn</span><span class="kw">:</span><span class="at"> </span><span class="st">"$ACM_CERT_ARN"</span></span>
<span id="cb24-75"><a href="#cb24-75" tabindex="-1"></a><span class="at">    </span><span class="fu">alb.ingress.kubernetes.io/listen-ports</span><span class="kw">:</span><span class="at"> </span><span class="st">'[{"HTTPS":443}]'</span></span>
<span id="cb24-76"><a href="#cb24-76" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb24-77"><a href="#cb24-77" tabindex="-1"></a><span class="at">  </span><span class="fu">rules</span><span class="kw">:</span></span>
<span id="cb24-78"><a href="#cb24-78" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">host</span><span class="kw">:</span><span class="at"> api.metasurvey.ejemplo.org</span></span>
<span id="cb24-79"><a href="#cb24-79" tabindex="-1"></a><span class="at">      </span><span class="fu">http</span><span class="kw">:</span></span>
<span id="cb24-80"><a href="#cb24-80" tabindex="-1"></a><span class="at">        </span><span class="fu">paths</span><span class="kw">:</span></span>
<span id="cb24-81"><a href="#cb24-81" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /</span></span>
<span id="cb24-82"><a href="#cb24-82" tabindex="-1"></a><span class="at">            </span><span class="fu">pathType</span><span class="kw">:</span><span class="at"> Prefix</span></span>
<span id="cb24-83"><a href="#cb24-83" tabindex="-1"></a><span class="at">            </span><span class="fu">backend</span><span class="kw">:</span></span>
<span id="cb24-84"><a href="#cb24-84" tabindex="-1"></a><span class="at">              </span><span class="fu">service</span><span class="kw">:</span></span>
<span id="cb24-85"><a href="#cb24-85" tabindex="-1"></a><span class="at">                </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb24-86"><a href="#cb24-86" tabindex="-1"></a><span class="at">                </span><span class="fu">port</span><span class="kw">:</span></span>
<span id="cb24-87"><a href="#cb24-87" tabindex="-1"></a><span class="at">                  </span><span class="fu">number</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="co"># Instalar AWS Load Balancer Controller (si no esta instalado)</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a><span class="ex">helm</span> repo add eks https://aws.github.io/eks-charts</span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a><span class="ex">helm</span> install aws-load-balancer-controller eks/aws-load-balancer-controller <span class="dt">\</span></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a>  <span class="at">-n</span> kube-system <span class="dt">\</span></span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a>  <span class="at">--set</span> clusterName=metasurvey-prod</span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> k8s/aws-api.yaml</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="despliegue-en-azure-aks">Despliegue en Azure (AKS)<a class="anchor" aria-label="anchor" href="#despliegue-en-azure-aks"></a>
</h2>
<p>Para produccion en Azure se usa <a href="https://azure.microsoft.com/en-us/products/kubernetes-service/" class="external-link">AKS</a>
con CosmosDB (API MongoDB) como base de datos gestionada.</p>
<div class="section level3">
<h3 id="crear-el-cluster-aks">1. Crear el cluster AKS<a class="anchor" aria-label="anchor" href="#crear-el-cluster-aks"></a>
</h3>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="co"># Requiere: az cli</span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a><span class="ex">az</span> group create <span class="at">--name</span> rg-metasurvey <span class="at">--location</span> brazilsouth</span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a><span class="ex">az</span> aks create <span class="dt">\</span></span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a>  <span class="at">--resource-group</span> rg-metasurvey <span class="dt">\</span></span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a>  <span class="at">--name</span> aks-metasurvey <span class="dt">\</span></span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a>  <span class="at">--node-count</span> 2 <span class="dt">\</span></span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a>  <span class="at">--node-vm-size</span> Standard_B2ms <span class="dt">\</span></span>
<span id="cb26-9"><a href="#cb26-9" tabindex="-1"></a>  <span class="at">--generate-ssh-keys</span> <span class="dt">\</span></span>
<span id="cb26-10"><a href="#cb26-10" tabindex="-1"></a>  <span class="at">--enable-managed-identity</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="crear-cosmosdb-con-api-mongodb">2. Crear CosmosDB con API MongoDB<a class="anchor" aria-label="anchor" href="#crear-cosmosdb-con-api-mongodb"></a>
</h3>
<div class="sourceCode" id="cb27"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="ex">az</span> cosmosdb create <span class="dt">\</span></span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a>  <span class="at">--name</span> cosmos-metasurvey <span class="dt">\</span></span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a>  <span class="at">--resource-group</span> rg-metasurvey <span class="dt">\</span></span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a>  <span class="at">--kind</span> MongoDB <span class="dt">\</span></span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a>  <span class="at">--capabilities</span> EnableMongo <span class="dt">\</span></span>
<span id="cb27-6"><a href="#cb27-6" tabindex="-1"></a>  <span class="at">--default-consistency-level</span> Session <span class="dt">\</span></span>
<span id="cb27-7"><a href="#cb27-7" tabindex="-1"></a>  <span class="at">--locations</span> regionName=brazilsouth</span>
<span id="cb27-8"><a href="#cb27-8" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" tabindex="-1"></a><span class="co"># Obtener connection string</span></span>
<span id="cb27-10"><a href="#cb27-10" tabindex="-1"></a><span class="va">COSMOS_URI</span><span class="op">=</span><span class="va">$(</span><span class="ex">az</span> cosmosdb keys list <span class="dt">\</span></span>
<span id="cb27-11"><a href="#cb27-11" tabindex="-1"></a>  <span class="at">--name</span> cosmos-metasurvey <span class="dt">\</span></span>
<span id="cb27-12"><a href="#cb27-12" tabindex="-1"></a>  <span class="at">--resource-group</span> rg-metasurvey <span class="dt">\</span></span>
<span id="cb27-13"><a href="#cb27-13" tabindex="-1"></a>  <span class="at">--type</span> connection-strings <span class="dt">\</span></span>
<span id="cb27-14"><a href="#cb27-14" tabindex="-1"></a>  <span class="at">--query</span> <span class="st">"connectionStrings[0].connectionString"</span> <span class="at">-o</span> tsv<span class="va">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="configurar-secrets-en-kubernetes-1">3. Configurar secrets en Kubernetes<a class="anchor" aria-label="anchor" href="#configurar-secrets-en-kubernetes-1"></a>
</h3>
<div class="sourceCode" id="cb28"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="ex">az</span> aks get-credentials <span class="dt">\</span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>  <span class="at">--resource-group</span> rg-metasurvey <span class="dt">\</span></span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a>  <span class="at">--name</span> aks-metasurvey</span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a><span class="ex">kubectl</span> create namespace metasurvey</span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a><span class="ex">kubectl</span> create secret generic metasurvey-secrets <span class="dt">\</span></span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a>  <span class="at">--namespace</span> metasurvey <span class="dt">\</span></span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a>  <span class="at">--from-literal</span><span class="op">=</span>mongo-uri=<span class="st">"</span><span class="va">$COSMOS_URI</span><span class="st">"</span> <span class="dt">\</span></span>
<span id="cb28-10"><a href="#cb28-10" tabindex="-1"></a>  <span class="at">--from-literal</span><span class="op">=</span>jwt-secret=<span class="st">"</span><span class="va">$(</span><span class="ex">openssl</span> rand <span class="at">-hex</span> 32<span class="va">)</span><span class="st">"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="deployment-con-nginx-ingress">4. Deployment con NGINX Ingress<a class="anchor" aria-label="anchor" href="#deployment-con-nginx-ingress"></a>
</h3>
<div class="sourceCode" id="cb29"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="co"># k8s/azure-api.yaml</span></span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> metasurvey</span></span>
<span id="cb29-7"><a href="#cb29-7" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb29-8"><a href="#cb29-8" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb29-9"><a href="#cb29-9" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb29-10"><a href="#cb29-10" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb29-11"><a href="#cb29-11" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb29-12"><a href="#cb29-12" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb29-13"><a href="#cb29-13" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb29-14"><a href="#cb29-14" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb29-15"><a href="#cb29-15" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb29-16"><a href="#cb29-16" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb29-17"><a href="#cb29-17" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb29-18"><a href="#cb29-18" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> api</span></span>
<span id="cb29-19"><a href="#cb29-19" tabindex="-1"></a><span class="at">          </span><span class="fu">image</span><span class="kw">:</span><span class="at"> ghcr.io/metasurveyr/metasurvey-api:latest</span></span>
<span id="cb29-20"><a href="#cb29-20" tabindex="-1"></a><span class="at">          </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb29-21"><a href="#cb29-21" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span>
<span id="cb29-22"><a href="#cb29-22" tabindex="-1"></a><span class="at">          </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb29-23"><a href="#cb29-23" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> METASURVEY_MONGO_URI</span></span>
<span id="cb29-24"><a href="#cb29-24" tabindex="-1"></a><span class="at">              </span><span class="fu">valueFrom</span><span class="kw">:</span></span>
<span id="cb29-25"><a href="#cb29-25" tabindex="-1"></a><span class="at">                </span><span class="fu">secretKeyRef</span><span class="kw">:</span></span>
<span id="cb29-26"><a href="#cb29-26" tabindex="-1"></a><span class="at">                  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-secrets</span></span>
<span id="cb29-27"><a href="#cb29-27" tabindex="-1"></a><span class="at">                  </span><span class="fu">key</span><span class="kw">:</span><span class="at"> mongo-uri</span></span>
<span id="cb29-28"><a href="#cb29-28" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> METASURVEY_JWT_SECRET</span></span>
<span id="cb29-29"><a href="#cb29-29" tabindex="-1"></a><span class="at">              </span><span class="fu">valueFrom</span><span class="kw">:</span></span>
<span id="cb29-30"><a href="#cb29-30" tabindex="-1"></a><span class="at">                </span><span class="fu">secretKeyRef</span><span class="kw">:</span></span>
<span id="cb29-31"><a href="#cb29-31" tabindex="-1"></a><span class="at">                  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-secrets</span></span>
<span id="cb29-32"><a href="#cb29-32" tabindex="-1"></a><span class="at">                  </span><span class="fu">key</span><span class="kw">:</span><span class="at"> jwt-secret</span></span>
<span id="cb29-33"><a href="#cb29-33" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> METASURVEY_WORKER_URL</span></span>
<span id="cb29-34"><a href="#cb29-34" tabindex="-1"></a><span class="at">              </span><span class="fu">value</span><span class="kw">:</span><span class="at"> </span><span class="st">"http://worker-service:8788"</span></span>
<span id="cb29-35"><a href="#cb29-35" tabindex="-1"></a><span class="at">          </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb29-36"><a href="#cb29-36" tabindex="-1"></a><span class="at">            </span><span class="fu">requests</span><span class="kw">:</span></span>
<span id="cb29-37"><a href="#cb29-37" tabindex="-1"></a><span class="at">              </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">"512Mi"</span></span>
<span id="cb29-38"><a href="#cb29-38" tabindex="-1"></a><span class="at">              </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">"250m"</span></span>
<span id="cb29-39"><a href="#cb29-39" tabindex="-1"></a><span class="at">            </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb29-40"><a href="#cb29-40" tabindex="-1"></a><span class="at">              </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">"1Gi"</span></span>
<span id="cb29-41"><a href="#cb29-41" tabindex="-1"></a><span class="at">              </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">"500m"</span></span>
<span id="cb29-42"><a href="#cb29-42" tabindex="-1"></a><span class="at">          </span><span class="fu">livenessProbe</span><span class="kw">:</span></span>
<span id="cb29-43"><a href="#cb29-43" tabindex="-1"></a><span class="at">            </span><span class="fu">httpGet</span><span class="kw">:</span></span>
<span id="cb29-44"><a href="#cb29-44" tabindex="-1"></a><span class="at">              </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /health</span></span>
<span id="cb29-45"><a href="#cb29-45" tabindex="-1"></a><span class="at">              </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span>
<span id="cb29-46"><a href="#cb29-46" tabindex="-1"></a><span class="at">            </span><span class="fu">initialDelaySeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">30</span></span>
<span id="cb29-47"><a href="#cb29-47" tabindex="-1"></a><span class="at">          </span><span class="fu">readinessProbe</span><span class="kw">:</span></span>
<span id="cb29-48"><a href="#cb29-48" tabindex="-1"></a><span class="at">            </span><span class="fu">httpGet</span><span class="kw">:</span></span>
<span id="cb29-49"><a href="#cb29-49" tabindex="-1"></a><span class="at">              </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /health</span></span>
<span id="cb29-50"><a href="#cb29-50" tabindex="-1"></a><span class="at">              </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span>
<span id="cb29-51"><a href="#cb29-51" tabindex="-1"></a><span class="at">            </span><span class="fu">initialDelaySeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">10</span></span>
<span id="cb29-52"><a href="#cb29-52" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb29-53"><a href="#cb29-53" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb29-54"><a href="#cb29-54" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb29-55"><a href="#cb29-55" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb29-56"><a href="#cb29-56" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb29-57"><a href="#cb29-57" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> metasurvey</span></span>
<span id="cb29-58"><a href="#cb29-58" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb29-59"><a href="#cb29-59" tabindex="-1"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> ClusterIP</span></span>
<span id="cb29-60"><a href="#cb29-60" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb29-61"><a href="#cb29-61" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb29-62"><a href="#cb29-62" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb29-63"><a href="#cb29-63" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span>
<span id="cb29-64"><a href="#cb29-64" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb29-65"><a href="#cb29-65" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> networking.k8s.io/v1</span></span>
<span id="cb29-66"><a href="#cb29-66" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Ingress</span></span>
<span id="cb29-67"><a href="#cb29-67" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb29-68"><a href="#cb29-68" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-ingress</span></span>
<span id="cb29-69"><a href="#cb29-69" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> metasurvey</span></span>
<span id="cb29-70"><a href="#cb29-70" tabindex="-1"></a><span class="at">  </span><span class="fu">annotations</span><span class="kw">:</span></span>
<span id="cb29-71"><a href="#cb29-71" tabindex="-1"></a><span class="at">    </span><span class="fu">cert-manager.io/cluster-issuer</span><span class="kw">:</span><span class="at"> letsencrypt-prod</span></span>
<span id="cb29-72"><a href="#cb29-72" tabindex="-1"></a><span class="at">    </span><span class="fu">nginx.ingress.kubernetes.io/ssl-redirect</span><span class="kw">:</span><span class="at"> </span><span class="st">"true"</span></span>
<span id="cb29-73"><a href="#cb29-73" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb29-74"><a href="#cb29-74" tabindex="-1"></a><span class="at">  </span><span class="fu">ingressClassName</span><span class="kw">:</span><span class="at"> nginx</span></span>
<span id="cb29-75"><a href="#cb29-75" tabindex="-1"></a><span class="at">  </span><span class="fu">tls</span><span class="kw">:</span></span>
<span id="cb29-76"><a href="#cb29-76" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">hosts</span><span class="kw">:</span></span>
<span id="cb29-77"><a href="#cb29-77" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> api.metasurvey.ejemplo.org</span></span>
<span id="cb29-78"><a href="#cb29-78" tabindex="-1"></a><span class="at">      </span><span class="fu">secretName</span><span class="kw">:</span><span class="at"> metasurvey-tls</span></span>
<span id="cb29-79"><a href="#cb29-79" tabindex="-1"></a><span class="at">  </span><span class="fu">rules</span><span class="kw">:</span></span>
<span id="cb29-80"><a href="#cb29-80" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">host</span><span class="kw">:</span><span class="at"> api.metasurvey.ejemplo.org</span></span>
<span id="cb29-81"><a href="#cb29-81" tabindex="-1"></a><span class="at">      </span><span class="fu">http</span><span class="kw">:</span></span>
<span id="cb29-82"><a href="#cb29-82" tabindex="-1"></a><span class="at">        </span><span class="fu">paths</span><span class="kw">:</span></span>
<span id="cb29-83"><a href="#cb29-83" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /</span></span>
<span id="cb29-84"><a href="#cb29-84" tabindex="-1"></a><span class="at">            </span><span class="fu">pathType</span><span class="kw">:</span><span class="at"> Prefix</span></span>
<span id="cb29-85"><a href="#cb29-85" tabindex="-1"></a><span class="at">            </span><span class="fu">backend</span><span class="kw">:</span></span>
<span id="cb29-86"><a href="#cb29-86" tabindex="-1"></a><span class="at">              </span><span class="fu">service</span><span class="kw">:</span></span>
<span id="cb29-87"><a href="#cb29-87" tabindex="-1"></a><span class="at">                </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb29-88"><a href="#cb29-88" tabindex="-1"></a><span class="at">                </span><span class="fu">port</span><span class="kw">:</span></span>
<span id="cb29-89"><a href="#cb29-89" tabindex="-1"></a><span class="at">                  </span><span class="fu">number</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="co"># Instalar NGINX Ingress Controller</span></span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a><span class="ex">helm</span> repo add ingress-nginx https://kubernetes.github.io/ingress-nginx</span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a><span class="ex">helm</span> install ingress-nginx ingress-nginx/ingress-nginx <span class="dt">\</span></span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a>  <span class="at">--namespace</span> ingress-nginx <span class="at">--create-namespace</span></span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a><span class="co"># Instalar cert-manager para TLS</span></span>
<span id="cb30-7"><a href="#cb30-7" tabindex="-1"></a><span class="ex">helm</span> repo add jetstack https://charts.jetstack.io</span>
<span id="cb30-8"><a href="#cb30-8" tabindex="-1"></a><span class="ex">helm</span> install cert-manager jetstack/cert-manager <span class="dt">\</span></span>
<span id="cb30-9"><a href="#cb30-9" tabindex="-1"></a>  <span class="at">--namespace</span> cert-manager <span class="at">--create-namespace</span> <span class="dt">\</span></span>
<span id="cb30-10"><a href="#cb30-10" tabindex="-1"></a>  <span class="at">--set</span> crds.enabled=true</span>
<span id="cb30-11"><a href="#cb30-11" tabindex="-1"></a></span>
<span id="cb30-12"><a href="#cb30-12" tabindex="-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> k8s/azure-api.yaml</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="feature-flags">Feature Flags<a class="anchor" aria-label="anchor" href="#feature-flags"></a>
</h2>
<p>La API soporta variables de entorno para controlar que modulos estan
disponibles. Esto permite usar la misma imagen en diferentes
configuraciones:</p>
<table class="table">
<colgroup>
<col width="31%">
<col width="28%">
<col width="40%">
</colgroup>
<thead><tr class="header">
<th>Variable</th>
<th>Default</th>
<th>Descripcion</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>METASURVEY_ENABLE_INDICATORS</code></td>
<td><code>1</code></td>
<td>Habilitar endpoints <code>/indicators</code>
</td>
</tr>
<tr class="even">
<td><code>METASURVEY_ENABLE_WORKER</code></td>
<td><code>0</code></td>
<td>Habilitar <code>POST /indicators/compute</code> (bajo demanda)</td>
</tr>
</tbody>
</table>
<p>Por ejemplo, la API publica de metasurvey en Railway solo sirve
recetas y workflows – indicadores y worker estan deshabilitados:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="va">METASURVEY_ENABLE_INDICATORS</span><span class="op">=</span>0</span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a><span class="va">METASURVEY_ENABLE_WORKER</span><span class="op">=</span>0</span></code></pre></div>
<p>Un despliegue self-hosted con todas las capacidades:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a><span class="va">METASURVEY_ENABLE_INDICATORS</span><span class="op">=</span>1</span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a><span class="va">METASURVEY_ENABLE_WORKER</span><span class="op">=</span>1</span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a><span class="va">METASURVEY_WORKER_URL</span><span class="op">=</span>http://worker:8788</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="despliegue-hibrido-registro-publico-infraestructura-privada">Despliegue hibrido: Registro publico + Infraestructura privada<a class="anchor" aria-label="anchor" href="#despliegue-hibrido-registro-publico-infraestructura-privada"></a>
</h2>
<p>No necesitas correr tu propio MongoDB para acceder a las recetas
compartidas. Podes desplegar <strong>tu propia API + Worker</strong>
apuntando al <strong>registro publico de recetas de metasurvey</strong>,
para que investigadores con acceso a microdatos apliquen recetas
publicadas por la comunidad.</p>
<p>La organizacion despliega dos servicios:</p>
<ol style="list-style-type: decimal">
<li>
<strong>plumber API</strong> (<code>:8787</code>) – se conecta al
MongoDB publico para leer recetas y workflows. Recibe requests del
frontend o investigadores, y delega las estimaciones al worker.</li>
<li>
<strong>Worker</strong> (<code>:8788</code>) – tiene metasurvey
instalado y acceso a los microdatos privados. Obtiene las recetas del
registro publico (via MongoDB), las aplica, y ejecuta las
estimaciones.</li>
</ol>
<pre class="text"><code>  MongoDB publico de metasurvey         Tu infraestructura
  (recetas, workflows)                  (red privada)
  +-------------------+           +---------------------------+
  |  MongoDB Atlas     |&lt;----------| plumber API  :8787        |
  |  (solo lectura)    |           |   - lee recetas/wf        |
  +-------------------+           |   - proxie POST /compute   |
                                   +-------------+-------------+
                                                 |
                                    POST /compute|
                                                 v
                                   +-------------+-------------+
                                   | Worker  :8788              |
                                   |   - carga microdatos       |
                                   |   - aplica recetas         |
                                   |   - ejecuta workflow()     |
                                   +---------------------------+
                                                 ^
                                   +-------------+-------------+
                                   | Microdatos (.sav, .dta)   |
                                   | PRIVADOS — nunca salen    |
                                   +---------------------------+</code></pre>
<div class="sourceCode" id="cb34"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a><span class="co"># .env para despliegue hibrido</span></span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a><span class="co"># Ambos (API y Worker) apuntan al MongoDB publico de metasurvey</span></span>
<span id="cb34-3"><a href="#cb34-3" tabindex="-1"></a><span class="va">METASURVEY_MONGO_URI</span><span class="op">=</span>mongodb+srv://readonly:public@metasurvey.mongodb.net</span>
<span id="cb34-4"><a href="#cb34-4" tabindex="-1"></a><span class="va">METASURVEY_DB</span><span class="op">=</span>metasurvey</span>
<span id="cb34-5"><a href="#cb34-5" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" tabindex="-1"></a><span class="co"># El worker tiene microdatos locales</span></span>
<span id="cb34-7"><a href="#cb34-7" tabindex="-1"></a><span class="va">SURVEY_DATA_PATH</span><span class="op">=</span>/secure/microdatos</span>
<span id="cb34-8"><a href="#cb34-8" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" tabindex="-1"></a><span class="co"># La API delega estimaciones al worker</span></span>
<span id="cb34-10"><a href="#cb34-10" tabindex="-1"></a><span class="va">METASURVEY_WORKER_URL</span><span class="op">=</span>http://worker:8788</span>
<span id="cb34-11"><a href="#cb34-11" tabindex="-1"></a><span class="va">METASURVEY_ENABLE_WORKER</span><span class="op">=</span>1</span>
<span id="cb34-12"><a href="#cb34-12" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" tabindex="-1"></a><span class="co"># Indicadores deshabilitados (no hay MongoDB local para guardarlos)</span></span>
<span id="cb34-14"><a href="#cb34-14" tabindex="-1"></a><span class="va">METASURVEY_ENABLE_INDICATORS</span><span class="op">=</span>0</span></code></pre></div>
<div class="sourceCode" id="cb35"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a><span class="ex">docker</span> compose up api worker</span></code></pre></div>
<p>En este modo:</p>
<ul>
<li>
<strong>Recetas y workflows</strong> se obtienen del registro
publico – cualquier receta publicada por la comunidad esta disponible
para tu API y worker.</li>
<li>
<strong>Los microdatos son privados</strong> – el worker carga
archivos de encuesta desde un volumen local, nunca expuestos
externamente.</li>
<li>
<strong>La estimacion es local</strong> – la API recibe el request,
lo delega al worker, que aplica las recetas y ejecuta
<code><a href="../reference/workflow.html">workflow()</a></code> en tu infraestructura.</li>
<li>
<strong>Sin MongoDB propio</strong> – usas el registro publico tal
cual.</li>
</ul>
<p>Esto es util para equipos de investigacion que tienen acceso a
microdatos restringidos y quieren aplicar recetas estandarizadas sin
mantener su propia base de datos.</p>
</div>
<div class="section level2">
<h2 id="despliegue-en-produccion">Despliegue en produccion<a class="anchor" aria-label="anchor" href="#despliegue-en-produccion"></a>
</h2>
<p>Para despliegues de produccion con modulos Terraform (AWS/Azure/GCP),
Helm charts y pipelines CI/CD, ver el repositorio de
infraestructura:</p>
<p>El repositorio de infraestructura incluira:</p>
<ul>
<li>Modulos Terraform para bases de datos gestionadas (RDS,
DocumentDB/CosmosDB, Cloud SQL, Memorystore)</li>
<li>Manifiestos Kubernetes con autoescalado, ingress TLS y gestion de
secretos</li>
<li>Builds de imagenes Docker y configuracion de registry</li>
<li>Monitoreo y health checks</li>
</ul>
</div>
<div class="section level2">
<h2 id="proximos-pasos">Proximos pasos<a class="anchor" aria-label="anchor" href="#proximos-pasos"></a>
</h2>
<ul>
<li>
<strong><a href="https://metasurveyr.github.io/metasurvey/articles/api-database.html">Referencia
de la API y Base de Datos</a></strong> – Documentacion completa de
endpoints, esquema MongoDB y autenticacion</li>
<li>
<strong><a href="recipes-es.html">Creacion y publicacion de
recetas</a></strong> – Construir recetas para procesamiento reproducible
de encuestas</li>
<li>
<strong><a href="workflows-and-estimation-es.html">Workflows de
estimacion</a></strong> – Calcular estimaciones ponderadas de encuestas
con <code><a href="../reference/workflow.html">workflow()</a></code>
</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://iesta.fcea.udelar.edu.uy/integrantes/loprete-mauro/" class="external-link">Mauro Loprete</a>, <a href="https://natydasilva.github.io/natydasilva/" class="external-link">Natalia da Silva</a>, <a href="https://iecon.fcea.udelar.edu.uy/es/autores/item/machado-fabricio.html" class="external-link">Fabricio Machado</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
