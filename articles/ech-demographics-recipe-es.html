<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Construyendo una Receta de Demografia ECH (ES) • metasurvey</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Construyendo una Receta de Demografia ECH (ES)">
<!-- javascript assets for rmarkdown --><meta name="pkgdown-site-root" content="../">
<script src="../ace-1.2.3/ace.js" type="text/javascript" charset="utf-8"></script><script src="../holder-2.9.0/holder.min.js" type="text/javascript" charset="utf-8"></script><script src="../snippets/snippets.js" type="text/javascript" charset="utf-8"></script><style type="text/css">
.snippet {
  border: solid 1px #cccccc;
  margin-bottom: 12px;
  width: 100%;
}
</style>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">metasurvey</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.17</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/metasurveyr/metasurvey/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<script src="ech-demographics-recipe-es_files/htmlwidgets-1.6.4/htmlwidgets.js"></script><link href="ech-demographics-recipe-es_files/vis-9.1.0/vis-network.min.css" rel="stylesheet">
<script src="ech-demographics-recipe-es_files/vis-9.1.0/vis-network.min.js"></script><script src="ech-demographics-recipe-es_files/visNetwork-binding-2.1.4/visNetwork.js"></script><link href="ech-demographics-recipe-es_files/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Construyendo una Receta de Demografia ECH (ES)</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/metasurveyr/metasurvey/blob/main/vignettes/ech-demographics-recipe-es.Rmd" class="external-link"><code>vignettes/ech-demographics-recipe-es.Rmd</code></a></small>
      <div class="d-none name"><code>ech-demographics-recipe-es.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="dos-caminos-transpilar-rapido-o-construir-bien">Dos caminos: transpilar rapido o construir bien<a class="anchor" aria-label="anchor" href="#dos-caminos-transpilar-rapido-o-construir-bien"></a>
</h2>
<p>metasurvey ofrece dos formas de crear recetas a partir de codigo
STATA existente:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Transpilar automaticamente</strong> con
<code><a href="../reference/transpile_stata.html">transpile_stata()</a></code> – convierte archivos <code>.do</code> a
recetas en segundos. Ideal para migrar codigo legacy rapidamente (ver
<code><a href="../articles/stata-transpiler-es.html">vignette("stata-transpiler-es")</a></code>).</li>
<li>
<strong>Construir desde cero</strong> en R – mas trabajo inicial,
pero el resultado es mas limpio, usa modismos propios de R y se controla
cada detalle.</li>
</ol>
<p>El transpilador es un atajo pragmatico: lee cientos de lineas de
STATA y produce una receta funcional, pero la salida hereda la
estructura del codigo original – largas cadenas
<code>gen</code>/<code>replace</code> se convierten en largas llamadas a
<code>step_recode</code>, las variables temporales sobreviven, y
patrones especificos de STATA (como <code>mvencode</code>) se traducen
literalmente en lugar de repensarse.</p>
<p>Una receta artesanal, en cambio, permite <strong>redisenar la
logica</strong> en R desde cero. Se eligen nombres de variables
significativos, se combinan transformaciones relacionadas en un solo
step, y se omiten variables intermedias que solo existian porque STATA
las necesitaba. El resultado es mas corto, mas legible y mas facil de
mantener.</p>
<p>Esta vignette construye una receta de demografia desde cero en unas
20 lineas de R. Una version transpilada del mismo pipeline tomaria 80+
steps y arrastraria nombres de variables como <code>bc_pe2</code> y
<code>bc_pe3</code> que no significan nada fuera del archivo
<code>.do</code> original.</p>
</div>
<div class="section level2">
<h2 id="configurando-la-encuesta">Configurando la encuesta<a class="anchor" aria-label="anchor" href="#configurando-la-encuesta"></a>
</h2>
<p>Comenzamos con un objeto Survey vacio. Esto declara el tipo de
encuesta y la edicion sin cargar datos todavia – la receta funcionara
con cualquier dato que le proporcionemos despues.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://metasurveyr.github.io/metasurvey/">metasurvey</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survey_empty.html">survey_empty</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"ech"</span>, edition <span class="op">=</span> <span class="st">"2023"</span><span class="op">)</span></span>
<span><span class="va">svy</span></span></code></pre></div>
<p>Ahora adjuntamos algunos datos de ejemplo. En produccion estos
vendrian de <code>anda_download_microdata("2023")</code> o un archivo
local; aqui los simulamos.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">200</span></span>
<span><span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>  id       <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">50</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>  nper     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="fl">50</span><span class="op">)</span>,</span>
<span>  pesoano  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">50</span>, <span class="fl">300</span><span class="op">)</span>,</span>
<span>  e26      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  e27      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">90</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  e30      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">7</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  e51_2    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">6</span>, <span class="op">-</span><span class="fl">9</span><span class="op">)</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  region_4 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="va">svy</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/set_data.html">set_data</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="construyendo-el-pipeline">Construyendo el pipeline<a class="anchor" aria-label="anchor" href="#construyendo-el-pipeline"></a>
</h2>
<p>Cada transformacion es un <strong>step</strong>. Por defecto, los
steps son <strong>lazy</strong>: registran que hacer sin ejecutarlo.
Esto permite inspeccionar y modificar el pipeline antes de materializar
los resultados.</p>
<p>Comparar con el enfoque del transpilador:
<code><a href="../reference/transpile_stata.html">transpile_stata()</a></code> produciria un step por cada comando
STATA, preservando fielmente cada <code>gen</code> y
<code>replace</code>. Aqui pensamos en terminos de las <em>variables de
salida</em> que queremos, no de los comandos que necesitamos
escribir.</p>
<div class="section level3">
<h3 id="renombrar-identificadores">Renombrar identificadores<a class="anchor" aria-label="anchor" href="#renombrar-identificadores"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="va">svy</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_rename.html">step_rename</a></span><span class="op">(</span></span>
<span>    hh_id <span class="op">=</span> <span class="st">"id"</span>, person_id <span class="op">=</span> <span class="st">"nper"</span>,</span>
<span>    comment <span class="op">=</span> <span class="st">"Estandarizar identificadores"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Nada le paso a los datos todavia:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_data.html">get_data</a></span><span class="op">(</span><span class="va">svy</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] "id"      "nper"    "pesoano" "e26"</span></span></code></pre></div>
<p>Los nombres de columna originales siguen ahi porque el step esta
pendiente. Sigamos agregando steps.</p>
</div>
<div class="section level3">
<h3 id="recodificar-sexo">Recodificar sexo<a class="anchor" aria-label="anchor" href="#recodificar-sexo"></a>
</h3>
<p>En STATA esto seria una secuencia gen + replace + replace (3
comandos). Con <code>step_recode</code> es un unico mapeo declarativo
que produce etiquetas legibles:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="va">svy</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_recode.html">step_recode</a></span><span class="op">(</span><span class="va">sex</span>,</span>
<span>    <span class="va">e26</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Hombre"</span>,</span>
<span>    <span class="va">e26</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"Mujer"</span>,</span>
<span>    .default <span class="op">=</span> <span class="cn">NA_character_</span>,</span>
<span>    comment <span class="op">=</span> <span class="st">"Sexo desde e26"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="grupos-de-edad">Grupos de edad<a class="anchor" aria-label="anchor" href="#grupos-de-edad"></a>
</h3>
<p>El equivalente en STATA usa cinco lineas <code>replace</code> con
<code><a href="https://rdrr.io/pkg/data.table/man/between.html" class="external-link">inrange()</a></code>. Aqui escribimos la misma logica como un unico
recode con condiciones legibles:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="va">svy</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_recode.html">step_recode</a></span><span class="op">(</span><span class="va">age_group</span>,</span>
<span>    <span class="va">e27</span> <span class="op">&gt;=</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">e27</span> <span class="op">&lt;=</span> <span class="fl">13</span> <span class="op">~</span> <span class="st">"Ninio"</span>,</span>
<span>    <span class="va">e27</span> <span class="op">&gt;=</span> <span class="fl">14</span> <span class="op">&amp;</span> <span class="va">e27</span> <span class="op">&lt;=</span> <span class="fl">17</span> <span class="op">~</span> <span class="st">"Adolescente"</span>,</span>
<span>    <span class="va">e27</span> <span class="op">&gt;=</span> <span class="fl">18</span> <span class="op">&amp;</span> <span class="va">e27</span> <span class="op">&lt;=</span> <span class="fl">29</span> <span class="op">~</span> <span class="st">"Joven adulto"</span>,</span>
<span>    <span class="va">e27</span> <span class="op">&gt;=</span> <span class="fl">30</span> <span class="op">&amp;</span> <span class="va">e27</span> <span class="op">&lt;=</span> <span class="fl">64</span> <span class="op">~</span> <span class="st">"Adulto"</span>,</span>
<span>    <span class="va">e27</span> <span class="op">&gt;=</span> <span class="fl">65</span> <span class="op">~</span> <span class="st">"Adulto mayor"</span>,</span>
<span>    .default <span class="op">=</span> <span class="cn">NA_character_</span>,</span>
<span>    comment <span class="op">=</span> <span class="st">"Grupos de edad desde e27"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="relacion-con-el-jefe-de-hogar">Relacion con el jefe de hogar<a class="anchor" aria-label="anchor" href="#relacion-con-el-jefe-de-hogar"></a>
</h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="va">svy</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_recode.html">step_recode</a></span><span class="op">(</span><span class="va">relationship</span>,</span>
<span>    <span class="va">e30</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Jefe"</span>,</span>
<span>    <span class="va">e30</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"Conyuge"</span>,</span>
<span>    <span class="va">e30</span> <span class="op">&gt;=</span> <span class="fl">3</span> <span class="op">&amp;</span> <span class="va">e30</span> <span class="op">&lt;=</span> <span class="fl">5</span> <span class="op">~</span> <span class="st">"Hijo"</span>,</span>
<span>    <span class="va">e30</span> <span class="op">==</span> <span class="fl">6</span> <span class="op">~</span> <span class="st">"Otro familiar"</span>,</span>
<span>    <span class="va">e30</span> <span class="op">==</span> <span class="fl">7</span> <span class="op">~</span> <span class="st">"No familiar"</span>,</span>
<span>    .default <span class="op">=</span> <span class="st">"Desconocido"</span>,</span>
<span>    comment <span class="op">=</span> <span class="st">"Relacion desde e30"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="nivel-educativo">Nivel educativo<a class="anchor" aria-label="anchor" href="#nivel-educativo"></a>
</h3>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="va">svy</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_recode.html">step_recode</a></span><span class="op">(</span><span class="va">edu_level</span>,</span>
<span>    <span class="va">e51_2</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"Sin instruccion"</span>,</span>
<span>    <span class="va">e51_2</span> <span class="op">&gt;=</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">e51_2</span> <span class="op">&lt;=</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"Primaria"</span>,</span>
<span>    <span class="va">e51_2</span> <span class="op">&gt;=</span> <span class="fl">3</span> <span class="op">&amp;</span> <span class="va">e51_2</span> <span class="op">&lt;=</span> <span class="fl">4</span> <span class="op">~</span> <span class="st">"Secundaria"</span>,</span>
<span>    <span class="va">e51_2</span> <span class="op">&gt;=</span> <span class="fl">5</span> <span class="op">&amp;</span> <span class="va">e51_2</span> <span class="op">&lt;=</span> <span class="fl">6</span> <span class="op">~</span> <span class="st">"Terciaria"</span>,</span>
<span>    .default <span class="op">=</span> <span class="cn">NA_character_</span>,</span>
<span>    comment <span class="op">=</span> <span class="st">"Nivel educativo desde e51_2"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="area-geografica">Area geografica<a class="anchor" aria-label="anchor" href="#area-geografica"></a>
</h3>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="va">svy</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_recode.html">step_recode</a></span><span class="op">(</span><span class="va">area</span>,</span>
<span>    <span class="va">region_4</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Montevideo"</span>,</span>
<span>    <span class="va">region_4</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"Urbano &gt;5k"</span>,</span>
<span>    <span class="va">region_4</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">~</span> <span class="st">"Urbano &lt;5k"</span>,</span>
<span>    <span class="va">region_4</span> <span class="op">==</span> <span class="fl">4</span> <span class="op">~</span> <span class="st">"Rural"</span>,</span>
<span>    .default <span class="op">=</span> <span class="cn">NA_character_</span>,</span>
<span>    comment <span class="op">=</span> <span class="st">"Area geografica desde region_4"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Notar que todas nuestras variables de salida tienen <strong>etiquetas
significativas</strong> en lugar de codigos numericos. Una receta
transpilada mantendria los codigos enteros originales (1, 2, 3…) porque
eso es lo que usaba el codigo STATA. Construir desde cero permite elegir
la representacion que facilita el analisis.</p>
</div>
<div class="section level3">
<h3 id="remover-variables-crudas">Remover variables crudas<a class="anchor" aria-label="anchor" href="#remover-variables-crudas"></a>
</h3>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="va">svy</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_remove.html">step_remove</a></span><span class="op">(</span><span class="va">e26</span>, <span class="va">e27</span>, <span class="va">e30</span>, <span class="va">e51_2</span>, <span class="va">region_4</span>,</span>
<span>    comment <span class="op">=</span> <span class="st">"Eliminar variables crudas de ECH"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="inspeccionando-el-pipeline-antes-de-ejecutar">Inspeccionando el pipeline antes de ejecutar<a class="anchor" aria-label="anchor" href="#inspeccionando-el-pipeline-antes-de-ejecutar"></a>
</h2>
<p>En este punto tenemos siete steps pendientes. Veamos que se
registro:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_steps.html">get_steps</a></span><span class="op">(</span><span class="va">svy</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 7</span></span></code></pre></div>
<p>Esta es una de las ventajas clave de construir desde cero: <strong>7
steps que cada uno hace una cosa clara</strong>. Una version transpilada
del modulo completo de demografia del IECON tiene 80+ steps porque
preserva cada comando STATA intermedio.</p>
<p>El pipeline es un DAG (grafo aciclico dirigido) de transformaciones.
<code><a href="../reference/view_graph.html">view_graph()</a></code> lo renderiza como una red interactiva – cada
nodo es un step, y las aristas muestran dependencias de variables:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/view_graph.html">view_graph</a></span><span class="op">(</span><span class="va">svy</span><span class="op">)</span></span></code></pre></div>
<div id="htmlwidget-ac96cb3ee4656e2e9ec3" style="width:100%;height:600px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-ac96cb3ee4656e2e9ec3">{"x":{"nodes":{"id":[1,2,3,4,5,6,7,8],"label":["Load survey","step_1 Rename: hh_id=id, person_id=nper","step_2 Recode: sex","step_3 Recode: age_group","step_4 Recode: relationship","step_5 Recode: edu_level","step_6 Recode: area","step_7 Remove: e26, e27, e30, e51_2, region_4"],"title":["<div style='font-family: system-ui, -apple-system, sans-serif; padding: 12px 16px; max-width: 300px;'><div style='font-weight: 800; font-size: 14px; color: #2C3E50; margin-bottom: 8px;'>Survey<\/div><table style='font-size: 12px; color: #555; border-collapse: collapse;'><tr><td style='font-weight:600; padding: 3px 12px 3px 0; color:#2C3E50;'>Type<\/td><td style='padding:3px 0;'>ech<\/td><\/tr><tr><td style='font-weight:600; padding: 3px 12px 3px 0; color:#2C3E50;'>Edition<\/td><td style='padding:3px 0;'>2023<\/td><\/tr><tr><td style='font-weight:600; padding: 3px 12px 3px 0; color:#2C3E50;'>Weight<\/td><td style='padding:3px 0;'><\/td><\/tr><\/table><\/div>","<div style='font-family: system-ui, -apple-system, sans-serif; padding: 10px 14px; max-width: 340px;'><div style='font-weight: 700; font-size: 13px; color: #2C3E50; margin-bottom: 6px; border-bottom: 2px solid #eee; padding-bottom: 6px;'>Estandarizar identificadores<\/div><div style='font-family: SFMono-Regular, Consolas, monospace; font-size: 11px; color: #6c757d; background: #f8f9fa; padding: 8px 10px; border-radius: 6px; line-height: 1.5; white-space: pre-wrap;'>list(mapping = c(hh_id = \"id\", person_id = \"nper\"))<\/div><\/div>","<div style='font-family: system-ui, -apple-system, sans-serif; padding: 10px 14px; max-width: 340px;'><div style='font-weight: 700; font-size: 13px; color: #2C3E50; margin-bottom: 6px; border-bottom: 2px solid #eee; padding-bottom: 6px;'>Sexo desde e26<\/div><div style='font-family: SFMono-Regular, Consolas, monospace; font-size: 11px; color: #6c757d; background: #f8f9fa; padding: 8px 10px; border-radius: 6px; line-height: 1.5; white-space: pre-wrap;'>sex: list(e26 == 1 ~ \"Hombre\", e26 == 2 ~ \"Mujer\")<\/div><\/div>","<div style='font-family: system-ui, -apple-system, sans-serif; padding: 10px 14px; max-width: 340px;'><div style='font-weight: 700; font-size: 13px; color: #2C3E50; margin-bottom: 6px; border-bottom: 2px solid #eee; padding-bottom: 6px;'>Grupos de edad desde e27<\/div><div style='font-family: SFMono-Regular, Consolas, monospace; font-size: 11px; color: #6c757d; background: #f8f9fa; padding: 8px 10px; border-radius: 6px; line-height: 1.5; white-space: pre-wrap;'>age_group: list(e27 &gt;= 0 &amp; e27 &lt;= 13 ~ \"Ninio\", e27 &gt;= 14 &amp; e27 &lt;= 17 ~ \"Adolescente\", e27 &gt;= 18 &amp; e27 &lt;= 29 ~ \"Joven adulto\", e27 &gt;= 30 &amp; e27 &lt;= 64 ~ \"Adulto\", e27 &gt;= 65 ~ \"Adulto mayor\")<\/div><\/div>","<div style='font-family: system-ui, -apple-system, sans-serif; padding: 10px 14px; max-width: 340px;'><div style='font-weight: 700; font-size: 13px; color: #2C3E50; margin-bottom: 6px; border-bottom: 2px solid #eee; padding-bottom: 6px;'>Relacion desde e30<\/div><div style='font-family: SFMono-Regular, Consolas, monospace; font-size: 11px; color: #6c757d; background: #f8f9fa; padding: 8px 10px; border-radius: 6px; line-height: 1.5; white-space: pre-wrap;'>relationship: list(e30 == 1 ~ \"Jefe\", e30 == 2 ~ \"Conyuge\", e30 &gt;= 3 &amp; e30 &lt;= 5 ~ \"Hijo\", e30 == 6 ~ \"Otro familiar\", e30 == 7 ~ \"No familiar\")<\/div><\/div>","<div style='font-family: system-ui, -apple-system, sans-serif; padding: 10px 14px; max-width: 340px;'><div style='font-weight: 700; font-size: 13px; color: #2C3E50; margin-bottom: 6px; border-bottom: 2px solid #eee; padding-bottom: 6px;'>Nivel educativo desde e51_2<\/div><div style='font-family: SFMono-Regular, Consolas, monospace; font-size: 11px; color: #6c757d; background: #f8f9fa; padding: 8px 10px; border-radius: 6px; line-height: 1.5; white-space: pre-wrap;'>edu_level: list(e51_2 == 0 ~ \"Sin instruccion\", e51_2 &gt;= 1 &amp; e51_2 &lt;= 2 ~ \"Primaria\", e51_2 &gt;= 3 &amp; e51_2 &lt;= 4 ~ \"Secundaria\", e51_2 &gt;= 5 &amp; e51_2 &lt;= 6 ~ \"Terciaria\")<\/div><\/div>","<div style='font-family: system-ui, -apple-system, sans-serif; padding: 10px 14px; max-width: 340px;'><div style='font-weight: 700; font-size: 13px; color: #2C3E50; margin-bottom: 6px; border-bottom: 2px solid #eee; padding-bottom: 6px;'>Area geografica desde region_4<\/div><div style='font-family: SFMono-Regular, Consolas, monospace; font-size: 11px; color: #6c757d; background: #f8f9fa; padding: 8px 10px; border-radius: 6px; line-height: 1.5; white-space: pre-wrap;'>area: list(region_4 == 1 ~ \"Montevideo\", region_4 == 2 ~ \"Urbano &gt;5k\", region_4 == 3 ~ \"Urbano &lt;5k\", region_4 == 4 ~ \"Rural\")<\/div><\/div>","<div style='font-family: system-ui, -apple-system, sans-serif; padding: 10px 14px; max-width: 340px;'><div style='font-weight: 700; font-size: 13px; color: #2C3E50; margin-bottom: 6px; border-bottom: 2px solid #eee; padding-bottom: 6px;'>Eliminar variables crudas de ECH<\/div><div style='font-family: SFMono-Regular, Consolas, monospace; font-size: 11px; color: #6c757d; background: #f8f9fa; padding: 8px 10px; border-radius: 6px; line-height: 1.5; white-space: pre-wrap;'>list(vars = c(\"e26\", \"e27\", \"e30\", \"e51_2\", \"region_4\"))<\/div><\/div>"],"group":["Load survey","step_rename","recode","recode","recode","recode","recode","step_remove"]},"edges":{"from":[1,2,3,4,5,6,7],"to":[2,3,4,5,6,7,8]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot"},"manipulation":{"enabled":false},"groups":{"Load survey":{"shape":"icon","icon":{"code":"f1c0","size":60,"color":"#2C3E50"},"font":{"size":16,"color":"#2C3E50","face":"bold","multi":true},"shadow":{"enabled":true,"size":8,"x":2,"y":2,"color":"rgba(44,62,80,.15)"}},"compute":{"shape":"icon","icon":{"code":"f1ec","size":50,"color":"#3498db"},"font":{"size":14,"color":"#2c3e50","face":"bold"},"shadow":{"enabled":true,"size":6,"x":2,"y":2,"color":"rgba(52,152,219,.2)"}},"recode":{"shape":"icon","icon":{"code":"f0e8","size":50,"color":"#9b59b6"},"font":{"size":14,"color":"#2c3e50","face":"bold"},"shadow":{"enabled":true,"size":6,"x":2,"y":2,"color":"rgba(155,89,182,.2)"}},"step_join":{"shape":"icon","icon":{"code":"f0c1","size":50,"color":"#1abc9c"},"font":{"size":14,"color":"#2c3e50","face":"bold"},"shadow":{"enabled":true,"size":6,"x":2,"y":2,"color":"rgba(26,188,156,.2)"}},"step_remove":{"shape":"icon","icon":{"code":"f1f8","size":50,"color":"#e74c3c"},"font":{"size":14,"color":"#2c3e50","face":"bold"},"shadow":{"enabled":true,"size":6,"x":2,"y":2,"color":"rgba(231,76,60,.2)"}},"step_rename":{"shape":"icon","icon":{"code":"f044","size":50,"color":"#e67e22"},"font":{"size":14,"color":"#2c3e50","face":"bold"},"shadow":{"enabled":true,"size":6,"x":2,"y":2,"color":"rgba(230,126,34,.2)"}},"useDefaultGroups":true,"dataframe":{"shape":"icon","icon":{"code":"f0ce","size":50,"color":"#95a5a6"},"font":{"size":14,"color":"#2c3e50"},"shadow":{"enabled":true,"size":6,"x":2,"y":2,"color":"rgba(149,165,166,.2)"}}},"edges":{"width":2,"arrows":{"to":{"enabled":true,"scaleFactor":0.7,"type":"arrow"}},"color":{"color":"#bdc3c7","highlight":"#3498db","hover":"#3498db"},"smooth":{"enabled":true,"type":"curvedCW","roundness":0.1}},"layout":{"hierarchical":{"enabled":true,"levelSeparation":220,"nodeSpacing":140,"direction":"LR","sortMethod":"directed"}},"interaction":{"keyboard":true,"navigationButtons":true,"tooltipDelay":100,"hover":true,"zoomSpeed":1},"clickToUse":false},"groups":["Load survey","step_rename","recode","step_remove"],"width":"100%","height":"600px","idselection":{"enabled":true,"style":"font-family: system-ui, sans-serif; font-size: 13px; padding: 6px 12px; border-radius: 8px; border: 1px solid #dee2e6; background: #fff; color: #2C3E50;","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)","highlight":false},"main":null,"submain":null,"footer":null,"background":"#f8f9fa","iconsRedraw":true,"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);","highlight":{"enabled":true,"hoverNearest":true,"degree":1,"algorithm":"all","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":false,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.15,"useGroups":true,"position":"right","ncol":1,"stepX":100,"stepY":100,"zoom":false,"main":{"text":"Step types","style":"font-family: system-ui, sans-serif; font-weight: 700; font-size: 14px; color: #2C3E50;"}}},"evals":[],"jsHooks":[]}</script><p>Con solo 7 nodos el grafo es limpio y navegable. Comparar con una
receta transpilada donde el DAG puede tener 100+ nodos – aun util para
auditoria, pero mucho mas dificil de leer de un vistazo.</p>
<p>Para salida estatica podemos inspeccionar la lista de steps:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fu"><a href="../reference/get_steps.html">get_steps</a></span><span class="op">(</span><span class="va">svy</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"[%s] %s\n"</span>, <span class="va">s</span><span class="op">$</span><span class="va">type</span>, <span class="va">s</span><span class="op">$</span><span class="va">comment</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="st">""</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [step_rename] Estandarizar identificadores</span></span>
<span><span class="co">#&gt; [recode] Sexo desde e26</span></span>
<span><span class="co">#&gt; [recode] Grupos de edad desde e27</span></span>
<span><span class="co">#&gt; [recode] Relacion desde e30</span></span>
<span><span class="co">#&gt; [recode] Nivel educativo desde e51_2</span></span>
<span><span class="co">#&gt; [recode] Area geografica desde region_4</span></span>
<span><span class="co">#&gt; [step_remove] Eliminar variables crudas de ECH</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="empaquetando-como-receta-antes-de-bake">Empaquetando como receta (antes de bake)<a class="anchor" aria-label="anchor" href="#empaquetando-como-receta-antes-de-bake"></a>
</h2>
<p>Una receta empaqueta los steps con metadatos para que cualquiera
pueda reproducir el mismo pipeline con datos diferentes. Creamos la
receta <strong>antes</strong> de hacer bake – los steps lazy son el
pipeline:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/steps_to_recipe.html">steps_to_recipe</a></span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="st">"ECH Demografia (minima)"</span>,</span>
<span>  user <span class="op">=</span> <span class="st">"equipo_investigacion"</span>,</span>
<span>  svy <span class="op">=</span> <span class="va">svy</span>,</span>
<span>  steps <span class="op">=</span> <span class="fu"><a href="../reference/get_steps.html">get_steps</a></span><span class="op">(</span><span class="va">svy</span><span class="op">)</span>,</span>
<span>  description <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span></span>
<span>    <span class="st">"Demografia armonizada: sexo, grupo de edad, relacion,"</span>,</span>
<span>    <span class="st">"nivel educativo y area geografica."</span></span>
<span>  <span class="op">)</span>,</span>
<span>  topic <span class="op">=</span> <span class="st">"demographics"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">rec</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">#&gt; ── Recipe: ECH Demografia (minima) ──</span></span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">#&gt; </span><span style="color: #555555;">Author:  </span>equipo_investigacion</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Survey:  </span>ech / 2023</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Version: </span>1.0.0</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Topic:   </span>demographics</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Description: </span>Demografia armonizada: sexo, grupo de edad, relacion, nivel educativo y area geografica.</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Certification: </span><span style="color: #BBBB00;">community</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">#&gt; ── Requires (5 variables) ──</span></span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">#&gt; </span>  e26, e27, e30, e51_2, region_4</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">#&gt; ── Pipeline (7 steps) ──</span></span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">#&gt; </span>  1. [step_rename] -&gt; mapping  "Estandarizar identificadores"</span></span>
<span><span class="co">#&gt;   2. [recode] -&gt; sex  "Sexo desde e26"</span></span>
<span><span class="co">#&gt;   3. [recode] -&gt; age_group  "Grupos de edad desde e27"</span></span>
<span><span class="co">#&gt;   4. [recode] -&gt; relationship  "Relacion desde e30"</span></span>
<span><span class="co">#&gt;   5. [recode] -&gt; edu_level  "Nivel educativo desde e51_2"</span></span>
<span><span class="co">#&gt;   6. [recode] -&gt; area  "Area geografica desde region_4"</span></span>
<span><span class="co">#&gt;   7. [step_remove] -&gt; (no output)  "Eliminar variables crudas de ECH"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">#&gt; ── Produces (6 variables) ──</span></span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">#&gt; </span>  sex [categorical], age_group [categorical], relationship [categorical], edu_level [categorical], area [categorical], mapping [inherited]</span></span></code></pre></div>
<p>La receta auto-genera documentacion a partir de los steps:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">doc</span> <span class="op">&lt;-</span> <span class="va">rec</span><span class="op">$</span><span class="fu">doc</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Variables de entrada: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">doc</span><span class="op">$</span><span class="va">input_variables</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Variables de entrada:  e26, e27, e30, e51_2, region_4</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Variables de salida:  "</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">doc</span><span class="op">$</span><span class="va">output_variables</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Variables de salida:   mapping, sex, age_group, relationship, edu_level, area</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Steps del pipeline:   "</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">doc</span><span class="op">$</span><span class="va">pipeline</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Steps del pipeline:    7</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="bake-materializando-el-pipeline">Bake: materializando el pipeline<a class="anchor" aria-label="anchor" href="#bake-materializando-el-pipeline"></a>
</h2>
<p>Ahora ejecutemos los steps. <code><a href="../reference/bake_steps.html">bake_steps()</a></code> ejecuta todos
los steps pendientes en orden y devuelve la encuesta transformada:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bake_steps.html">bake_steps</a></span><span class="op">(</span><span class="va">svy</span><span class="op">)</span></span></code></pre></div>
<p>Los datos tienen las nuevas columnas con etiquetas legibles:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_data.html">get_data</a></span><span class="op">(</span><span class="va">svy</span><span class="op">)</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  <span class="va">hh_id</span>, <span class="va">person_id</span>, <span class="va">sex</span>, <span class="va">age_group</span>, <span class="va">relationship</span>,</span>
<span>  <span class="va">edu_level</span>, <span class="va">area</span></span>
<span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;    hh_id person_id    sex    age_group relationship       edu_level       area</span></span>
<span><span class="co">#&gt;    &lt;int&gt;     &lt;int&gt; &lt;char&gt;       &lt;char&gt;       &lt;char&gt;          &lt;char&gt;     &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:     1         1  Mujer Adulto mayor  No familiar Sin instruccion Urbano &lt;5k</span></span>
<span><span class="co">#&gt; 2:     1         2  Mujer       Adulto         Jefe        Primaria Montevideo</span></span>
<span><span class="co">#&gt; 3:     1         3 Hombre Joven adulto      Conyuge       Terciaria Urbano &lt;5k</span></span>
<span><span class="co">#&gt; 4:     1         4  Mujer       Adulto         Hijo        Primaria      Rural</span></span>
<span><span class="co">#&gt; 5:     2         1 Hombre Adulto mayor         Hijo Sin instruccion Urbano &gt;5k</span></span>
<span><span class="co">#&gt; 6:     2         2 Hombre Joven adulto      Conyuge       Terciaria      Rural</span></span></code></pre></div>
<p>Las variables crudas ya no estan:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="st">"e26"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_data.html">get_data</a></span><span class="op">(</span><span class="va">svy</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="guardar-y-cargar">Guardar y cargar<a class="anchor" aria-label="anchor" href="#guardar-y-cargar"></a>
</h2>
<p>Las recetas se serializan a JSON para control de versiones y
compartir:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".json"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/save_recipe.html">save_recipe</a></span><span class="op">(</span><span class="va">rec</span>, <span class="va">f</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_recipe.html">read_recipe</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span>
<span><span class="va">rec2</span><span class="op">$</span><span class="va">name</span></span>
<span><span class="co">#&gt; [1] "ECH Demografia (minima)"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">rec2</span><span class="op">$</span><span class="va">steps</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 7</span></span></code></pre></div>
<p>El JSON es legible y diffeable en git:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="va">f</span>, n <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;   "name": "ECH Demografia (minima)",</span></span>
<span><span class="co">#&gt;   "user": "equipo_investigacion",</span></span>
<span><span class="co">#&gt;   "survey_type": "ech",</span></span>
<span><span class="co">#&gt;   "edition": 2023,</span></span>
<span><span class="co">#&gt;   "description": "Demografia armonizada: sexo, grupo de edad, relacion, nivel educativo y area geografica.",</span></span>
<span><span class="co">#&gt;   "topic": "demographics",</span></span>
<span><span class="co">#&gt;   "doi": {},</span></span>
<span><span class="co">#&gt;   "id": "r_1771295421_663",</span></span>
<span><span class="co">#&gt;   "version": "1.0.0",</span></span>
<span><span class="co">#&gt;   "downloads": 0,</span></span>
<span><span class="co">#&gt;   "categories": [],</span></span>
<span><span class="co">#&gt;   "certification": {</span></span>
<span><span class="co">#&gt;     "level": "community",</span></span>
<span><span class="co">#&gt;     "certified_at": "2026-02-17 02:30:21.227441"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="aplicando-a-una-nueva-edicion">Aplicando a una nueva edicion<a class="anchor" aria-label="anchor" href="#aplicando-a-una-nueva-edicion"></a>
</h2>
<p>La misma receta funciona con cualquier edicion. Cargar la receta
desde JSON, adjuntarla a nuevos datos y hacer bake:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec_loaded</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_recipe.html">read_recipe</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span>
<span></span>
<span><span class="va">svy_2024</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survey_empty.html">survey_empty</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"ech"</span>, edition <span class="op">=</span> <span class="st">"2024"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_data.html">set_data</a></span><span class="op">(</span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>    id       <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">30</span>, each <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>    nper     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">30</span><span class="op">)</span>,</span>
<span>    pesoano  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">90</span>, <span class="fl">50</span>, <span class="fl">300</span><span class="op">)</span>,</span>
<span>    e26      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">90</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    e27      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">90</span>, <span class="fl">90</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    e30      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">7</span>, <span class="fl">90</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    e51_2    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">6</span>, <span class="op">-</span><span class="fl">9</span><span class="op">)</span>, <span class="fl">90</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    region_4 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="fl">90</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/add_recipe.html">add_recipe</a></span><span class="op">(</span><span class="va">rec_loaded</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/bake_recipes.html">bake_recipes</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_data.html">get_data</a></span><span class="op">(</span><span class="va">svy_2024</span><span class="op">)</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">hh_id</span>, <span class="va">person_id</span>, <span class="va">sex</span>, <span class="va">age_group</span>, <span class="va">area</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;    hh_id person_id    sex    age_group       area</span></span>
<span><span class="co">#&gt;    &lt;int&gt;     &lt;int&gt; &lt;char&gt;       &lt;char&gt;     &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:     1         1 Hombre Adulto mayor      Rural</span></span>
<span><span class="co">#&gt; 2:     1         2 Hombre       Adulto Urbano &lt;5k</span></span>
<span><span class="co">#&gt; 3:     1         3  Mujer Joven adulto Urbano &gt;5k</span></span>
<span><span class="co">#&gt; 4:     2         1 Hombre       Adulto Montevideo</span></span>
<span><span class="co">#&gt; 5:     2         2  Mujer Adulto mayor      Rural</span></span>
<span><span class="co">#&gt; 6:     2         3 Hombre Adulto mayor Urbano &lt;5k</span></span></code></pre></div>
<p>No se necesitan cambios en el codigo. La receta codifica la
<em>logica</em>, no los datos.</p>
</div>
<div class="section level2">
<h2 id="transpilador-vs-artesanal-cuando-usar-cada-uno">Transpilador vs artesanal: cuando usar cada uno<a class="anchor" aria-label="anchor" href="#transpilador-vs-artesanal-cuando-usar-cada-uno"></a>
</h2>
<table class="table">
<colgroup>
<col width="33%">
<col width="33%">
<col width="33%">
</colgroup>
<thead><tr class="header">
<th></th>
<th>Transpilador (<code><a href="../reference/transpile_stata.html">transpile_stata()</a></code>)</th>
<th>Receta artesanal</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><strong>Velocidad</strong></td>
<td>Segundos – migracion instantanea</td>
<td>Horas – requiere entender la logica</td>
</tr>
<tr class="even">
<td><strong>Steps</strong></td>
<td>80-200 por modulo (uno por linea STATA)</td>
<td>5-20 (uno por concepto)</td>
</tr>
<tr class="odd">
<td><strong>Nombres de variables</strong></td>
<td>Hereda nombres STATA (<code>bc_pe2</code>, <code>bc_pe3</code>)</td>
<td>Nombres propios (<code>sex</code>, <code>age_group</code>)</td>
</tr>
<tr class="even">
<td><strong>Etiquetas</strong></td>
<td>Codigos numericos (<code>1</code>, <code>2</code>,
<code>3</code>)</td>
<td>Etiquetas legibles (<code>"Hombre"</code>,
<code>"Mujer"</code>)</td>
</tr>
<tr class="odd">
<td><strong>Legibilidad</strong></td>
<td>Fiel al original, verboso</td>
<td>Limpio, auto-documentado</td>
</tr>
<tr class="even">
<td><strong>Mantenimiento</strong></td>
<td>Dificil modificar steps individuales</td>
<td>Facil cambiar cualquier mapeo</td>
</tr>
<tr class="odd">
<td><strong>Visualizacion DAG</strong></td>
<td>Grande, dificil de leer</td>
<td>Compacto, nodos significativos</td>
</tr>
<tr class="even">
<td><strong>Mejor para</strong></td>
<td>Migrar codigo legacy rapido</td>
<td>Proyectos nuevos, pipelines criticos</td>
</tr>
</tbody>
</table>
<p><strong>Flujo de trabajo recomendado</strong>: usar
<code><a href="../reference/transpile_stata.html">transpile_stata()</a></code> para migrar los archivos <code>.do</code>
existentes inmediatamente para tener un baseline funcional. Luego
reemplazar gradualmente las recetas transpiladas con artesanales a
medida que se revisa cada modulo. La version transpilada mantiene todo
funcionando; la version artesanal es donde se quiere llegar.</p>
</div>
<div class="section level2">
<h2 id="lo-que-metasurvey-ofrece">Lo que metasurvey ofrece<a class="anchor" aria-label="anchor" href="#lo-que-metasurvey-ofrece"></a>
</h2>
<table class="table">
<colgroup>
<col width="50%">
<col width="50%">
</colgroup>
<thead><tr class="header">
<th>Scripts STATA manuales</th>
<th>Receta metasurvey</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Copiar-pegar archivos <code>.do</code> por anio</td>
<td>Una receta, cualquier edicion</td>
</tr>
<tr class="even">
<td>Nombres de variables sin documentar</td>
<td>Documentacion auto-generada de entrada/salida</td>
</tr>
<tr class="odd">
<td>Sin seguimiento de dependencias</td>
<td>Visualizacion DAG con <code><a href="../reference/view_graph.html">view_graph()</a></code>
</td>
</tr>
<tr class="even">
<td>Scripts planos, sin validacion</td>
<td>
<code>validate()</code> verifica variables requeridas</td>
</tr>
<tr class="odd">
<td>Enviar archivos <code>.do</code> por email</td>
<td>
<code><a href="../reference/publish_recipe.html">publish_recipe()</a></code> a registro compartido</td>
</tr>
<tr class="even">
<td>Re-ejecutar todo el script para probar</td>
<td>Steps lazy: inspeccionar antes de bake</td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="proximos-pasos">Proximos pasos<a class="anchor" aria-label="anchor" href="#proximos-pasos"></a>
</h2>
<ul>
<li>
<strong>Agregar mas variables</strong>: ingresos, condicion de
actividad, condiciones de vivienda – cada una puede ser una receta
separada con <code>depends_on_recipes</code>
</li>
<li>
<strong>Certificar la receta</strong>: usar
<code><a href="../reference/certify_recipe.html">certify_recipe()</a></code> para marcarla como revisada u oficial</li>
<li>
<strong>Publicar</strong>: <code>publish_recipe(rec)</code> sube al
registro compartido donde otros pueden encontrarla con
<code>search_recipes(topic = "demographics")</code>
</li>
<li>
<strong>Partir desde STATA</strong>: si ya se tienen archivos
<code>.do</code>, usar <code><a href="../reference/transpile_stata.html">transpile_stata()</a></code> para generar un
baseline funcional inmediatamente – ver
<code><a href="../articles/stata-transpiler-es.html">vignette("stata-transpiler-es")</a></code> – y luego refinar la salida
en una receta artesanal como la de esta vignette</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://www.mauroloprete.com" class="external-link">Mauro Loprete</a>, <a href="https://natydasilva.github.io/natydasilva/" class="external-link">Natalia da Silva</a>, <a href="https://iecon.fcea.udelar.edu.uy/es/autores/item/machado-fabricio.html" class="external-link">Fabricio Machado</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
