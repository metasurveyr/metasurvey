<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Self-Hosting Guide • metasurvey</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Self-Hosting Guide">
<!-- javascript assets for rmarkdown --><meta name="pkgdown-site-root" content="../">
<script src="../ace-1.2.3/ace.js" type="text/javascript" charset="utf-8"></script><script src="../holder-2.9.0/holder.min.js" type="text/javascript" charset="utf-8"></script><script src="../snippets/snippets.js" type="text/javascript" charset="utf-8"></script><style type="text/css">
.snippet {
  border: solid 1px #cccccc;
  margin-bottom: 12px;
  width: 100%;
}
</style>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">metasurvey</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.21</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/metasurveyr/metasurvey/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Self-Hosting Guide</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/metasurveyr/metasurvey/blob/develop/vignettes/self-hosting.Rmd" class="external-link"><code>vignettes/self-hosting.Rmd</code></a></small>
      <div class="d-none name"><code>self-hosting.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>Many organizations publish statistical indicators derived from survey
data (unemployment rates, poverty rates, innovation metrics) without
disclosing how those indicators were computed. The final number is
public, but the methodology – which variables were used, what
transformations were applied, what survey design was used – remains
opaque.</p>
<p>metasurvey solves this by <strong>separating private data from public
methodology</strong>. You can deploy the metasurvey API on your own
infrastructure where:</p>
<ul>
<li>
<strong>Microdata stays private</strong>: raw survey files never
leave your network.</li>
<li>
<strong>Indicators are public</strong>: computed results (point
estimates, standard errors, confidence intervals) are served via the
API.</li>
<li>
<strong>Methodology is transparent</strong>: anyone can query the
recipe (data transformation steps) and the workflow (estimation calls
and survey design) that produced each indicator.</li>
</ul>
<p>The traceability chain is:</p>
<pre class="text"><code>Indicator                Workflow                    Recipe
(the number)      --&gt;    (how it was estimated)  --&gt; (how variables were built)
value: 0.082             svymean(~pd, design)        step_compute(svy, pd = ...)
se: 0.003                estimation_type: annual     step_recode(svy, pea, ...)
cv: 0.037                recipe_ids: [ech_emp_001]   depends_on: [e27, f66, ...]</code></pre>
</div>
<div class="section level2">
<h2 id="architecture">Architecture<a class="anchor" aria-label="anchor" href="#architecture"></a>
</h2>
<p>The system has <strong>two R services</strong>: a public API that
serves indicators and their traceability, and a private
<strong>Worker</strong> that has metasurvey installed and access to
microdata. The worker is the only component that touches raw survey
data.</p>
<div class="figure">
<img src="metasurvey-infrastructure.png" class="r-plt" alt="metasurvey self-hosting infrastructure" width="100%"><p class="caption">
metasurvey self-hosting infrastructure
</p>
</div>
<p><strong>Key separation</strong>: The Worker loads microdata, fetches
recipes from MongoDB, applies them (<code>bake_steps</code>), runs the
estimation (<code>workflow</code>), and posts the result back to the
API. The public API never touches microdata – it only serves
pre-computed indicators and their traceability.</p>
<p>The frontend can also request <strong>on-demand computations</strong>
with filters (e.g., “unemployment rate for women in Montevideo”) via
<code>POST /indicators/compute</code>, which the API proxies to the
Worker.</p>
</div>
<div class="section level2">
<h2 id="quick-start-with-docker-compose">Quick Start with Docker Compose<a class="anchor" aria-label="anchor" href="#quick-start-with-docker-compose"></a>
</h2>
<p>The repository includes a <code>docker-compose.yml</code> that starts
MongoDB, the plumber API, and the Shiny recipe explorer. No external
database required.</p>
<div class="section level3">
<h3 id="clone-and-configure">1. Clone and configure<a class="anchor" aria-label="anchor" href="#clone-and-configure"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/metasurveyr/metasurvey.git</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="bu">cd</span> metasurvey</span></code></pre></div>
<p>Create a <code>.env</code> file (or use the defaults for
development):</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># .env</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="va">MONGO_USER</span><span class="op">=</span>metasurvey</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="va">MONGO_PASSWORD</span><span class="op">=</span>change-me-in-production</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="va">METASURVEY_JWT_SECRET</span><span class="op">=</span>change-me-in-production</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="va">METASURVEY_ADMIN_EMAIL</span><span class="op">=</span>admin@example.com</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="start-the-stack">2. Start the stack<a class="anchor" aria-label="anchor" href="#start-the-stack"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="ex">docker</span> compose up <span class="at">--build</span></span></code></pre></div>
<p>This starts four services:</p>
<table class="table">
<thead><tr class="header">
<th>Service</th>
<th>URL</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>mongo</code></td>
<td><code>localhost:27017</code></td>
<td>MongoDB 7 with persistent volume</td>
</tr>
<tr class="even">
<td><code>worker</code></td>
<td><code>localhost:8788</code></td>
<td>Compute worker (internal only)</td>
</tr>
<tr class="odd">
<td><code>api</code></td>
<td><code>http://localhost:8787</code></td>
<td>Plumber REST API</td>
</tr>
<tr class="even">
<td><code>shiny</code></td>
<td><code>http://localhost:3838</code></td>
<td>Recipe explorer</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="initialize-the-database">3. Initialize the database<a class="anchor" aria-label="anchor" href="#initialize-the-database"></a>
</h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># Create collections and indexes</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="ex">docker</span> compose exec mongo mongosh <span class="dt">\</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>  <span class="at">-u</span> metasurvey <span class="at">-p</span> change-me-in-production <span class="dt">\</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>  <span class="at">--authenticationDatabase</span> admin <span class="dt">\</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>  metasurvey /dev/stdin <span class="op">&lt;</span> inst/scripts/setup_mongodb.js</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="co"># Seed example recipes, workflows, and indicators</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="ex">docker</span> compose exec api Rscript <span class="at">-e</span> <span class="st">'</span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a><span class="st">  Sys.setenv(</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a><span class="st">    METASURVEY_MONGO_URI = "mongodb://metasurvey:change-me-in-production@mongo:27017/?authSource=admin"</span></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a><span class="st">  )</span></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a><span class="st">  source("/app/seed_ech_recipes.R")</span></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a><span class="st">'</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="verify">4. Verify<a class="anchor" aria-label="anchor" href="#verify"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="ex">curl</span> http://localhost:8787/health</span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>  <span class="dt">"status"</span><span class="fu">:</span> <span class="st">"ok"</span><span class="fu">,</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>  <span class="dt">"service"</span><span class="fu">:</span> <span class="st">"metasurvey-api"</span><span class="fu">,</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>  <span class="dt">"mongodb"</span><span class="fu">:</span> <span class="st">"connected"</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="computing-and-publishing-indicators">Computing and Publishing Indicators<a class="anchor" aria-label="anchor" href="#computing-and-publishing-indicators"></a>
</h2>
<p>The typical flow: load survey data, apply a recipe, run a workflow,
and publish the result as an indicator with full traceability.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://metasurveyr.github.io/metasurvey/">metasurvey</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 1. Load survey data (private -- stays on your server)</span></span>
<span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/Survey.html">Survey</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">my_survey_data</span>,</span>
<span>  edition <span class="op">=</span> <span class="st">"2024"</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"ech"</span>,</span>
<span>  engine <span class="op">=</span> <span class="st">"data.table"</span>,</span>
<span>  weight <span class="op">=</span> <span class="fu"><a href="../reference/add_weight.html">add_weight</a></span><span class="op">(</span>annual <span class="op">=</span> <span class="st">"W_ANO"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Apply a recipe (defines variables like unemployment status)</span></span>
<span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/step_compute.html">step_compute</a></span><span class="op">(</span><span class="va">svy</span>,</span>
<span>  pd <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/fcase.html" class="external-link">fcase</a></span><span class="op">(</span></span>
<span>    <span class="va">pobpcoac</span> <span class="op">==</span> <span class="fl">2</span>, <span class="fl">1L</span>,</span>
<span>    <span class="va">pobpcoac</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fl">0L</span></span>
<span>  <span class="op">)</span>,</span>
<span>  comment <span class="op">=</span> <span class="st">"Unemployed: POBPCOAC == 2"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bake_steps.html">bake_steps</a></span><span class="op">(</span><span class="va">svy</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Run the estimation (workflow)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/workflow.html">workflow</a></span><span class="op">(</span></span>
<span>  svy <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">svy</span><span class="op">)</span>,</span>
<span>  <span class="fu">survey</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svymean</a></span><span class="op">(</span><span class="op">~</span><span class="va">pd</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  estimation_type <span class="op">=</span> <span class="st">"annual"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># result is a data.table:</span></span>
<span><span class="co">#       stat      value     se     cv</span></span>
<span><span class="co"># svymean: pd    0.082  0.003  0.037</span></span></code></pre></div>
<p>Now publish the indicator to the API:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Connect to your local API</span></span>
<span><span class="fu"><a href="../reference/configure_api.html">configure_api</a></span><span class="op">(</span><span class="st">"http://localhost:8787"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/api_login.html">api_login</a></span><span class="op">(</span><span class="st">"admin@example.com"</span>, <span class="st">"your-password"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build the indicator payload</span></span>
<span><span class="va">indicator</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="st">"Unemployment Rate 2024"</span>,</span>
<span>  description <span class="op">=</span> <span class="st">"Annual unemployment rate, population 14+"</span>,</span>
<span>  recipe_id <span class="op">=</span> <span class="st">"ech_employment_001"</span>,</span>
<span>  workflow_id <span class="op">=</span> <span class="st">"ech_wf_labor"</span>,</span>
<span>  survey_type <span class="op">=</span> <span class="st">"ech"</span>,</span>
<span>  edition <span class="op">=</span> <span class="st">"2024"</span>,</span>
<span>  estimation_type <span class="op">=</span> <span class="st">"annual"</span>,</span>
<span>  stat <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">stat</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>  value <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">value</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>  se <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">se</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>  cv <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">cv</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>  confint_lower <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">confint_lower</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>  confint_upper <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">confint_upper</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>  metadata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> <span class="st">"~pd"</span>,</span>
<span>    estimation_function <span class="op">=</span> <span class="st">"svymean"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Publish (requires authentication)</span></span>
<span><span class="va">resp</span> <span class="op">&lt;-</span> <span class="fu">httr2</span><span class="fu">::</span><span class="fu"><a href="https://httr2.r-lib.org/reference/request.html" class="external-link">request</a></span><span class="op">(</span><span class="st">"http://localhost:8787/indicators"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">httr2</span><span class="fu">::</span><span class="fu"><a href="https://httr2.r-lib.org/reference/req_headers.html" class="external-link">req_headers</a></span><span class="op">(</span></span>
<span>    Authorization <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Bearer"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"METASURVEY_TOKEN"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">httr2</span><span class="fu">::</span><span class="fu"><a href="https://httr2.r-lib.org/reference/req_body.html" class="external-link">req_body_json</a></span><span class="op">(</span><span class="va">indicator</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">httr2</span><span class="fu">::</span><span class="fu"><a href="https://httr2.r-lib.org/reference/req_perform.html" class="external-link">req_perform</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">httr2</span><span class="fu">::</span><span class="fu"><a href="https://httr2.r-lib.org/reference/resp_body_raw.html" class="external-link">resp_body_json</a></span><span class="op">(</span><span class="va">resp</span><span class="op">)</span></span>
<span><span class="co"># {ok: true, id: "ind_1708099200_42"}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="consuming-indicators-transparency">Consuming Indicators (Transparency)<a class="anchor" aria-label="anchor" href="#consuming-indicators-transparency"></a>
</h2>
<p>Once published, indicators and their full methodology are accessible
<strong>without authentication</strong>. This is the transparency
layer.</p>
<div class="section level3">
<h3 id="get-the-indicator-value">Get the indicator value<a class="anchor" aria-label="anchor" href="#get-the-indicator-value"></a>
</h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="ex">curl</span> http://localhost:8787/indicators/ind_ech_unemployment_2024</span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>  <span class="dt">"ok"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>  <span class="dt">"indicator"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>    <span class="dt">"id"</span><span class="fu">:</span> <span class="st">"ind_ech_unemployment_2024"</span><span class="fu">,</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>    <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Tasa de desempleo 2024"</span><span class="fu">,</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>    <span class="dt">"value"</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.082</span><span class="fu">,</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>    <span class="dt">"se"</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.003</span><span class="fu">,</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>    <span class="dt">"cv"</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.037</span><span class="fu">,</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>    <span class="dt">"confint_lower"</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.076</span><span class="fu">,</span></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>    <span class="dt">"confint_upper"</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.088</span><span class="fu">,</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>    <span class="dt">"survey_type"</span><span class="fu">:</span> <span class="st">"ech"</span><span class="fu">,</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>    <span class="dt">"edition"</span><span class="fu">:</span> <span class="st">"2024"</span><span class="fu">,</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>    <span class="dt">"recipe_id"</span><span class="fu">:</span> <span class="st">"ech_employment_001"</span><span class="fu">,</span></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>    <span class="dt">"workflow_id"</span><span class="fu">:</span> <span class="st">"ech_wf_labor"</span></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="get-the-workflow-how-it-was-estimated">Get the workflow (how it was estimated)<a class="anchor" aria-label="anchor" href="#get-the-workflow-how-it-was-estimated"></a>
</h3>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="ex">curl</span> http://localhost:8787/indicators/ind_ech_unemployment_2024/workflow</span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>  <span class="dt">"ok"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>  <span class="dt">"indicator_id"</span><span class="fu">:</span> <span class="st">"ind_ech_unemployment_2024"</span><span class="fu">,</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>  <span class="dt">"workflow"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>    <span class="dt">"id"</span><span class="fu">:</span> <span class="st">"ech_wf_labor"</span><span class="fu">,</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>    <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Mercado Laboral ECH"</span><span class="fu">,</span></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>    <span class="dt">"estimation_type"</span><span class="fu">:</span> <span class="st">"annual"</span><span class="fu">,</span></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>    <span class="dt">"recipe_ids"</span><span class="fu">:</span> <span class="ot">[</span><span class="st">"ech_pobpcoac_000"</span><span class="ot">,</span> <span class="st">"ech_employment_001"</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>    <span class="dt">"calls"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>      <span class="st">"svymean(~pea, design, na.rm=TRUE)"</span><span class="ot">,</span></span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>      <span class="st">"svymean(~po, design, na.rm=TRUE)"</span><span class="ot">,</span></span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>      <span class="st">"svymean(~pd, design, na.rm=TRUE)"</span></span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>    <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a>    <span class="dt">"call_metadata"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a>      <span class="fu">{</span></span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a>        <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"svymean"</span><span class="fu">,</span></span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a>        <span class="dt">"formula"</span><span class="fu">:</span> <span class="st">"~pea"</span><span class="fu">,</span></span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a>        <span class="dt">"description"</span><span class="fu">:</span> <span class="st">"Tasa de actividad"</span></span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a>      <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a>      <span class="fu">{</span></span>
<span id="cb13-21"><a href="#cb13-21" tabindex="-1"></a>        <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"svymean"</span><span class="fu">,</span></span>
<span id="cb13-22"><a href="#cb13-22" tabindex="-1"></a>        <span class="dt">"formula"</span><span class="fu">:</span> <span class="st">"~pd"</span><span class="fu">,</span></span>
<span id="cb13-23"><a href="#cb13-23" tabindex="-1"></a>        <span class="dt">"description"</span><span class="fu">:</span> <span class="st">"Tasa de desempleo"</span></span>
<span id="cb13-24"><a href="#cb13-24" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb13-25"><a href="#cb13-25" tabindex="-1"></a>    <span class="ot">]</span></span>
<span id="cb13-26"><a href="#cb13-26" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb13-27"><a href="#cb13-27" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>The workflow tells you <strong>what statistical function was
used</strong> (<code>svymean</code>), <strong>what formula</strong>
(<code>~pd</code>), and <strong>which recipes</strong> were applied to
the data before estimation.</p>
</div>
<div class="section level3">
<h3 id="get-the-recipe-how-variables-were-built">Get the recipe (how variables were built)<a class="anchor" aria-label="anchor" href="#get-the-recipe-how-variables-were-built"></a>
</h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="ex">curl</span> http://localhost:8787/indicators/ind_ech_unemployment_2024/recipe</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>  <span class="dt">"ok"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>  <span class="dt">"indicator_id"</span><span class="fu">:</span> <span class="st">"ind_ech_unemployment_2024"</span><span class="fu">,</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>  <span class="dt">"recipe"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>    <span class="dt">"id"</span><span class="fu">:</span> <span class="st">"ech_employment_001"</span><span class="fu">,</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>    <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Employment Status"</span><span class="fu">,</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>    <span class="dt">"steps"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>      <span class="st">"step_compute(svy, po = fcase(pobpcoac == 1, 1L, TRUE, 0L), comment = 'Employed')"</span><span class="ot">,</span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>      <span class="st">"step_compute(svy, pd = fcase(pobpcoac == 2, 1L, TRUE, 0L), comment = 'Unemployed')"</span><span class="ot">,</span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>      <span class="st">"step_compute(svy, pea = fcase(pobpcoac %in% 1:2, 1L, TRUE, 0L), comment = 'EAP')"</span></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>    <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>    <span class="dt">"depends_on"</span><span class="fu">:</span> <span class="ot">[</span><span class="st">"pobpcoac"</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>    <span class="dt">"doc"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>      <span class="dt">"input_variables"</span><span class="fu">:</span> <span class="ot">[</span><span class="st">"pobpcoac"</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a>      <span class="dt">"output_variables"</span><span class="fu">:</span> <span class="ot">[</span><span class="st">"po"</span><span class="ot">,</span> <span class="st">"pd"</span><span class="ot">,</span> <span class="st">"pea"</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a>      <span class="dt">"pipeline"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a>        <span class="fu">{</span><span class="dt">"step"</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"compute"</span><span class="fu">,</span> <span class="dt">"outputs"</span><span class="fu">:</span> <span class="ot">[</span><span class="st">"po"</span><span class="ot">]</span><span class="fu">}</span><span class="ot">,</span></span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a>        <span class="fu">{</span><span class="dt">"step"</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"compute"</span><span class="fu">,</span> <span class="dt">"outputs"</span><span class="fu">:</span> <span class="ot">[</span><span class="st">"pd"</span><span class="ot">]</span><span class="fu">}</span><span class="ot">,</span></span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a>        <span class="fu">{</span><span class="dt">"step"</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"compute"</span><span class="fu">,</span> <span class="dt">"outputs"</span><span class="fu">:</span> <span class="ot">[</span><span class="st">"pea"</span><span class="ot">]</span><span class="fu">}</span></span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a>      <span class="ot">]</span></span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>The recipe tells you <strong>exactly how each variable was
constructed</strong> from the original survey variables. Combined with
the workflow, anyone can verify the full computation chain without
accessing the microdata.</p>
</div>
</div>
<div class="section level2">
<h2 id="indicator-api-reference">Indicator API Reference<a class="anchor" aria-label="anchor" href="#indicator-api-reference"></a>
</h2>
<table class="table">
<colgroup>
<col width="21%">
<col width="27%">
<col width="16%">
<col width="35%">
</colgroup>
<thead><tr class="header">
<th>Method</th>
<th>Endpoint</th>
<th>Auth</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>GET</code></td>
<td><code>/indicators</code></td>
<td>No</td>
<td>List and search published indicators</td>
</tr>
<tr class="even">
<td><code>GET</code></td>
<td><code>/indicators/:id</code></td>
<td>No</td>
<td>Get a single indicator with metadata</td>
</tr>
<tr class="odd">
<td><code>GET</code></td>
<td><code>/indicators/:id/recipe</code></td>
<td>No</td>
<td>Get the recipe that built the variables</td>
</tr>
<tr class="even">
<td><code>GET</code></td>
<td><code>/indicators/:id/workflow</code></td>
<td>No</td>
<td>Get the workflow (estimation + design)</td>
</tr>
<tr class="odd">
<td><code>POST</code></td>
<td><code>/indicators</code></td>
<td>Yes</td>
<td>Publish a computed indicator</td>
</tr>
<tr class="even">
<td><code>POST</code></td>
<td><code>/indicators/compute</code></td>
<td>Yes</td>
<td>On-demand estimation via the Worker (with filters)</td>
</tr>
</tbody>
</table>
<div class="section level3">
<h3 id="query-parameters-for-get-indicators">Query parameters for <code>GET /indicators</code><a class="anchor" aria-label="anchor" href="#query-parameters-for-get-indicators"></a>
</h3>
<table class="table">
<thead><tr class="header">
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>search</code></td>
<td>string</td>
<td>Regex search on indicator name</td>
</tr>
<tr class="even">
<td><code>survey_type</code></td>
<td>string</td>
<td>Filter by survey type</td>
</tr>
<tr class="odd">
<td><code>recipe_id</code></td>
<td>string</td>
<td>Filter by recipe ID</td>
</tr>
<tr class="even">
<td><code>workflow_id</code></td>
<td>string</td>
<td>Filter by workflow ID</td>
</tr>
<tr class="odd">
<td><code>edition</code></td>
<td>string</td>
<td>Filter by survey edition</td>
</tr>
<tr class="even">
<td><code>limit</code></td>
<td>integer</td>
<td>Max results (default 50)</td>
</tr>
<tr class="odd">
<td><code>offset</code></td>
<td>integer</td>
<td>Skip N results (default 0)</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="indicator-document-fields">Indicator document fields<a class="anchor" aria-label="anchor" href="#indicator-document-fields"></a>
</h3>
<table class="table">
<thead><tr class="header">
<th>Field</th>
<th>Type</th>
<th>Required</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>id</code></td>
<td>string</td>
<td>Auto</td>
<td>Unique identifier</td>
</tr>
<tr class="even">
<td><code>name</code></td>
<td>string</td>
<td>Yes</td>
<td>Indicator name</td>
</tr>
<tr class="odd">
<td><code>workflow_id</code></td>
<td>string</td>
<td>Yes</td>
<td>Workflow that produced it</td>
</tr>
<tr class="even">
<td><code>value</code></td>
<td>number</td>
<td>Yes</td>
<td>Point estimate</td>
</tr>
<tr class="odd">
<td><code>recipe_id</code></td>
<td>string</td>
<td>No</td>
<td>Recipe that built variables</td>
</tr>
<tr class="even">
<td><code>description</code></td>
<td>string</td>
<td>No</td>
<td>Human-readable description</td>
</tr>
<tr class="odd">
<td><code>survey_type</code></td>
<td>string</td>
<td>No</td>
<td>Survey type</td>
</tr>
<tr class="even">
<td><code>edition</code></td>
<td>string</td>
<td>No</td>
<td>Survey edition</td>
</tr>
<tr class="odd">
<td><code>estimation_type</code></td>
<td>string</td>
<td>No</td>
<td>
<code>annual</code>, <code>quarterly</code>,
<code>monthly</code>
</td>
</tr>
<tr class="even">
<td><code>stat</code></td>
<td>string</td>
<td>No</td>
<td>Statistic label (e.g., <code>svymean: pd</code>)</td>
</tr>
<tr class="odd">
<td><code>se</code></td>
<td>number</td>
<td>No</td>
<td>Standard error</td>
</tr>
<tr class="even">
<td><code>cv</code></td>
<td>number</td>
<td>No</td>
<td>Coefficient of variation</td>
</tr>
<tr class="odd">
<td><code>confint_lower</code></td>
<td>number</td>
<td>No</td>
<td>Lower bound of confidence interval</td>
</tr>
<tr class="even">
<td><code>confint_upper</code></td>
<td>number</td>
<td>No</td>
<td>Upper bound of confidence interval</td>
</tr>
<tr class="odd">
<td><code>metadata</code></td>
<td>object</td>
<td>No</td>
<td>Additional context (formula, notes)</td>
</tr>
<tr class="even">
<td><code>published_at</code></td>
<td>string</td>
<td>Auto</td>
<td>ISO timestamp</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="deploying-with-minikube">Deploying with Minikube<a class="anchor" aria-label="anchor" href="#deploying-with-minikube"></a>
</h2>
<p>For Kubernetes-based deployment, you can test locally with <a href="https://minikube.sigs.k8s.io/" class="external-link">Minikube</a>.</p>
<div class="section level3">
<h3 id="start-minikube">Start Minikube<a class="anchor" aria-label="anchor" href="#start-minikube"></a>
</h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="ex">minikube</span> start</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="mongodb-deployment">MongoDB deployment<a class="anchor" aria-label="anchor" href="#mongodb-deployment"></a>
</h3>
<div class="sourceCode" id="cb17"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="co"># k8s/mongo.yaml</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-mongo</span></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> metasurvey</span></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-mongo</span></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-mongo</span></span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> mongo</span></span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a><span class="at">          </span><span class="fu">image</span><span class="kw">:</span><span class="at"> mongo:7</span></span>
<span id="cb17-20"><a href="#cb17-20" tabindex="-1"></a><span class="at">          </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb17-21"><a href="#cb17-21" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">27017</span></span>
<span id="cb17-22"><a href="#cb17-22" tabindex="-1"></a><span class="at">          </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb17-23"><a href="#cb17-23" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> MONGO_INITDB_ROOT_USERNAME</span></span>
<span id="cb17-24"><a href="#cb17-24" tabindex="-1"></a><span class="at">              </span><span class="fu">value</span><span class="kw">:</span><span class="at"> metasurvey</span></span>
<span id="cb17-25"><a href="#cb17-25" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> MONGO_INITDB_ROOT_PASSWORD</span></span>
<span id="cb17-26"><a href="#cb17-26" tabindex="-1"></a><span class="at">              </span><span class="fu">valueFrom</span><span class="kw">:</span></span>
<span id="cb17-27"><a href="#cb17-27" tabindex="-1"></a><span class="at">                </span><span class="fu">secretKeyRef</span><span class="kw">:</span></span>
<span id="cb17-28"><a href="#cb17-28" tabindex="-1"></a><span class="at">                  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-secrets</span></span>
<span id="cb17-29"><a href="#cb17-29" tabindex="-1"></a><span class="at">                  </span><span class="fu">key</span><span class="kw">:</span><span class="at"> mongo-password</span></span>
<span id="cb17-30"><a href="#cb17-30" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb17-31"><a href="#cb17-31" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb17-32"><a href="#cb17-32" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb17-33"><a href="#cb17-33" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb17-34"><a href="#cb17-34" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> mongo-service</span></span>
<span id="cb17-35"><a href="#cb17-35" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> metasurvey</span></span>
<span id="cb17-36"><a href="#cb17-36" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb17-37"><a href="#cb17-37" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb17-38"><a href="#cb17-38" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-mongo</span></span>
<span id="cb17-39"><a href="#cb17-39" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb17-40"><a href="#cb17-40" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">27017</span></span>
<span id="cb17-41"><a href="#cb17-41" tabindex="-1"></a><span class="at">      </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">27017</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="worker-deployment">Worker deployment<a class="anchor" aria-label="anchor" href="#worker-deployment"></a>
</h3>
<div class="sourceCode" id="cb18"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="co"># k8s/worker.yaml</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-worker</span></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> metasurvey</span></span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-worker</span></span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb18-15"><a href="#cb18-15" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-worker</span></span>
<span id="cb18-16"><a href="#cb18-16" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb18-17"><a href="#cb18-17" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb18-18"><a href="#cb18-18" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> worker</span></span>
<span id="cb18-19"><a href="#cb18-19" tabindex="-1"></a><span class="at">          </span><span class="fu">image</span><span class="kw">:</span><span class="at"> ghcr.io/metasurveyr/metasurvey-worker:latest</span></span>
<span id="cb18-20"><a href="#cb18-20" tabindex="-1"></a><span class="at">          </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb18-21"><a href="#cb18-21" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">8788</span></span>
<span id="cb18-22"><a href="#cb18-22" tabindex="-1"></a><span class="at">          </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb18-23"><a href="#cb18-23" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> METASURVEY_MONGO_URI</span></span>
<span id="cb18-24"><a href="#cb18-24" tabindex="-1"></a><span class="at">              </span><span class="fu">value</span><span class="kw">:</span><span class="at"> </span><span class="st">"mongodb://metasurvey:$(MONGO_PASSWORD)@mongo-service:27017/?authSource=admin"</span></span>
<span id="cb18-25"><a href="#cb18-25" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> MONGO_PASSWORD</span></span>
<span id="cb18-26"><a href="#cb18-26" tabindex="-1"></a><span class="at">              </span><span class="fu">valueFrom</span><span class="kw">:</span></span>
<span id="cb18-27"><a href="#cb18-27" tabindex="-1"></a><span class="at">                </span><span class="fu">secretKeyRef</span><span class="kw">:</span></span>
<span id="cb18-28"><a href="#cb18-28" tabindex="-1"></a><span class="at">                  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-secrets</span></span>
<span id="cb18-29"><a href="#cb18-29" tabindex="-1"></a><span class="at">                  </span><span class="fu">key</span><span class="kw">:</span><span class="at"> mongo-password</span></span>
<span id="cb18-30"><a href="#cb18-30" tabindex="-1"></a><span class="at">          </span><span class="fu">volumeMounts</span><span class="kw">:</span></span>
<span id="cb18-31"><a href="#cb18-31" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> survey-data</span></span>
<span id="cb18-32"><a href="#cb18-32" tabindex="-1"></a><span class="at">              </span><span class="fu">mountPath</span><span class="kw">:</span><span class="at"> /data/surveys</span></span>
<span id="cb18-33"><a href="#cb18-33" tabindex="-1"></a><span class="at">              </span><span class="fu">readOnly</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb18-34"><a href="#cb18-34" tabindex="-1"></a><span class="at">          </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb18-35"><a href="#cb18-35" tabindex="-1"></a><span class="at">            </span><span class="fu">requests</span><span class="kw">:</span></span>
<span id="cb18-36"><a href="#cb18-36" tabindex="-1"></a><span class="at">              </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">"1Gi"</span></span>
<span id="cb18-37"><a href="#cb18-37" tabindex="-1"></a><span class="at">              </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">"500m"</span></span>
<span id="cb18-38"><a href="#cb18-38" tabindex="-1"></a><span class="at">            </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb18-39"><a href="#cb18-39" tabindex="-1"></a><span class="at">              </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">"4Gi"</span></span>
<span id="cb18-40"><a href="#cb18-40" tabindex="-1"></a><span class="at">              </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">"2000m"</span></span>
<span id="cb18-41"><a href="#cb18-41" tabindex="-1"></a><span class="at">      </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb18-42"><a href="#cb18-42" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> survey-data</span></span>
<span id="cb18-43"><a href="#cb18-43" tabindex="-1"></a><span class="at">          </span><span class="fu">persistentVolumeClaim</span><span class="kw">:</span></span>
<span id="cb18-44"><a href="#cb18-44" tabindex="-1"></a><span class="at">            </span><span class="fu">claimName</span><span class="kw">:</span><span class="at"> survey-microdata-pvc</span></span>
<span id="cb18-45"><a href="#cb18-45" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb18-46"><a href="#cb18-46" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb18-47"><a href="#cb18-47" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb18-48"><a href="#cb18-48" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb18-49"><a href="#cb18-49" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> worker-service</span></span>
<span id="cb18-50"><a href="#cb18-50" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> metasurvey</span></span>
<span id="cb18-51"><a href="#cb18-51" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb18-52"><a href="#cb18-52" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb18-53"><a href="#cb18-53" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-worker</span></span>
<span id="cb18-54"><a href="#cb18-54" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb18-55"><a href="#cb18-55" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8788</span></span>
<span id="cb18-56"><a href="#cb18-56" tabindex="-1"></a><span class="at">      </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">8788</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="api-deployment">API deployment<a class="anchor" aria-label="anchor" href="#api-deployment"></a>
</h3>
<div class="sourceCode" id="cb19"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="co"># k8s/api.yaml</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> metasurvey</span></span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb19-15"><a href="#cb19-15" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb19-16"><a href="#cb19-16" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb19-17"><a href="#cb19-17" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb19-18"><a href="#cb19-18" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> api</span></span>
<span id="cb19-19"><a href="#cb19-19" tabindex="-1"></a><span class="at">          </span><span class="fu">image</span><span class="kw">:</span><span class="at"> ghcr.io/metasurveyr/metasurvey-api:latest</span></span>
<span id="cb19-20"><a href="#cb19-20" tabindex="-1"></a><span class="at">          </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb19-21"><a href="#cb19-21" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span>
<span id="cb19-22"><a href="#cb19-22" tabindex="-1"></a><span class="at">          </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb19-23"><a href="#cb19-23" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> METASURVEY_MONGO_URI</span></span>
<span id="cb19-24"><a href="#cb19-24" tabindex="-1"></a><span class="at">              </span><span class="fu">value</span><span class="kw">:</span><span class="at"> </span><span class="st">"mongodb://metasurvey:$(MONGO_PASSWORD)@mongo-service:27017/?authSource=admin"</span></span>
<span id="cb19-25"><a href="#cb19-25" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> MONGO_PASSWORD</span></span>
<span id="cb19-26"><a href="#cb19-26" tabindex="-1"></a><span class="at">              </span><span class="fu">valueFrom</span><span class="kw">:</span></span>
<span id="cb19-27"><a href="#cb19-27" tabindex="-1"></a><span class="at">                </span><span class="fu">secretKeyRef</span><span class="kw">:</span></span>
<span id="cb19-28"><a href="#cb19-28" tabindex="-1"></a><span class="at">                  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-secrets</span></span>
<span id="cb19-29"><a href="#cb19-29" tabindex="-1"></a><span class="at">                  </span><span class="fu">key</span><span class="kw">:</span><span class="at"> mongo-password</span></span>
<span id="cb19-30"><a href="#cb19-30" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> METASURVEY_JWT_SECRET</span></span>
<span id="cb19-31"><a href="#cb19-31" tabindex="-1"></a><span class="at">              </span><span class="fu">valueFrom</span><span class="kw">:</span></span>
<span id="cb19-32"><a href="#cb19-32" tabindex="-1"></a><span class="at">                </span><span class="fu">secretKeyRef</span><span class="kw">:</span></span>
<span id="cb19-33"><a href="#cb19-33" tabindex="-1"></a><span class="at">                  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-secrets</span></span>
<span id="cb19-34"><a href="#cb19-34" tabindex="-1"></a><span class="at">                  </span><span class="fu">key</span><span class="kw">:</span><span class="at"> jwt-secret</span></span>
<span id="cb19-35"><a href="#cb19-35" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> METASURVEY_WORKER_URL</span></span>
<span id="cb19-36"><a href="#cb19-36" tabindex="-1"></a><span class="at">              </span><span class="fu">value</span><span class="kw">:</span><span class="at"> </span><span class="st">"http://worker-service:8788"</span></span>
<span id="cb19-37"><a href="#cb19-37" tabindex="-1"></a><span class="at">          </span><span class="fu">livenessProbe</span><span class="kw">:</span></span>
<span id="cb19-38"><a href="#cb19-38" tabindex="-1"></a><span class="at">            </span><span class="fu">httpGet</span><span class="kw">:</span></span>
<span id="cb19-39"><a href="#cb19-39" tabindex="-1"></a><span class="at">              </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /health</span></span>
<span id="cb19-40"><a href="#cb19-40" tabindex="-1"></a><span class="at">              </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span>
<span id="cb19-41"><a href="#cb19-41" tabindex="-1"></a><span class="at">            </span><span class="fu">initialDelaySeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">30</span></span>
<span id="cb19-42"><a href="#cb19-42" tabindex="-1"></a><span class="at">          </span><span class="fu">readinessProbe</span><span class="kw">:</span></span>
<span id="cb19-43"><a href="#cb19-43" tabindex="-1"></a><span class="at">            </span><span class="fu">httpGet</span><span class="kw">:</span></span>
<span id="cb19-44"><a href="#cb19-44" tabindex="-1"></a><span class="at">              </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /health</span></span>
<span id="cb19-45"><a href="#cb19-45" tabindex="-1"></a><span class="at">              </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span>
<span id="cb19-46"><a href="#cb19-46" tabindex="-1"></a><span class="at">            </span><span class="fu">initialDelaySeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">10</span></span>
<span id="cb19-47"><a href="#cb19-47" tabindex="-1"></a><span class="at">          </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb19-48"><a href="#cb19-48" tabindex="-1"></a><span class="at">            </span><span class="fu">requests</span><span class="kw">:</span></span>
<span id="cb19-49"><a href="#cb19-49" tabindex="-1"></a><span class="at">              </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">"512Mi"</span></span>
<span id="cb19-50"><a href="#cb19-50" tabindex="-1"></a><span class="at">              </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">"250m"</span></span>
<span id="cb19-51"><a href="#cb19-51" tabindex="-1"></a><span class="at">            </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb19-52"><a href="#cb19-52" tabindex="-1"></a><span class="at">              </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">"1Gi"</span></span>
<span id="cb19-53"><a href="#cb19-53" tabindex="-1"></a><span class="at">              </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">"500m"</span></span>
<span id="cb19-54"><a href="#cb19-54" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb19-55"><a href="#cb19-55" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb19-56"><a href="#cb19-56" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb19-57"><a href="#cb19-57" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb19-58"><a href="#cb19-58" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb19-59"><a href="#cb19-59" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> metasurvey</span></span>
<span id="cb19-60"><a href="#cb19-60" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb19-61"><a href="#cb19-61" tabindex="-1"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> NodePort</span></span>
<span id="cb19-62"><a href="#cb19-62" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb19-63"><a href="#cb19-63" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb19-64"><a href="#cb19-64" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb19-65"><a href="#cb19-65" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span>
<span id="cb19-66"><a href="#cb19-66" tabindex="-1"></a><span class="at">      </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="apply-and-test">Apply and test<a class="anchor" aria-label="anchor" href="#apply-and-test"></a>
</h3>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="ex">kubectl</span> create namespace metasurvey</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a><span class="ex">kubectl</span> create secret generic metasurvey-secrets <span class="dt">\</span></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>  <span class="at">--namespace</span> metasurvey <span class="dt">\</span></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>  <span class="at">--from-literal</span><span class="op">=</span>mongo-password=change-me <span class="dt">\</span></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>  <span class="at">--from-literal</span><span class="op">=</span>jwt-secret=change-me</span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> k8s/mongo.yaml <span class="at">-f</span> k8s/worker.yaml <span class="at">-f</span> k8s/api.yaml</span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a><span class="co"># Access the API</span></span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a><span class="ex">minikube</span> service metasurvey-api <span class="at">-n</span> metasurvey</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="deploying-on-aws-eks">Deploying on AWS (EKS)<a class="anchor" aria-label="anchor" href="#deploying-on-aws-eks"></a>
</h2>
<p>For production on AWS, use <a href="https://aws.amazon.com/eks/" class="external-link">EKS</a> with DocumentDB (MongoDB
compatible) as the managed database.</p>
<div class="section level3">
<h3 id="create-the-eks-cluster">1. Create the EKS cluster<a class="anchor" aria-label="anchor" href="#create-the-eks-cluster"></a>
</h3>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="co"># Requires: aws-cli, eksctl</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a><span class="ex">eksctl</span> create cluster <span class="dt">\</span></span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>  <span class="at">--name</span> metasurvey-prod <span class="dt">\</span></span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a>  <span class="at">--region</span> sa-east-1 <span class="dt">\</span></span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a>  <span class="at">--node-type</span> t3.medium <span class="dt">\</span></span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a>  <span class="at">--nodes</span> 2 <span class="dt">\</span></span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a>  <span class="at">--nodes-min</span> 1 <span class="dt">\</span></span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a>  <span class="at">--nodes-max</span> 5</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="create-documentdb-mongodb-compatible">2. Create DocumentDB (MongoDB compatible)<a class="anchor" aria-label="anchor" href="#create-documentdb-mongodb-compatible"></a>
</h3>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="ex">aws</span> docdb create-db-cluster <span class="dt">\</span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>  <span class="at">--db-cluster-identifier</span> metasurvey-db <span class="dt">\</span></span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>  <span class="at">--engine</span> docdb <span class="dt">\</span></span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>  <span class="at">--master-username</span> metasurvey_admin <span class="dt">\</span></span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a>  <span class="at">--master-user-password</span> <span class="st">"</span><span class="va">$DB_PASSWORD</span><span class="st">"</span> <span class="dt">\</span></span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a>  <span class="at">--vpc-security-group-ids</span> <span class="st">"</span><span class="va">$SG_ID</span><span class="st">"</span> <span class="dt">\</span></span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a>  <span class="at">--db-subnet-group-name</span> <span class="st">"</span><span class="va">$SUBNET_GROUP</span><span class="st">"</span></span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a><span class="ex">aws</span> docdb create-db-instance <span class="dt">\</span></span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a>  <span class="at">--db-instance-identifier</span> metasurvey-db-1 <span class="dt">\</span></span>
<span id="cb22-11"><a href="#cb22-11" tabindex="-1"></a>  <span class="at">--db-cluster-identifier</span> metasurvey-db <span class="dt">\</span></span>
<span id="cb22-12"><a href="#cb22-12" tabindex="-1"></a>  <span class="at">--db-instance-class</span> db.r6g.large <span class="dt">\</span></span>
<span id="cb22-13"><a href="#cb22-13" tabindex="-1"></a>  <span class="at">--engine</span> docdb</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="configure-secrets-in-kubernetes">3. Configure secrets in Kubernetes<a class="anchor" aria-label="anchor" href="#configure-secrets-in-kubernetes"></a>
</h3>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="ex">aws</span> eks update-kubeconfig <span class="at">--name</span> metasurvey-prod <span class="at">--region</span> sa-east-1</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a><span class="ex">kubectl</span> create namespace metasurvey</span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a><span class="ex">kubectl</span> create secret generic metasurvey-secrets <span class="dt">\</span></span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a>  <span class="at">--namespace</span> metasurvey <span class="dt">\</span></span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a>  <span class="at">--from-literal</span><span class="op">=</span>mongo-uri=<span class="st">"mongodb://metasurvey_admin:</span><span class="va">$DB_PASSWORD</span><span class="st">@metasurvey-db.cluster-xxx.sa-east-1.docdb.amazonaws.com:27017/?tls=true&amp;tlsCAFile=/rds-combined-ca-bundle.pem&amp;retryWrites=false"</span> <span class="dt">\</span></span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a>  <span class="at">--from-literal</span><span class="op">=</span>jwt-secret=<span class="st">"</span><span class="va">$(</span><span class="ex">openssl</span> rand <span class="at">-hex</span> 32<span class="va">)</span><span class="st">"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="deployment-with-alb-ingress">4. Deployment with ALB Ingress<a class="anchor" aria-label="anchor" href="#deployment-with-alb-ingress"></a>
</h3>
<div class="sourceCode" id="cb24"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="co"># k8s/aws-api.yaml</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> metasurvey</span></span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb24-11"><a href="#cb24-11" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb24-12"><a href="#cb24-12" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb24-13"><a href="#cb24-13" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb24-14"><a href="#cb24-14" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb24-15"><a href="#cb24-15" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb24-16"><a href="#cb24-16" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb24-17"><a href="#cb24-17" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb24-18"><a href="#cb24-18" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> api</span></span>
<span id="cb24-19"><a href="#cb24-19" tabindex="-1"></a><span class="at">          </span><span class="fu">image</span><span class="kw">:</span><span class="at"> ghcr.io/metasurveyr/metasurvey-api:latest</span></span>
<span id="cb24-20"><a href="#cb24-20" tabindex="-1"></a><span class="at">          </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb24-21"><a href="#cb24-21" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span>
<span id="cb24-22"><a href="#cb24-22" tabindex="-1"></a><span class="at">          </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb24-23"><a href="#cb24-23" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> METASURVEY_MONGO_URI</span></span>
<span id="cb24-24"><a href="#cb24-24" tabindex="-1"></a><span class="at">              </span><span class="fu">valueFrom</span><span class="kw">:</span></span>
<span id="cb24-25"><a href="#cb24-25" tabindex="-1"></a><span class="at">                </span><span class="fu">secretKeyRef</span><span class="kw">:</span></span>
<span id="cb24-26"><a href="#cb24-26" tabindex="-1"></a><span class="at">                  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-secrets</span></span>
<span id="cb24-27"><a href="#cb24-27" tabindex="-1"></a><span class="at">                  </span><span class="fu">key</span><span class="kw">:</span><span class="at"> mongo-uri</span></span>
<span id="cb24-28"><a href="#cb24-28" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> METASURVEY_JWT_SECRET</span></span>
<span id="cb24-29"><a href="#cb24-29" tabindex="-1"></a><span class="at">              </span><span class="fu">valueFrom</span><span class="kw">:</span></span>
<span id="cb24-30"><a href="#cb24-30" tabindex="-1"></a><span class="at">                </span><span class="fu">secretKeyRef</span><span class="kw">:</span></span>
<span id="cb24-31"><a href="#cb24-31" tabindex="-1"></a><span class="at">                  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-secrets</span></span>
<span id="cb24-32"><a href="#cb24-32" tabindex="-1"></a><span class="at">                  </span><span class="fu">key</span><span class="kw">:</span><span class="at"> jwt-secret</span></span>
<span id="cb24-33"><a href="#cb24-33" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> METASURVEY_WORKER_URL</span></span>
<span id="cb24-34"><a href="#cb24-34" tabindex="-1"></a><span class="at">              </span><span class="fu">value</span><span class="kw">:</span><span class="at"> </span><span class="st">"http://worker-service:8788"</span></span>
<span id="cb24-35"><a href="#cb24-35" tabindex="-1"></a><span class="at">          </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb24-36"><a href="#cb24-36" tabindex="-1"></a><span class="at">            </span><span class="fu">requests</span><span class="kw">:</span></span>
<span id="cb24-37"><a href="#cb24-37" tabindex="-1"></a><span class="at">              </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">"512Mi"</span></span>
<span id="cb24-38"><a href="#cb24-38" tabindex="-1"></a><span class="at">              </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">"250m"</span></span>
<span id="cb24-39"><a href="#cb24-39" tabindex="-1"></a><span class="at">            </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb24-40"><a href="#cb24-40" tabindex="-1"></a><span class="at">              </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">"1Gi"</span></span>
<span id="cb24-41"><a href="#cb24-41" tabindex="-1"></a><span class="at">              </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">"500m"</span></span>
<span id="cb24-42"><a href="#cb24-42" tabindex="-1"></a><span class="at">          </span><span class="fu">livenessProbe</span><span class="kw">:</span></span>
<span id="cb24-43"><a href="#cb24-43" tabindex="-1"></a><span class="at">            </span><span class="fu">httpGet</span><span class="kw">:</span></span>
<span id="cb24-44"><a href="#cb24-44" tabindex="-1"></a><span class="at">              </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /health</span></span>
<span id="cb24-45"><a href="#cb24-45" tabindex="-1"></a><span class="at">              </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span>
<span id="cb24-46"><a href="#cb24-46" tabindex="-1"></a><span class="at">            </span><span class="fu">initialDelaySeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">30</span></span>
<span id="cb24-47"><a href="#cb24-47" tabindex="-1"></a><span class="at">          </span><span class="fu">readinessProbe</span><span class="kw">:</span></span>
<span id="cb24-48"><a href="#cb24-48" tabindex="-1"></a><span class="at">            </span><span class="fu">httpGet</span><span class="kw">:</span></span>
<span id="cb24-49"><a href="#cb24-49" tabindex="-1"></a><span class="at">              </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /health</span></span>
<span id="cb24-50"><a href="#cb24-50" tabindex="-1"></a><span class="at">              </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span>
<span id="cb24-51"><a href="#cb24-51" tabindex="-1"></a><span class="at">            </span><span class="fu">initialDelaySeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">10</span></span>
<span id="cb24-52"><a href="#cb24-52" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb24-53"><a href="#cb24-53" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb24-54"><a href="#cb24-54" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb24-55"><a href="#cb24-55" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb24-56"><a href="#cb24-56" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb24-57"><a href="#cb24-57" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> metasurvey</span></span>
<span id="cb24-58"><a href="#cb24-58" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb24-59"><a href="#cb24-59" tabindex="-1"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> ClusterIP</span></span>
<span id="cb24-60"><a href="#cb24-60" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb24-61"><a href="#cb24-61" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb24-62"><a href="#cb24-62" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb24-63"><a href="#cb24-63" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span>
<span id="cb24-64"><a href="#cb24-64" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb24-65"><a href="#cb24-65" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> networking.k8s.io/v1</span></span>
<span id="cb24-66"><a href="#cb24-66" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Ingress</span></span>
<span id="cb24-67"><a href="#cb24-67" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb24-68"><a href="#cb24-68" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-ingress</span></span>
<span id="cb24-69"><a href="#cb24-69" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> metasurvey</span></span>
<span id="cb24-70"><a href="#cb24-70" tabindex="-1"></a><span class="at">  </span><span class="fu">annotations</span><span class="kw">:</span></span>
<span id="cb24-71"><a href="#cb24-71" tabindex="-1"></a><span class="at">    </span><span class="fu">kubernetes.io/ingress.class</span><span class="kw">:</span><span class="at"> alb</span></span>
<span id="cb24-72"><a href="#cb24-72" tabindex="-1"></a><span class="at">    </span><span class="fu">alb.ingress.kubernetes.io/scheme</span><span class="kw">:</span><span class="at"> internet-facing</span></span>
<span id="cb24-73"><a href="#cb24-73" tabindex="-1"></a><span class="at">    </span><span class="fu">alb.ingress.kubernetes.io/target-type</span><span class="kw">:</span><span class="at"> ip</span></span>
<span id="cb24-74"><a href="#cb24-74" tabindex="-1"></a><span class="at">    </span><span class="fu">alb.ingress.kubernetes.io/certificate-arn</span><span class="kw">:</span><span class="at"> </span><span class="st">"$ACM_CERT_ARN"</span></span>
<span id="cb24-75"><a href="#cb24-75" tabindex="-1"></a><span class="at">    </span><span class="fu">alb.ingress.kubernetes.io/listen-ports</span><span class="kw">:</span><span class="at"> </span><span class="st">'[{"HTTPS":443}]'</span></span>
<span id="cb24-76"><a href="#cb24-76" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb24-77"><a href="#cb24-77" tabindex="-1"></a><span class="at">  </span><span class="fu">rules</span><span class="kw">:</span></span>
<span id="cb24-78"><a href="#cb24-78" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">host</span><span class="kw">:</span><span class="at"> api.metasurvey.example.org</span></span>
<span id="cb24-79"><a href="#cb24-79" tabindex="-1"></a><span class="at">      </span><span class="fu">http</span><span class="kw">:</span></span>
<span id="cb24-80"><a href="#cb24-80" tabindex="-1"></a><span class="at">        </span><span class="fu">paths</span><span class="kw">:</span></span>
<span id="cb24-81"><a href="#cb24-81" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /</span></span>
<span id="cb24-82"><a href="#cb24-82" tabindex="-1"></a><span class="at">            </span><span class="fu">pathType</span><span class="kw">:</span><span class="at"> Prefix</span></span>
<span id="cb24-83"><a href="#cb24-83" tabindex="-1"></a><span class="at">            </span><span class="fu">backend</span><span class="kw">:</span></span>
<span id="cb24-84"><a href="#cb24-84" tabindex="-1"></a><span class="at">              </span><span class="fu">service</span><span class="kw">:</span></span>
<span id="cb24-85"><a href="#cb24-85" tabindex="-1"></a><span class="at">                </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb24-86"><a href="#cb24-86" tabindex="-1"></a><span class="at">                </span><span class="fu">port</span><span class="kw">:</span></span>
<span id="cb24-87"><a href="#cb24-87" tabindex="-1"></a><span class="at">                  </span><span class="fu">number</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="co"># Install AWS Load Balancer Controller (if not installed)</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a><span class="ex">helm</span> repo add eks https://aws.github.io/eks-charts</span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a><span class="ex">helm</span> install aws-load-balancer-controller eks/aws-load-balancer-controller <span class="dt">\</span></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a>  <span class="at">-n</span> kube-system <span class="dt">\</span></span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a>  <span class="at">--set</span> clusterName=metasurvey-prod</span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> k8s/aws-api.yaml</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="deploying-on-azure-aks">Deploying on Azure (AKS)<a class="anchor" aria-label="anchor" href="#deploying-on-azure-aks"></a>
</h2>
<p>For production on Azure, use <a href="https://azure.microsoft.com/en-us/products/kubernetes-service/" class="external-link">AKS</a>
with CosmosDB (MongoDB API) as the managed database.</p>
<div class="section level3">
<h3 id="create-the-aks-cluster">1. Create the AKS cluster<a class="anchor" aria-label="anchor" href="#create-the-aks-cluster"></a>
</h3>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="co"># Requires: az cli</span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a><span class="ex">az</span> group create <span class="at">--name</span> rg-metasurvey <span class="at">--location</span> brazilsouth</span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a><span class="ex">az</span> aks create <span class="dt">\</span></span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a>  <span class="at">--resource-group</span> rg-metasurvey <span class="dt">\</span></span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a>  <span class="at">--name</span> aks-metasurvey <span class="dt">\</span></span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a>  <span class="at">--node-count</span> 2 <span class="dt">\</span></span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a>  <span class="at">--node-vm-size</span> Standard_B2ms <span class="dt">\</span></span>
<span id="cb26-9"><a href="#cb26-9" tabindex="-1"></a>  <span class="at">--generate-ssh-keys</span> <span class="dt">\</span></span>
<span id="cb26-10"><a href="#cb26-10" tabindex="-1"></a>  <span class="at">--enable-managed-identity</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="create-cosmosdb-with-mongodb-api">2. Create CosmosDB with MongoDB API<a class="anchor" aria-label="anchor" href="#create-cosmosdb-with-mongodb-api"></a>
</h3>
<div class="sourceCode" id="cb27"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="ex">az</span> cosmosdb create <span class="dt">\</span></span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a>  <span class="at">--name</span> cosmos-metasurvey <span class="dt">\</span></span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a>  <span class="at">--resource-group</span> rg-metasurvey <span class="dt">\</span></span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a>  <span class="at">--kind</span> MongoDB <span class="dt">\</span></span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a>  <span class="at">--capabilities</span> EnableMongo <span class="dt">\</span></span>
<span id="cb27-6"><a href="#cb27-6" tabindex="-1"></a>  <span class="at">--default-consistency-level</span> Session <span class="dt">\</span></span>
<span id="cb27-7"><a href="#cb27-7" tabindex="-1"></a>  <span class="at">--locations</span> regionName=brazilsouth</span>
<span id="cb27-8"><a href="#cb27-8" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" tabindex="-1"></a><span class="co"># Get connection string</span></span>
<span id="cb27-10"><a href="#cb27-10" tabindex="-1"></a><span class="va">COSMOS_URI</span><span class="op">=</span><span class="va">$(</span><span class="ex">az</span> cosmosdb keys list <span class="dt">\</span></span>
<span id="cb27-11"><a href="#cb27-11" tabindex="-1"></a>  <span class="at">--name</span> cosmos-metasurvey <span class="dt">\</span></span>
<span id="cb27-12"><a href="#cb27-12" tabindex="-1"></a>  <span class="at">--resource-group</span> rg-metasurvey <span class="dt">\</span></span>
<span id="cb27-13"><a href="#cb27-13" tabindex="-1"></a>  <span class="at">--type</span> connection-strings <span class="dt">\</span></span>
<span id="cb27-14"><a href="#cb27-14" tabindex="-1"></a>  <span class="at">--query</span> <span class="st">"connectionStrings[0].connectionString"</span> <span class="at">-o</span> tsv<span class="va">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="configure-secrets-in-kubernetes-1">3. Configure secrets in Kubernetes<a class="anchor" aria-label="anchor" href="#configure-secrets-in-kubernetes-1"></a>
</h3>
<div class="sourceCode" id="cb28"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="ex">az</span> aks get-credentials <span class="dt">\</span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>  <span class="at">--resource-group</span> rg-metasurvey <span class="dt">\</span></span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a>  <span class="at">--name</span> aks-metasurvey</span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a><span class="ex">kubectl</span> create namespace metasurvey</span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a><span class="ex">kubectl</span> create secret generic metasurvey-secrets <span class="dt">\</span></span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a>  <span class="at">--namespace</span> metasurvey <span class="dt">\</span></span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a>  <span class="at">--from-literal</span><span class="op">=</span>mongo-uri=<span class="st">"</span><span class="va">$COSMOS_URI</span><span class="st">"</span> <span class="dt">\</span></span>
<span id="cb28-10"><a href="#cb28-10" tabindex="-1"></a>  <span class="at">--from-literal</span><span class="op">=</span>jwt-secret=<span class="st">"</span><span class="va">$(</span><span class="ex">openssl</span> rand <span class="at">-hex</span> 32<span class="va">)</span><span class="st">"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="deployment-with-nginx-ingress">4. Deployment with NGINX Ingress<a class="anchor" aria-label="anchor" href="#deployment-with-nginx-ingress"></a>
</h3>
<div class="sourceCode" id="cb29"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="co"># k8s/azure-api.yaml</span></span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> metasurvey</span></span>
<span id="cb29-7"><a href="#cb29-7" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb29-8"><a href="#cb29-8" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb29-9"><a href="#cb29-9" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb29-10"><a href="#cb29-10" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb29-11"><a href="#cb29-11" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb29-12"><a href="#cb29-12" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb29-13"><a href="#cb29-13" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb29-14"><a href="#cb29-14" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb29-15"><a href="#cb29-15" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb29-16"><a href="#cb29-16" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb29-17"><a href="#cb29-17" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb29-18"><a href="#cb29-18" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> api</span></span>
<span id="cb29-19"><a href="#cb29-19" tabindex="-1"></a><span class="at">          </span><span class="fu">image</span><span class="kw">:</span><span class="at"> ghcr.io/metasurveyr/metasurvey-api:latest</span></span>
<span id="cb29-20"><a href="#cb29-20" tabindex="-1"></a><span class="at">          </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb29-21"><a href="#cb29-21" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span>
<span id="cb29-22"><a href="#cb29-22" tabindex="-1"></a><span class="at">          </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb29-23"><a href="#cb29-23" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> METASURVEY_MONGO_URI</span></span>
<span id="cb29-24"><a href="#cb29-24" tabindex="-1"></a><span class="at">              </span><span class="fu">valueFrom</span><span class="kw">:</span></span>
<span id="cb29-25"><a href="#cb29-25" tabindex="-1"></a><span class="at">                </span><span class="fu">secretKeyRef</span><span class="kw">:</span></span>
<span id="cb29-26"><a href="#cb29-26" tabindex="-1"></a><span class="at">                  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-secrets</span></span>
<span id="cb29-27"><a href="#cb29-27" tabindex="-1"></a><span class="at">                  </span><span class="fu">key</span><span class="kw">:</span><span class="at"> mongo-uri</span></span>
<span id="cb29-28"><a href="#cb29-28" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> METASURVEY_JWT_SECRET</span></span>
<span id="cb29-29"><a href="#cb29-29" tabindex="-1"></a><span class="at">              </span><span class="fu">valueFrom</span><span class="kw">:</span></span>
<span id="cb29-30"><a href="#cb29-30" tabindex="-1"></a><span class="at">                </span><span class="fu">secretKeyRef</span><span class="kw">:</span></span>
<span id="cb29-31"><a href="#cb29-31" tabindex="-1"></a><span class="at">                  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-secrets</span></span>
<span id="cb29-32"><a href="#cb29-32" tabindex="-1"></a><span class="at">                  </span><span class="fu">key</span><span class="kw">:</span><span class="at"> jwt-secret</span></span>
<span id="cb29-33"><a href="#cb29-33" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> METASURVEY_WORKER_URL</span></span>
<span id="cb29-34"><a href="#cb29-34" tabindex="-1"></a><span class="at">              </span><span class="fu">value</span><span class="kw">:</span><span class="at"> </span><span class="st">"http://worker-service:8788"</span></span>
<span id="cb29-35"><a href="#cb29-35" tabindex="-1"></a><span class="at">          </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb29-36"><a href="#cb29-36" tabindex="-1"></a><span class="at">            </span><span class="fu">requests</span><span class="kw">:</span></span>
<span id="cb29-37"><a href="#cb29-37" tabindex="-1"></a><span class="at">              </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">"512Mi"</span></span>
<span id="cb29-38"><a href="#cb29-38" tabindex="-1"></a><span class="at">              </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">"250m"</span></span>
<span id="cb29-39"><a href="#cb29-39" tabindex="-1"></a><span class="at">            </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb29-40"><a href="#cb29-40" tabindex="-1"></a><span class="at">              </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">"1Gi"</span></span>
<span id="cb29-41"><a href="#cb29-41" tabindex="-1"></a><span class="at">              </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">"500m"</span></span>
<span id="cb29-42"><a href="#cb29-42" tabindex="-1"></a><span class="at">          </span><span class="fu">livenessProbe</span><span class="kw">:</span></span>
<span id="cb29-43"><a href="#cb29-43" tabindex="-1"></a><span class="at">            </span><span class="fu">httpGet</span><span class="kw">:</span></span>
<span id="cb29-44"><a href="#cb29-44" tabindex="-1"></a><span class="at">              </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /health</span></span>
<span id="cb29-45"><a href="#cb29-45" tabindex="-1"></a><span class="at">              </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span>
<span id="cb29-46"><a href="#cb29-46" tabindex="-1"></a><span class="at">            </span><span class="fu">initialDelaySeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">30</span></span>
<span id="cb29-47"><a href="#cb29-47" tabindex="-1"></a><span class="at">          </span><span class="fu">readinessProbe</span><span class="kw">:</span></span>
<span id="cb29-48"><a href="#cb29-48" tabindex="-1"></a><span class="at">            </span><span class="fu">httpGet</span><span class="kw">:</span></span>
<span id="cb29-49"><a href="#cb29-49" tabindex="-1"></a><span class="at">              </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /health</span></span>
<span id="cb29-50"><a href="#cb29-50" tabindex="-1"></a><span class="at">              </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span>
<span id="cb29-51"><a href="#cb29-51" tabindex="-1"></a><span class="at">            </span><span class="fu">initialDelaySeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">10</span></span>
<span id="cb29-52"><a href="#cb29-52" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb29-53"><a href="#cb29-53" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb29-54"><a href="#cb29-54" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb29-55"><a href="#cb29-55" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb29-56"><a href="#cb29-56" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb29-57"><a href="#cb29-57" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> metasurvey</span></span>
<span id="cb29-58"><a href="#cb29-58" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb29-59"><a href="#cb29-59" tabindex="-1"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> ClusterIP</span></span>
<span id="cb29-60"><a href="#cb29-60" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb29-61"><a href="#cb29-61" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb29-62"><a href="#cb29-62" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb29-63"><a href="#cb29-63" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span>
<span id="cb29-64"><a href="#cb29-64" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb29-65"><a href="#cb29-65" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> networking.k8s.io/v1</span></span>
<span id="cb29-66"><a href="#cb29-66" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Ingress</span></span>
<span id="cb29-67"><a href="#cb29-67" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb29-68"><a href="#cb29-68" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-ingress</span></span>
<span id="cb29-69"><a href="#cb29-69" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> metasurvey</span></span>
<span id="cb29-70"><a href="#cb29-70" tabindex="-1"></a><span class="at">  </span><span class="fu">annotations</span><span class="kw">:</span></span>
<span id="cb29-71"><a href="#cb29-71" tabindex="-1"></a><span class="at">    </span><span class="fu">cert-manager.io/cluster-issuer</span><span class="kw">:</span><span class="at"> letsencrypt-prod</span></span>
<span id="cb29-72"><a href="#cb29-72" tabindex="-1"></a><span class="at">    </span><span class="fu">nginx.ingress.kubernetes.io/ssl-redirect</span><span class="kw">:</span><span class="at"> </span><span class="st">"true"</span></span>
<span id="cb29-73"><a href="#cb29-73" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb29-74"><a href="#cb29-74" tabindex="-1"></a><span class="at">  </span><span class="fu">ingressClassName</span><span class="kw">:</span><span class="at"> nginx</span></span>
<span id="cb29-75"><a href="#cb29-75" tabindex="-1"></a><span class="at">  </span><span class="fu">tls</span><span class="kw">:</span></span>
<span id="cb29-76"><a href="#cb29-76" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">hosts</span><span class="kw">:</span></span>
<span id="cb29-77"><a href="#cb29-77" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> api.metasurvey.example.org</span></span>
<span id="cb29-78"><a href="#cb29-78" tabindex="-1"></a><span class="at">      </span><span class="fu">secretName</span><span class="kw">:</span><span class="at"> metasurvey-tls</span></span>
<span id="cb29-79"><a href="#cb29-79" tabindex="-1"></a><span class="at">  </span><span class="fu">rules</span><span class="kw">:</span></span>
<span id="cb29-80"><a href="#cb29-80" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">host</span><span class="kw">:</span><span class="at"> api.metasurvey.example.org</span></span>
<span id="cb29-81"><a href="#cb29-81" tabindex="-1"></a><span class="at">      </span><span class="fu">http</span><span class="kw">:</span></span>
<span id="cb29-82"><a href="#cb29-82" tabindex="-1"></a><span class="at">        </span><span class="fu">paths</span><span class="kw">:</span></span>
<span id="cb29-83"><a href="#cb29-83" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /</span></span>
<span id="cb29-84"><a href="#cb29-84" tabindex="-1"></a><span class="at">            </span><span class="fu">pathType</span><span class="kw">:</span><span class="at"> Prefix</span></span>
<span id="cb29-85"><a href="#cb29-85" tabindex="-1"></a><span class="at">            </span><span class="fu">backend</span><span class="kw">:</span></span>
<span id="cb29-86"><a href="#cb29-86" tabindex="-1"></a><span class="at">              </span><span class="fu">service</span><span class="kw">:</span></span>
<span id="cb29-87"><a href="#cb29-87" tabindex="-1"></a><span class="at">                </span><span class="fu">name</span><span class="kw">:</span><span class="at"> metasurvey-api</span></span>
<span id="cb29-88"><a href="#cb29-88" tabindex="-1"></a><span class="at">                </span><span class="fu">port</span><span class="kw">:</span></span>
<span id="cb29-89"><a href="#cb29-89" tabindex="-1"></a><span class="at">                  </span><span class="fu">number</span><span class="kw">:</span><span class="at"> </span><span class="dv">8787</span></span></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="co"># Install NGINX Ingress Controller</span></span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a><span class="ex">helm</span> repo add ingress-nginx https://kubernetes.github.io/ingress-nginx</span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a><span class="ex">helm</span> install ingress-nginx ingress-nginx/ingress-nginx <span class="dt">\</span></span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a>  <span class="at">--namespace</span> ingress-nginx <span class="at">--create-namespace</span></span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a><span class="co"># Install cert-manager for TLS</span></span>
<span id="cb30-7"><a href="#cb30-7" tabindex="-1"></a><span class="ex">helm</span> repo add jetstack https://charts.jetstack.io</span>
<span id="cb30-8"><a href="#cb30-8" tabindex="-1"></a><span class="ex">helm</span> install cert-manager jetstack/cert-manager <span class="dt">\</span></span>
<span id="cb30-9"><a href="#cb30-9" tabindex="-1"></a>  <span class="at">--namespace</span> cert-manager <span class="at">--create-namespace</span> <span class="dt">\</span></span>
<span id="cb30-10"><a href="#cb30-10" tabindex="-1"></a>  <span class="at">--set</span> crds.enabled=true</span>
<span id="cb30-11"><a href="#cb30-11" tabindex="-1"></a></span>
<span id="cb30-12"><a href="#cb30-12" tabindex="-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> k8s/azure-api.yaml</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="feature-flags">Feature Flags<a class="anchor" aria-label="anchor" href="#feature-flags"></a>
</h2>
<p>The API supports feature flags via environment variables to control
which modules are available. This lets you run the same API image in
different configurations:</p>
<table class="table">
<colgroup>
<col width="31%">
<col width="28%">
<col width="40%">
</colgroup>
<thead><tr class="header">
<th>Variable</th>
<th>Default</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>METASURVEY_ENABLE_INDICATORS</code></td>
<td><code>1</code></td>
<td>Enable <code>/indicators</code> endpoints</td>
</tr>
<tr class="even">
<td><code>METASURVEY_ENABLE_WORKER</code></td>
<td><code>0</code></td>
<td>Enable <code>POST /indicators/compute</code> (on-demand)</td>
</tr>
</tbody>
</table>
<p>For example, the public metasurvey API on Railway only serves recipes
and workflows – indicators and worker are disabled:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="va">METASURVEY_ENABLE_INDICATORS</span><span class="op">=</span>0</span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a><span class="va">METASURVEY_ENABLE_WORKER</span><span class="op">=</span>0</span></code></pre></div>
<p>A self-hosted deployment with full capabilities:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a><span class="va">METASURVEY_ENABLE_INDICATORS</span><span class="op">=</span>1</span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a><span class="va">METASURVEY_ENABLE_WORKER</span><span class="op">=</span>1</span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a><span class="va">METASURVEY_WORKER_URL</span><span class="op">=</span>http://worker:8788</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="hybrid-deployment-public-registry-private-infrastructure">Hybrid Deployment: Public Registry + Private Infrastructure<a class="anchor" aria-label="anchor" href="#hybrid-deployment-public-registry-private-infrastructure"></a>
</h2>
<p>You don’t need to run your own MongoDB to access shared recipes. You
can deploy <strong>your own API + Worker</strong> pointing to the
<strong>public metasurvey recipe registry</strong>, so that researchers
with access to microdata can apply community-published recipes
locally.</p>
<p>The organization deploys two services:</p>
<ol style="list-style-type: decimal">
<li>
<strong>plumber API</strong> (<code>:8787</code>) – connects to the
public MongoDB to read recipes and workflows. Receives requests from the
frontend or researchers, and proxies compute requests to the
worker.</li>
<li>
<strong>Worker</strong> (<code>:8788</code>) – has metasurvey
installed and access to private microdata. Fetches recipes from the
public registry (via MongoDB), applies them, and runs estimations.</li>
</ol>
<pre class="text"><code>  Public metasurvey MongoDB             Your infrastructure
  (recipes, workflows)                  (private network)
  +-------------------+           +---------------------------+
  |  MongoDB Atlas     |&lt;----------| plumber API  :8787        |
  |  (read-only)       |           |   - reads recipes/wf      |
  +-------------------+           |   - proxies POST /compute  |
                                   +-------------+-------------+
                                                 |
                                    POST /compute|
                                                 v
                                   +-------------+-------------+
                                   | Worker  :8788              |
                                   |   - loads microdata        |
                                   |   - applies recipes        |
                                   |   - runs workflow()        |
                                   +---------------------------+
                                                 ^
                                   +-------------+-------------+
                                   | Microdata (.sav, .dta)    |
                                   | PRIVATE — never leaves    |
                                   +---------------------------+</code></pre>
<div class="sourceCode" id="cb34"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a><span class="co"># .env for hybrid deployment</span></span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a><span class="co"># Both API and Worker point to the public metasurvey MongoDB</span></span>
<span id="cb34-3"><a href="#cb34-3" tabindex="-1"></a><span class="va">METASURVEY_MONGO_URI</span><span class="op">=</span>mongodb+srv://readonly:public@metasurvey.mongodb.net</span>
<span id="cb34-4"><a href="#cb34-4" tabindex="-1"></a><span class="va">METASURVEY_DB</span><span class="op">=</span>metasurvey</span>
<span id="cb34-5"><a href="#cb34-5" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" tabindex="-1"></a><span class="co"># Worker has local microdata</span></span>
<span id="cb34-7"><a href="#cb34-7" tabindex="-1"></a><span class="va">SURVEY_DATA_PATH</span><span class="op">=</span>/secure/microdata</span>
<span id="cb34-8"><a href="#cb34-8" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" tabindex="-1"></a><span class="co"># API proxies compute requests to the worker</span></span>
<span id="cb34-10"><a href="#cb34-10" tabindex="-1"></a><span class="va">METASURVEY_WORKER_URL</span><span class="op">=</span>http://worker:8788</span>
<span id="cb34-11"><a href="#cb34-11" tabindex="-1"></a><span class="va">METASURVEY_ENABLE_WORKER</span><span class="op">=</span>1</span>
<span id="cb34-12"><a href="#cb34-12" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" tabindex="-1"></a><span class="co"># Indicators disabled (no local MongoDB to store them)</span></span>
<span id="cb34-14"><a href="#cb34-14" tabindex="-1"></a><span class="va">METASURVEY_ENABLE_INDICATORS</span><span class="op">=</span>0</span></code></pre></div>
<div class="sourceCode" id="cb35"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a><span class="ex">docker</span> compose up api worker</span></code></pre></div>
<p>In this mode:</p>
<ul>
<li>
<strong>Recipes and workflows</strong> are fetched from the public
registry – any recipe published by the community is available to your
API and worker.</li>
<li>
<strong>Microdata stays private</strong> – the worker loads survey
files from a local volume, never exposed externally.</li>
<li>
<strong>Estimation is local</strong> – the API receives the request,
proxies it to the worker, which applies recipes and runs
<code><a href="../reference/workflow.html">workflow()</a></code> on your infrastructure.</li>
<li>
<strong>No MongoDB to maintain</strong> – you use the public
registry as-is.</li>
</ul>
<p>This is useful for research teams that have access to restricted
microdata and want to apply standardized recipes without maintaining
their own database.</p>
</div>
<div class="section level2">
<h2 id="production-deployment">Production Deployment<a class="anchor" aria-label="anchor" href="#production-deployment"></a>
</h2>
<p>For production deployments with Terraform modules (AWS/Azure/GCP),
Helm charts, and CI/CD pipelines, see the infrastructure repository:</p>
<p>The infrastructure repository will include:</p>
<ul>
<li>Terraform modules for managed databases (RDS, DocumentDB/CosmosDB,
Cloud SQL, Memorystore)</li>
<li>Kubernetes manifests with autoscaling, TLS ingress, and secrets
management</li>
<li>Docker image builds and registry configuration</li>
<li>Monitoring and health check setup</li>
</ul>
</div>
<div class="section level2">
<h2 id="next-steps">Next Steps<a class="anchor" aria-label="anchor" href="#next-steps"></a>
</h2>
<ul>
<li>
<strong><a href="api-database.html">API and Database
Reference</a></strong> – Full endpoint documentation, MongoDB schema,
and authentication details</li>
<li>
<strong><a href="recipes.html">Creating and Sharing
Recipes</a></strong> – Build recipes for reproducible survey
processing</li>
<li>
<strong><a href="workflows-and-estimation.html">Estimation
Workflows</a></strong> – Compute weighted survey estimates with
<code><a href="../reference/workflow.html">workflow()</a></code>
</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://www.mauroloprete.com" class="external-link">Mauro Loprete</a>, <a href="https://natydasilva.github.io/natydasilva/" class="external-link">Natalia da Silva</a>, <a href="https://iecon.fcea.udelar.edu.uy/es/autores/item/machado-fabricio.html" class="external-link">Fabricio Machado</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
