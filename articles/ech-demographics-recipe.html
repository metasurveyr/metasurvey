<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Building an ECH Demographics Recipe • metasurvey</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Building an ECH Demographics Recipe">
<!-- javascript assets for rmarkdown --><meta name="pkgdown-site-root" content="../">
<script src="../ace-1.2.3/ace.js" type="text/javascript" charset="utf-8"></script><script src="../holder-2.9.0/holder.min.js" type="text/javascript" charset="utf-8"></script><script src="../snippets/snippets.js" type="text/javascript" charset="utf-8"></script><style type="text/css">
.snippet {
  border: solid 1px #cccccc;
  margin-bottom: 12px;
  width: 100%;
}
</style>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">metasurvey</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.16</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/metasurveyr/metasurvey/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<script src="ech-demographics-recipe_files/htmlwidgets-1.6.4/htmlwidgets.js"></script><link href="ech-demographics-recipe_files/vis-9.1.0/vis-network.min.css" rel="stylesheet">
<script src="ech-demographics-recipe_files/vis-9.1.0/vis-network.min.js"></script><script src="ech-demographics-recipe_files/visNetwork-binding-2.1.4/visNetwork.js"></script><link href="ech-demographics-recipe_files/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Building an ECH Demographics Recipe</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/metasurveyr/metasurvey/blob/main/vignettes/ech-demographics-recipe.Rmd" class="external-link"><code>vignettes/ech-demographics-recipe.Rmd</code></a></small>
      <div class="d-none name"><code>ech-demographics-recipe.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="two-paths-transpile-fast-or-build-right">Two paths: transpile fast or build right<a class="anchor" aria-label="anchor" href="#two-paths-transpile-fast-or-build-right"></a>
</h2>
<p>metasurvey offers two ways to create recipes from existing STATA
code:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Transpile automatically</strong> with
<code><a href="../reference/transpile_stata.html">transpile_stata()</a></code> – converts <code>.do</code> files to
recipes in seconds. Great for migrating legacy code quickly (see
<code><a href="../articles/stata-transpiler.html">vignette("stata-transpiler")</a></code>).</li>
<li>
<strong>Build from scratch</strong> in R – more work upfront, but
the result is cleaner, uses proper R idioms, and you control every
detail.</li>
</ol>
<p>The transpiler is a pragmatic shortcut: it reads hundreds of lines of
STATA and produces a working recipe, but the output inherits the
original code’s structure – long <code>gen</code>/<code>replace</code>
chains become long <code>step_recode</code> calls, temporary variables
survive, and STATA-specific patterns (like <code>mvencode</code>) get
translated literally rather than rethought.</p>
<p>A hand-crafted recipe, on the other hand, lets you <strong>redesign
the logic</strong> in R from the ground up. You pick meaningful variable
names, combine related transformations into a single step, and skip
intermediate variables that only existed because STATA needed them. The
result is shorter, easier to read, and easier to maintain.</p>
<p>This vignette builds a demographics recipe from scratch in about 20
lines of R. A transpiled version of the same pipeline would take 80+
steps and carry over variable names like <code>bc_pe2</code> and
<code>bc_pe3</code> that mean nothing outside the original
<code>.do</code> file.</p>
</div>
<div class="section level2">
<h2 id="setting-up-the-survey">Setting up the survey<a class="anchor" aria-label="anchor" href="#setting-up-the-survey"></a>
</h2>
<p>We start with an empty Survey object. This declares the survey type
and edition without loading any data yet – the recipe will work on
whatever data we feed it later.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://metasurveyr.github.io/metasurvey/">metasurvey</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survey_empty.html">survey_empty</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"ech"</span>, edition <span class="op">=</span> <span class="st">"2023"</span><span class="op">)</span></span>
<span><span class="va">svy</span></span></code></pre></div>
<p>Now let’s attach some sample data. In production this would come from
<code>anda_download_microdata("2023")</code> or a local file; here we
simulate it.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">200</span></span>
<span><span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>  id       <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">50</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>  nper     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="fl">50</span><span class="op">)</span>,</span>
<span>  pesoano  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">50</span>, <span class="fl">300</span><span class="op">)</span>,</span>
<span>  e26      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  e27      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">90</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  e30      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">7</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  e51_2    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">6</span>, <span class="op">-</span><span class="fl">9</span><span class="op">)</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  region_4 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="va">svy</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/set_data.html">set_data</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="building-the-pipeline">Building the pipeline<a class="anchor" aria-label="anchor" href="#building-the-pipeline"></a>
</h2>
<p>Every transformation is a <strong>step</strong>. By default, steps
are <strong>lazy</strong>: they record what to do without executing it.
This lets you inspect and modify the pipeline before materializing the
results.</p>
<p>Compare this with the transpiler approach:
<code><a href="../reference/transpile_stata.html">transpile_stata()</a></code> would produce one step per STATA command,
faithfully preserving every <code>gen</code> and <code>replace</code>.
Here we think in terms of the <em>output variables</em> we want, not the
commands we need to type.</p>
<div class="section level3">
<h3 id="rename-identifiers">Rename identifiers<a class="anchor" aria-label="anchor" href="#rename-identifiers"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="va">svy</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_rename.html">step_rename</a></span><span class="op">(</span></span>
<span>    hh_id <span class="op">=</span> <span class="st">"id"</span>, person_id <span class="op">=</span> <span class="st">"nper"</span>,</span>
<span>    comment <span class="op">=</span> <span class="st">"Standardize identifiers"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Nothing happened to the data yet:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_data.html">get_data</a></span><span class="op">(</span><span class="va">svy</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] "id"      "nper"    "pesoano" "e26"</span></span></code></pre></div>
<p>The original column names are still there because the step is
pending. Let’s keep adding steps.</p>
</div>
<div class="section level3">
<h3 id="recode-sex">Recode sex<a class="anchor" aria-label="anchor" href="#recode-sex"></a>
</h3>
<p>In STATA this would be a <code>gen</code> + <code>replace</code> +
<code>replace</code> sequence (3 commands). With
<code>step_recode</code> it’s a single, declarative mapping that
produces human-readable labels:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="va">svy</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_recode.html">step_recode</a></span><span class="op">(</span><span class="va">sex</span>,</span>
<span>    <span class="va">e26</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Male"</span>,</span>
<span>    <span class="va">e26</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"Female"</span>,</span>
<span>    .default <span class="op">=</span> <span class="cn">NA_character_</span>,</span>
<span>    comment <span class="op">=</span> <span class="st">"Sex from e26"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="age-groups">Age groups<a class="anchor" aria-label="anchor" href="#age-groups"></a>
</h3>
<p>The STATA equivalent uses five <code>replace</code> lines with
<code><a href="https://rdrr.io/pkg/data.table/man/between.html" class="external-link">inrange()</a></code>. Here we write the same logic as a single recode
with readable conditions:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="va">svy</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_recode.html">step_recode</a></span><span class="op">(</span><span class="va">age_group</span>,</span>
<span>    <span class="va">e27</span> <span class="op">&gt;=</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">e27</span> <span class="op">&lt;=</span> <span class="fl">13</span> <span class="op">~</span> <span class="st">"Child"</span>,</span>
<span>    <span class="va">e27</span> <span class="op">&gt;=</span> <span class="fl">14</span> <span class="op">&amp;</span> <span class="va">e27</span> <span class="op">&lt;=</span> <span class="fl">17</span> <span class="op">~</span> <span class="st">"Adolescent"</span>,</span>
<span>    <span class="va">e27</span> <span class="op">&gt;=</span> <span class="fl">18</span> <span class="op">&amp;</span> <span class="va">e27</span> <span class="op">&lt;=</span> <span class="fl">29</span> <span class="op">~</span> <span class="st">"Young adult"</span>,</span>
<span>    <span class="va">e27</span> <span class="op">&gt;=</span> <span class="fl">30</span> <span class="op">&amp;</span> <span class="va">e27</span> <span class="op">&lt;=</span> <span class="fl">64</span> <span class="op">~</span> <span class="st">"Adult"</span>,</span>
<span>    <span class="va">e27</span> <span class="op">&gt;=</span> <span class="fl">65</span> <span class="op">~</span> <span class="st">"Elderly"</span>,</span>
<span>    .default <span class="op">=</span> <span class="cn">NA_character_</span>,</span>
<span>    comment <span class="op">=</span> <span class="st">"Age groups from e27"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="relationship-to-head-of-household">Relationship to head of household<a class="anchor" aria-label="anchor" href="#relationship-to-head-of-household"></a>
</h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="va">svy</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_recode.html">step_recode</a></span><span class="op">(</span><span class="va">relationship</span>,</span>
<span>    <span class="va">e30</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Head"</span>,</span>
<span>    <span class="va">e30</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"Spouse"</span>,</span>
<span>    <span class="va">e30</span> <span class="op">&gt;=</span> <span class="fl">3</span> <span class="op">&amp;</span> <span class="va">e30</span> <span class="op">&lt;=</span> <span class="fl">5</span> <span class="op">~</span> <span class="st">"Child"</span>,</span>
<span>    <span class="va">e30</span> <span class="op">==</span> <span class="fl">6</span> <span class="op">~</span> <span class="st">"Other relative"</span>,</span>
<span>    <span class="va">e30</span> <span class="op">==</span> <span class="fl">7</span> <span class="op">~</span> <span class="st">"Non-relative"</span>,</span>
<span>    .default <span class="op">=</span> <span class="st">"Unknown"</span>,</span>
<span>    comment <span class="op">=</span> <span class="st">"Relationship from e30"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="education-level">Education level<a class="anchor" aria-label="anchor" href="#education-level"></a>
</h3>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="va">svy</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_recode.html">step_recode</a></span><span class="op">(</span><span class="va">edu_level</span>,</span>
<span>    <span class="va">e51_2</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"None"</span>,</span>
<span>    <span class="va">e51_2</span> <span class="op">&gt;=</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">e51_2</span> <span class="op">&lt;=</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"Primary"</span>,</span>
<span>    <span class="va">e51_2</span> <span class="op">&gt;=</span> <span class="fl">3</span> <span class="op">&amp;</span> <span class="va">e51_2</span> <span class="op">&lt;=</span> <span class="fl">4</span> <span class="op">~</span> <span class="st">"Secondary"</span>,</span>
<span>    <span class="va">e51_2</span> <span class="op">&gt;=</span> <span class="fl">5</span> <span class="op">&amp;</span> <span class="va">e51_2</span> <span class="op">&lt;=</span> <span class="fl">6</span> <span class="op">~</span> <span class="st">"Tertiary"</span>,</span>
<span>    .default <span class="op">=</span> <span class="cn">NA_character_</span>,</span>
<span>    comment <span class="op">=</span> <span class="st">"Education level from e51_2"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="geographic-area">Geographic area<a class="anchor" aria-label="anchor" href="#geographic-area"></a>
</h3>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="va">svy</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_recode.html">step_recode</a></span><span class="op">(</span><span class="va">area</span>,</span>
<span>    <span class="va">region_4</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Montevideo"</span>,</span>
<span>    <span class="va">region_4</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"Urban &gt;5k"</span>,</span>
<span>    <span class="va">region_4</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">~</span> <span class="st">"Urban &lt;5k"</span>,</span>
<span>    <span class="va">region_4</span> <span class="op">==</span> <span class="fl">4</span> <span class="op">~</span> <span class="st">"Rural"</span>,</span>
<span>    .default <span class="op">=</span> <span class="cn">NA_character_</span>,</span>
<span>    comment <span class="op">=</span> <span class="st">"Geographic area from region_4"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Notice that all our output variables have <strong>meaningful
labels</strong> instead of numeric codes. A transpiled recipe would keep
the original integer codes (1, 2, 3…) because that’s what the STATA code
used. Building from scratch lets you choose the representation that
makes analysis easier.</p>
</div>
<div class="section level3">
<h3 id="remove-raw-variables">Remove raw variables<a class="anchor" aria-label="anchor" href="#remove-raw-variables"></a>
</h3>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="va">svy</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_remove.html">step_remove</a></span><span class="op">(</span><span class="va">e26</span>, <span class="va">e27</span>, <span class="va">e30</span>, <span class="va">e51_2</span>, <span class="va">region_4</span>,</span>
<span>    comment <span class="op">=</span> <span class="st">"Drop raw ECH variables"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="inspecting-the-pipeline-before-execution">Inspecting the pipeline before execution<a class="anchor" aria-label="anchor" href="#inspecting-the-pipeline-before-execution"></a>
</h2>
<p>At this point we have seven pending steps. Let’s see what was
recorded:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_steps.html">get_steps</a></span><span class="op">(</span><span class="va">svy</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 7</span></span></code></pre></div>
<p>This is one of the key advantages of building from scratch: <strong>7
steps that each do one clear thing</strong>. A transpiled version of the
full IECON demographics module has 80+ steps because it preserves every
intermediate STATA command.</p>
<p>The pipeline is a DAG (directed acyclic graph) of transformations.
<code><a href="../reference/view_graph.html">view_graph()</a></code> renders it as an interactive network – each
node is a step, and edges show variable dependencies:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/view_graph.html">view_graph</a></span><span class="op">(</span><span class="va">svy</span><span class="op">)</span></span></code></pre></div>
<div id="htmlwidget-ac96cb3ee4656e2e9ec3" style="width:100%;height:600px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-ac96cb3ee4656e2e9ec3">{"x":{"nodes":{"id":[1,2,3,4,5,6,7,8],"label":["Load survey","step_1 Rename: hh_id=id, person_id=nper","step_2 Recode: sex","step_3 Recode: age_group","step_4 Recode: relationship","step_5 Recode: edu_level","step_6 Recode: area","step_7 Remove: e26, e27, e30, e51_2, region_4"],"title":["<div style='font-family: system-ui, -apple-system, sans-serif; padding: 12px 16px; max-width: 300px;'><div style='font-weight: 800; font-size: 14px; color: #2C3E50; margin-bottom: 8px;'>Survey<\/div><table style='font-size: 12px; color: #555; border-collapse: collapse;'><tr><td style='font-weight:600; padding: 3px 12px 3px 0; color:#2C3E50;'>Type<\/td><td style='padding:3px 0;'>ech<\/td><\/tr><tr><td style='font-weight:600; padding: 3px 12px 3px 0; color:#2C3E50;'>Edition<\/td><td style='padding:3px 0;'>2023<\/td><\/tr><tr><td style='font-weight:600; padding: 3px 12px 3px 0; color:#2C3E50;'>Weight<\/td><td style='padding:3px 0;'><\/td><\/tr><\/table><\/div>","<div style='font-family: system-ui, -apple-system, sans-serif; padding: 10px 14px; max-width: 340px;'><div style='font-weight: 700; font-size: 13px; color: #2C3E50; margin-bottom: 6px; border-bottom: 2px solid #eee; padding-bottom: 6px;'>Standardize identifiers<\/div><div style='font-family: SFMono-Regular, Consolas, monospace; font-size: 11px; color: #6c757d; background: #f8f9fa; padding: 8px 10px; border-radius: 6px; line-height: 1.5; white-space: pre-wrap;'>list(mapping = c(hh_id = \"id\", person_id = \"nper\"))<\/div><\/div>","<div style='font-family: system-ui, -apple-system, sans-serif; padding: 10px 14px; max-width: 340px;'><div style='font-weight: 700; font-size: 13px; color: #2C3E50; margin-bottom: 6px; border-bottom: 2px solid #eee; padding-bottom: 6px;'>Sex from e26<\/div><div style='font-family: SFMono-Regular, Consolas, monospace; font-size: 11px; color: #6c757d; background: #f8f9fa; padding: 8px 10px; border-radius: 6px; line-height: 1.5; white-space: pre-wrap;'>sex: list(e26 == 1 ~ \"Male\", e26 == 2 ~ \"Female\")<\/div><\/div>","<div style='font-family: system-ui, -apple-system, sans-serif; padding: 10px 14px; max-width: 340px;'><div style='font-weight: 700; font-size: 13px; color: #2C3E50; margin-bottom: 6px; border-bottom: 2px solid #eee; padding-bottom: 6px;'>Age groups from e27<\/div><div style='font-family: SFMono-Regular, Consolas, monospace; font-size: 11px; color: #6c757d; background: #f8f9fa; padding: 8px 10px; border-radius: 6px; line-height: 1.5; white-space: pre-wrap;'>age_group: list(e27 &gt;= 0 &amp; e27 &lt;= 13 ~ \"Child\", e27 &gt;= 14 &amp; e27 &lt;= 17 ~ \"Adolescent\", e27 &gt;= 18 &amp; e27 &lt;= 29 ~ \"Young adult\", e27 &gt;= 30 &amp; e27 &lt;= 64 ~ \"Adult\", e27 &gt;= 65 ~ \"Elderly\")<\/div><\/div>","<div style='font-family: system-ui, -apple-system, sans-serif; padding: 10px 14px; max-width: 340px;'><div style='font-weight: 700; font-size: 13px; color: #2C3E50; margin-bottom: 6px; border-bottom: 2px solid #eee; padding-bottom: 6px;'>Relationship from e30<\/div><div style='font-family: SFMono-Regular, Consolas, monospace; font-size: 11px; color: #6c757d; background: #f8f9fa; padding: 8px 10px; border-radius: 6px; line-height: 1.5; white-space: pre-wrap;'>relationship: list(e30 == 1 ~ \"Head\", e30 == 2 ~ \"Spouse\", e30 &gt;= 3 &amp; e30 &lt;= 5 ~ \"Child\", e30 == 6 ~ \"Other relative\", e30 == 7 ~ \"Non-relative\")<\/div><\/div>","<div style='font-family: system-ui, -apple-system, sans-serif; padding: 10px 14px; max-width: 340px;'><div style='font-weight: 700; font-size: 13px; color: #2C3E50; margin-bottom: 6px; border-bottom: 2px solid #eee; padding-bottom: 6px;'>Education level from e51_2<\/div><div style='font-family: SFMono-Regular, Consolas, monospace; font-size: 11px; color: #6c757d; background: #f8f9fa; padding: 8px 10px; border-radius: 6px; line-height: 1.5; white-space: pre-wrap;'>edu_level: list(e51_2 == 0 ~ \"None\", e51_2 &gt;= 1 &amp; e51_2 &lt;= 2 ~ \"Primary\", e51_2 &gt;= 3 &amp; e51_2 &lt;= 4 ~ \"Secondary\", e51_2 &gt;= 5 &amp; e51_2 &lt;= 6 ~ \"Tertiary\")<\/div><\/div>","<div style='font-family: system-ui, -apple-system, sans-serif; padding: 10px 14px; max-width: 340px;'><div style='font-weight: 700; font-size: 13px; color: #2C3E50; margin-bottom: 6px; border-bottom: 2px solid #eee; padding-bottom: 6px;'>Geographic area from region_4<\/div><div style='font-family: SFMono-Regular, Consolas, monospace; font-size: 11px; color: #6c757d; background: #f8f9fa; padding: 8px 10px; border-radius: 6px; line-height: 1.5; white-space: pre-wrap;'>area: list(region_4 == 1 ~ \"Montevideo\", region_4 == 2 ~ \"Urban &gt;5k\", region_4 == 3 ~ \"Urban &lt;5k\", region_4 == 4 ~ \"Rural\")<\/div><\/div>","<div style='font-family: system-ui, -apple-system, sans-serif; padding: 10px 14px; max-width: 340px;'><div style='font-weight: 700; font-size: 13px; color: #2C3E50; margin-bottom: 6px; border-bottom: 2px solid #eee; padding-bottom: 6px;'>Drop raw ECH variables<\/div><div style='font-family: SFMono-Regular, Consolas, monospace; font-size: 11px; color: #6c757d; background: #f8f9fa; padding: 8px 10px; border-radius: 6px; line-height: 1.5; white-space: pre-wrap;'>list(vars = c(\"e26\", \"e27\", \"e30\", \"e51_2\", \"region_4\"))<\/div><\/div>"],"group":["Load survey","step_rename","recode","recode","recode","recode","recode","step_remove"]},"edges":{"from":[1,2,3,4,5,6,7],"to":[2,3,4,5,6,7,8]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot"},"manipulation":{"enabled":false},"groups":{"Load survey":{"shape":"icon","icon":{"code":"f1c0","size":60,"color":"#2C3E50"},"font":{"size":16,"color":"#2C3E50","face":"bold","multi":true},"shadow":{"enabled":true,"size":8,"x":2,"y":2,"color":"rgba(44,62,80,.15)"}},"compute":{"shape":"icon","icon":{"code":"f1ec","size":50,"color":"#3498db"},"font":{"size":14,"color":"#2c3e50","face":"bold"},"shadow":{"enabled":true,"size":6,"x":2,"y":2,"color":"rgba(52,152,219,.2)"}},"recode":{"shape":"icon","icon":{"code":"f0e8","size":50,"color":"#9b59b6"},"font":{"size":14,"color":"#2c3e50","face":"bold"},"shadow":{"enabled":true,"size":6,"x":2,"y":2,"color":"rgba(155,89,182,.2)"}},"step_join":{"shape":"icon","icon":{"code":"f0c1","size":50,"color":"#1abc9c"},"font":{"size":14,"color":"#2c3e50","face":"bold"},"shadow":{"enabled":true,"size":6,"x":2,"y":2,"color":"rgba(26,188,156,.2)"}},"step_remove":{"shape":"icon","icon":{"code":"f1f8","size":50,"color":"#e74c3c"},"font":{"size":14,"color":"#2c3e50","face":"bold"},"shadow":{"enabled":true,"size":6,"x":2,"y":2,"color":"rgba(231,76,60,.2)"}},"step_rename":{"shape":"icon","icon":{"code":"f044","size":50,"color":"#e67e22"},"font":{"size":14,"color":"#2c3e50","face":"bold"},"shadow":{"enabled":true,"size":6,"x":2,"y":2,"color":"rgba(230,126,34,.2)"}},"useDefaultGroups":true,"dataframe":{"shape":"icon","icon":{"code":"f0ce","size":50,"color":"#95a5a6"},"font":{"size":14,"color":"#2c3e50"},"shadow":{"enabled":true,"size":6,"x":2,"y":2,"color":"rgba(149,165,166,.2)"}}},"edges":{"width":2,"arrows":{"to":{"enabled":true,"scaleFactor":0.7,"type":"arrow"}},"color":{"color":"#bdc3c7","highlight":"#3498db","hover":"#3498db"},"smooth":{"enabled":true,"type":"curvedCW","roundness":0.1}},"layout":{"hierarchical":{"enabled":true,"levelSeparation":220,"nodeSpacing":140,"direction":"LR","sortMethod":"directed"}},"interaction":{"keyboard":true,"navigationButtons":true,"tooltipDelay":100,"hover":true,"zoomSpeed":1},"clickToUse":false},"groups":["Load survey","step_rename","recode","step_remove"],"width":"100%","height":"600px","idselection":{"enabled":true,"style":"font-family: system-ui, sans-serif; font-size: 13px; padding: 6px 12px; border-radius: 8px; border: 1px solid #dee2e6; background: #fff; color: #2C3E50;","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)","highlight":false},"main":null,"submain":null,"footer":null,"background":"#f8f9fa","iconsRedraw":true,"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);","highlight":{"enabled":true,"hoverNearest":true,"degree":1,"algorithm":"all","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":false,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.15,"useGroups":true,"position":"right","ncol":1,"stepX":100,"stepY":100,"zoom":false,"main":{"text":"Step types","style":"font-family: system-ui, sans-serif; font-weight: 700; font-size: 14px; color: #2C3E50;"}}},"evals":[],"jsHooks":[]}</script><p>With only 7 nodes the graph is clean and navigable. Compare that with
a transpiled recipe where the DAG can have 100+ nodes – still useful for
auditing, but much harder to read at a glance.</p>
<p>For static output we can inspect the step list:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fu"><a href="../reference/get_steps.html">get_steps</a></span><span class="op">(</span><span class="va">svy</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"[%s] %s\n"</span>, <span class="va">s</span><span class="op">$</span><span class="va">type</span>, <span class="va">s</span><span class="op">$</span><span class="va">comment</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="st">""</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [step_rename] Standardize identifiers</span></span>
<span><span class="co">#&gt; [recode] Sex from e26</span></span>
<span><span class="co">#&gt; [recode] Age groups from e27</span></span>
<span><span class="co">#&gt; [recode] Relationship from e30</span></span>
<span><span class="co">#&gt; [recode] Education level from e51_2</span></span>
<span><span class="co">#&gt; [recode] Geographic area from region_4</span></span>
<span><span class="co">#&gt; [step_remove] Drop raw ECH variables</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="packaging-as-a-recipe-before-baking">Packaging as a recipe (before baking)<a class="anchor" aria-label="anchor" href="#packaging-as-a-recipe-before-baking"></a>
</h2>
<p>A recipe bundles the steps with metadata so anyone can reproduce the
same pipeline on different data. We create the recipe
<strong>before</strong> baking – the lazy steps are the pipeline:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/steps_to_recipe.html">steps_to_recipe</a></span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="st">"ECH Demographics (minimal)"</span>,</span>
<span>  user <span class="op">=</span> <span class="st">"research_team"</span>,</span>
<span>  svy <span class="op">=</span> <span class="va">svy</span>,</span>
<span>  steps <span class="op">=</span> <span class="fu"><a href="../reference/get_steps.html">get_steps</a></span><span class="op">(</span><span class="va">svy</span><span class="op">)</span>,</span>
<span>  description <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span></span>
<span>    <span class="st">"Harmonized demographics: sex, age group, relationship,"</span>,</span>
<span>    <span class="st">"education level, and geographic area."</span></span>
<span>  <span class="op">)</span>,</span>
<span>  topic <span class="op">=</span> <span class="st">"demographics"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">rec</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">#&gt; ── Recipe: ECH Demographics (minimal) ──</span></span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">#&gt; </span><span style="color: #555555;">Author:  </span>research_team</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Survey:  </span>ech / 2023</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Version: </span>1.0.0</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Topic:   </span>demographics</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Description: </span>Harmonized demographics: sex, age group, relationship, education level, and geographic area.</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Certification: </span><span style="color: #BBBB00;">community</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">#&gt; ── Requires (5 variables) ──</span></span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">#&gt; </span>  e26, e27, e30, e51_2, region_4</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">#&gt; ── Pipeline (7 steps) ──</span></span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">#&gt; </span>  1. [step_rename] -&gt; mapping  "Standardize identifiers"</span></span>
<span><span class="co">#&gt;   2. [recode] -&gt; sex  "Sex from e26"</span></span>
<span><span class="co">#&gt;   3. [recode] -&gt; age_group  "Age groups from e27"</span></span>
<span><span class="co">#&gt;   4. [recode] -&gt; relationship  "Relationship from e30"</span></span>
<span><span class="co">#&gt;   5. [recode] -&gt; edu_level  "Education level from e51_2"</span></span>
<span><span class="co">#&gt;   6. [recode] -&gt; area  "Geographic area from region_4"</span></span>
<span><span class="co">#&gt;   7. [step_remove] -&gt; (no output)  "Drop raw ECH variables"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">#&gt; ── Produces (6 variables) ──</span></span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">#&gt; </span>  sex [categorical], age_group [categorical], relationship [categorical], edu_level [categorical], area [categorical], mapping [inherited]</span></span></code></pre></div>
<p>The recipe auto-generates documentation from the steps:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">doc</span> <span class="op">&lt;-</span> <span class="va">rec</span><span class="op">$</span><span class="fu">doc</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Input variables: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">doc</span><span class="op">$</span><span class="va">input_variables</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Input variables:  e26, e27, e30, e51_2, region_4</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Output variables:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">doc</span><span class="op">$</span><span class="va">output_variables</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Output variables: mapping, sex, age_group, relationship, edu_level, area</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Pipeline steps:  "</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">doc</span><span class="op">$</span><span class="va">pipeline</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Pipeline steps:   7</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="baking-materializing-the-pipeline">Baking: materializing the pipeline<a class="anchor" aria-label="anchor" href="#baking-materializing-the-pipeline"></a>
</h2>
<p>Now let’s execute the steps. <code><a href="../reference/bake_steps.html">bake_steps()</a></code> runs all
pending steps in order and returns the transformed survey:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bake_steps.html">bake_steps</a></span><span class="op">(</span><span class="va">svy</span><span class="op">)</span></span></code></pre></div>
<p>The data has the new columns with readable labels:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_data.html">get_data</a></span><span class="op">(</span><span class="va">svy</span><span class="op">)</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  <span class="va">hh_id</span>, <span class="va">person_id</span>, <span class="va">sex</span>, <span class="va">age_group</span>, <span class="va">relationship</span>,</span>
<span>  <span class="va">edu_level</span>, <span class="va">area</span></span>
<span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;    hh_id person_id    sex   age_group relationship edu_level       area</span></span>
<span><span class="co">#&gt;    &lt;int&gt;     &lt;int&gt; &lt;char&gt;      &lt;char&gt;       &lt;char&gt;    &lt;char&gt;     &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:     1         1 Female     Elderly Non-relative      None  Urban &lt;5k</span></span>
<span><span class="co">#&gt; 2:     1         2 Female       Adult         Head   Primary Montevideo</span></span>
<span><span class="co">#&gt; 3:     1         3   Male Young adult       Spouse  Tertiary  Urban &lt;5k</span></span>
<span><span class="co">#&gt; 4:     1         4 Female       Adult        Child   Primary      Rural</span></span>
<span><span class="co">#&gt; 5:     2         1   Male     Elderly        Child      None  Urban &gt;5k</span></span>
<span><span class="co">#&gt; 6:     2         2   Male Young adult       Spouse  Tertiary      Rural</span></span></code></pre></div>
<p>The raw variables are gone:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="st">"e26"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_data.html">get_data</a></span><span class="op">(</span><span class="va">svy</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="saving-and-loading">Saving and loading<a class="anchor" aria-label="anchor" href="#saving-and-loading"></a>
</h2>
<p>Recipes serialize to JSON for version control and sharing:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".json"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/save_recipe.html">save_recipe</a></span><span class="op">(</span><span class="va">rec</span>, <span class="va">f</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_recipe.html">read_recipe</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span>
<span><span class="va">rec2</span><span class="op">$</span><span class="va">name</span></span>
<span><span class="co">#&gt; [1] "ECH Demographics (minimal)"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">rec2</span><span class="op">$</span><span class="va">steps</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 7</span></span></code></pre></div>
<p>The JSON is human-readable and diffable in git:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="va">f</span>, n <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;   "name": "ECH Demographics (minimal)",</span></span>
<span><span class="co">#&gt;   "user": "research_team",</span></span>
<span><span class="co">#&gt;   "survey_type": "ech",</span></span>
<span><span class="co">#&gt;   "edition": 2023,</span></span>
<span><span class="co">#&gt;   "description": "Harmonized demographics: sex, age group, relationship, education level, and geographic area.",</span></span>
<span><span class="co">#&gt;   "topic": "demographics",</span></span>
<span><span class="co">#&gt;   "doi": {},</span></span>
<span><span class="co">#&gt;   "id": "r_1771294292_663",</span></span>
<span><span class="co">#&gt;   "version": "1.0.0",</span></span>
<span><span class="co">#&gt;   "downloads": 0,</span></span>
<span><span class="co">#&gt;   "categories": [],</span></span>
<span><span class="co">#&gt;   "certification": {</span></span>
<span><span class="co">#&gt;     "level": "community",</span></span>
<span><span class="co">#&gt;     "certified_at": "2026-02-17 02:11:32.07084"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="applying-to-a-new-edition">Applying to a new edition<a class="anchor" aria-label="anchor" href="#applying-to-a-new-edition"></a>
</h2>
<p>The same recipe works on any edition. Load the recipe from JSON,
attach it to new data, and bake:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec_loaded</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_recipe.html">read_recipe</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span>
<span></span>
<span><span class="va">svy_2024</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survey_empty.html">survey_empty</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"ech"</span>, edition <span class="op">=</span> <span class="st">"2024"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_data.html">set_data</a></span><span class="op">(</span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>    id       <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">30</span>, each <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>    nper     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">30</span><span class="op">)</span>,</span>
<span>    pesoano  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">90</span>, <span class="fl">50</span>, <span class="fl">300</span><span class="op">)</span>,</span>
<span>    e26      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">90</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    e27      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">90</span>, <span class="fl">90</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    e30      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">7</span>, <span class="fl">90</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    e51_2    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">6</span>, <span class="op">-</span><span class="fl">9</span><span class="op">)</span>, <span class="fl">90</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    region_4 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="fl">90</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/add_recipe.html">add_recipe</a></span><span class="op">(</span><span class="va">rec_loaded</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/bake_recipes.html">bake_recipes</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_data.html">get_data</a></span><span class="op">(</span><span class="va">svy_2024</span><span class="op">)</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">hh_id</span>, <span class="va">person_id</span>, <span class="va">sex</span>, <span class="va">age_group</span>, <span class="va">area</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;    hh_id person_id    sex   age_group       area</span></span>
<span><span class="co">#&gt;    &lt;int&gt;     &lt;int&gt; &lt;char&gt;      &lt;char&gt;     &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:     1         1   Male     Elderly      Rural</span></span>
<span><span class="co">#&gt; 2:     1         2   Male       Adult  Urban &lt;5k</span></span>
<span><span class="co">#&gt; 3:     1         3 Female Young adult  Urban &gt;5k</span></span>
<span><span class="co">#&gt; 4:     2         1   Male       Adult Montevideo</span></span>
<span><span class="co">#&gt; 5:     2         2 Female     Elderly      Rural</span></span>
<span><span class="co">#&gt; 6:     2         3   Male     Elderly  Urban &lt;5k</span></span></code></pre></div>
<p>No code changes needed. The recipe encodes the <em>logic</em>, not
the data.</p>
</div>
<div class="section level2">
<h2 id="transpiler-vs-hand-crafted-when-to-use-each">Transpiler vs hand-crafted: when to use each<a class="anchor" aria-label="anchor" href="#transpiler-vs-hand-crafted-when-to-use-each"></a>
</h2>
<table class="table">
<colgroup>
<col width="33%">
<col width="33%">
<col width="33%">
</colgroup>
<thead><tr class="header">
<th></th>
<th>Transpiler (<code><a href="../reference/transpile_stata.html">transpile_stata()</a></code>)</th>
<th>Hand-crafted recipe</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><strong>Speed</strong></td>
<td>Seconds – instant migration</td>
<td>Hours – requires understanding the logic</td>
</tr>
<tr class="even">
<td><strong>Steps</strong></td>
<td>80-200 per module (one per STATA line)</td>
<td>5-20 (one per concept)</td>
</tr>
<tr class="odd">
<td><strong>Variable names</strong></td>
<td>Inherits STATA names (<code>bc_pe2</code>, <code>bc_pe3</code>)</td>
<td>Your own names (<code>sex</code>, <code>age_group</code>)</td>
</tr>
<tr class="even">
<td><strong>Labels</strong></td>
<td>Numeric codes (<code>1</code>, <code>2</code>, <code>3</code>)</td>
<td>Readable labels (<code>"Male"</code>, <code>"Female"</code>)</td>
</tr>
<tr class="odd">
<td><strong>Readability</strong></td>
<td>Faithful to original, verbose</td>
<td>Clean, self-documenting</td>
</tr>
<tr class="even">
<td><strong>Maintenance</strong></td>
<td>Hard to modify individual steps</td>
<td>Easy to change any mapping</td>
</tr>
<tr class="odd">
<td><strong>DAG visualization</strong></td>
<td>Large, hard to read</td>
<td>Compact, meaningful nodes</td>
</tr>
<tr class="even">
<td><strong>Best for</strong></td>
<td>Migrating legacy code fast</td>
<td>New projects, critical pipelines</td>
</tr>
</tbody>
</table>
<p><strong>Recommended workflow</strong>: use
<code><a href="../reference/transpile_stata.html">transpile_stata()</a></code> to migrate your existing <code>.do</code>
files immediately so you have a working baseline. Then gradually replace
transpiled recipes with hand-crafted ones as you review each module. The
transpiled version keeps you running; the hand-crafted version is where
you want to end up.</p>
</div>
<div class="section level2">
<h2 id="what-metasurvey-gives-you">What metasurvey gives you<a class="anchor" aria-label="anchor" href="#what-metasurvey-gives-you"></a>
</h2>
<table class="table">
<colgroup>
<col width="50%">
<col width="50%">
</colgroup>
<thead><tr class="header">
<th>Manual STATA scripts</th>
<th>metasurvey recipe</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Copy-paste <code>.do</code> files per year</td>
<td>One recipe, any edition</td>
</tr>
<tr class="even">
<td>Undocumented variable names</td>
<td>Auto-generated input/output docs</td>
</tr>
<tr class="odd">
<td>No dependency tracking</td>
<td>DAG visualization with <code><a href="../reference/view_graph.html">view_graph()</a></code>
</td>
</tr>
<tr class="even">
<td>Flat scripts, no validation</td>
<td>
<code>validate()</code> checks required variables</td>
</tr>
<tr class="odd">
<td>Email <code>.do</code> files to colleagues</td>
<td>
<code><a href="../reference/publish_recipe.html">publish_recipe()</a></code> to shared registry</td>
</tr>
<tr class="even">
<td>Re-run entire script to test</td>
<td>Lazy steps: inspect before baking</td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="next-steps">Next steps<a class="anchor" aria-label="anchor" href="#next-steps"></a>
</h2>
<ul>
<li>
<strong>Add more variables</strong>: income, labor force status,
housing conditions – each can be a separate recipe with
<code>depends_on_recipes</code>
</li>
<li>
<strong>Certify your recipe</strong>: use
<code><a href="../reference/certify_recipe.html">certify_recipe()</a></code> to mark it as reviewed or official</li>
<li>
<strong>Publish</strong>: <code>publish_recipe(rec)</code> uploads
to the shared registry where others can find it with
<code>search_recipes(topic = "demographics")</code>
</li>
<li>
<strong>Start from STATA</strong>: if you already have
<code>.do</code> files, use <code><a href="../reference/transpile_stata.html">transpile_stata()</a></code> to generate a
working baseline immediately – see
<code><a href="../articles/stata-transpiler.html">vignette("stata-transpiler")</a></code> – then refine the output into
a hand-crafted recipe like the one in this vignette</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://www.mauroloprete.com" class="external-link">Mauro Loprete</a>, <a href="https://natydasilva.github.io/natydasilva/" class="external-link">Natalia da Silva</a>, <a href="https://iecon.fcea.udelar.edu.uy/es/autores/item/machado-fabricio.html" class="external-link">Fabricio Machado</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
