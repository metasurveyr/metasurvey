<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Transpilando archivos .do de STATA a Recetas metasurvey (ES) • metasurvey</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Transpilando archivos .do de STATA a Recetas metasurvey (ES)">
<!-- javascript assets for rmarkdown --><meta name="pkgdown-site-root" content="../">
<script src="../ace-1.2.3/ace.js" type="text/javascript" charset="utf-8"></script><script src="../holder-2.9.0/holder.min.js" type="text/javascript" charset="utf-8"></script><script src="../snippets/snippets.js" type="text/javascript" charset="utf-8"></script><style type="text/css">
.snippet {
  border: solid 1px #cccccc;
  margin-bottom: 12px;
  width: 100%;
}
</style>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">metasurvey</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.21</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/metasurveyr/metasurvey/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Transpilando archivos .do de STATA a Recetas metasurvey (ES)</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/metasurveyr/metasurvey/blob/main/vignettes/stata-transpiler-es.Rmd" class="external-link"><code>vignettes/stata-transpiler-es.Rmd</code></a></small>
      <div class="d-none name"><code>stata-transpiler-es.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="motivacion">Motivacion<a class="anchor" aria-label="anchor" href="#motivacion"></a>
</h2>
<p>Muchos grupos de investigacion latinoamericanos mantienen decadas de
archivos <code>.do</code> de STATA que procesan microdatos de encuestas
de hogares. Estos scripts codifican conocimiento institucional sobre
armonizacion de variables, descomposicion de ingresos y construccion de
indicadores – pero estan encerrados en un formato dificil de versionar,
compartir o integrar con flujos de trabajo modernos en R.</p>
<p>El <strong>transpilador de metasurvey</strong> convierte archivos
<code>.do</code> de STATA en objetos Recipe de metasurvey. Esto
permite:</p>
<ul>
<li>
<strong>Reproducibilidad</strong>: los pipelines de STATA se
convierten en recetas JSON versionadas</li>
<li>
<strong>Interoperabilidad</strong>: la misma receta se ejecuta sobre
cualquier objeto Survey respaldado por <code>data.table</code>
</li>
<li>
<strong>Descubrimiento</strong>: las recetas transpiladas pueden
publicarse en la API de metasurvey para que otros investigadores las
encuentren y reutilicen</li>
</ul>
<p>El transpilador maneja los patrones de STATA mas comunes en scripts
de procesamiento de encuestas: generacion de variables, reemplazo
condicional, recodificacion, agregacion, loops, codificacion de valores
faltantes y extraccion de etiquetas.</p>
</div>
<div class="section level2">
<h2 id="inicio-rapido">Inicio rapido<a class="anchor" aria-label="anchor" href="#inicio-rapido"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://metasurveyr.github.io/metasurvey/">metasurvey</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Transpilar un archivo .do</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/transpile_stata.html">transpile_stata</a></span><span class="op">(</span><span class="st">"demographics.do"</span><span class="op">)</span></span>
<span><span class="va">result</span><span class="op">$</span><span class="va">steps</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] "step_rename(svy, hh_id = \"id\", person_id = \"nper\")"</span></span>
<span><span class="co">#&gt; [2] "step_compute(svy, weight_yr = pesoano)"</span></span>
<span><span class="co">#&gt; [3] "step_compute(svy, sex = e26)"</span></span></code></pre></div>
<p>El resultado es una lista con cuatro elementos:</p>
<table class="table">
<colgroup>
<col width="50%">
<col width="50%">
</colgroup>
<thead><tr class="header">
<th>Elemento</th>
<th>Descripcion</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>steps</code></td>
<td>Vector de caracteres con llamadas a steps de metasurvey</td>
</tr>
<tr class="even">
<td><code>labels</code></td>
<td>Etiquetas de variables y valores extraidas del archivo
<code>.do</code>
</td>
</tr>
<tr class="odd">
<td><code>warnings</code></td>
<td>Comandos que requieren revision manual</td>
</tr>
<tr class="even">
<td><code>stats</code></td>
<td>Conteos de comandos traducidos, omitidos y para revision manual</td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="pipeline-de-transpilacion">Pipeline de transpilacion<a class="anchor" aria-label="anchor" href="#pipeline-de-transpilacion"></a>
</h2>
<p>El transpilador trabaja en cuatro pasadas:</p>
<pre><code>  archivo .do
     |
     v
  [1] parse_do_file()      -- tokenizar lineas en objetos de comando
     |
     v
  [2] translate_commands()  -- mapear cada comando STATA a steps de metasurvey
     |
     v
  [3] optimize_steps()      -- consolidar renames, drops, etc. consecutivos
     |
     v
  [4] Recipe / JSON         -- empaquetar steps con metadatos</code></pre>
<div class="section level3">
<h3 id="pasada-1-parsing">Pasada 1: Parsing<a class="anchor" aria-label="anchor" href="#pasada-1-parsing"></a>
</h3>
<p><code><a href="../reference/parse_do_file.html">parse_do_file()</a></code> lee un archivo <code>.do</code> y
produce una lista de objetos de comando. Maneja:</p>
<ul>
<li>
<strong>Eliminacion de comentarios</strong>: <code>*</code>,
<code>//</code>, y bloques <code>/* */</code>
</li>
<li>
<strong>Continuacion de linea</strong>: <code>///</code> y
<code>/* */</code> usados como marcadores de continuacion</li>
<li>
<strong>Expansion de loops</strong>: <code>foreach</code> y
<code>forvalues</code> se desenrollan, sustituyendo macros con backtick
(<code>`var'</code>) con cada valor de iteracion</li>
<li>
<strong>Manejo de prefijos</strong>: <code>capture</code>,
<code>bysort group:</code>, y abreviaciones de comandos (<code>g</code>
por <code>gen</code>, <code>cap</code> por <code>capture</code>)</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">commands</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/parse_do_file.html">parse_do_file</a></span><span class="op">(</span><span class="st">"demographics.do"</span><span class="op">)</span></span>
<span><span class="va">commands</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; $cmd</span></span>
<span><span class="co">#&gt; [1] "gen"</span></span>
<span><span class="co">#&gt; $args</span></span>
<span><span class="co">#&gt; [1] "sex = e26"</span></span>
<span><span class="co">#&gt; $if_clause</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; $by_group</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; $capture</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="pasada-2-traduccion-de-comandos">Pasada 2: Traduccion de comandos<a class="anchor" aria-label="anchor" href="#pasada-2-traduccion-de-comandos"></a>
</h3>
<p>Cada comando parseado se mapea a una o mas cadenas de steps de
metasurvey. La siguiente tabla muestra los comandos de STATA soportados
y sus traducciones.</p>
</div>
</div>
<div class="section level2">
<h2 id="patrones-soportados">Patrones soportados<a class="anchor" aria-label="anchor" href="#patrones-soportados"></a>
</h2>
<div class="section level3">
<h3 id="gen-generate">gen / generate<a class="anchor" aria-label="anchor" href="#gen-generate"></a>
</h3>
<p>La creacion simple de variables se traduce a
<code>step_compute</code>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="kw">gen</span> sex = q01</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="kw">gen</span> is_urban = (region &lt; 3)</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="kw">gen</span> <span class="kw">byte</span> age_group = -9</span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/step_compute.html">step_compute</a></span><span class="op">(</span><span class="va">svy</span>, sex <span class="op">=</span> <span class="va">q01</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/step_compute.html">step_compute</a></span><span class="op">(</span><span class="va">svy</span>, is_urban <span class="op">=</span> <span class="op">(</span><span class="va">region</span> <span class="op">&lt;</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/step_compute.html">step_compute</a></span><span class="op">(</span><span class="va">svy</span>, age_group <span class="op">=</span> <span class="op">-</span><span class="fl">9L</span><span class="op">)</span></span></code></pre></div>
<p>Cuando un <code>gen</code> incluye una clausula <code>if</code>, la
condicion se envuelve en <code>fifelse</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="kw">gen</span> employed = hours_worked <span class="kw">if</span> age &gt;= 14</span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/step_compute.html">step_compute</a></span><span class="op">(</span><span class="va">svy</span>, employed <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/fifelse.html" class="external-link">fifelse</a></span><span class="op">(</span><span class="va">age</span> <span class="op">&gt;=</span> <span class="fl">14</span>, <span class="va">hours_worked</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="cadenas-gen-replace-el-patron-dominante">Cadenas gen + replace (el patron dominante)<a class="anchor" aria-label="anchor" href="#cadenas-gen-replace-el-patron-dominante"></a>
</h3>
<p>El patron mas comun en archivos <code>.do</code> de encuestas es
inicializar una variable y luego completarla con reemplazos
condicionales:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="kw">gen</span> relationship = -9</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="kw">replace</span> relationship = 1 <span class="kw">if</span> q05 == 1</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="kw">replace</span> relationship = 2 <span class="kw">if</span> q05 == 2</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="kw">replace</span> relationship = 3 <span class="kw">if</span> <span class="fu">inrange</span>(q05, 3, 5)</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="kw">replace</span> relationship = 4 <span class="kw">if</span> q05 == 6</span></code></pre></div>
<p>Cuando <strong>todos</strong> los lados derechos son constantes, el
transpilador emite un unico <code>step_recode</code>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/step_recode.html">step_recode</a></span><span class="op">(</span><span class="va">svy</span>, <span class="va">relationship</span>,</span>
<span>    <span class="va">q05</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">1L</span>,</span>
<span>    <span class="va">q05</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="fl">2L</span>,</span>
<span>    <span class="va">q05</span> <span class="op">&gt;=</span> <span class="fl">3</span> <span class="op">&amp;</span> <span class="va">q05</span> <span class="op">&lt;=</span> <span class="fl">5</span> <span class="op">~</span> <span class="fl">3L</span>,</span>
<span>    <span class="va">q05</span> <span class="op">==</span> <span class="fl">6</span> <span class="op">~</span> <span class="fl">4L</span>,</span>
<span>    .default <span class="op">=</span> <span class="op">-</span><span class="fl">9L</span><span class="op">)</span></span></code></pre></div>
<p>Cuando algun lado derecho es una <strong>expresion</strong>, el
transpilador emite una cadena de <code>step_compute</code> con
<code>fifelse</code>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="kw">gen</span> labour_inc = 0</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="kw">replace</span> labour_inc = wage <span class="kw">if</span> job_type == 1</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="kw">replace</span> labour_inc = wage + bonus <span class="kw">if</span> job_type == 2</span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/step_compute.html">step_compute</a></span><span class="op">(</span><span class="va">svy</span>, labour_inc <span class="op">=</span> <span class="fl">0L</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/step_compute.html">step_compute</a></span><span class="op">(</span><span class="va">svy</span>, labour_inc <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/fifelse.html" class="external-link">fifelse</a></span><span class="op">(</span></span>
<span>    <span class="va">job_type</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">wage</span>, <span class="va">labour_inc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/step_compute.html">step_compute</a></span><span class="op">(</span><span class="va">svy</span>, labour_inc <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/fifelse.html" class="external-link">fifelse</a></span><span class="op">(</span></span>
<span>    <span class="va">job_type</span> <span class="op">==</span> <span class="fl">2</span>, <span class="va">wage</span> <span class="op">+</span> <span class="va">bonus</span>, <span class="va">labour_inc</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="recode">recode<a class="anchor" aria-label="anchor" href="#recode"></a>
</h3>
<p>STATA <code>recode</code> con mapeos entre parentesis o sintaxis
inline:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="kw">recode</span> urban_filter (0=2)</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="kw">recode</span> edu_level (2=2) (3=-9) (4=3) (5=4), <span class="kw">gen</span>(edu_compat)</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="kw">recode</span> var1 var2 var3 .=0</span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/step_compute.html">step_compute</a></span><span class="op">(</span><span class="va">svy</span>, urban_filter <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/fifelse.html" class="external-link">fifelse</a></span><span class="op">(</span></span>
<span>    <span class="va">urban_filter</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">2</span>, <span class="va">urban_filter</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/step_compute.html">step_compute</a></span><span class="op">(</span><span class="va">svy</span>, edu_compat <span class="op">=</span> <span class="va">edu_level</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/step_compute.html">step_compute</a></span><span class="op">(</span><span class="va">svy</span>, edu_compat <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/fifelse.html" class="external-link">fifelse</a></span><span class="op">(</span></span>
<span>    <span class="va">edu_compat</span> <span class="op">==</span> <span class="fl">2</span>, <span class="fl">2</span>, <span class="va">edu_compat</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># ... un fifelse por mapeo</span></span>
<span></span>
<span><span class="co"># Recode multi-variable: un step por variable</span></span>
<span><span class="fu"><a href="../reference/step_compute.html">step_compute</a></span><span class="op">(</span><span class="va">svy</span>, var1 <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/fifelse.html" class="external-link">fifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">var1</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">var1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/step_compute.html">step_compute</a></span><span class="op">(</span><span class="va">svy</span>, var2 <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/fifelse.html" class="external-link">fifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">var2</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">var2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/step_compute.html">step_compute</a></span><span class="op">(</span><span class="va">svy</span>, var3 <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/fifelse.html" class="external-link">fifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">var3</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">var3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="egen-agregacion-con-by-groups">egen (agregacion con by-groups)<a class="anchor" aria-label="anchor" href="#egen-agregacion-con-by-groups"></a>
</h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="kw">bysort</span> household: <span class="kw">egen</span> hh_income = <span class="kw">sum</span>(income)</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="kw">egen</span> max_age = <span class="fu">max</span>(age), <span class="kw">by</span>(household)</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/step_compute.html">step_compute</a></span><span class="op">(</span><span class="va">svy</span>, hh_income <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">income</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    .by <span class="op">=</span> <span class="st">"household"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/step_compute.html">step_compute</a></span><span class="op">(</span><span class="va">svy</span>, max_age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">age</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    .by <span class="op">=</span> <span class="st">"household"</span><span class="op">)</span></span></code></pre></div>
<p>Funciones <code>egen</code> soportadas: <code>sum</code>,
<code>max</code>, <code>min</code>, <code>mean</code>,
<code>count</code>, <code>sd</code>, <code>median</code>,
<code>total</code>, <code>rowtotal</code>, <code>rowmean</code>.</p>
</div>
<div class="section level3">
<h3 id="loops-foreach">Loops foreach<a class="anchor" aria-label="anchor" href="#loops-foreach"></a>
</h3>
<p>Los loops se expanden durante el parsing. El transpilador desenrolla
<code>foreach</code> tanto con listas <code>in</code> como con rangos
<code>of numlist</code>, incluyendo loops anidados:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="kw">foreach</span> i <span class="kw">of</span> numlist 1/4 {</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>    <span class="kw">gen</span> contrib<span class="ot">`i'</span> = 0</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>    <span class="kw">replace</span> contrib<span class="ot">`i'</span> = amount <span class="kw">if</span> provider == <span class="ot">`i'</span></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>}</span></code></pre></div>
<p>Se expande a 4 pares de gen+replace, cada uno transpilado
independientemente:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/step_recode.html">step_recode</a></span><span class="op">(</span><span class="va">svy</span>, <span class="va">contrib1</span>, <span class="va">provider</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="va">amount</span>, .default <span class="op">=</span> <span class="fl">0L</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/step_recode.html">step_recode</a></span><span class="op">(</span><span class="va">svy</span>, <span class="va">contrib2</span>, <span class="va">provider</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="va">amount</span>, .default <span class="op">=</span> <span class="fl">0L</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/step_recode.html">step_recode</a></span><span class="op">(</span><span class="va">svy</span>, <span class="va">contrib3</span>, <span class="va">provider</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">~</span> <span class="va">amount</span>, .default <span class="op">=</span> <span class="fl">0L</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/step_recode.html">step_recode</a></span><span class="op">(</span><span class="va">svy</span>, <span class="va">contrib4</span>, <span class="va">provider</span> <span class="op">==</span> <span class="fl">4</span> <span class="op">~</span> <span class="va">amount</span>, .default <span class="op">=</span> <span class="fl">0L</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="mvencode-codificacion-de-valores-faltantes">mvencode (codificacion de valores faltantes)<a class="anchor" aria-label="anchor" href="#mvencode-codificacion-de-valores-faltantes"></a>
</h3>
<div class="sourceCode" id="cb18"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="kw">mvencode</span> income_1 income_2 income_3, mv(0)</span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/step_compute.html">step_compute</a></span><span class="op">(</span><span class="va">svy</span>, income_1 <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/fifelse.html" class="external-link">fifelse</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">income_1</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">income_1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/step_compute.html">step_compute</a></span><span class="op">(</span><span class="va">svy</span>, income_2 <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/fifelse.html" class="external-link">fifelse</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">income_2</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">income_2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/step_compute.html">step_compute</a></span><span class="op">(</span><span class="va">svy</span>, income_3 <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/fifelse.html" class="external-link">fifelse</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">income_3</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">income_3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="destring">destring<a class="anchor" aria-label="anchor" href="#destring"></a>
</h3>
<div class="sourceCode" id="cb20"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="kw">destring</span> wage bonus, <span class="kw">replace</span> <span class="kw">force</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/step_compute.html">step_compute</a></span><span class="op">(</span><span class="va">svy</span>, wage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">wage</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/step_compute.html">step_compute</a></span><span class="op">(</span><span class="va">svy</span>, bonus <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">bonus</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="rename-drop-keep">rename, drop, keep<a class="anchor" aria-label="anchor" href="#rename-drop-keep"></a>
</h3>
<div class="sourceCode" id="cb22"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="kw">rename</span> id hh_id</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="kw">drop</span> aux1 aux2 aux3</span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/step_rename.html">step_rename</a></span><span class="op">(</span><span class="va">svy</span>, hh_id <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/step_remove.html">step_remove</a></span><span class="op">(</span><span class="va">svy</span>, <span class="va">aux1</span>, <span class="va">aux2</span>, <span class="va">aux3</span><span class="op">)</span></span></code></pre></div>
<p>Los renames consecutivos se consolidan en una unica llamada a
<code>step_rename</code>, y los drops consecutivos se fusionan en un
solo <code>step_remove</code>.</p>
</div>
<div class="section level3">
<h3 id="traduccion-de-expresiones-stata">Traduccion de expresiones STATA<a class="anchor" aria-label="anchor" href="#traduccion-de-expresiones-stata"></a>
</h3>
<p>La sintaxis especifica de STATA en expresiones se traduce
automaticamente:</p>
<table class="table">
<thead><tr class="header">
<th>STATA</th>
<th>R (data.table)</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>inrange(x, a, b)</code></td>
<td><code>(x &gt;= a &amp; x &lt;= b)</code></td>
</tr>
<tr class="even">
<td><code>inlist(x, 1, 2, 3)</code></td>
<td><code>(x %in% c(1, 2, 3))</code></td>
</tr>
<tr class="odd">
<td><code>var == .</code></td>
<td><code>is.na(var)</code></td>
</tr>
<tr class="even">
<td><code>var != .</code></td>
<td><code>!is.na(var)</code></td>
</tr>
<tr class="odd">
<td>
<code>.</code> (como valor)</td>
<td><code>NA</code></td>
</tr>
<tr class="even">
<td><code>string(var)</code></td>
<td><code>as.character(var)</code></td>
</tr>
<tr class="odd">
<td><code>var[_n-1]</code></td>
<td><code>data.table::shift(var, 1, type = "lag")</code></td>
</tr>
<tr class="even">
<td><code>var[_n+1]</code></td>
<td><code>data.table::shift(var, 1, type = "lead")</code></td>
</tr>
<tr class="odd">
<td><code>_N</code></td>
<td><code>.N</code></td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="rangos-de-variables">Rangos de variables<a class="anchor" aria-label="anchor" href="#rangos-de-variables"></a>
</h3>
<p>STATA permite rangos de variables como <code>aux1-aux4</code> que
significan <code>aux1 aux2 aux3 aux4</code>. El transpilador los expande
en comandos <code>drop</code>, <code>recode</code> y
<code>mvencode</code>:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="kw">drop</span> contrib1-contrib4</span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/step_remove.html">step_remove</a></span><span class="op">(</span><span class="va">svy</span>, <span class="va">contrib1</span>, <span class="va">contrib2</span>, <span class="va">contrib3</span>, <span class="va">contrib4</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="etiquetas">Etiquetas<a class="anchor" aria-label="anchor" href="#etiquetas"></a>
</h3>
<p>Las etiquetas de variables y valores se extraen y almacenan en los
metadatos de la receta:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>lab <span class="kw">var</span> sex <span class="st">"Sex of respondent"</span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>lab def sex_lbl 1 <span class="st">"Male"</span> 2 <span class="st">"Female"</span></span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a>lab val sex sex_lbl</span></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span><span class="op">$</span><span class="va">labels</span></span>
<span><span class="co">#&gt; $var_labels</span></span>
<span><span class="co">#&gt; $var_labels$sex</span></span>
<span><span class="co">#&gt; [1] "Sex of respondent"</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; $val_labels</span></span>
<span><span class="co">#&gt; $val_labels$sex</span></span>
<span><span class="co">#&gt; $val_labels$sex$`1`</span></span>
<span><span class="co">#&gt; [1] "Male"</span></span>
<span><span class="co">#&gt; $val_labels$sex$`2`</span></span>
<span><span class="co">#&gt; [1] "Female"</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="comandos-omitidos">Comandos omitidos<a class="anchor" aria-label="anchor" href="#comandos-omitidos"></a>
</h2>
<p>Los comandos que no modifican datos de la encuesta se omiten
silenciosamente durante la transpilacion. Estos incluyen:</p>
<ul>
<li>E/S: <code>use</code>, <code>save</code>, <code>import</code>,
<code>export</code>, <code>insheet</code>, <code>outsheet</code>
</li>
<li>Visualizacion: <code>tabulate</code>, <code>summarize</code>,
<code>describe</code>, <code>list</code>, <code>browse</code>,
<code>display</code>
</li>
<li>Flujo de control: <code>if</code>/<code>else</code>,
<code>while</code>, <code>program</code>, <code>exit</code>
</li>
<li>Configuracion: <code>set</code>, <code>sort</code>,
<code>order</code>, <code>compress</code>, <code>format</code>
</li>
<li>Macros: <code>global</code>, <code>local</code>,
<code>scalar</code>, <code>matrix</code>
</li>
</ul>
<p>El elemento <code>$stats</code> del resultado reporta cuantos
comandos cayeron en cada categoria.</p>
</div>
<div class="section level2">
<h2 id="un-ejemplo-realista">Un ejemplo realista<a class="anchor" aria-label="anchor" href="#un-ejemplo-realista"></a>
</h2>
<p>El siguiente archivo <code>.do</code> es una version simplificada de
un modulo tipico de demografia de encuestas. No es un script de
produccion real, pero usa los mismos patrones encontrados en pipelines
reales de procesamiento de la ECH.</p>
<p>Guardar como <code>demo_module.do</code>:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a>* ──────────────────────────────────────────────</span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>* Modulo <span class="kw">de</span> demografia -- ejemplo simplificado</span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a>* ──────────────────────────────────────────────</span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a><span class="kw">rename</span> id hh_id</span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a><span class="kw">rename</span> nper person_id</span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a><span class="kw">gen</span> weight_yr = pesoano</span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a><span class="kw">gen</span> weight_qt = pesotri</span>
<span id="cb28-10"><a href="#cb28-10" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" tabindex="-1"></a>* ── Sexo ──</span>
<span id="cb28-12"><a href="#cb28-12" tabindex="-1"></a><span class="kw">gen</span> sex = q01</span>
<span id="cb28-13"><a href="#cb28-13" tabindex="-1"></a></span>
<span id="cb28-14"><a href="#cb28-14" tabindex="-1"></a>* ── Relacion con <span class="fu">el</span> jefe <span class="kw">de</span> hogar ──</span>
<span id="cb28-15"><a href="#cb28-15" tabindex="-1"></a>g relationship = -9</span>
<span id="cb28-16"><a href="#cb28-16" tabindex="-1"></a><span class="kw">replace</span> relationship = 1 <span class="kw">if</span> q05 == 1</span>
<span id="cb28-17"><a href="#cb28-17" tabindex="-1"></a><span class="kw">replace</span> relationship = 2 <span class="kw">if</span> q05 == 2</span>
<span id="cb28-18"><a href="#cb28-18" tabindex="-1"></a><span class="kw">replace</span> relationship = 3 <span class="kw">if</span> <span class="fu">inrange</span>(q05, 3, 5)</span>
<span id="cb28-19"><a href="#cb28-19" tabindex="-1"></a><span class="kw">replace</span> relationship = 4 <span class="kw">if</span> q05 == 6</span>
<span id="cb28-20"><a href="#cb28-20" tabindex="-1"></a><span class="kw">replace</span> relationship = 5 <span class="kw">if</span> q05 == 7</span>
<span id="cb28-21"><a href="#cb28-21" tabindex="-1"></a></span>
<span id="cb28-22"><a href="#cb28-22" tabindex="-1"></a>* ── Area ──</span>
<span id="cb28-23"><a href="#cb28-23" tabindex="-1"></a><span class="kw">gen</span> area = .</span>
<span id="cb28-24"><a href="#cb28-24" tabindex="-1"></a><span class="kw">replace</span> area = 1 <span class="kw">if</span> region == 1</span>
<span id="cb28-25"><a href="#cb28-25" tabindex="-1"></a><span class="kw">replace</span> area = 2 <span class="kw">if</span> region == 2</span>
<span id="cb28-26"><a href="#cb28-26" tabindex="-1"></a><span class="kw">replace</span> area = 3 <span class="kw">if</span> region == 3</span>
<span id="cb28-27"><a href="#cb28-27" tabindex="-1"></a></span>
<span id="cb28-28"><a href="#cb28-28" tabindex="-1"></a>* ── Nivel educativo (armonizado) ──</span>
<span id="cb28-29"><a href="#cb28-29" tabindex="-1"></a><span class="kw">recode</span> q20 (2=2) (3=-9) (4=3) (5=4), <span class="kw">gen</span>(edu_compat)</span>
<span id="cb28-30"><a href="#cb28-30" tabindex="-1"></a></span>
<span id="cb28-31"><a href="#cb28-31" tabindex="-1"></a>* ── Estadisticas <span class="kw">de</span> edad a nivel <span class="kw">de</span> hogar ──</span>
<span id="cb28-32"><a href="#cb28-32" tabindex="-1"></a><span class="kw">bysort</span> hh_id: <span class="kw">egen</span> max_age = <span class="fu">max</span>(edad)</span>
<span id="cb28-33"><a href="#cb28-33" tabindex="-1"></a><span class="kw">bysort</span> hh_id: <span class="kw">egen</span> n_members = <span class="fu">count</span>(person_id)</span>
<span id="cb28-34"><a href="#cb28-34" tabindex="-1"></a></span>
<span id="cb28-35"><a href="#cb28-35" tabindex="-1"></a>* ── Inicializar contribuciones <span class="kw">de</span> seguro <span class="kw">de</span> salud ──</span>
<span id="cb28-36"><a href="#cb28-36" tabindex="-1"></a><span class="kw">foreach</span> i <span class="kw">of</span> numlist 1/3 {</span>
<span id="cb28-37"><a href="#cb28-37" tabindex="-1"></a>    <span class="kw">gen</span> contrib<span class="ot">`i'</span> = 0</span>
<span id="cb28-38"><a href="#cb28-38" tabindex="-1"></a>    <span class="kw">replace</span> contrib<span class="ot">`i'</span> = amount <span class="kw">if</span> provider == <span class="ot">`i'</span></span>
<span id="cb28-39"><a href="#cb28-39" tabindex="-1"></a>}</span>
<span id="cb28-40"><a href="#cb28-40" tabindex="-1"></a></span>
<span id="cb28-41"><a href="#cb28-41" tabindex="-1"></a>* ── Codificar valores faltantes ──</span>
<span id="cb28-42"><a href="#cb28-42" tabindex="-1"></a><span class="kw">mvencode</span> contrib1 contrib2 contrib3, mv(0)</span>
<span id="cb28-43"><a href="#cb28-43" tabindex="-1"></a></span>
<span id="cb28-44"><a href="#cb28-44" tabindex="-1"></a>* ── Limpiar ──</span>
<span id="cb28-45"><a href="#cb28-45" tabindex="-1"></a><span class="kw">drop</span> region q01 q05 q20</span>
<span id="cb28-46"><a href="#cb28-46" tabindex="-1"></a></span>
<span id="cb28-47"><a href="#cb28-47" tabindex="-1"></a>* ── Etiquetas ──</span>
<span id="cb28-48"><a href="#cb28-48" tabindex="-1"></a>lab <span class="kw">var</span> sex <span class="st">"Sexo"</span></span>
<span id="cb28-49"><a href="#cb28-49" tabindex="-1"></a>lab <span class="kw">var</span> relationship <span class="st">"Relacion con el jefe de hogar"</span></span>
<span id="cb28-50"><a href="#cb28-50" tabindex="-1"></a>lab def sex_lbl 1 <span class="st">"Hombre"</span> 2 <span class="st">"Mujer"</span></span>
<span id="cb28-51"><a href="#cb28-51" tabindex="-1"></a>lab val sex sex_lbl</span>
<span id="cb28-52"><a href="#cb28-52" tabindex="-1"></a>lab def rel_lbl 1 <span class="st">"Jefe"</span> 2 <span class="st">"Conyuge"</span> 3 <span class="st">"Hijo"</span> 4 <span class="st">"Otro familiar"</span> 5 <span class="st">"No familiar"</span></span>
<span id="cb28-53"><a href="#cb28-53" tabindex="-1"></a>lab val relationship rel_lbl</span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://metasurveyr.github.io/metasurvey/">metasurvey</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Escribir el archivo .do de ejemplo en una ubicacion temporal</span></span>
<span><span class="co"># Nota: las macros de STATA usan backtick-quote (`var') que construimos con paste0</span></span>
<span><span class="va">bt</span> <span class="op">&lt;-</span> <span class="st">"`"</span> <span class="co"># backtick</span></span>
<span><span class="va">sq</span> <span class="op">&lt;-</span> <span class="st">"'"</span> <span class="co"># comilla simple</span></span>
<span><span class="va">do_lines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"rename id hh_id"</span>,</span>
<span>  <span class="st">"rename nper person_id"</span>,</span>
<span>  <span class="st">"gen weight_yr = pesoano"</span>,</span>
<span>  <span class="st">"gen weight_qt = pesotri"</span>,</span>
<span>  <span class="st">"gen sex = q01"</span>,</span>
<span>  <span class="st">"g relationship = -9"</span>,</span>
<span>  <span class="st">"replace relationship = 1 if q05 == 1"</span>,</span>
<span>  <span class="st">"replace relationship = 2 if q05 == 2"</span>,</span>
<span>  <span class="st">"replace relationship = 3 if inrange(q05, 3, 5)"</span>,</span>
<span>  <span class="st">"replace relationship = 4 if q05 == 6"</span>,</span>
<span>  <span class="st">"replace relationship = 5 if q05 == 7"</span>,</span>
<span>  <span class="st">"gen area = ."</span>,</span>
<span>  <span class="st">"replace area = 1 if region == 1"</span>,</span>
<span>  <span class="st">"replace area = 2 if region == 2"</span>,</span>
<span>  <span class="st">"replace area = 3 if region == 3"</span>,</span>
<span>  <span class="st">"recode q20 (2=2) (3=-9) (4=3) (5=4), gen(edu_compat)"</span>,</span>
<span>  <span class="st">"bysort hh_id: egen max_age = max(edad)"</span>,</span>
<span>  <span class="st">"bysort hh_id: egen n_members = count(person_id)"</span>,</span>
<span>  <span class="st">"foreach i of numlist 1/3 {"</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"gen contrib"</span>, <span class="va">bt</span>, <span class="st">"i"</span>, <span class="va">sq</span>, <span class="st">" = 0"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"replace contrib"</span>, <span class="va">bt</span>, <span class="st">"i"</span>, <span class="va">sq</span>, <span class="st">" = amount if provider == "</span>, <span class="va">bt</span>, <span class="st">"i"</span>, <span class="va">sq</span><span class="op">)</span>,</span>
<span>  <span class="st">"}"</span>,</span>
<span>  <span class="st">"mvencode contrib1 contrib2 contrib3, mv(0)"</span>,</span>
<span>  <span class="st">"drop region q01 q05 q20"</span>,</span>
<span>  <span class="st">'lab var sex "Sexo"'</span>,</span>
<span>  <span class="st">'lab var relationship "Relacion con el jefe de hogar"'</span>,</span>
<span>  <span class="st">'lab def sex_lbl 1 "Hombre" 2 "Mujer"'</span>,</span>
<span>  <span class="st">"lab val sex sex_lbl"</span>,</span>
<span>  <span class="st">'lab def rel_lbl 1 "Jefe" 2 "Conyuge" 3 "Hijo" 4 "Otro familiar" 5 "No familiar"'</span>,</span>
<span>  <span class="st">"lab val relationship rel_lbl"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">do_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".do"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span><span class="va">do_lines</span>, <span class="va">do_file</span><span class="op">)</span></span>
<span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/transpile_stata.html">transpile_stata</a></span><span class="op">(</span><span class="va">do_file</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="inspeccionando-la-salida">Inspeccionando la salida<a class="anchor" aria-label="anchor" href="#inspeccionando-la-salida"></a>
</h3>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Traducidos:"</span>, <span class="va">result</span><span class="op">$</span><span class="va">stats</span><span class="op">$</span><span class="va">translated</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Traducidos: 27</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Omitidos:  "</span>, <span class="va">result</span><span class="op">$</span><span class="va">stats</span><span class="op">$</span><span class="va">skipped</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Omitidos:   6</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Manual:    "</span>, <span class="va">result</span><span class="op">$</span><span class="va">stats</span><span class="op">$</span><span class="va">manual_review</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Manual:     0</span></span></code></pre></div>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Imprimir los steps generados</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="va">result</span><span class="op">$</span><span class="va">steps</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; step_rename(svy, hh_id = "id", person_id = "nper") </span></span>
<span><span class="co">#&gt; step_compute(svy, weight_yr = pesoano, weight_qt = pesotri, sex = q01) </span></span>
<span><span class="co">#&gt; step_recode(svy, relationship,</span></span>
<span><span class="co">#&gt;     q05 == 1 ~ "1",</span></span>
<span><span class="co">#&gt;     q05 == 2 ~ "2",</span></span>
<span><span class="co">#&gt;     (q05 &gt;= 3 &amp; q05 &lt;= 5) ~ "3",</span></span>
<span><span class="co">#&gt;     q05 == 6 ~ "4",</span></span>
<span><span class="co">#&gt;     q05 == 7 ~ "5",</span></span>
<span><span class="co">#&gt;     .default = "-9") </span></span>
<span><span class="co">#&gt; step_compute(svy, area = NA, area = data.table::fifelse(region == 1, 1, area), area = data.table::fifelse(region == 2, 2, area), area = data.table::fifelse(region == 3, 3, area), edu_compat = q20, edu_compat = data.table::fifelse(q20 == 2, 2, edu_compat), edu_compat = data.table::fifelse(q20 == 3, -9, edu_compat), edu_compat = data.table::fifelse(q20 == 4, 3, edu_compat), edu_compat = data.table::fifelse(q20 == 5, 4, edu_compat)) </span></span>
<span><span class="co">#&gt; step_compute(svy, max_age = max(edad, na.rm = TRUE), n_members = sum(!is.na(person_id)), .by = "hh_id") </span></span>
<span><span class="co">#&gt; step_compute(svy, contrib1 = 0, contrib1 = data.table::fifelse(provider == 1, amount, contrib1), contrib2 = 0, contrib2 = data.table::fifelse(provider == 2, amount, contrib2), contrib3 = 0, contrib3 = data.table::fifelse(provider == 3, amount, contrib3), contrib1 = data.table::fifelse(is.na(contrib1), 0, contrib1), contrib2 = data.table::fifelse(is.na(contrib2), 0, contrib2), contrib3 = data.table::fifelse(is.na(contrib3), 0, contrib3)) </span></span>
<span><span class="co">#&gt; step_remove(svy, region, q01, q05, q20)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="etiquetas-1">Etiquetas<a class="anchor" aria-label="anchor" href="#etiquetas-1"></a>
</h3>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">labels</span><span class="op">$</span><span class="va">var_labels</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 2</span></span>
<span><span class="co">#&gt;  $ sex         : chr "Sexo"</span></span>
<span><span class="co">#&gt;  $ relationship: chr "Relacion con el jefe de hogar"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">labels</span><span class="op">$</span><span class="va">val_labels</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 2</span></span>
<span><span class="co">#&gt;  $ sex         :List of 2</span></span>
<span><span class="co">#&gt;   ..$ 1: chr "Hombre"</span></span>
<span><span class="co">#&gt;   ..$ 2: chr "Mujer"</span></span>
<span><span class="co">#&gt;  $ relationship:List of 5</span></span>
<span><span class="co">#&gt;   ..$ 1: chr "Jefe"</span></span>
<span><span class="co">#&gt;   ..$ 2: chr "Conyuge"</span></span>
<span><span class="co">#&gt;   ..$ 3: chr "Hijo"</span></span>
<span><span class="co">#&gt;   ..$ 4: chr "Otro familiar"</span></span>
<span><span class="co">#&gt;   ..$ 5: chr "No familiar"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="construir-una-recipe-a-partir-de-los-steps-transpilados">Construir una Recipe a partir de los steps transpilados<a class="anchor" aria-label="anchor" href="#construir-una-recipe-a-partir-de-los-steps-transpilados"></a>
</h3>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/Recipe-class.html">Recipe</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  id <span class="op">=</span> <span class="st">"example_demographics"</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"Demografia (transpilada)"</span>,</span>
<span>  user <span class="op">=</span> <span class="st">"equipo_investigacion"</span>,</span>
<span>  edition <span class="op">=</span> <span class="st">"2022"</span>,</span>
<span>  survey_type <span class="op">=</span> <span class="st">"ech"</span>,</span>
<span>  default_engine <span class="op">=</span> <span class="st">"data.table"</span>,</span>
<span>  depends_on <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>,</span>
<span>  description <span class="op">=</span> <span class="st">"Demografia armonizada desde transpilacion de STATA"</span>,</span>
<span>  steps <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">steps</span>,</span>
<span>  labels <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">labels</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Guardar como JSON</span></span>
<span><span class="fu"><a href="../reference/save_recipe.html">save_recipe</a></span><span class="op">(</span><span class="va">rec</span>, <span class="st">"demographics_recipe.json"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Aplicar a datos de encuesta</span></span>
<span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survey_empty.html">survey_empty</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"ech"</span>, edition <span class="op">=</span> <span class="st">"2022"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_data.html">set_data</a></span><span class="op">(</span><span class="va">my_data</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/add_recipe.html">add_recipe</a></span><span class="op">(</span><span class="va">rec</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/bake_recipes.html">bake_recipes</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="transpilacion-a-nivel-de-modulo">Transpilacion a nivel de modulo<a class="anchor" aria-label="anchor" href="#transpilacion-a-nivel-de-modulo"></a>
</h2>
<p>Para proyectos que organizan archivos <code>.do</code> por anio y
modulo tematico, <code><a href="../reference/transpile_stata_module.html">transpile_stata_module()</a></code> procesa un
directorio de un anio completo y agrupa los resultados en objetos Recipe
separados:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">recipes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/transpile_stata_module.html">transpile_stata_module</a></span><span class="op">(</span></span>
<span>  year_dir <span class="op">=</span> <span class="st">"do_files/2022"</span>,</span>
<span>  year <span class="op">=</span> <span class="fl">2022</span>,</span>
<span>  user <span class="op">=</span> <span class="st">"equipo_investigacion"</span>,</span>
<span>  output_dir <span class="op">=</span> <span class="st">"recipes/"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">recipes</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "data_prep"        "demographics"     "income_detail"</span></span>
<span><span class="co">#&gt; [4] "income_aggregate" "cleanup"</span></span>
<span></span>
<span><span class="co"># Cada receta tiene dependencias inter-modulo</span></span>
<span><span class="va">recipes</span><span class="op">$</span><span class="va">income_detail</span><span class="op">$</span><span class="va">depends_on_recipes</span></span>
<span><span class="co">#&gt; [1] "ech_2022_data_prep"    "ech_2022_demographics"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="analisis-de-cobertura">Analisis de cobertura<a class="anchor" aria-label="anchor" href="#analisis-de-cobertura"></a>
</h2>
<p><code><a href="../reference/transpile_coverage.html">transpile_coverage()</a></code> reporta cuantos comandos en un
archivo <code>.do</code> (o directorio) pueden transpilarse
automaticamente:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/transpile_coverage.html">transpile_coverage</a></span><span class="op">(</span><span class="st">"do_files/"</span><span class="op">)</span></span>
<span><span class="co">#&gt;                               file total translated skipped manual coverage</span></span>
<span><span class="co">#&gt; 1   2022/2_correc_datos.do             82        60      22      0   100.00</span></span>
<span><span class="co">#&gt; 2   2022/3_compatibiliz...do          420       380      40      0   100.00</span></span>
<span><span class="co">#&gt; 3   2022/4_ingreso_ht11...do          310       270      40      0   100.00</span></span></code></pre></div>
<p>La columna <code>coverage_pct</code> reporta el porcentaje de
comandos <strong>que transforman datos</strong> que fueron traducidos
(excluyendo comandos no-datos omitidos). Un valor por debajo de 100%
significa que algunos comandos necesitan revision manual – consultar el
elemento <code>$warnings</code> para detalles.</p>
</div>
<div class="section level2">
<h2 id="limitaciones">Limitaciones<a class="anchor" aria-label="anchor" href="#limitaciones"></a>
</h2>
<p>El transpilador <strong>no</strong> maneja:</p>
<ul>
<li>Comandos <code>merge</code> (dependen de archivos externos y se
traducen como comentarios con <code># MANUAL_REVIEW</code>)</li>
<li>
<code>collapse</code> / <code>reshape</code> (transformaciones
estructurales de datos)</li>
<li>Definiciones de <code>program</code> personalizados</li>
<li>Bloques <code>mata</code> o llamadas a <code>plugin</code>
</li>
<li>Comentarios de bloque <code>/* */</code> anidados que contienen
continuaciones de linea <code>/* */</code> internamente (raro; solo
visto en codigo legacy comentado)</li>
</ul>
<p>Los comandos que quedan fuera del alcance del transpilador se marcan
con <code># MANUAL_REVIEW</code> en la salida y se cuentan en
<code>$stats$manual_review</code>.</p>
</div>
<div class="section level2">
<h2 id="resumen">Resumen<a class="anchor" aria-label="anchor" href="#resumen"></a>
</h2>
<table class="table">
<colgroup>
<col width="50%">
<col width="50%">
</colgroup>
<thead><tr class="header">
<th>Funcionalidad</th>
<th>Estado</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>gen / generate</td>
<td>Completamente soportado</td>
</tr>
<tr class="even">
<td>replace (condicional)</td>
<td>Completamente soportado</td>
</tr>
<tr class="odd">
<td>Cadenas gen + replace</td>
<td>Auto-agrupadas en step_recode o step_compute</td>
</tr>
<tr class="even">
<td>recode (simple y multi-variable)</td>
<td>Completamente soportado</td>
</tr>
<tr class="odd">
<td>egen con by-groups</td>
<td>Completamente soportado</td>
</tr>
<tr class="even">
<td>foreach / forvalues</td>
<td>Expandidos durante el parsing</td>
</tr>
<tr class="odd">
<td>mvencode</td>
<td>Completamente soportado</td>
</tr>
<tr class="even">
<td>destring / tostring</td>
<td>Completamente soportado</td>
</tr>
<tr class="odd">
<td>rename / drop / keep</td>
<td>Completamente soportado</td>
</tr>
<tr class="even">
<td>Etiquetas de variables y valores</td>
<td>Extraidas a metadatos de la receta</td>
</tr>
<tr class="odd">
<td>Expresiones STATA</td>
<td>inrange, inlist, missing, lag/lead, _N</td>
</tr>
<tr class="even">
<td>Rangos de variables</td>
<td>Expandidos (ej., var1-var4)</td>
</tr>
<tr class="odd">
<td>Loops anidados</td>
<td>Expansion recursiva</td>
</tr>
<tr class="even">
<td>Continuacion de linea (///)</td>
<td>Unidas durante el parsing</td>
</tr>
<tr class="odd">
<td>Prefijo capture</td>
<td>Manejado (errores suprimidos)</td>
</tr>
<tr class="even">
<td>Prefijo bysort</td>
<td>Convertido a parametro .by</td>
</tr>
</tbody>
</table>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://iesta.fcea.udelar.edu.uy/integrantes/loprete-mauro/" class="external-link">Mauro Loprete</a>, <a href="https://natydasilva.github.io/natydasilva/" class="external-link">Natalia da Silva</a>, <a href="https://iecon.fcea.udelar.edu.uy/es/autores/item/machado-fabricio.html" class="external-link">Fabricio Machado</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
