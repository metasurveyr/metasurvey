<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>API and Database Reference • metasurvey</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="API and Database Reference">
<!-- javascript assets for rmarkdown --><meta name="pkgdown-site-root" content="../">
<script src="../ace-1.2.3/ace.js" type="text/javascript" charset="utf-8"></script><script src="../holder-2.9.0/holder.min.js" type="text/javascript" charset="utf-8"></script><script src="../snippets/snippets.js" type="text/javascript" charset="utf-8"></script><style type="text/css">
.snippet {
  border: solid 1px #cccccc;
  margin-bottom: 12px;
  width: 100%;
}
</style>
</head>
<body>
<p>
pkgdown/templates/in-header.html

  

  </p>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">metasurvey</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.5</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/metasurveyr/metasurvey/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>API and Database Reference</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/metasurveyr/metasurvey/blob/feature/v0.0.4-refactor/vignettes/api-database.Rmd" class="external-link"><code>vignettes/api-database.Rmd</code></a></small>
      <div class="d-none name"><code>api-database.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>metasurvey provides a REST API built with <a href="https://www.rplumber.io/" class="external-link">plumber</a> backed by MongoDB for
sharing recipes, workflows, and variable metadata with the community.
The API is deployed on Railway and is used by both the R client
functions (<code>api_*</code>) and the Shiny exploration
application.</p>
<p><strong>Production URL:</strong>
<code>https://metasurvey-api-production.up.railway.app</code></p>
<p><strong>Interactive API documentation (Swagger UI):</strong>
<code>https://metasurvey-api-production.up.railway.app/__docs__/</code></p>
<p>The Swagger UI interface provides an interactive endpoint explorer
automatically generated by plumber. For detailed request/response
schemas and MongoDB collection documentation, see the sections
below.</p>
</div>
<div class="section level2">
<h2 id="configuration">Configuration<a class="anchor" aria-label="anchor" href="#configuration"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://metasurveyr.github.io/metasurvey">metasurvey</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Point to the production API (default)</span></span>
<span><span class="fu"><a href="../reference/configure_api.html">configure_api</a></span><span class="op">(</span><span class="st">"https://metasurvey-api-production.up.railway.app"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Or use an environment variable</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span>METASURVEY_API_URL <span class="op">=</span> <span class="st">"https://metasurvey-api-production.up.railway.app"</span><span class="op">)</span></span></code></pre></div>
<p>The R client reads the URL first from <code><a href="../reference/configure_api.html">configure_api()</a></code>,
then falls back to the <code>METASURVEY_API_URL</code> environment
variable, and finally uses the production URL.</p>
</div>
<div class="section level2">
<h2 id="authentication">Authentication<a class="anchor" aria-label="anchor" href="#authentication"></a>
</h2>
<p>The API uses JWT (JSON Web Token) authentication with HMAC-SHA256
signing. Tokens expire after 24 hours; long-lived tokens (90 days) can
be generated for automated scripts.</p>
<div class="section level3">
<h3 id="registration">Registration<a class="anchor" aria-label="anchor" href="#registration"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Individual account (auto-approved)</span></span>
<span><span class="fu"><a href="../reference/api_register.html">api_register</a></span><span class="op">(</span><span class="st">"Ana Garcia"</span>, <span class="st">"ana@example.com"</span>, <span class="st">"password123"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Institutional member (requires admin review)</span></span>
<span><span class="fu"><a href="../reference/api_register.html">api_register</a></span><span class="op">(</span></span>
<span>  <span class="st">"Carlos Rodriguez"</span>,</span>
<span>  <span class="st">"carlos@ine.gub.uy"</span>,</span>
<span>  <span class="st">"password123"</span>,</span>
<span>  user_type <span class="op">=</span> <span class="st">"institutional_member"</span>,</span>
<span>  institution <span class="op">=</span> <span class="st">"INE Uruguay"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Account types:</p>
<table class="table">
<colgroup>
<col width="20%">
<col width="44%">
<col width="34%">
</colgroup>
<thead><tr class="header">
<th>Type</th>
<th>Description</th>
<th>Approval</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>individual</code></td>
<td>Independent researcher</td>
<td>Automatic</td>
</tr>
<tr class="even">
<td><code>institutional_member</code></td>
<td>Member of a recognized institution</td>
<td>Requires admin review</td>
</tr>
<tr class="odd">
<td><code>institution</code></td>
<td>Institutional account</td>
<td>Requires admin review</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="login">Login<a class="anchor" aria-label="anchor" href="#login"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/api_login.html">api_login</a></span><span class="op">(</span><span class="st">"ana@example.com"</span>, <span class="st">"password123"</span><span class="op">)</span></span></code></pre></div>
<p>The token is stored in the session and used automatically in
subsequent API calls. The client automatically renews tokens within 5
minutes of their expiration.</p>
</div>
<div class="section level3">
<h3 id="session-management">Session Management<a class="anchor" aria-label="anchor" href="#session-management"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># View current user profile</span></span>
<span><span class="fu"><a href="../reference/api_me.html">api_me</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Refresh token</span></span>
<span><span class="fu"><a href="../reference/api_refresh_token.html">api_refresh_token</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Logout</span></span>
<span><span class="fu"><a href="../reference/api_logout.html">api_logout</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="long-lived-tokens">Long-lived Tokens<a class="anchor" aria-label="anchor" href="#long-lived-tokens"></a>
</h3>
<p>For automated scripts and CI/CD, generate a 90-day token from the
Shiny application (Profile tab) or use it directly:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span>METASURVEY_TOKEN <span class="op">=</span> <span class="st">"your-long-lived-token"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># API calls work without interactive login</span></span>
<span><span class="va">recipes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/api_list_recipes.html">api_list_recipes</a></span><span class="op">(</span>survey_type <span class="op">=</span> <span class="st">"ech"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="api-endpoints">API Endpoints<a class="anchor" aria-label="anchor" href="#api-endpoints"></a>
</h2>
<div class="section level3">
<h3 id="recipes">Recipes<a class="anchor" aria-label="anchor" href="#recipes"></a>
</h3>
<table class="table">
<thead><tr class="header">
<th>Method</th>
<th>Endpoint</th>
<th>Auth</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>GET</code></td>
<td><code>/recipes</code></td>
<td>No</td>
<td>List and search recipes</td>
</tr>
<tr class="even">
<td><code>GET</code></td>
<td><code>/recipes/:id</code></td>
<td>No</td>
<td>Get an individual recipe</td>
</tr>
<tr class="odd">
<td><code>POST</code></td>
<td><code>/recipes</code></td>
<td>Yes</td>
<td>Publish a new recipe</td>
</tr>
<tr class="even">
<td><code>POST</code></td>
<td><code>/recipes/:id/download</code></td>
<td>No</td>
<td>Increment download counter</td>
</tr>
</tbody>
</table>
<div class="section level4">
<h4 id="list-recipes">List Recipes<a class="anchor" aria-label="anchor" href="#list-recipes"></a>
</h4>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># All recipes</span></span>
<span><span class="va">all</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/api_list_recipes.html">api_list_recipes</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Filter by survey type</span></span>
<span><span class="va">ech</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/api_list_recipes.html">api_list_recipes</a></span><span class="op">(</span>survey_type <span class="op">=</span> <span class="st">"ech"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Search by text</span></span>
<span><span class="va">labor</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/api_list_recipes.html">api_list_recipes</a></span><span class="op">(</span>search <span class="op">=</span> <span class="st">"empleo"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Filter by topic</span></span>
<span><span class="va">income</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/api_list_recipes.html">api_list_recipes</a></span><span class="op">(</span>topic <span class="op">=</span> <span class="st">"income"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Filter by certification level</span></span>
<span><span class="va">official</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/api_list_recipes.html">api_list_recipes</a></span><span class="op">(</span>certification <span class="op">=</span> <span class="st">"official"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Pagination</span></span>
<span><span class="va">page2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/api_list_recipes.html">api_list_recipes</a></span><span class="op">(</span>limit <span class="op">=</span> <span class="fl">10</span>, offset <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p>Query parameters:</p>
<table class="table">
<colgroup>
<col width="36%">
<col width="20%">
<col width="43%">
</colgroup>
<thead><tr class="header">
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>search</code></td>
<td>string</td>
<td>Regex search on recipe name</td>
</tr>
<tr class="even">
<td><code>survey_type</code></td>
<td>string</td>
<td>
<code>ech</code>, <code>eaii</code>, <code>eph</code>,
<code>eai</code>
</td>
</tr>
<tr class="odd">
<td><code>topic</code></td>
<td>string</td>
<td>
<code>labor_market</code>, <code>income</code>,
<code>education</code>, <code>health</code>, <code>demographics</code>,
<code>housing</code>
</td>
</tr>
<tr class="even">
<td><code>certification</code></td>
<td>string</td>
<td>
<code>community</code>, <code>reviewed</code>,
<code>official</code>
</td>
</tr>
<tr class="odd">
<td><code>user</code></td>
<td>string</td>
<td>Filter by author email</td>
</tr>
<tr class="even">
<td><code>limit</code></td>
<td>integer</td>
<td>Maximum results (default 50)</td>
</tr>
<tr class="odd">
<td><code>offset</code></td>
<td>integer</td>
<td>Skip N results (default 0)</td>
</tr>
</tbody>
</table>
</div>
<div class="section level4">
<h4 id="get-recipe">Get Recipe<a class="anchor" aria-label="anchor" href="#get-recipe"></a>
</h4>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">recipe</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/api_get_recipe.html">api_get_recipe</a></span><span class="op">(</span><span class="st">"ech_employment_001"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="publish-recipe">Publish Recipe<a class="anchor" aria-label="anchor" href="#publish-recipe"></a>
</h4>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/api_login.html">api_login</a></span><span class="op">(</span><span class="st">"ana@example.com"</span>, <span class="st">"password123"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/api_publish_recipe.html">api_publish_recipe</a></span><span class="op">(</span><span class="va">my_recipe</span><span class="op">)</span></span></code></pre></div>
<p>The server automatically sets the <code>user</code> field from the
JWT, initializes <code>downloads = 0</code>, generates an
<code>id</code> if not provided, and assigns the <code>community</code>
certification by default.</p>
</div>
</div>
<div class="section level3">
<h3 id="workflows">Workflows<a class="anchor" aria-label="anchor" href="#workflows"></a>
</h3>
<table class="table">
<thead><tr class="header">
<th>Method</th>
<th>Endpoint</th>
<th>Auth</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>GET</code></td>
<td><code>/workflows</code></td>
<td>No</td>
<td>List and search workflows</td>
</tr>
<tr class="even">
<td><code>GET</code></td>
<td><code>/workflows/:id</code></td>
<td>No</td>
<td>Get an individual workflow</td>
</tr>
<tr class="odd">
<td><code>POST</code></td>
<td><code>/workflows</code></td>
<td>Yes</td>
<td>Publish a new workflow</td>
</tr>
<tr class="even">
<td><code>POST</code></td>
<td><code>/workflows/:id/download</code></td>
<td>No</td>
<td>Increment download counter</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># List workflows for ECH</span></span>
<span><span class="va">wf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/api_list_workflows.html">api_list_workflows</a></span><span class="op">(</span>survey_type <span class="op">=</span> <span class="st">"ech"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Find workflows that use a specific recipe</span></span>
<span><span class="va">wf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/api_list_workflows.html">api_list_workflows</a></span><span class="op">(</span>recipe_id <span class="op">=</span> <span class="st">"ech_employment_001"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get specific workflow</span></span>
<span><span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/api_get_workflow.html">api_get_workflow</a></span><span class="op">(</span><span class="st">"wf_labor_market_001"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Publish</span></span>
<span><span class="fu"><a href="../reference/api_publish_workflow.html">api_publish_workflow</a></span><span class="op">(</span><span class="va">my_workflow</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="anda-variable-metadata">ANDA Variable Metadata<a class="anchor" aria-label="anchor" href="#anda-variable-metadata"></a>
</h3>
<blockquote>
<p><strong>Note:</strong> The ANDA integration is an <em>unofficial</em>
implementation that parses DDI XML metadata from INE Uruguay’s public
ANDA catalog. It is not endorsed by INE and may contain errors or become
outdated if INE changes the catalog structure. Always verify critical
variable definitions against the official codebook.</p>
</blockquote>
<p>The <code>/anda/variables</code> endpoint provides variable metadata
obtained from INE Uruguay’s ANDA catalog (DDI XML format). This includes
variable labels, value categories, and type information.</p>
<table class="table">
<thead><tr class="header">
<th>Method</th>
<th>Endpoint</th>
<th>Auth</th>
<th>Description</th>
</tr></thead>
<tbody><tr class="odd">
<td><code>GET</code></td>
<td><code>/anda/variables</code></td>
<td>No</td>
<td>Get variable metadata</td>
</tr></tbody>
</table>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get all ECH variables</span></span>
<span><span class="va">vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/api_get_anda_variables.html">api_get_anda_variables</a></span><span class="op">(</span>survey_type <span class="op">=</span> <span class="st">"ech"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get specific variables</span></span>
<span><span class="va">vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/api_get_anda_variables.html">api_get_anda_variables</a></span><span class="op">(</span></span>
<span>  survey_type <span class="op">=</span> <span class="st">"ech"</span>,</span>
<span>  var_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pobpcoac"</span>, <span class="st">"e27"</span>, <span class="st">"ht11"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Query parameters:</p>
<table class="table">
<thead><tr class="header">
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>survey_type</code></td>
<td>string</td>
<td>Survey type (default <code>"ech"</code>)</td>
</tr>
<tr class="even">
<td><code>names</code></td>
<td>string</td>
<td>Comma-separated variable names (all if empty)</td>
</tr>
</tbody>
</table>
<p>Each variable document contains:</p>
<table class="table">
<thead><tr class="header">
<th>Field</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>name</code></td>
<td>Variable name (lowercase)</td>
</tr>
<tr class="even">
<td><code>label</code></td>
<td>Human-readable label</td>
</tr>
<tr class="odd">
<td><code>type</code></td>
<td>
<code>discrete</code>, <code>continuous</code>, or
<code>unknown</code>
</td>
</tr>
<tr class="even">
<td><code>value_labels</code></td>
<td>List of code-label mappings</td>
</tr>
<tr class="odd">
<td><code>description</code></td>
<td>Extended description</td>
</tr>
<tr class="even">
<td><code>source_edition</code></td>
<td>Survey edition (e.g., <code>"2024"</code>)</td>
</tr>
<tr class="odd">
<td><code>source_catalog_id</code></td>
<td>ANDA catalog ID (e.g., <code>767</code>)</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="administration">Administration<a class="anchor" aria-label="anchor" href="#administration"></a>
</h3>
<table class="table">
<colgroup>
<col width="21%">
<col width="27%">
<col width="16%">
<col width="35%">
</colgroup>
<thead><tr class="header">
<th>Method</th>
<th>Endpoint</th>
<th>Auth</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>GET</code></td>
<td><code>/admin/pending-users</code></td>
<td>Admin</td>
<td>List institutional accounts pending review</td>
</tr>
<tr class="even">
<td><code>POST</code></td>
<td><code>/admin/approve/:email</code></td>
<td>Admin</td>
<td>Approve an institutional account</td>
</tr>
<tr class="odd">
<td><code>POST</code></td>
<td><code>/admin/reject/:email</code></td>
<td>Admin</td>
<td>Reject an institutional account</td>
</tr>
</tbody>
</table>
<p>Admin access is controlled via the
<code>METASURVEY_ADMIN_EMAIL</code> environment variable on the
server.</p>
</div>
<div class="section level3">
<h3 id="health-check">Health Check<a class="anchor" aria-label="anchor" href="#health-check"></a>
</h3>
<table class="table">
<thead><tr class="header">
<th>Method</th>
<th>Endpoint</th>
<th>Auth</th>
<th>Description</th>
</tr></thead>
<tbody><tr class="odd">
<td><code>GET</code></td>
<td><code>/health</code></td>
<td>No</td>
<td>API and MongoDB status</td>
</tr></tbody>
</table>
<div class="sourceCode" id="cb11"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>  <span class="dt">"status"</span><span class="fu">:</span> <span class="st">"ok"</span><span class="fu">,</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>  <span class="dt">"service"</span><span class="fu">:</span> <span class="st">"metasurvey-api"</span><span class="fu">,</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>  <span class="dt">"version"</span><span class="fu">:</span> <span class="st">"2.0.0"</span><span class="fu">,</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>  <span class="dt">"database"</span><span class="fu">:</span> <span class="st">"metasurvey"</span><span class="fu">,</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>  <span class="dt">"mongodb"</span><span class="fu">:</span> <span class="st">"connected"</span><span class="fu">,</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>  <span class="dt">"timestamp"</span><span class="fu">:</span> <span class="st">"2026-02-15T12:00:00Z"</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="mongodb-schema">MongoDB Schema<a class="anchor" aria-label="anchor" href="#mongodb-schema"></a>
</h2>
<p>The database has four collections, each with JSON Schema validation
and optimized indexes.</p>
<div class="section level3">
<h3 id="entity-relationship-diagram">Entity-Relationship Diagram<a class="anchor" aria-label="anchor" href="#entity-relationship-diagram"></a>
</h3>
<p>The following diagram shows the MongoDB collections and their
relationships:</p>
<pre class="text"><code>  ┌──────────────────┐       ┌──────────────────────┐
  │     users         │       │      recipes          │
  ├──────────────────┤       ├──────────────────────┤
  │ email (PK)       │──┐    │ id (PK)              │
  │ name             │  │    │ name                 │
  │ password_hash    │  ├───&gt;│ user (FK)            │
  │ user_type        │  │    │ survey_type          │
  │ institution      │  │    │ edition              │
  └──────────────────┘  │    │ steps[]              │
                        │    │ certification{}      │
                        │    │ categories[]         │
                        │    └──────────┬───────────┘
                        │               │
                        │    ┌──────────┴───────────┐
                        │    │     workflows         │
                        │    ├──────────────────────┤
                        │    │ id (PK)              │
                        └───&gt;│ user (FK)            │
                             │ survey_type          │
                             │ recipe_ids[] (FK)    │
                             │ calls[]              │
                             └──────────────────────┘

  ┌──────────────────────┐
  │   anda_variables      │
  ├──────────────────────┤
  │ survey_type (PK)     │
  │ name (PK)            │
  │ label                │
  │ type                 │
  │ value_labels{}       │
  └──────────────────────┘

  Relationships:
    users    ──1:N──&gt;  recipes     (publishes)
    users    ──1:N──&gt;  workflows   (publishes)
    recipes  ──1:N──&gt;  workflows   (referenced by)</code></pre>
</div>
<div class="section level3">
<h3 id="collections">Collections<a class="anchor" aria-label="anchor" href="#collections"></a>
</h3>
<div class="section level4">
<h4 id="users">
<code>users</code><a class="anchor" aria-label="anchor" href="#users"></a>
</h4>
<table class="table">
<colgroup>
<col width="19%">
<col width="16%">
<col width="27%">
<col width="36%">
</colgroup>
<thead><tr class="header">
<th>Field</th>
<th>Type</th>
<th>Required</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>name</code></td>
<td>string</td>
<td>Yes</td>
<td>Display name</td>
</tr>
<tr class="even">
<td><code>email</code></td>
<td>string</td>
<td>Yes</td>
<td>Email (unique, validated)</td>
</tr>
<tr class="odd">
<td><code>password_hash</code></td>
<td>string</td>
<td>Yes</td>
<td>SHA-256 hash (64 characters)</td>
</tr>
<tr class="even">
<td><code>user_type</code></td>
<td>enum</td>
<td>Yes</td>
<td>
<code>individual</code>, <code>institutional_member</code>,
<code>institution</code>
</td>
</tr>
<tr class="odd">
<td><code>institution</code></td>
<td>string</td>
<td>No</td>
<td>Institution name</td>
</tr>
<tr class="even">
<td><code>verified</code></td>
<td>boolean</td>
<td>No</td>
<td>Whether identity is verified</td>
</tr>
<tr class="odd">
<td><code>review_status</code></td>
<td>enum</td>
<td>No</td>
<td>
<code>approved</code>, <code>pending</code>,
<code>rejected</code>
</td>
</tr>
<tr class="even">
<td><code>reviewed_by</code></td>
<td>string</td>
<td>No</td>
<td>Reviewing admin’s email</td>
</tr>
<tr class="odd">
<td><code>reviewed_at</code></td>
<td>string</td>
<td>No</td>
<td>ISO timestamp</td>
</tr>
<tr class="even">
<td><code>created_at</code></td>
<td>string</td>
<td>Yes</td>
<td>ISO timestamp</td>
</tr>
</tbody>
</table>
<p><strong>Indexes:</strong> unique on <code>email</code>.</p>
</div>
<div class="section level4">
<h4 id="recipes-1">
<code>recipes</code><a class="anchor" aria-label="anchor" href="#recipes-1"></a>
</h4>
<table class="table">
<colgroup>
<col width="19%">
<col width="16%">
<col width="27%">
<col width="36%">
</colgroup>
<thead><tr class="header">
<th>Field</th>
<th>Type</th>
<th>Required</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>id</code></td>
<td>string</td>
<td>No</td>
<td>Unique identifier (auto-generated)</td>
</tr>
<tr class="even">
<td><code>name</code></td>
<td>string</td>
<td>Yes</td>
<td>Recipe name</td>
</tr>
<tr class="odd">
<td><code>user</code></td>
<td>string</td>
<td>Yes</td>
<td>Author email</td>
</tr>
<tr class="even">
<td><code>survey_type</code></td>
<td>enum</td>
<td>Yes</td>
<td>
<code>ech</code>, <code>eaii</code>, <code>eph</code>,
<code>eai</code>
</td>
</tr>
<tr class="odd">
<td><code>edition</code></td>
<td>string/array</td>
<td>No</td>
<td>Survey edition(s)</td>
</tr>
<tr class="even">
<td><code>description</code></td>
<td>string</td>
<td>No</td>
<td>Description</td>
</tr>
<tr class="odd">
<td><code>topic</code></td>
<td>enum</td>
<td>No</td>
<td>
<code>labor_market</code>, <code>income</code>,
<code>education</code>, <code>health</code>, <code>demographics</code>,
<code>housing</code>
</td>
</tr>
<tr class="even">
<td><code>version</code></td>
<td>string</td>
<td>No</td>
<td>Semantic version (default <code>"1.0.0"</code>)</td>
</tr>
<tr class="odd">
<td><code>downloads</code></td>
<td>number</td>
<td>No</td>
<td>Download counter (default <code>0</code>)</td>
</tr>
<tr class="even">
<td><code>steps</code></td>
<td>array</td>
<td>No</td>
<td>Step expressions as strings</td>
</tr>
<tr class="odd">
<td><code>depends_on</code></td>
<td>array</td>
<td>No</td>
<td>Required input variable names</td>
</tr>
<tr class="even">
<td><code>depends_on_recipes</code></td>
<td>array</td>
<td>No</td>
<td>IDs of dependent recipes</td>
</tr>
<tr class="odd">
<td><code>categories</code></td>
<td>array</td>
<td>No</td>
<td>Category objects</td>
</tr>
<tr class="even">
<td><code>certification</code></td>
<td>object</td>
<td>No</td>
<td><code>{level, certified_at, certified_by, notes}</code></td>
</tr>
<tr class="odd">
<td><code>user_info</code></td>
<td>object</td>
<td>No</td>
<td><code>{name, user_type, email, url, verified}</code></td>
</tr>
<tr class="even">
<td><code>doc</code></td>
<td>object</td>
<td>No</td>
<td><code>{input_variables, output_variables, pipeline}</code></td>
</tr>
<tr class="odd">
<td><code>data_source</code></td>
<td>object</td>
<td>No</td>
<td><code>{s3_bucket, s3_prefix, file_pattern, provider}</code></td>
</tr>
</tbody>
</table>
<p><strong>Indexes:</strong> unique on <code>id</code>; on
<code>user</code>, <code>survey_type</code>, <code>topic</code>,
<code>downloads</code> (desc), <code>certification.level</code>;
compound on <code>(survey_type, edition)</code>; text search on
<code>(name, description, topic)</code>.</p>
</div>
<div class="section level4">
<h4 id="workflows-1">
<code>workflows</code><a class="anchor" aria-label="anchor" href="#workflows-1"></a>
</h4>
<table class="table">
<colgroup>
<col width="19%">
<col width="16%">
<col width="27%">
<col width="36%">
</colgroup>
<thead><tr class="header">
<th>Field</th>
<th>Type</th>
<th>Required</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>id</code></td>
<td>string</td>
<td>No</td>
<td>Unique identifier (auto-generated)</td>
</tr>
<tr class="even">
<td><code>name</code></td>
<td>string</td>
<td>Yes</td>
<td>Workflow name</td>
</tr>
<tr class="odd">
<td><code>user</code></td>
<td>string</td>
<td>Yes</td>
<td>Author email</td>
</tr>
<tr class="even">
<td><code>survey_type</code></td>
<td>enum</td>
<td>Yes</td>
<td>
<code>ech</code>, <code>eaii</code>, <code>eph</code>,
<code>eai</code>
</td>
</tr>
<tr class="odd">
<td><code>edition</code></td>
<td>string/array</td>
<td>No</td>
<td>Survey edition(s)</td>
</tr>
<tr class="even">
<td><code>description</code></td>
<td>string</td>
<td>No</td>
<td>Description</td>
</tr>
<tr class="odd">
<td><code>version</code></td>
<td>string</td>
<td>No</td>
<td>Semantic version</td>
</tr>
<tr class="even">
<td><code>downloads</code></td>
<td>number</td>
<td>No</td>
<td>Download counter</td>
</tr>
<tr class="odd">
<td><code>estimation_type</code></td>
<td>string/array</td>
<td>No</td>
<td>
<code>annual</code>, <code>quarterly</code>,
<code>monthly</code>
</td>
</tr>
<tr class="even">
<td><code>recipe_ids</code></td>
<td>array</td>
<td>No</td>
<td>Referenced recipe IDs</td>
</tr>
<tr class="odd">
<td><code>calls</code></td>
<td>array</td>
<td>No</td>
<td>Estimation calls as strings</td>
</tr>
<tr class="even">
<td><code>call_metadata</code></td>
<td>array</td>
<td>No</td>
<td>Call descriptions</td>
</tr>
<tr class="odd">
<td><code>categories</code></td>
<td>array</td>
<td>No</td>
<td>Category objects</td>
</tr>
<tr class="even">
<td><code>certification</code></td>
<td>object</td>
<td>No</td>
<td>Same as recipes</td>
</tr>
<tr class="odd">
<td><code>user_info</code></td>
<td>object</td>
<td>No</td>
<td>Same as recipes</td>
</tr>
</tbody>
</table>
<p><strong>Indexes:</strong> unique on <code>id</code>; on
<code>user</code>, <code>survey_type</code>, <code>recipe_ids</code>,
<code>downloads</code> (desc); compound on
<code>(survey_type, edition)</code>; text search on
<code>(name, description)</code>.</p>
</div>
<div class="section level4">
<h4 id="anda_variables">
<code>anda_variables</code><a class="anchor" aria-label="anchor" href="#anda_variables"></a>
</h4>
<table class="table">
<thead><tr class="header">
<th>Field</th>
<th>Type</th>
<th>Required</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>survey_type</code></td>
<td>string</td>
<td>Yes</td>
<td>Survey type</td>
</tr>
<tr class="even">
<td><code>name</code></td>
<td>string</td>
<td>Yes</td>
<td>Variable name (lowercase)</td>
</tr>
<tr class="odd">
<td><code>label</code></td>
<td>string</td>
<td>Yes</td>
<td>Human-readable label</td>
</tr>
<tr class="even">
<td><code>type</code></td>
<td>enum</td>
<td>No</td>
<td>
<code>discrete</code>, <code>continuous</code>,
<code>unknown</code>
</td>
</tr>
<tr class="odd">
<td><code>value_labels</code></td>
<td>object</td>
<td>No</td>
<td>Code-label mappings</td>
</tr>
<tr class="even">
<td><code>description</code></td>
<td>string</td>
<td>No</td>
<td>Extended description</td>
</tr>
<tr class="odd">
<td><code>source_edition</code></td>
<td>string</td>
<td>No</td>
<td>Edition (e.g., <code>"2024"</code>)</td>
</tr>
<tr class="even">
<td><code>source_catalog_id</code></td>
<td>number</td>
<td>No</td>
<td>ANDA catalog ID</td>
</tr>
</tbody>
</table>
<p><strong>Indexes:</strong> compound unique on
<code>(survey_type, name)</code>; on <code>survey_type</code>.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="database-setup">Database Setup<a class="anchor" aria-label="anchor" href="#database-setup"></a>
</h2>
<p>To set up the database on a new deployment:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co"># 1. Create collections with JSON Schema validation and indexes</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="ex">mongosh</span> <span class="st">"</span><span class="va">$METASURVEY_MONGO_URI</span><span class="st">"</span> inst/scripts/setup_mongodb.js</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="co"># 2. Seed recipes, workflows, and users</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a><span class="va">METASURVEY_MONGO_URI</span><span class="op">=</span><span class="st">"..."</span> <span class="ex">Rscript</span> inst/scripts/seed_ech_recipes.R</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a><span class="co"># 3. Seed ANDA variable metadata from INE catalog</span></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a><span class="va">METASURVEY_MONGO_URI</span><span class="op">=</span><span class="st">"..."</span> <span class="ex">Rscript</span> inst/scripts/seed_anda_metadata.R</span></code></pre></div>
<p>The setup script creates the four collections and builds the indexes.
It is idempotent: existing collections are skipped.</p>
</div>
<div class="section level2">
<h2 id="server-deployment">Server Deployment<a class="anchor" aria-label="anchor" href="#server-deployment"></a>
</h2>
<div class="section level3">
<h3 id="environment-variables">Environment Variables<a class="anchor" aria-label="anchor" href="#environment-variables"></a>
</h3>
<table class="table">
<colgroup>
<col width="23%">
<col width="23%">
<col width="21%">
<col width="30%">
</colgroup>
<thead><tr class="header">
<th>Variable</th>
<th>Required</th>
<th>Default</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>METASURVEY_MONGO_URI</code></td>
<td>Yes</td>
<td>—</td>
<td>MongoDB connection string</td>
</tr>
<tr class="even">
<td><code>METASURVEY_DB</code></td>
<td>No</td>
<td><code>metasurvey</code></td>
<td>Database name</td>
</tr>
<tr class="odd">
<td><code>METASURVEY_JWT_SECRET</code></td>
<td>No</td>
<td><code>metasurvey-dev-secret-...</code></td>
<td>JWT signing secret (override in production)</td>
</tr>
<tr class="even">
<td><code>METASURVEY_ADMIN_EMAIL</code></td>
<td>No</td>
<td>—</td>
<td>Admin email for institutional review</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="running-locally">Running Locally<a class="anchor" aria-label="anchor" href="#running-locally"></a>
</h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="va">METASURVEY_MONGO_URI</span><span class="op">=</span><span class="st">"mongodb+srv://user:pass@cluster.mongodb.net"</span> <span class="dt">\</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>  <span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">'plumber::plumb("inst/api/plumber.R")$run(port = 8787)'</span></span></code></pre></div>
<p>The Swagger UI interface will be available at
<code>http://localhost:8787/__docs__/</code>.</p>
</div>
<div class="section level3">
<h3 id="docker">Docker<a class="anchor" aria-label="anchor" href="#docker"></a>
</h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="ex">docker</span> build <span class="at">-t</span> metasurvey-api inst/api/</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-p</span> 8787:8787 <span class="dt">\</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>  <span class="at">-e</span> METASURVEY_MONGO_URI=<span class="st">"mongodb+srv://..."</span> <span class="dt">\</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>  <span class="at">-e</span> METASURVEY_JWT_SECRET=<span class="st">"your-production-secret"</span> <span class="dt">\</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>  <span class="at">-e</span> METASURVEY_ADMIN_EMAIL=<span class="st">"admin@example.com"</span> <span class="dt">\</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>  metasurvey-api</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="railway">Railway<a class="anchor" aria-label="anchor" href="#railway"></a>
</h3>
<p>The API is configured for Railway deployment via the
<code>render.yaml</code> file in <code>inst/api/</code>. Push the
repository and configure the environment variables in the Railway
dashboard.</p>
</div>
</div>
<div class="section level2">
<h2 id="cors">CORS<a class="anchor" aria-label="anchor" href="#cors"></a>
</h2>
<p>The API allows cross-origin requests from any origin:</p>
<ul>
<li>
<strong>Allowed methods:</strong> GET, POST, OPTIONS</li>
<li>
<strong>Allowed headers:</strong> Content-Type, Authorization</li>
</ul>
</div>
<div class="section level2">
<h2 id="next-steps">Next Steps<a class="anchor" aria-label="anchor" href="#next-steps"></a>
</h2>
<ul>
<li>
<strong><a href="shiny-explorer.html">Interactive recipe
explorer</a></strong> – Browse recipes and workflows through the Shiny
web application</li>
<li>
<strong><a href="recipes.html">Creating and publishing
recipes</a></strong> – Build recipes programmatically and publish them
to the API</li>
<li>
<strong><a href="workflows-and-estimation.html">Estimation
workflows</a></strong> – Compute weighted survey estimates with
<code><a href="../reference/workflow.html">workflow()</a></code>
</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://www.mauroloprete.com" class="external-link">Mauro Loprete</a>, <a href="https://natydasilva.github.io/natydasilva/" class="external-link">Natalia da Silva</a>, <a href="https://iecon.fcea.udelar.edu.uy/es/autores/item/machado-fabricio.html" class="external-link">Fabricio Machado</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  
</body>
</html>
