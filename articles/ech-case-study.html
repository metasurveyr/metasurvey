<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>ECH Case Study: From STATA to R • metasurvey</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="ECH Case Study: From STATA to R">
<!-- javascript assets for rmarkdown --><meta name="pkgdown-site-root" content="../">
<script src="../ace-1.2.3/ace.js" type="text/javascript" charset="utf-8"></script><script src="../holder-2.9.0/holder.min.js" type="text/javascript" charset="utf-8"></script><script src="../snippets/snippets.js" type="text/javascript" charset="utf-8"></script><style type="text/css">
.snippet {
  border: solid 1px #cccccc;
  margin-bottom: 12px;
  width: 100%;
}
</style>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">metasurvey</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.7</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/metasurveyr/metasurvey/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>ECH Case Study: From STATA to R</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/metasurveyr/metasurvey/blob/main/vignettes/ech-case-study.Rmd" class="external-link"><code>vignettes/ech-case-study.Rmd</code></a></small>
      <div class="d-none name"><code>ech-case-study.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="the-ech-harmonization-problem">The ECH harmonization problem<a class="anchor" aria-label="anchor" href="#the-ech-harmonization-problem"></a>
</h2>
<p>Uruguay’s <em>Encuesta Continua de Hogares</em> (ECH) is published
annually by the Instituto Nacional de Estadistica (INE). Over the years,
the INE has changed variable names, codebook definitions, and module
structure across editions. Researchers working with ECH data must
<em>harmonize</em> variables —that is, map different naming conventions
to a common schema— before any cross-year analysis is possible.</p>
<p>ECH harmonization has historically been carried out by the Instituto
de Economia (IECON) at the Universidad de la Republica. The resulting
dataset has DOI: <a href="http://doi.org/10.47426/ECH.INE" class="external-link">http://doi.org/10.47426/ECH.INE</a>
(Instituto de Economia, 2020). metasurvey aims to complement and
facilitate this kind of work by providing reproducible tools in R.</p>
<p>In Uruguayan academia, this work has been done in STATA for over 30
years. A typical harmonization pipeline consists of approximately
<strong>8 .do files per year</strong>, covering:</p>
<ol style="list-style-type: decimal">
<li>
<code>2_correc_datos.do</code> – Raw data loading, merging person
and household files, variable name corrections</li>
<li>
<code>3_compatibilizacion_mod_1_4.do</code> – Harmonization of
demographic, health, education, and labor modules</li>
<li>
<code>4_ingreso_ht11.do</code> – Household income construction
(<code>ht11</code>)</li>
<li>
<code>5_descomp_fuentes.do</code> – Income decomposition by
source</li>
<li>
<code>6_ingreso_ht11_sss.do</code> – Social security
adjustments</li>
<li>
<code>7_check_ingr.do</code> – Income variable validation</li>
<li>
<code>8_arregla_base_comp.do</code> – Final dataset preparation</li>
<li>
<code>9_labels.do</code> – Value label application</li>
</ol>
<p>Multiplied over 30+ years, that means over <strong>240 STATA
scripts</strong> doing essentially the same task: mapping raw ECH
variables to a common schema.</p>
<p><strong>metasurvey solves this with recipes.</strong> Instead of
maintaining hundreds of <code>.do</code> files, you write a single
recipe that encodes the transformation logic and can be applied to any
ECH edition.</p>
</div>
<div class="section level2">
<h2 id="stata-vs-metasurvey-side-by-side-comparison">STATA vs metasurvey: Side-by-side comparison<a class="anchor" aria-label="anchor" href="#stata-vs-metasurvey-side-by-side-comparison"></a>
</h2>
<p>Below is a snippet from a typical STATA harmonization script for sex,
age, and relationship to head of household:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>* <span class="kw">STATA</span>: Typical ECH compatibility script</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>* sexo</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>g bc_pe2 = e26</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>* edad</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>g bc_pe3 = e27</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a>* parentesco</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a>g bc_pe4 = -9</span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a>  <span class="kw">replace</span> bc_pe4 = 1 <span class="kw">if</span> e31 == 1</span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a>  <span class="kw">replace</span> bc_pe4 = 2 <span class="kw">if</span> e31 == 2</span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a>  <span class="kw">replace</span> bc_pe4 = 3 <span class="kw">if</span> e31 == 3 | e31 == 4 | e31 == 5</span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a>  <span class="kw">replace</span> bc_pe4 = 4 <span class="kw">if</span> e31 == 7 | e31 == 8</span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a>  <span class="kw">replace</span> bc_pe4 = 5 <span class="kw">if</span> e31 == 6 | e31 == 9 | e31 == 10 | e31 == 11 | e31 == 12</span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a>  <span class="kw">replace</span> bc_pe4 = 6 <span class="kw">if</span> e31 == 13</span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a>  <span class="kw">replace</span> bc_pe4 = 7 <span class="kw">if</span> e31 == 14</span></code></pre></div>
<p>The metasurvey equivalent:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/step_rename.html">step_rename</a></span><span class="op">(</span><span class="va">svy</span>, sex <span class="op">=</span> <span class="va">e26</span>, age <span class="op">=</span> <span class="va">e27</span><span class="op">)</span></span>
<span></span>
<span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/step_recode.html">step_recode</a></span><span class="op">(</span><span class="va">svy</span>, <span class="va">relationship</span>,</span>
<span>  <span class="va">e31</span> <span class="op">==</span> <span class="fl">1</span>                <span class="op">~</span> <span class="st">"Head"</span>,</span>
<span>  <span class="va">e31</span> <span class="op">==</span> <span class="fl">2</span>                <span class="op">~</span> <span class="st">"Spouse"</span>,</span>
<span>  <span class="va">e31</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">3</span><span class="op">:</span><span class="fl">5</span>            <span class="op">~</span> <span class="st">"Child"</span>,</span>
<span>  <span class="va">e31</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">8</span><span class="op">)</span>        <span class="op">~</span> <span class="st">"Parent"</span>,</span>
<span>  <span class="va">e31</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span>     <span class="op">~</span> <span class="st">"Other relative"</span>,</span>
<span>  <span class="va">e31</span> <span class="op">==</span> <span class="fl">13</span>               <span class="op">~</span> <span class="st">"Domestic service"</span>,</span>
<span>  <span class="va">e31</span> <span class="op">==</span> <span class="fl">14</span>               <span class="op">~</span> <span class="st">"Non-relative"</span>,</span>
<span>  .default <span class="op">=</span> <span class="cn">NA_character_</span>,</span>
<span>  comment <span class="op">=</span> <span class="st">"Relationship to head of household"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Key differences:</p>
<table class="table">
<colgroup>
<col width="18%">
<col width="38%">
<col width="43%">
</colgroup>
<thead><tr class="header">
<th>Aspect</th>
<th>STATA <code>.do</code> file</th>
<th>metasurvey recipe</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Format</td>
<td>Flat script with hard-coded paths</td>
<td>Portable JSON with metadata</td>
</tr>
<tr class="even">
<td>Validation</td>
<td>Manual checks with <code>assert</code>
</td>
<td>Automatic <code>validate()</code> method</td>
</tr>
<tr class="odd">
<td>Documentation</td>
<td>In-code comments</td>
<td>Auto-generated <code>doc()</code> method</td>
</tr>
<tr class="even">
<td>Sharing</td>
<td>Copy files via email/server</td>
<td>Registry with search and versioning</td>
</tr>
<tr class="odd">
<td>Reproducibility</td>
<td>Depends on file paths and environment</td>
<td>Self-contained, any machine</td>
</tr>
<tr class="even">
<td>Cross-edition</td>
<td>Duplicate script per year</td>
<td>One recipe, multiple editions</td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="simulating-ech-like-data">Simulating ECH-like data<a class="anchor" aria-label="anchor" href="#simulating-ech-like-data"></a>
</h2>
<p>For this vignette we simulate data that replicates the structure of a
real ECH microdata file. The simulated variables follow the same naming
conventions and value ranges used by the INE.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://metasurveyr.github.io/metasurvey">metasurvey</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2023</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span></span>
<span><span class="va">ech_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>  numero <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span>, each <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>  nper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>  e26 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  e27 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">90</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  e31 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">14</span>, <span class="va">n</span>,</span>
<span>    replace <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="fl">0.20</span>, <span class="fl">0.15</span>, <span class="fl">0.25</span>, <span class="fl">0.05</span>, <span class="fl">0.03</span>,</span>
<span>      <span class="fl">0.02</span>, <span class="fl">0.03</span>, <span class="fl">0.02</span>, <span class="fl">0.02</span>, <span class="fl">0.01</span>,</span>
<span>      <span class="fl">0.01</span>, <span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.15</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  pobpcoac <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">5</span>, <span class="fl">6</span>, <span class="fl">7</span><span class="op">)</span>, <span class="va">n</span>,</span>
<span>    replace <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.50</span>, <span class="fl">0.03</span>, <span class="fl">0.02</span>, <span class="fl">0.02</span>, <span class="fl">0.30</span>, <span class="fl">0.13</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  e51 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">14</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  ht11 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">5000</span>, <span class="fl">120000</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  dpto <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">19</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  pesoano <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0.5</span>, <span class="fl">3.0</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/Survey.html">Survey</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  data    <span class="op">=</span> <span class="va">ech_sim</span>,</span>
<span>  edition <span class="op">=</span> <span class="st">"2023"</span>,</span>
<span>  type    <span class="op">=</span> <span class="st">"ech"</span>,</span>
<span>  psu     <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  engine  <span class="op">=</span> <span class="st">"data.table"</span>,</span>
<span>  weight  <span class="op">=</span> <span class="fu"><a href="../reference/add_weight.html">add_weight</a></span><span class="op">(</span>annual <span class="op">=</span> <span class="st">"pesoano"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_data.html">get_data</a></span><span class="op">(</span><span class="va">svy</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;    numero  nper   e26   e27   e31 pobpcoac   e51   ht11  dpto pesoano</span></span>
<span><span class="co">#&gt;     &lt;int&gt; &lt;int&gt; &lt;num&gt; &lt;int&gt; &lt;int&gt;    &lt;num&gt; &lt;int&gt;  &lt;num&gt; &lt;int&gt;   &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      1     1     1    60     1        2    14 116378     5  0.6996</span></span>
<span><span class="co">#&gt; 2:      1     2     2     5     1        7    10  48407    11  0.7896</span></span>
<span><span class="co">#&gt; 3:      1     3     1     0     1        2     7 103278     4  1.5015</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-1-demographic-variables">Step 1: Demographic variables<a class="anchor" aria-label="anchor" href="#step-1-demographic-variables"></a>
</h2>
<p>Recode raw INE codes to readable names and recode categorical
variables:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Recode sex from INE codes (e26: 1=Male, 2=Female)</span></span>
<span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/step_recode.html">step_recode</a></span><span class="op">(</span><span class="va">svy</span>, <span class="va">sex</span>,</span>
<span>  <span class="va">e26</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Male"</span>,</span>
<span>  <span class="va">e26</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"Female"</span>,</span>
<span>  .default <span class="op">=</span> <span class="cn">NA_character_</span>,</span>
<span>  comment <span class="op">=</span> <span class="st">"Sex: 1=Male, 2=Female (INE e26)"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Recode age groups (standard ECH grouping, e27 = age)</span></span>
<span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/step_recode.html">step_recode</a></span><span class="op">(</span><span class="va">svy</span>, <span class="va">age_group</span>,</span>
<span>  <span class="va">e27</span> <span class="op">&lt;</span> <span class="fl">14</span> <span class="op">~</span> <span class="st">"Child (0-13)"</span>,</span>
<span>  <span class="va">e27</span> <span class="op">&lt;</span> <span class="fl">25</span> <span class="op">~</span> <span class="st">"Youth (14-24)"</span>,</span>
<span>  <span class="va">e27</span> <span class="op">&lt;</span> <span class="fl">45</span> <span class="op">~</span> <span class="st">"Adult (25-44)"</span>,</span>
<span>  <span class="va">e27</span> <span class="op">&lt;</span> <span class="fl">65</span> <span class="op">~</span> <span class="st">"Mature (45-64)"</span>,</span>
<span>  .default <span class="op">=</span> <span class="st">"Senior (65+)"</span>,</span>
<span>  .to_factor <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  ordered <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  comment <span class="op">=</span> <span class="st">"Standard age groups for labor statistics"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-2-labor-force-classification">Step 2: Labor force classification<a class="anchor" aria-label="anchor" href="#step-2-labor-force-classification"></a>
</h2>
<p>The <code>POBPCOAC</code> variable (Population by activity status) is
the central labor status classification in the ECH. INE codes:</p>
<ul>
<li>2 = Employed</li>
<li>3-5 = Unemployed (various subcategories)</li>
<li>6-7 = Inactive</li>
</ul>
<p>This replicates the standard ILO labor force framework:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/step_recode.html">step_recode</a></span><span class="op">(</span><span class="va">svy</span>, <span class="va">labor_status</span>,</span>
<span>  <span class="va">pobpcoac</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"Employed"</span>,</span>
<span>  <span class="va">pobpcoac</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">3</span><span class="op">:</span><span class="fl">5</span> <span class="op">~</span> <span class="st">"Unemployed"</span>,</span>
<span>  <span class="va">pobpcoac</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">6</span><span class="op">:</span><span class="fl">7</span> <span class="op">~</span> <span class="st">"Inactive"</span>,</span>
<span>  .default <span class="op">=</span> <span class="cn">NA_character_</span>,</span>
<span>  comment <span class="op">=</span> <span class="st">"ILO labor force status from POBPCOAC"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create binary indicators</span></span>
<span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/step_compute.html">step_compute</a></span><span class="op">(</span><span class="va">svy</span>,</span>
<span>  employed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">pobpcoac</span> <span class="op">==</span> <span class="fl">2</span>, <span class="fl">1L</span>, <span class="fl">0L</span><span class="op">)</span>,</span>
<span>  unemployed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">pobpcoac</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">3</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">1L</span>, <span class="fl">0L</span><span class="op">)</span>,</span>
<span>  active <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">pobpcoac</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">2</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">1L</span>, <span class="fl">0L</span><span class="op">)</span>,</span>
<span>  working_age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">e27</span> <span class="op">&gt;=</span> <span class="fl">14</span>, <span class="fl">1L</span>, <span class="fl">0L</span><span class="op">)</span>,</span>
<span>  comment <span class="op">=</span> <span class="st">"Labor force binary indicators"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-3-income-variables">Step 3: Income variables<a class="anchor" aria-label="anchor" href="#step-3-income-variables"></a>
</h2>
<p>Build income indicators following the standard methodology used with
ECH data:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/step_compute.html">step_compute</a></span><span class="op">(</span><span class="va">svy</span>,</span>
<span>  income_pc <span class="op">=</span> <span class="va">ht11</span> <span class="op">/</span> <span class="fl">5</span>,</span>
<span>  income_thousands <span class="op">=</span> <span class="va">ht11</span> <span class="op">/</span> <span class="fl">1000</span>,</span>
<span>  log_income <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">ht11</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  comment <span class="op">=</span> <span class="st">"Income transformations"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-4-geographic-classification">Step 4: Geographic classification<a class="anchor" aria-label="anchor" href="#step-4-geographic-classification"></a>
</h2>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dept_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>  dpto <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">19</span>,</span>
<span>  department <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"Montevideo"</span>, <span class="st">"Artigas"</span>, <span class="st">"Canelones"</span>, <span class="st">"Cerro Largo"</span>,</span>
<span>    <span class="st">"Colonia"</span>, <span class="st">"Durazno"</span>, <span class="st">"Flores"</span>, <span class="st">"Florida"</span>, <span class="st">"Lavalleja"</span>,</span>
<span>    <span class="st">"Maldonado"</span>, <span class="st">"Paysandu"</span>, <span class="st">"Rio Negro"</span>, <span class="st">"Rivera"</span>, <span class="st">"Rocha"</span>,</span>
<span>    <span class="st">"Salto"</span>, <span class="st">"San Jose"</span>, <span class="st">"Soriano"</span>, <span class="st">"Tacuarembo"</span>,</span>
<span>    <span class="st">"Treinta y Tres"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  region <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Montevideo"</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"Interior"</span>, <span class="fl">18</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">svy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/step_join.html">step_join</a></span><span class="op">(</span><span class="va">svy</span>,</span>
<span>  <span class="va">dept_names</span>,</span>
<span>  by <span class="op">=</span> <span class="st">"dpto"</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"left"</span>,</span>
<span>  comment <span class="op">=</span> <span class="st">"Department names and region classification"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="building-the-recipe">Building the recipe<a class="anchor" aria-label="anchor" href="#building-the-recipe"></a>
</h2>
<p>Convert all transformations into a portable recipe:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ech_recipe</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/steps_to_recipe.html">steps_to_recipe</a></span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="st">"ECH Labor Market Indicators"</span>,</span>
<span>  user <span class="op">=</span> <span class="st">"Research Team"</span>,</span>
<span>  svy <span class="op">=</span> <span class="va">svy</span>,</span>
<span>  description <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span></span>
<span>    <span class="st">"Standard labor market indicators for the ECH."</span>,</span>
<span>    <span class="st">"Includes demographic recoding, ILO labor classification,"</span>,</span>
<span>    <span class="st">"income transformations, and geographic joins."</span></span>
<span>  <span class="op">)</span>,</span>
<span>  steps <span class="op">=</span> <span class="fu"><a href="../reference/get_steps.html">get_steps</a></span><span class="op">(</span><span class="va">svy</span><span class="op">)</span>,</span>
<span>  topic <span class="op">=</span> <span class="st">"labor"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">ech_recipe</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">#&gt; ── Recipe: ECH Labor Market Indicators ──</span></span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">#&gt; </span><span style="color: #555555;">Author:  </span>Research Team</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Survey:  </span>ech / 2023</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Version: </span>1.0.0</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Topic:   </span>labor</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Description: </span>Standard labor market indicators for the ECH. Includes demographic recoding, ILO labor classification, income transformations, and geographic joins.</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Certification: </span><span style="color: #BBBB00;">community</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">#&gt; ── Requires (5 variables) ──</span></span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">#&gt; </span>  e26, e27, pobpcoac, ht11, dpto</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">#&gt; ── Pipeline (6 steps) ──</span></span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">#&gt; </span>  1. [recode] -&gt; sex  "Sex: 1=Male, 2=Female (INE e26)"</span></span>
<span><span class="co">#&gt;   2. [recode] -&gt; age_group  "Standard age groups for labor statistics"</span></span>
<span><span class="co">#&gt;   3. [recode] -&gt; labor_status  "ILO labor force status from POBPCOAC"</span></span>
<span><span class="co">#&gt;   4. [compute] -&gt; employed, unemployed, active, working_age  "Labor force binary indicators"</span></span>
<span><span class="co">#&gt;   5. [compute] -&gt; income_pc, income_thousands, log_income  "Income transformations"</span></span>
<span><span class="co">#&gt;   6. [step_join] -&gt; (no output)  "Department names and region classification"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">#&gt; ── Produces (10 variables) ──</span></span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">#&gt; </span>  sex [categorical], age_group [categorical], labor_status [categorical], employed [numeric], unemployed [numeric], active [numeric], working_age [numeric], income_pc [numeric], income_thousands [numeric], log_income [numeric]</span></span></code></pre></div>
<div class="section level3">
<h3 id="automatic-documentation">Automatic documentation<a class="anchor" aria-label="anchor" href="#automatic-documentation"></a>
</h3>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">doc</span> <span class="op">&lt;-</span> <span class="va">ech_recipe</span><span class="op">$</span><span class="fu">doc</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># What variables does the recipe need?</span></span>
<span><span class="va">doc</span><span class="op">$</span><span class="va">input_variables</span></span>
<span><span class="co">#&gt; [1] "e26"      "e27"      "pobpcoac" "ht11"     "dpto"</span></span>
<span></span>
<span><span class="co"># What variables does it create?</span></span>
<span><span class="va">doc</span><span class="op">$</span><span class="va">output_variables</span></span>
<span><span class="co">#&gt;  [1] "sex"              "age_group"        "labor_status"     "employed"        </span></span>
<span><span class="co">#&gt;  [5] "unemployed"       "active"           "working_age"      "income_pc"       </span></span>
<span><span class="co">#&gt;  [9] "income_thousands" "log_income"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="publishing-to-the-registry">Publishing to the registry<a class="anchor" aria-label="anchor" href="#publishing-to-the-registry"></a>
</h3>
<p>Publish the recipe so others can discover and reuse it:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set up a local registry</span></span>
<span><span class="fu"><a href="../reference/set_backend.html">set_backend</a></span><span class="op">(</span><span class="st">"local"</span>, path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".json"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/publish_recipe.html">publish_recipe</a></span><span class="op">(</span><span class="va">ech_recipe</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Now anyone can retrieve it by ID</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_recipe.html">get_recipe</a></span><span class="op">(</span><span class="st">"ech_labor"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="estimation-with-workflow">Estimation with workflow()<a class="anchor" aria-label="anchor" href="#estimation-with-workflow"></a>
</h2>
<p>Now we compute standard labor market indicators:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Mean household income</span></span>
<span><span class="va">result_income</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/workflow.html">workflow</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">svy</span><span class="op">)</span>,</span>
<span>  <span class="fu">survey</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svymean</a></span><span class="op">(</span><span class="op">~</span><span class="va">ht11</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  estimation_type <span class="op">=</span> <span class="st">"annual"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">result_income</span></span>
<span><span class="co">#&gt;                     stat    value       se         cv confint_lower</span></span>
<span><span class="co">#&gt;                   &lt;char&gt;    &lt;num&gt;    &lt;num&gt;      &lt;num&gt;         &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: survey::svymean: ht11 60742.91 1631.918 0.02686598      57544.41</span></span>
<span><span class="co">#&gt;    confint_upper</span></span>
<span><span class="co">#&gt;            &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      63941.41</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Employment rate (proportion employed among total population)</span></span>
<span><span class="va">result_employment</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/workflow.html">workflow</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">svy</span><span class="op">)</span>,</span>
<span>  <span class="fu">survey</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svymean</a></span><span class="op">(</span><span class="op">~</span><span class="va">employed</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  estimation_type <span class="op">=</span> <span class="st">"annual"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">result_employment</span></span>
<span><span class="co">#&gt;                         stat     value         se         cv confint_lower</span></span>
<span><span class="co">#&gt;                       &lt;char&gt;     &lt;num&gt;      &lt;num&gt;      &lt;num&gt;         &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: survey::svymean: employed 0.5778099 0.02386869 0.04130891     0.5310281</span></span>
<span><span class="co">#&gt;    confint_upper</span></span>
<span><span class="co">#&gt;            &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:     0.6245916</span></span></code></pre></div>
<div class="section level3">
<h3 id="domain-estimation">Domain estimation<a class="anchor" aria-label="anchor" href="#domain-estimation"></a>
</h3>
<p>Compute estimates by subpopulation:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Mean income by region</span></span>
<span><span class="va">income_region</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/workflow.html">workflow</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">svy</span><span class="op">)</span>,</span>
<span>  <span class="fu">survey</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/svyby.html" class="external-link">svyby</a></span><span class="op">(</span><span class="op">~</span><span class="va">ht11</span>, <span class="op">~</span><span class="va">region</span>, <span class="fu">survey</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svymean</a></span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  estimation_type <span class="op">=</span> <span class="st">"annual"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">income_region</span></span>
<span><span class="co">#&gt;          stat     value    se        cv confint_lower confint_upper</span></span>
<span><span class="co">#&gt;        &lt;char&gt;     &lt;num&gt; &lt;num&gt;     &lt;num&gt;         &lt;num&gt;         &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:   Interior        NA    NA 0.0275355      57568.21      64136.44</span></span>
<span><span class="co">#&gt; 2: Montevideo        NA    NA 0.1223059      44632.89      72778.09</span></span>
<span><span class="co">#&gt; 3:   Interior 60852.322    NA 0.0275355            NA            NA</span></span>
<span><span class="co">#&gt; 4: Montevideo 58705.489    NA 0.1223059            NA            NA</span></span>
<span><span class="co">#&gt; 5:   Interior  1675.599    NA 0.0275355            NA            NA</span></span>
<span><span class="co">#&gt; 6: Montevideo  7180.028    NA 0.1223059            NA            NA</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Employment by sex</span></span>
<span><span class="va">employment_sex</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/workflow.html">workflow</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">svy</span><span class="op">)</span>,</span>
<span>  <span class="fu">survey</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/svyby.html" class="external-link">svyby</a></span><span class="op">(</span><span class="op">~</span><span class="va">employed</span>, <span class="op">~</span><span class="va">sex</span>, <span class="fu">survey</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svymean</a></span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  estimation_type <span class="op">=</span> <span class="st">"annual"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">employment_sex</span></span>
<span><span class="co">#&gt;      stat      value    se         cv confint_lower confint_upper</span></span>
<span><span class="co">#&gt;    &lt;char&gt;      &lt;num&gt; &lt;num&gt;      &lt;num&gt;         &lt;num&gt;         &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: Female         NA    NA 0.06019825     0.4912161     0.6226354</span></span>
<span><span class="co">#&gt; 2:   Male         NA    NA 0.05644886     0.5343696     0.6673221</span></span>
<span><span class="co">#&gt; 3: Female 0.55692572    NA 0.06019825            NA            NA</span></span>
<span><span class="co">#&gt; 4:   Male 0.60084583    NA 0.05644886            NA            NA</span></span>
<span><span class="co">#&gt; 5: Female 0.03352595    NA 0.06019825            NA            NA</span></span>
<span><span class="co">#&gt; 6:   Male 0.03391706    NA 0.05644886            NA            NA</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="quality-assessment">Quality assessment<a class="anchor" aria-label="anchor" href="#quality-assessment"></a>
</h3>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/workflow.html">workflow</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">svy</span><span class="op">)</span>,</span>
<span>  <span class="fu">survey</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svymean</a></span><span class="op">(</span><span class="op">~</span><span class="va">ht11</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="fu">survey</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svymean</a></span><span class="op">(</span><span class="op">~</span><span class="va">employed</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  estimation_type <span class="op">=</span> <span class="st">"annual"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">results_all</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">cv_pct</span> <span class="op">&lt;-</span> <span class="va">results_all</span><span class="op">$</span><span class="va">cv</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="fl">100</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span></span>
<span>    <span class="va">results_all</span><span class="op">$</span><span class="va">stat</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">":"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">cv_pct</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"% CV -"</span>,</span>
<span>    <span class="fu"><a href="../reference/evaluate_cv.html">evaluate_cv</a></span><span class="op">(</span><span class="va">cv_pct</span><span class="op">)</span>, <span class="st">"\n"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; survey::svymean: ht11 : 2.7 % CV - Excelente </span></span>
<span><span class="co">#&gt; survey::svymean: employed : 4.1 % CV - Excelente</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="reproducibility-same-recipe-different-edition">Reproducibility: same recipe, different edition<a class="anchor" aria-label="anchor" href="#reproducibility-same-recipe-different-edition"></a>
</h2>
<p>The power of recipes lies in applying them unchanged to new data.
Here we simulate a “2024 edition” with the same structure:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2024</span><span class="op">)</span></span>
<span><span class="va">ech_2024</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>  numero <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span>, each <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>  nper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>  e26 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  e27 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">90</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  e31 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">14</span>, <span class="va">n</span>,</span>
<span>    replace <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="fl">0.20</span>, <span class="fl">0.15</span>, <span class="fl">0.25</span>, <span class="fl">0.05</span>, <span class="fl">0.03</span>,</span>
<span>      <span class="fl">0.02</span>, <span class="fl">0.03</span>, <span class="fl">0.02</span>, <span class="fl">0.02</span>, <span class="fl">0.01</span>,</span>
<span>      <span class="fl">0.01</span>, <span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.15</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  pobpcoac <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">5</span>, <span class="fl">6</span>, <span class="fl">7</span><span class="op">)</span>, <span class="va">n</span>,</span>
<span>    replace <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.50</span>, <span class="fl">0.03</span>, <span class="fl">0.02</span>, <span class="fl">0.02</span>, <span class="fl">0.30</span>, <span class="fl">0.13</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  e51 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">14</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  ht11 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">5500</span>, <span class="fl">130000</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  dpto <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">19</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  pesoano <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0.5</span>, <span class="fl">3.0</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">svy_2024</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/Survey.html">Survey</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">ech_2024</span>, edition <span class="op">=</span> <span class="st">"2024"</span>, type <span class="op">=</span> <span class="st">"ech"</span>,</span>
<span>  psu <span class="op">=</span> <span class="cn">NULL</span>, engine <span class="op">=</span> <span class="st">"data.table"</span>,</span>
<span>  weight <span class="op">=</span> <span class="fu"><a href="../reference/add_weight.html">add_weight</a></span><span class="op">(</span>annual <span class="op">=</span> <span class="st">"pesoano"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Apply the same recipe</span></span>
<span><span class="va">svy_2024</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/add_recipe.html">add_recipe</a></span><span class="op">(</span><span class="va">svy_2024</span>, <span class="va">ech_recipe</span><span class="op">)</span></span>
<span><span class="va">svy_2024</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bake_recipes.html">bake_recipes</a></span><span class="op">(</span><span class="va">svy_2024</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate</span></span>
<span><span class="va">result_2024</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/workflow.html">workflow</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">svy_2024</span><span class="op">)</span>,</span>
<span>  <span class="fu">survey</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svymean</a></span><span class="op">(</span><span class="op">~</span><span class="va">ht11</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="fu">survey</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svymean</a></span><span class="op">(</span><span class="op">~</span><span class="va">employed</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  estimation_type <span class="op">=</span> <span class="st">"annual"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">result_2024</span></span>
<span><span class="co">#&gt;                         stat        value           se         cv confint_lower</span></span>
<span><span class="co">#&gt;                       &lt;char&gt;        &lt;num&gt;        &lt;num&gt;      &lt;num&gt;         &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:     survey::svymean: ht11 7.177680e+04 1.702000e+03 0.02371240  6.844094e+04</span></span>
<span><span class="co">#&gt; 2: survey::svymean: employed 5.234533e-01 2.410369e-02 0.04604745  4.762109e-01</span></span>
<span><span class="co">#&gt;    confint_upper</span></span>
<span><span class="co">#&gt;            &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:  7.511266e+04</span></span>
<span><span class="co">#&gt; 2:  5.706957e-01</span></span></code></pre></div>
<p>Same recipe, different data, consistent methodology.</p>
</div>
<div class="section level2">
<h2 id="for-stata-users-quick-reference">For STATA users: quick reference<a class="anchor" aria-label="anchor" href="#for-stata-users-quick-reference"></a>
</h2>
<p>If you are transitioning from STATA to R for survey analysis, here is
a mapping of common operations:</p>
<table class="table">
<colgroup>
<col width="28%">
<col width="44%">
<col width="28%">
</colgroup>
<thead><tr class="header">
<th>STATA</th>
<th>metasurvey</th>
<th>Notes</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>gen var = expr</code></td>
<td><code>step_compute(svy, var = expr)</code></td>
<td>Lazy by default; call <code><a href="../reference/bake_steps.html">bake_steps()</a></code> to execute</td>
</tr>
<tr class="even">
<td><code>replace var = x if cond</code></td>
<td><code>step_compute(svy, var = ifelse(cond, x, var))</code></td>
<td>Conditional assignment</td>
</tr>
<tr class="odd">
<td><code>recode var (old=new)</code></td>
<td><code>step_recode(svy, new_var, old == val ~ "label")</code></td>
<td>Creates a new variable</td>
</tr>
<tr class="even">
<td><code>rename old new</code></td>
<td><code>step_rename(svy, new = old)</code></td>
<td></td>
</tr>
<tr class="odd">
<td><code>drop var1 var2</code></td>
<td><code>step_remove(svy, var1, var2)</code></td>
<td></td>
</tr>
<tr class="even">
<td><code>merge using file</code></td>
<td><code>step_join(svy, data, by = "key")</code></td>
<td>Left join by default</td>
</tr>
<tr class="odd">
<td><code>svy: mean var</code></td>
<td><code>workflow(list(svy), svymean(~var))</code></td>
<td>Returns data.table with SE, CV</td>
</tr>
<tr class="even">
<td><code>svy: total var</code></td>
<td><code>workflow(list(svy), svytotal(~var))</code></td>
<td></td>
</tr>
<tr class="odd">
<td><code>svy: mean var, over(group)</code></td>
<td><code>workflow(list(svy), svyby(~var, ~group, svymean))</code></td>
<td></td>
</tr>
<tr class="even">
<td>
<code>.do</code> file</td>
<td>
<code><a href="../reference/steps_to_recipe.html">steps_to_recipe()</a></code> + publish</td>
<td>Portable, discoverable, version-controlled</td>
</tr>
<tr class="odd">
<td><code>use "data.dta"</code></td>
<td><code>load_survey(path = "data.dta")</code></td>
<td>Reads STATA, CSV, RDS, etc.</td>
</tr>
</tbody>
</table>
<div class="section level3">
<h3 id="key-differences">Key differences<a class="anchor" aria-label="anchor" href="#key-differences"></a>
</h3>
<ol style="list-style-type: decimal">
<li><p><strong>Lazy evaluation</strong>: In STATA, commands execute
immediately. In metasurvey, steps are recorded and executed together
with <code><a href="../reference/bake_steps.html">bake_steps()</a></code>. This enables validation and optimization
before execution.</p></li>
<li><p><strong>Immutability</strong>: metasurvey creates new variables
instead of modifying existing ones. <code><a href="../reference/step_recode.html">step_recode()</a></code> creates a
new column; it does not overwrite the source variable.</p></li>
<li><p><strong>Design awareness</strong>: Survey weights and design are
attached to the <code>Survey</code> object. There is no need to prefix
commands with <code>svy:</code> or remember to set up the design
—<code><a href="../reference/workflow.html">workflow()</a></code> handles it automatically.</p></li>
<li><p><strong>Recipes vs .do files</strong>: Recipes are
self-documenting (via <code>doc()</code>), self-validating (via
<code>validate()</code>), and discoverable (via the registry). A
<code>.do</code> file is just a script; a recipe is a structured,
portable object.</p></li>
</ol>
</div>
</div>
<div class="section level2">
<h2 id="next-steps">Next steps<a class="anchor" aria-label="anchor" href="#next-steps"></a>
</h2>
<ul>
<li>
<strong><a href="recipes.html">Creating and publishing
recipes</a></strong> – Learn about recipe registries, certification, and
discovery</li>
<li>
<strong><a href="workflows-and-estimation.html">Estimation
workflows</a></strong> – Deep dive into <code><a href="../reference/workflow.html">workflow()</a></code> and
<code>RecipeWorkflow</code>
</li>
<li>
<strong><a href="panel-analysis.html">Rotating panels and
PoolSurvey</a></strong> – Working with the ECH’s rotating panel
structure</li>
<li>
<strong><a href="getting-started.html">Getting started</a></strong>
– Review the basics</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://www.mauroloprete.com" class="external-link">Mauro Loprete</a>, <a href="https://natydasilva.github.io/natydasilva/" class="external-link">Natalia da Silva</a>, <a href="https://iecon.fcea.udelar.edu.uy/es/autores/item/machado-fabricio.html" class="external-link">Fabricio Machado</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
