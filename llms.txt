# metasurvey

**metasurvey** is an R package for processing and analysing complex
survey data using metaprogramming and reproducible pipelines. It
integrates with the
[`survey`](https://cran.r-project.org/package=survey) package and is
designed for **complex sampling designs** and **recurring estimations**
over time (rotating panels, repeated cross-sections).

### Key features

- **Steps**: lazy transformation pipeline (`step_compute`,
  `step_recode`, `step_rename`, `step_remove`, `step_join`) executed via
  [`bake_steps()`](https://metasurveyr.github.io/metasurvey/reference/bake_steps.md).
- **Recipes**: portable, versioned objects that encapsulate
  harmonisation pipelines with automatic documentation (`doc()`) and
  validation (`validate()`).
- **Workflows**: estimation with
  [`survey::svymean`](https://rdrr.io/pkg/survey/man/surveysummary.html),
  `svytotal`, `svyratio` and `svyby` integrated in
  [`workflow()`](https://metasurveyr.github.io/metasurvey/reference/workflow.md),
  returning a `data.table` with value, standard error and coefficient of
  variation.
- **Rotating panels**: support for `RotativePanelSurvey` with
  implantation and follow-ups, and `PoolSurvey` for combined estimation.
- **Replicate weights**: bootstrap replicate configuration via
  [`add_replicate()`](https://metasurveyr.github.io/metasurvey/reference/add_replicate.md)
  for robust variance with
  [`survey::svrepdesign`](https://rdrr.io/pkg/survey/man/svrepdesign.html).
- **Recipe registry**: publish, search and discover recipes and
  workflows through a REST API or a local JSON registry.
- **Shiny app**: interactive recipe and workflow explorer with
  [`explore_recipes()`](https://metasurveyr.github.io/metasurvey/reference/explore_recipes.md).

------------------------------------------------------------------------

## Installation

Development version from GitHub:

``` r
# install.packages("devtools")
devtools::install_github("metasurveyR/metasurvey")
```

------------------------------------------------------------------------

## Quick example

``` r
library(metasurvey)

# Create a survey with sample data
data(api, package = "survey")

svy <- Survey$new(
  data    = apistrat,
  edition = "2000",
  type    = "api",
  psu     = NULL,
  engine  = "data.table",
  weight  = add_weight(annual = "pw")
)

# Lazy transformations
svy <- step_compute(svy, growth = api00 - api99, comment = "API growth")
svy <- step_recode(svy, school_level,
  stype == "E" ~ "Elementary",
  stype == "M" ~ "Middle",
  stype == "H" ~ "High",
  .default = NA_character_
)
svy <- bake_steps(svy)

# Estimation
workflow(
  list(svy),
  survey::svymean(~growth, na.rm = TRUE),
  estimation_type = "annual"
)
```

------------------------------------------------------------------------

## Full example: ECH panel with bootstrap replicate weights

This example uses the rotating panel from Uruguay’s [*Encuesta Continua
de Hogares*](https://www.ine.gub.uy/encuesta-continua-de-hogares) (ECH)
with bootstrap replicate weights. First, download the example data:

``` r
download_example_ech <- function() {
  zip_url <- "https://informe-tfg.s3.us-east-2.amazonaws.com/example-data.zip"
  dest_zip <- "example-data.zip"
  temp_dir <- tempfile("example-data")
  download.file(zip_url, destfile = dest_zip, mode = "wb")
  dir.create(temp_dir)
  unzip(dest_zip, exdir = temp_dir)
  target_dir <- "example-data"
  dir.create(target_dir, recursive = TRUE, showWarnings = FALSE)
  file.rename(
    list.files(file.path(temp_dir, "example-data"), full.names = TRUE),
    file.path(target_dir, basename(list.files(file.path(temp_dir, "example-data"))))
  )
  unlink(dest_zip)
  unlink(temp_dir, recursive = TRUE)
}
download_example_ech()
```

With the data downloaded:

``` r
library(metasurvey)
library(magrittr)

path_dir <- file.path("example-data", "ech", "ech_2023")

ech_2023 <- load_panel_survey(
  path_implantation = file.path(path_dir, "ECH_implantacion_2023.csv"),
  path_follow_up = file.path(path_dir, "seguimiento"),
  svy_type = "ECH_2023",
  svy_weight_implantation = add_weight(annual = "W_ANO"),
  svy_weight_follow_up = add_weight(
    monthly = add_replicate(
      "W",
      replicate_path = file.path(
        path_dir,
        c(
          "Pesos replicados Bootstrap mensuales enero_junio 2023",
          "Pesos replicados Bootstrap mensuales julio_diciembre 2023"
        ),
        c(
          "Pesos replicados mensuales enero_junio 2023",
          "Pesos replicados mensuales Julio_diciembre 2023"
        )
      ),
      replicate_id = c("ID" = "ID"),
      replicate_pattern = "wr[0-9]+",
      replicate_type = "bootstrap"
    )
  )
)

# Build labour market indicators
ech_2023 <- ech_2023 %>%
  step_recode("pea", POBPCOAC %in% 2:5 ~ 1, .default = 0,
              comment = "EAP", .level = "follow_up") %>%
  step_recode("pet", e27 >= 14 ~ 1, .default = 0,
              comment = "WAP", .level = "follow_up") %>%
  step_recode("po", POBPCOAC == 2 ~ 1, .default = 0,
              comment = "Employed", .level = "follow_up") %>%
  step_recode("pd", POBPCOAC %in% 3:5 ~ 1, .default = 0,
              comment = "Unemployed", .level = "follow_up")

ech_2023_bake <- bake_steps(ech_2023)

# Quarterly rates: activity, employment and unemployment
workflow_result <- workflow(
  survey = extract_surveys(ech_2023_bake, quarterly = 1:4),
  survey::svyratio(~pea, denominator = ~pet),
  survey::svyratio(~po, denominator = ~pet),
  survey::svyratio(~pd, denominator = ~pea),
  estimation_type = "quarterly:monthly",
  rho = 0.5,
  R = 5 / 6
)

workflow_result
```

This pipeline loads a rotating panel with bootstrap replicate weights,
builds binary labour market indicators (EAP, WAP, employed, unemployed),
and estimates activity, employment and unemployment rates by quarter
with robust variance.

------------------------------------------------------------------------

## Documentation

- [Getting
  started](https://metasurveyr.github.io/metasurvey/articles/getting-started.html)
- [Recipes](https://metasurveyr.github.io/metasurvey/articles/recipes.html)
- [Workflows and
  estimation](https://metasurveyr.github.io/metasurvey/articles/workflows-and-estimation.html)
- [Complex
  designs](https://metasurveyr.github.io/metasurvey/articles/complex-designs.html)
- [Rotating
  panels](https://metasurveyr.github.io/metasurvey/articles/panel-analysis.html)
- [Case study:
  ECH](https://metasurveyr.github.io/metasurvey/articles/ech-case-study.html)
- [Interactive
  explorer](https://metasurveyr.github.io/metasurvey/articles/shiny-explorer.html)
- [API and
  database](https://metasurveyr.github.io/metasurvey/articles/api-database.html)

# Package index

## Surveys

Create and manipulate Survey objects

- [`Survey`](https://metasurveyr.github.io/metasurvey/reference/Survey.md)
  : Survey R6 class
- [`RotativePanelSurvey`](https://metasurveyr.github.io/metasurvey/reference/RotativePanelSurvey.md)
  : RotativePanelSurvey Class
- [`PoolSurvey`](https://metasurveyr.github.io/metasurvey/reference/PoolSurvey.md)
  : PoolSurvey Class
- [`load_survey()`](https://metasurveyr.github.io/metasurvey/reference/load_survey.md)
  : Load survey from file and create Survey object
- [`load_panel_survey()`](https://metasurveyr.github.io/metasurvey/reference/load_panel_survey.md)
  : Read panel survey files from different formats and create a
  RotativePanelSurvey object
- [`load_survey_example()`](https://metasurveyr.github.io/metasurvey/reference/load_survey_example.md)
  : Load survey example data
- [`survey_empty()`](https://metasurveyr.github.io/metasurvey/reference/survey_empty.md)
  : survey_empty
- [`get_data()`](https://metasurveyr.github.io/metasurvey/reference/get_data.md)
  : get_data
- [`set_data()`](https://metasurveyr.github.io/metasurvey/reference/set_data.md)
  : Set data on a Survey
- [`get_metadata()`](https://metasurveyr.github.io/metasurvey/reference/get_metadata.md)
  : get_metadata
- [`get_steps()`](https://metasurveyr.github.io/metasurvey/reference/get_steps.md)
  : get_steps
- [`survey_to_data_frame()`](https://metasurveyr.github.io/metasurvey/reference/survey_to_data_frame.md)
  : survey_to_data_frame
- [`survey_to_data.table()`](https://metasurveyr.github.io/metasurvey/reference/survey_to_data.table.md)
  : survey_to_data.table
- [`survey_to_tibble()`](https://metasurveyr.github.io/metasurvey/reference/survey_to_tibble.md)
  : survey_to_tibble

## Steps

Lazy transformations on surveys

- [`step_compute()`](https://metasurveyr.github.io/metasurvey/reference/step_compute.md)
  : Create computation steps for survey variables
- [`step_recode()`](https://metasurveyr.github.io/metasurvey/reference/step_recode.md)
  : Create recoding steps for categorical variables
- [`step_rename()`](https://metasurveyr.github.io/metasurvey/reference/step_rename.md)
  : Rename variables in survey data (step)
- [`step_remove()`](https://metasurveyr.github.io/metasurvey/reference/step_remove.md)
  : Remove variables from survey data (step)
- [`step_join()`](https://metasurveyr.github.io/metasurvey/reference/step_join.md)
  : Join external data into survey (step)
- [`bake_steps()`](https://metasurveyr.github.io/metasurvey/reference/bake_steps.md)
  : Execute all pending steps

## Recipes

Reproducible and portable pipelines

- [`Recipe-class`](https://metasurveyr.github.io/metasurvey/reference/Recipe-class.md)
  [`Recipe`](https://metasurveyr.github.io/metasurvey/reference/Recipe-class.md)
  : Recipe R6 class
- [`recipe()`](https://metasurveyr.github.io/metasurvey/reference/recipe.md)
  : Crear receta de transformación de datos de encuesta
- [`steps_to_recipe()`](https://metasurveyr.github.io/metasurvey/reference/steps_to_recipe.md)
  : Convert a list of steps to a recipe
- [`add_recipe()`](https://metasurveyr.github.io/metasurvey/reference/add_recipe.md)
  : Add a recipe to a Survey
- [`bake_recipes()`](https://metasurveyr.github.io/metasurvey/reference/bake_recipes.md)
  : Bake recipes
- [`save_recipe()`](https://metasurveyr.github.io/metasurvey/reference/save_recipe.md)
  : Save Recipe
- [`read_recipe()`](https://metasurveyr.github.io/metasurvey/reference/read_recipe.md)
  : Read Recipe
- [`get_recipe()`](https://metasurveyr.github.io/metasurvey/reference/get_recipe.md)
  : Get recipe from repository or API
- [`certify_recipe()`](https://metasurveyr.github.io/metasurvey/reference/certify_recipe.md)
  : Certify a recipe
- [`print(`*`<Recipe>`*`)`](https://metasurveyr.github.io/metasurvey/reference/print.Recipe.md)
  : Print method for Recipe objects
- [`recipe_user()`](https://metasurveyr.github.io/metasurvey/reference/recipe_user.md)
  : Create a recipe user
- [`recipe_category()`](https://metasurveyr.github.io/metasurvey/reference/recipe_category.md)
  : Create a recipe category
- [`recipe_certification()`](https://metasurveyr.github.io/metasurvey/reference/recipe_certification.md)
  : Create a recipe certification
- [`add_category()`](https://metasurveyr.github.io/metasurvey/reference/add_category.md)
  : Add a category to a recipe
- [`remove_category()`](https://metasurveyr.github.io/metasurvey/reference/remove_category.md)
  : Remove a category from a recipe
- [`default_categories()`](https://metasurveyr.github.io/metasurvey/reference/default_categories.md)
  : Default recipe categories
- [`set_user_info()`](https://metasurveyr.github.io/metasurvey/reference/set_user_info.md)
  : Set user info on a recipe
- [`set_version()`](https://metasurveyr.github.io/metasurvey/reference/set_version.md)
  : Set version on a recipe

## Recipe Discovery

Search, filter, and publish recipes

- [`list_recipes()`](https://metasurveyr.github.io/metasurvey/reference/list_recipes.md)
  : List all recipes
- [`search_recipes()`](https://metasurveyr.github.io/metasurvey/reference/search_recipes.md)
  : Search recipes
- [`filter_recipes()`](https://metasurveyr.github.io/metasurvey/reference/filter_recipes.md)
  : Filter recipes by criteria
- [`rank_recipes()`](https://metasurveyr.github.io/metasurvey/reference/rank_recipes.md)
  : Rank recipes by downloads
- [`explore_recipes()`](https://metasurveyr.github.io/metasurvey/reference/explore_recipes.md)
  : Launch the Recipe Explorer Shiny App
- [`publish_recipe()`](https://metasurveyr.github.io/metasurvey/reference/publish_recipe.md)
  : Publish Recipe
- [`set_backend()`](https://metasurveyr.github.io/metasurvey/reference/set_backend.md)
  : Set recipe backend
- [`get_backend()`](https://metasurveyr.github.io/metasurvey/reference/get_backend.md)
  : Get recipe backend

## Estimation

Survey estimation workflows

- [`workflow()`](https://metasurveyr.github.io/metasurvey/reference/workflow.md)
  : Execute estimation workflow for surveys
- [`RecipeWorkflow-class`](https://metasurveyr.github.io/metasurvey/reference/RecipeWorkflow-class.md)
  [`RecipeWorkflow`](https://metasurveyr.github.io/metasurvey/reference/RecipeWorkflow-class.md)
  : RecipeWorkflow R6 class
- [`evaluate_cv()`](https://metasurveyr.github.io/metasurvey/reference/evaluate_cv.md)
  : Evaluate estimation with Coefficient of Variation
- [`save_workflow()`](https://metasurveyr.github.io/metasurvey/reference/save_workflow.md)
  : Save a RecipeWorkflow to a JSON file
- [`read_workflow()`](https://metasurveyr.github.io/metasurvey/reference/read_workflow.md)
  : Read a RecipeWorkflow from a JSON file
- [`workflow_from_list()`](https://metasurveyr.github.io/metasurvey/reference/workflow_from_list.md)
  : Construct a RecipeWorkflow from a plain list
- [`list_workflows()`](https://metasurveyr.github.io/metasurvey/reference/list_workflows.md)
  : List all workflows
- [`search_workflows()`](https://metasurveyr.github.io/metasurvey/reference/search_workflows.md)
  : Search workflows
- [`filter_workflows()`](https://metasurveyr.github.io/metasurvey/reference/filter_workflows.md)
  : Filter workflows by criteria
- [`rank_workflows()`](https://metasurveyr.github.io/metasurvey/reference/rank_workflows.md)
  : Rank workflows by downloads
- [`find_workflows_for_recipe()`](https://metasurveyr.github.io/metasurvey/reference/find_workflows_for_recipe.md)
  : Find workflows that use a specific recipe
- [`publish_workflow()`](https://metasurveyr.github.io/metasurvey/reference/publish_workflow.md)
  : Publish a workflow to the active backend
- [`set_workflow_backend()`](https://metasurveyr.github.io/metasurvey/reference/set_workflow_backend.md)
  : Set workflow backend
- [`get_workflow_backend()`](https://metasurveyr.github.io/metasurvey/reference/get_workflow_backend.md)
  : Get workflow backend
- [`reproduce_workflow()`](https://metasurveyr.github.io/metasurvey/reference/reproduce_workflow.md)
  : Reproduce a workflow from its published specification
- [`print(`*`<RecipeWorkflow>`*`)`](https://metasurveyr.github.io/metasurvey/reference/print.RecipeWorkflow.md)
  : Print method for RecipeWorkflow objects

## Rotating Panels

Panels with implantation and follow-ups

- [`get_implantation()`](https://metasurveyr.github.io/metasurvey/reference/get_implantation.md)
  : Obtener encuesta de implantación de panel rotativo
- [`get_follow_up()`](https://metasurveyr.github.io/metasurvey/reference/get_follow_up.md)
  : Obtener encuestas de seguimiento de panel rotativo
- [`extract_surveys()`](https://metasurveyr.github.io/metasurvey/reference/extract_surveys.md)
  : Extraer encuestas por periodicidad de panel rotativo

## Weights and Design

Weight and sampling design configuration

- [`add_weight()`](https://metasurveyr.github.io/metasurvey/reference/add_weight.md)
  : Configure weights by periodicity for Survey objects
- [`add_replicate()`](https://metasurveyr.github.io/metasurvey/reference/add_replicate.md)
  : Configure replicate weights for variance estimation
- [`resolve_weight_spec()`](https://metasurveyr.github.io/metasurvey/reference/resolve_weight_spec.md)
  : Resolve a portable weight specification to a usable weight
  configuration
- [`cat_design()`](https://metasurveyr.github.io/metasurvey/reference/cat_design.md)
  : Display survey design information
- [`cat_design_type()`](https://metasurveyr.github.io/metasurvey/reference/cat_design_type.md)
  : cat_design_type
- [`set_engine()`](https://metasurveyr.github.io/metasurvey/reference/set_engine.md)
  : set_engine
- [`get_engine()`](https://metasurveyr.github.io/metasurvey/reference/get_engine.md)
  : get_engine
- [`show_engines()`](https://metasurveyr.github.io/metasurvey/reference/show_engines.md)
  : show_engines
- [`set_use_copy()`](https://metasurveyr.github.io/metasurvey/reference/set_use_copy.md)
  : Set data copy option
- [`use_copy_default()`](https://metasurveyr.github.io/metasurvey/reference/use_copy_default.md)
  : Get data copy option
- [`set_lazy_processing()`](https://metasurveyr.github.io/metasurvey/reference/set_lazy_processing.md)
  : Set lazy processing
- [`lazy_default()`](https://metasurveyr.github.io/metasurvey/reference/lazy_default.md)
  : Lazy processing

## Time and Dates

Utilities for editions and periodicity

- [`extract_time_pattern()`](https://metasurveyr.github.io/metasurvey/reference/extract_time_pattern.md)
  : Extract time pattern
- [`validate_time_pattern()`](https://metasurveyr.github.io/metasurvey/reference/validate_time_pattern.md)
  : Validate time pattern
- [`group_dates()`](https://metasurveyr.github.io/metasurvey/reference/group_dates.md)
  : Group dates

## Visualization

- [`view_graph()`](https://metasurveyr.github.io/metasurvey/reference/view_graph.md)
  : View graph

## Remote API

REST client for the recipe registry

- [`configure_api()`](https://metasurveyr.github.io/metasurvey/reference/configure_api.md)
  : Configure metasurvey API
- [`api_login()`](https://metasurveyr.github.io/metasurvey/reference/api_login.md)
  : Login
- [`api_logout()`](https://metasurveyr.github.io/metasurvey/reference/api_logout.md)
  : Logout
- [`api_register()`](https://metasurveyr.github.io/metasurvey/reference/api_register.md)
  : Register a new user
- [`api_me()`](https://metasurveyr.github.io/metasurvey/reference/api_me.md)
  : Get current user profile
- [`api_refresh_token()`](https://metasurveyr.github.io/metasurvey/reference/api_refresh_token.md)
  : Refresh JWT token
- [`api_list_recipes()`](https://metasurveyr.github.io/metasurvey/reference/api_list_recipes.md)
  : List recipes from API
- [`api_get_recipe()`](https://metasurveyr.github.io/metasurvey/reference/api_get_recipe.md)
  : Get a single recipe by ID
- [`api_publish_recipe()`](https://metasurveyr.github.io/metasurvey/reference/api_publish_recipe.md)
  : Publish a recipe
- [`api_list_workflows()`](https://metasurveyr.github.io/metasurvey/reference/api_list_workflows.md)
  : List workflows from API
- [`api_get_workflow()`](https://metasurveyr.github.io/metasurvey/reference/api_get_workflow.md)
  : Get a single workflow by ID
- [`api_publish_workflow()`](https://metasurveyr.github.io/metasurvey/reference/api_publish_workflow.md)
  : Publish a workflow
- [`api_get_anda_variables()`](https://metasurveyr.github.io/metasurvey/reference/api_get_anda_variables.md)
  : Get ANDA variable metadata from the API

## ANDA

INE Uruguay ANDA catalog metadata

- [`anda_variables()`](https://metasurveyr.github.io/metasurvey/reference/anda_variables.md)
  : Query ANDA variable metadata from the API
- [`anda_download_microdata()`](https://metasurveyr.github.io/metasurvey/reference/anda_download_microdata.md)
  : Download ECH microdata from ANDA5

## Ecosystem Classes

R6 classes for the recipe ecosystem

- [`RecipeCategory`](https://metasurveyr.github.io/metasurvey/reference/RecipeCategory.md)
  : RecipeCategory
- [`RecipeCertification`](https://metasurveyr.github.io/metasurvey/reference/RecipeCertification.md)
  : RecipeCertification
- [`RecipeUser`](https://metasurveyr.github.io/metasurvey/reference/RecipeUser.md)
  : RecipeUser

# Articles

### Getting Started

Learn the basics of metasurvey

- [Getting Started with
  metasurvey](https://metasurveyr.github.io/metasurvey/articles/getting-started.md):

### Core Features

Recipes, workflows, and estimation

- [Creating and Sharing
  Recipes](https://metasurveyr.github.io/metasurvey/articles/recipes.md):
- [Estimation
  Workflows](https://metasurveyr.github.io/metasurvey/articles/workflows-and-estimation.md):

### Advanced Topics

Complex designs, panels, and validation

- [Survey Designs and
  Validation](https://metasurveyr.github.io/metasurvey/articles/complex-designs.md):
- [Rotating Panels and
  PoolSurvey](https://metasurveyr.github.io/metasurvey/articles/panel-analysis.md):

### Web App and API

Interactive explorer, REST API, and database

- [Interactive Recipe
  Explorer](https://metasurveyr.github.io/metasurvey/articles/shiny-explorer.md):
- [API and Database
  Reference](https://metasurveyr.github.io/metasurvey/articles/api-database.md):

### Case Studies

Real-world examples with ECH data

- [ECH Case Study: From STATA to
  R](https://metasurveyr.github.io/metasurvey/articles/ech-case-study.md):

### Español

Documentación en español

- [Introducción a
  metasurvey](https://metasurveyr.github.io/metasurvey/articles/metasurvey-es.md):
- [Primeros pasos con metasurvey
  (ES)](https://metasurveyr.github.io/metasurvey/articles/getting-started-es.md):
- [Creación y Compartición de Recipes
  (ES)](https://metasurveyr.github.io/metasurvey/articles/recipes-es.md):
- [Flujos de Trabajo y Estimacion
  (ES)](https://metasurveyr.github.io/metasurvey/articles/workflows-and-estimation-es.md):
- [Diseños de encuestas y validación
  (ES)](https://metasurveyr.github.io/metasurvey/articles/complex-designs-es.md):
- [Paneles Rotativos y PoolSurvey
  (ES)](https://metasurveyr.github.io/metasurvey/articles/panel-analysis-es.md):
- [Estudio de caso ECH: De STATA a R
  (ES)](https://metasurveyr.github.io/metasurvey/articles/ech-case-study-es.md):
- [Explorador Interactivo de Recetas
  (ES)](https://metasurveyr.github.io/metasurvey/articles/shiny-explorer-es.md):
- [Referencia de la API y Base de Datos
  (ES)](https://metasurveyr.github.io/metasurvey/articles/api-database-es.md):
